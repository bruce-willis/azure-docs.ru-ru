---
title: включение файла
description: включение файла
services: virtual-machines
author: axayjo
ms.service: virtual-machines
ms.topic: include
ms.date: 09/20/2018
ms.author: akjosh; cynthn
ms.custom: include file
ms.openlocfilehash: 6a64d85cc476c7494a1730959b96e9480115cd90
ms.sourcegitcommit: 4ecc62198f299fc215c49e38bca81f7eb62cdef3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2018
ms.locfileid: "47047007"
---
Коллекция общих образов — это служба, которая позволяет создавать структуру и организацию на основе пользовательских образов виртуальных машин. Коллекция общих образов предоставляет три основных предложения:
- Простое управление.
- Масштабирование образов клиентов.
- Совместное использование образов. Отправляйте образы различным пользователям, субъектам-службам или группам Active Directory в рамках вашей организации, а также в разных регионах, используя репликацию между несколькими регионами.

Управляемый образ представляет собой либо полную копию виртуальной машины (вместе со всеми подключенными дисками данных), либо просто копию диска операционной системы, в зависимости от того, как создается образ. При создании виртуальной машины из образа копии виртуальных жестких дисков в образе используются для создания дисков для новой виртуальной машины. Управляемый образ остается в хранилище и может использоваться для создания виртуальных машин снова и снова.

Если у вас есть большое количество управляемых образов, которые нужно сохранить и сделать доступными для всей компании, можно использовать коллекцию общих образов в качестве репозитория, что позволит легко обновлять и передавать образы. Расходы на использование коллекции общих образов — это расходы на хранилище, которое используют образы, а также любые расходы на исходящий трафик сети для репликации образов из исходного региона в опубликованные области.

Функция коллекции общих образов имеет несколько типов ресурсов.

| Ресурс | ОПИСАНИЕ|
|----------|------------|
| **Управляемый образ** | Это образ базового плана, который можно использовать отдельно или для создания нескольких **версий общих образов** в коллекции образов.|
| **Коллекция образов** | Как и Azure Marketplace, **коллекция образов** — это репозиторий для управления и совместного использования образов, но в отличие от Azure Marketplace доступ к коллекции образов контролируете вы. |
| **Образ коллекции** | Образы определяются в пределах коллекции и содержат в себе сведения об образе и требования для его использования. Эти сведения включают в себя: определение, относится ли этот образ к Windows или к Linux, заметки о выпуске, а также минимальные и максимальные требования к памяти. Этот тип образов — это ресурс в рамках модели развертывания Resource Manager, который не используется непосредственно для создания виртуальных машин. Это определение типа образа. |
| **Версия общего образа** | **Версия образа** используется для создания виртуальной машины с помощью коллекции. В зависимости от требований для вашей среды, у вас может быть несколько версий образа. Так же как и управляемый образ при использовании **версии образа** для создания виртуальной машины, версия образа используется для создания новых дисков для виртуальной машины. Версии образов можно использовать несколько раз. |

<br>


![Рисунок, показывающий, как использовать несколько версий образа в коллекции](./media/shared-image-galleries/shared-image-gallery.png)

### <a name="regional-support"></a>Поддержка в регионах

Поддержка в регионах для коллекции общих образов ограничена, но будет расширяться со временем. Для предварительной версии. Ниже приведены списки регионов, в которых можно создавать коллекции, и регионов, в которых можно реплицировать какие-либо коллекции. 

| Создание коллекции  | Репликация версии |
|--------------------|----------------------|
| Западно-центральная часть США    |Центрально-южная часть США|
| Восток США 2          |Восточная часть США|
| Центрально-южная часть США   |Восток США 2|
| Юго-Восточная Азия     |Запад США|
| Западная Европа        |Западный регион США 2|
|                    |Центральный регион США|
|                    |Центрально-северная часть США|
|                    |Центральная Канада|
|                    |Восточная Канада|
|                    |Северная Европа|
|                    |Западная Европа|
|                    |Южная Индия|
|                    |Юго-Восточная Азия|



## <a name="scaling"></a>Масштабирование
Коллекция общих образов позволяет указать число реплик, которые вы хотите, чтобы Azure сохранил для образов. Это помогает в сценариях развертывания нескольких виртуальных машин, поскольку их развертывания могут быть распространены на разные реплики, уменьшая вероятность того, что процесс создания экземпляра будет регулироваться из-за перегрузки отдельной реплики.

![Рисунок, показывающий, как можно масштабировать образы](./media/shared-image-galleries/scaling.png)


## <a name="replication"></a>Репликация
Коллекция общих образов также позволяет автоматически реплицировать свои образы в других регионах Azure. Каждую версию общего образа можно реплицировать в разных регионах в зависимости от того, что лучше всего подходит для вашей организации. Примером может служить репликация последних образов в нескольких регионах, хотя все старые версии доступны только в одном регионе. Это позволяет экономить на стоимости хранения для версий общих образов. Области, в которых реплицирована версия общего образа, можно обновить после создания. Время, необходимое для репликации в разных регионах, зависит от объема копируемых данных и количества регионов, в которые реплицируется версия. В некоторых случаях это может занять несколько часов. В процессе репликации можно просмотреть ее состояние для каждого региона. По завершении репликации образа в регионе с помощью этой версии в нем можно развернуть виртуальную машину или масштабируемый набор виртуальных машин.

![Рисунок, показывающий, как можно реплицировать образы](./media/shared-image-galleries/replication.png)


## <a name="access"></a>Access
Поскольку коллекция общих образов, общий образ и версия общего образа — это ресурсы, их можно совместно использовать с помощью собственных встроенных средств управления Azure RBAC. С помощью RBAC вы можете поделиться этими материалами с другими пользователями, субъектами-службами и группами в вашей организации. Область общего доступа к этим ресурсам находится в пределах того же клиента Active Directory. Как только пользователь получает доступ к версии общего образа, виртуальную машину или масштабируемый набор виртуальных машин можно развернуть в любой из подписок, к которой имеется доступ в рамках того же клиента Active Directory, что и версия общего образа.  Ниже приведена матрица общего доступа, которая помогает понять, к чему пользователь получает доступ.

| Доступ предоставлен пользователю     | Общая коллекция образов | Общий образ | Версия общего образа |
|----------------------|----------------------|--------------|----------------------|
| Общая коллекция образов | Yes                  | Да          | Yes                  |
| Общий образ         | Нет                    | Yes          | Yes                  |
| Версия общего образа | Нет                    | Нет            | Yes                  |



## <a name="billing"></a>Выставление счетов
За использование службы "Коллекция общих образов" дополнительная оплата не взимается. Плата взимается за следующие ресурсы.
- Расходы хранилища для хранения версий общих образов. Они зависят от числа реплик версии и количества регионов ее репликации.
- Плата за исходящий трафик сети для репликации из исходного региона версии в реплицируемые регионы.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы 

**Вопрос.** Как зарегистрироваться на общедоступную предварительную версию коллекции общих образов?
 
 О. Чтобы зарегистрироваться на общедоступную предварительную версию коллекции общих образов, необходимо зарегистрироваться для функции, выполнив следующие команды из каждой из подписок, в которых хотите создать коллекцию общих образов, определение образа или ресурсы версий образов, а также где планируете развертывание виртуальных машин с помощью версий образов.

**CLI**: 

```bash 
az feature register --namespace Microsoft.Compute --name GalleryPreview
az provider register -n Microsoft.Compute
```

**PowerShell**: 

```powershell
Register-AzureRmProviderFeature -FeatureName GalleryPreview -ProviderNamespace Microsoft.Compute
Register-AzureRmResourceProvider -ProviderNamespace Microsoft.Compute
```

**Вопрос.** Как создать список всех ресурсов коллекции общих образов в разных подписках? 
 
 О. Чтобы получить список всех ресурсов коллекции общих образов в разных подписках, к которым вы имеете доступ на портале Azure, выполните следующие действия:

 1. Откройте [портал Azure](https://portal.azure.com).
 1. Перейдите в раздел **Все ресурсы**.
 1. Выберите все подписки, из которых вы хотите включить в список все ресурсы.
 1. Найдите ресурсы типа **Закрытая коллекция**.
 
 Для просмотра определений и версий образов следует также выбрать **Показать скрытые типы**.
 
 Чтобы получить список всех ресурсов коллекции общих образов в разных подписках, к которым у вас есть доступ, выполните следующую команду в Azure CLI.

 ```bash
 az account list -otsv --query "[].id" | xargs -n 1 az sig list --subscription
 ```


**Вопрос.** Как предоставить общий доступ к образам в разных подписках?
 
 О. Вы можете предоставить общий доступ к образам в разных подписках с помощью службы "Контроль доступа на основе ролей" (RBAC). Любой пользователь, имеющий разрешения на чтение версии образа даже в разных подписках, сможет развернуть виртуальную машину с помощью версии образа.


**Вопрос.** Можно ли перенести существующий образ в коллекцию общих образов?
 
 О. Да. Существует 3 сценария, в зависимости от типов образов, которые у вас могут быть.

 Сценарий 1. Если у вас есть управляемый образ, из него можно создать определение образа и версию образа.

 Сценарий 2. Если у вас есть неуправляемый универсальный образ, из него можно создать управляемый образ, из которого впоследствии можно создать определение образа и версию образа. 

 Сценарий 3. Если у вас есть виртуальный жесткий диск в локальной файловой системе, необходимо его отправить, создать управляемый образ, из которого впоследствии можно создать определение образа и версию образа. 
    - Если это виртуальный жесткий диск виртуальной машины Windows, см. раздел [Отправка универсального диска VHD и создание виртуальных машин с его помощью в Azure](https://docs.microsoft.com/azure/virtual-machines/windows/upload-generalized-managed).
    - Если это виртуальный жесткий диск виртуальной машины Linux, см. раздел [Создание виртуальной машины Linux на основе пользовательского диска с помощью Azure CLI](https://docs.microsoft.com/azure/virtual-machines/linux/upload-vhd#option-1-upload-a-vhd).


**Вопрос.** Можно ли создать версию образа из специализированного диска?

 О. Нет, в настоящее время мы не поддерживаем специализированные диски в качестве образов. Если у вас есть специализированный диск, необходимо [создать виртуальную машину из виртуального жесткого диска](https://docs.microsoft.com/azure/virtual-machines/windows/create-vm-specialized-portal#create-a-vm-from-a-disk) путем присоединения специализированного диска к новой виртуальной машине. Запустив виртуальную машину, необходимо следовать инструкциям, чтобы создать управляемый образ из [виртуальной машины Windows] https://docs.microsoft.com/en-us/azure/virtual-machines/windows/tutorial-custom-images) или [виртуальной машины Linux](https://docs.microsoft.com/en-us/azure/virtual-machines/linux/tutorial-custom-images). При наличии универсального управляемого образа можно начать процесс создания описания общего образа и версии образа.


**Вопрос.** Можно ли создать коллекцию общих образов, определение образа и версию образа с помощью портала Azure?

 О. Нет, на данный момент создание ресурсов коллекции общих образов с помощью портала Azure не поддерживается. Тем не менее создавать ресурсы коллекции общих образов можно через интерфейс командной строки, шаблоны и пакеты SDK. Скоро также появится поддержка PowerShell.

 
**Вопрос.** Можно ли обновить определение образа или версию образа после создания? Какие сведения можно изменить?

 О. Ниже перечислены сведения, которые можно обновить для каждого из ресурсов.
 
Коллекция общих образов
- ОПИСАНИЕ

Определение образа
- Рекомендуемое число виртуальных ЦП
- Память
- ОПИСАНИЕ
- Дата окончания жизненного цикла

Версия образа
- Количество региональных реплик
- Целевые регионы
- Исключения из последней версии
- Дата окончания жизненного цикла


**Вопрос.** Можно ли после создания переместить ресурс коллекции общих образов в другую подписку?

 О. Нет, ресурс коллекции общих образов невозможно переместить в другую подписку. Тем не менее при необходимости можно реплицировать версии образов в коллекции в другие регионы.

**Вопрос.** Можно ли реплицировать версии образов между облаками — 21Vianet Azure для Китая, Azure для Германии и облако Azure для государственных организаций? 

 О. Нет, реплицировать версии образов между облаками невозможно.

**Вопрос.** Можно ли реплицировать версии образов между подписками? 

 О. Нет, можно реплицировать версии образов между регионами в рамках подписки и использовать их в других подписках с помощью RBAC.

**Вопрос.** Возможно ли предоставить общий доступ к версиям образов между клиентами Active Directory? 

 О. Нет, на данный момент коллекция общих образов не поддерживает предоставление общего доступа к версиям образов между клиентами Active Directory. Тем не менее для достижения этой цели вы можете использовать функцию "Частные предложения" в Azure Marketplace.


**Вопрос.** Сколько времени занимает репликация версии образа между целевыми регионами?

 О. Время репликации версии образа полностью зависит от размера образа и числа регионов, в которые он реплицируется. Однако для достижения наилучших результатов рекомендуется, чтобы размер образа был маленьким, а исходный и целевые регионы находились близко друг к другу. Можно проверить состояние репликации, используя флажок ReplicationStatus.


**Вопрос.** Сколько коллекций общих образов можно создать в подписке?

 О. Квота по умолчанию: 
- 10 коллекций общих образов на одну подписку на один регион;
- 200 определений образов на одну подписку на один регион;
- 2000 версий образов на одну подписку на один регион.


**Вопрос.** В чем разница между исходным и целевым регионом?

 О. Исходный регион — это регион, в котором будет создана версия образа. А целевые регионы — это регионы, в которых будет храниться копия вашей версии образа. Для каждой версии образа может быть только один исходный регион. Кроме того, убедитесь, что при создании версии образа вы передали расположение исходного региона как одно из целевых регионов.  


**Вопрос.** Как указать исходный регион при создании версии образа?

 О. При создании версии образа, чтобы указать исходный регион, можно использовать теги **--location** в интерфейсе командной строки и **-Location** в PowerShell. Убедитесь, что управляемый образ, который используется в качестве базового для создания версии образа, находится в том же расположении, в котором вы хотите создать версию образа. Кроме того, убедитесь, что при создании версии образа вы передали расположение исходного региона как одно из целевых регионов.  


**Вопрос.** Как задать число реплик версии образа, создаваемых в каждом регионе?

 О. Задать число реплик версии образа, создаваемых в каждом регионе, можно двумя способами:
 
1. Количество региональных реплик, которое указывает на число реплик, создаваемых на регион. 
2. Общее количество реплик, которое является значением по умолчанию для регионов в случае, если не указано количество региональных реплик. 

Чтобы указать количество региональных реплик, передайте расположение вместе с количеством реплик, которые вы хотите создать в этом регионе, следующим образом: "South Central US=2". 

Если количество региональных реплик указано не для всех расположений, то количеством по умолчанию будет общее количество реплик, которое вы указали. 

Чтобы указать общее количество реплик в интерфейсе командной строки, используйте аргумент **--replica-count** в команде `az sig image-version create`.


**Вопрос.** Можно ли создать коллекцию общих образов в расположении, отличном от того, где планируется создание определения образа и версии образа?

 О. Да, это возможно. Но мы рекомендуем вам держать группу ресурсов, коллекцию общих образов, определение образа и версию образа в одном расположении.


**Вопрос.** Какова стоимость использования коллекции общих образов?

 О. За использование службы "Коллекция общих образов" плата не взимается, за исключением расходов на хранение версий образов и на исходящий трафик для репликации версий образов из исходного региона в целевые регионы.

**Вопрос.** Какую версию API следует использовать для создания коллекции общих образов, определения образа, версии образа и виртуальной машины или масштабируемого набора виртуальных машин из версии образа?

 О. Для развертываний виртуальной машины и масштабируемого набора виртуальных машин с помощью версии образа рекомендуется использовать API версии 2018-04-01 или более поздней. Для работы с коллекцией общих образов, определениями образов и версиями образов рекомендуется использовать API версии 2018-06-01. 