---
title: Решение служб анализа SQL Azure в Log Analytics | Документация Майкрософт
description: Как решение "Аналитика SQL Azure" поможет вам управлять базами данных SQL Azure
services: log-analytics
documentationcenter: ''
author: danimir
manager: carmonm
ms.reviewer: carlrab
ms.assetid: b2712749-1ded-40c4-b211-abc51cc65171
ms.service: log-analytics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 05/03/2018
ms.author: v-daljep
ms.component: na
ms.openlocfilehash: b7a7e2787128c74cd7d016c01b751d15628fb4b2
ms.sourcegitcommit: 5b8d9dc7c50a26d8f085a10c7281683ea2da9c10
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/26/2018
ms.locfileid: "47181997"
---
# <a name="monitor-azure-sql-database-using-azure-sql-analytics-preview"></a>Мониторинг базы данных SQL Azure с помощью решения "Аналитика SQL Azure" (предварительная версия)

![Символ службы "Аналитика SQL Azure"](./media/log-analytics-azure-sql/azure-sql-symbol.png)

Аналитика SQL Azure — это облачное решение для наблюдения за производительностью баз данных SQL Azure, эластичных пулов и управляемых экземпляров в нужном масштабе и в нескольких подписках. Эта служба собирает и отображает важные метрики производительности Базы данных SQL Azure благодаря встроенным средствам аналитики, которые помогают устранять соответствующие неполадки.

На основе этих метрик можно создавать пользовательские правила мониторинга и оповещения. Решение также поможет вам определить проблемы на каждом уровне стека приложений. Оно использует метрики диагностики Azure с представлениями Log Analytics, чтобы представить данные обо всех Базах данных SQL Azure, эластичных пулах и базах данных в Управляемом экземпляре в единой рабочей области Log Analytics. Log Analytics помогает собирать, коррелировать и визуализировать структурированные и неструктурированные данные.

Практические сведения об использовании решения "Аналитика SQL Azure" и типичные сценарии его применения приведены в видео:


> [!VIDEO https://channel9.msdn.com/Shows/Azure-Friday/Get-Intelligent-Insights-for-Improving-Azure-SQL-Database-Performance/player]
>

## <a name="connected-sources"></a>Подключенные источники

Аналитика SQL Azure — это облачное решение для мониторинга с поддержкой потоковой передачи диагностических данных телеметрии для баз данных SQL Azure, баз данных управляемых экземпляров и эластичных пулов.

Так как это решение не использует агенты для подключения к Log Analytics, оно не поддерживает мониторинг серверов SQL Server, размещенных в локальной среде или на виртуальных машинах (сведения о совместимости см. в следующей таблице).

| Подключенный источник | Поддерживаются | ОПИСАНИЕ |
| --- | --- | --- |
| **[Система диагностики Azure](log-analytics-azure-storage.md)** | **Да** | Данные метрик и журнала Azure отправляются в Log Analytics непосредственно из Azure. |
| [Учетная запись хранения Azure](log-analytics-azure-storage.md) | Нет  | Log Analytics не считывает данные из учетной записи хранения. |
| [Агенты Windows](log-analytics-windows-agent.md) | Нет  | Решение не использует прямые агенты Windows. |
| [Агенты Linux](log-analytics-linux-agents.md) | Нет  | Решение не использует прямые агенты Linux. |
| [Группы управления SCOM](log-analytics-om-agents.md) | Нет  | Решение не использует прямое подключение агента SCOM к Log Analytics. |

## <a name="configuration"></a>Параметр Configuration

Чтобы добавить решение "Аналитика SQL Azure" на панель мониторинга Azure, сделайте следующее.

1. Добавьте решение "Аналитика SQL Azure" в рабочую область из [Azure marketplace](https://azuremarketplace.microsoft.com/en-us/marketplace/apps/Microsoft.AzureSQLAnalyticsOMS?tab=Overview).
2. На портале Azure щелкните **+Создать ресурс** и выберите **Аналитика SQL Azure**.  
    ![Мониторинг и управление](./media/log-analytics-azure-sql/monitoring-management.png)
3. Выберите в списке **Аналитика SQL Azure (предварительная версия)**.
4. В области **Службы анализа SQL Azure (предварительная версия)** щелкните **Создать**.  
    ![Создание](./media/log-analytics-azure-sql/portal-create.png)
5. В области **Создание решения** выберите или создайте рабочую область, в которую необходимо добавить решение, а затем нажмите кнопку **Создать**.

    ![Добавление в рабочую область](./media/log-analytics-azure-sql/add-to-workspace.png)

### <a name="configure-azure-sql-databases-elastic-pools-and-managed-instances-to-stream-diagnostics-telemetry"></a>Настройка баз данных SQL Azure, эластичных пулов и управляемых экземпляров для потоковой передачи телеметрии службы диагностики

Когда вы создадите решение "Аналитика SQL Azure" в рабочей области для наблюдения за производительностью баз данных SQL Azure, баз данных управляемых экземпляров и эластичных пулов, необходимо будет **настроить каждый** из этих ресурсов для потоковой передачи его телеметрии системы диагностики в решение.

- Включите систему диагностики Azure для базы данных Azure SQL, баз данных управляемых экземпляров и эластичных пулов для [потоковой передачи телеметрии системы диагностики в решение "Аналитика SQL Azure"](../sql-database/sql-database-metrics-diag-logging.md).

### <a name="to-configure-multiple-azure-subscriptions"></a>Настройка нескольких подписок Azure
 
Чтобы обеспечить поддержку нескольких подписок, используйте сценарий PowerShell. Дополнительные сведения см. в статье [Enable Azure resource metrics logging using PowerShell](https://blogs.technet.microsoft.com/msoms/2017/01/17/enable-azure-resource-metrics-logging-using-powershell/) (Включение ведения журнала метрик ресурсов Azure с помощью PowerShell). Укажите идентификатор ресурса рабочей области в качестве параметра при выполнении скрипта для отправки диагностических данных из ресурсов в одной подписке Azure в рабочую область в другой подписке Azure.

**Пример**

```
PS C:\> $WSID = "/subscriptions/<subID>/resourcegroups/oms/providers/microsoft.operationalinsights/workspaces/omsws"
```

```
PS C:\> .\Enable-AzureRMDiagnostics.ps1 -WSID $WSID
```

## <a name="using-the-solution"></a>Использование решения

Вместе с решением в рабочую область добавляется элемент служб анализа SQL Azure. Кроме того, он появляется в общих сведениях. На плитке отображаются количество баз данных SQL Azure, эластичных пулов, управляемых экземпляров и баз данных в управляемых экземплярах, от которых решение получает телеметрию системы диагностики.

![Элемент служб анализа SQL Azure](./media/log-analytics-azure-sql/azure-sql-sol-tile.png)

Это решение включает два отдельных представления — одно для мониторинга баз данных SQL Azure и эластичных пулов, а другое для мониторинга управляемого экземпляра и баз данных в управляемых экземплярах.

Чтобы просмотреть панель мониторинга решения "Аналитика SQL Azure" для баз данных SQL Azure и эластичных пулов, щелкните в верхней части плитки. Чтобы просмотреть панель мониторинга решения "Аналитика SQL Azure" для управляемого экземпляра и баз данных в управляемом экземпляре, щелкните в нижней части плитки.

### <a name="viewing-azure-sql-analytics-data"></a>Просмотр данных службы "Аналитика SQL Azure"

На панели мониторинга отображаются общие сведения обо всех базах данных, мониторинг которых осуществляется через различные перспективы. Для работы различных перспектив необходимо включить соответствующие метрики или журналы в ресурсах SQL для потоковой передачи в рабочую область Log Analytics.

Обратите внимание: если потоковая передача некоторых метрик или журналов в службу Azure Log Analytics не выполняются, плитки в решении не будут заполнены данными мониторинга.

### <a name="azure-sql-database-and-elastic-pool-view"></a>Представление базы данных SQL Azure и эластичных пулов

После выбора плитки "Аналитика SQL Azure" для базы данных SQL Azure и эластичных пулов отобразится панель мониторинга.

![Обзор службы "Аналитика SQL Azure"](./media/log-analytics-azure-sql/azure-sql-sol-overview.png)

При выборе любой плитки открывается подробный отчет о конкретной перспективе. Выбрав перспективу, вы увидите подробный отчет.

![Время ожидания службы "Аналитика SQL Azure"](./media/log-analytics-azure-sql/azure-sql-sol-metrics.png)

Каждая перспектива в этом представлении включает сводки по подписке, серверу, эластичному пулу и уровню базы данных. Кроме того, справа в каждой перспективе отображается отчет о ней. Выбор подписки, сервера, пула или базы данных из списка позволяет продолжить подробное изучение.

### <a name="managed-instance-and-databases-in-managed-instance-view"></a>Управляемый экземпляр и базы данных в представлении управляемого экземпляра

После выбора плитки решения "Аналитика SQL Azure" для управляемых экземпляров и баз данных управляемых экземпляров отобразится панель мониторинга.

![Обзор службы "Аналитика SQL Azure"](./media/log-analytics-azure-sql/azure-sql-sol-overview-mi.png)

При выборе любой плитки открывается подробный отчет о конкретной перспективе. Выбрав перспективу, вы увидите подробный отчет.

При выборе представления управляемого экземпляра отображаются сведения об использовании управляемого экземпляра, содержащихся в нем базах данных, а также телеметрия по запросам, выполняемым в пределах экземпляра.

![Время ожидания службы "Аналитика SQL Azure"](./media/log-analytics-azure-sql/azure-sql-sol-metrics-mi.png)

### <a name="perspectives"></a>Перспективы

В таблице ниже представлены перспективы, поддерживаемые для двух версий панели мониторинга — одной для базы данных SQL Azure и эластичных пулов, а другой для управляемого экземпляра.

| Перспектива | ОПИСАНИЕ | Поддержка базы данных SQL и эластичных пулов | Поддержка управляемого экземпляра |
| --- | ------- | ----- | ----- |
| Resource by type (Ресурсы по типу) | Перспектива, в которой представлено число всех отслеживаемых ресурсов. | Yes | Yes | 
| Аналитика | Предоставляет подробные сведения о производительности Intelligent Insights в иерархическом виде. | Yes | Yes |
| Errors | Предоставляет подробные данные об ошибках SQL, возникших в базах данных, в иерархическом виде. | Yes | Yes |
| Время ожидания | Предоставляет подробные данные о времени ожидания SQL в базах данных в иерархическом виде. | Yes | Нет  |
| Blockings (Блокировки) | Предоставляет подробные данные о блокировках SQL в базах данных в иерархическом виде. | Yes | Нет  |
| Database waits (Время ожидания базы данных) | Предоставляет подробную статистику времени ожидания SQL на уровне базы данных в иерархическом виде. Включает сводку по общему времени ожидания и времени ожидания для каждого типа ожидания. |Yes | Yes |
| Query duration (Длительность запросов) | Предоставляет подробную статистику о выполнении запросов, такую как продолжительность запроса, загрузку ЦП, число операций ввода-вывода данных, число операций ввода-вывода журнала, в иерархическом виде. | Yes | Yes |
| Query waits (Время ожидания запроса) | Предоставляет подробную статистику времени ожидании запросов по категории ожидания в иерархическом виде. | Yes | Yes |

### <a name="intelligent-insights-report"></a>Отчет Intelligent Insights

[Intelligent Insights](../sql-database/sql-database-intelligent-insights.md) для базы данных SQL Azure позволяет узнать, что происходит с производительностью баз данных SQL Azure и баз данных управляемых экземпляров. Все собранные данные Intelligent Insights можно визуализировать в перспективе Intelligent Insights, а также получить к ним доступ.

![Аналитические сведения службы "Аналитика SQL Azure"](./media/log-analytics-azure-sql/azure-sql-sol-insights.png)

### <a name="elastic-pool-and-database-reports"></a>Отчеты об эластичных пулах и базах данных

Для эластичных пулов и баз данных SQL предусмотрены собственные определенные отчеты, в которых можно просмотреть все данные, собранные для ресурса в указанное время.

![База данных службы "Аналитика SQL Azure"](./media/log-analytics-azure-sql/azure-sql-sol-database.png)

![Эластичный пул SQL Azure](./media/log-analytics-azure-sql/azure-sql-sol-pool.png)

### <a name="query-reports"></a>Отчеты о запросах

С помощью перспективы Query duration (Длительность запроса) и Query waits (Время ожидания запроса) можно сопоставить производительность любого запроса в отчете о запросах. В этом отчете сравнивается производительность запросов в различных базах данных. Кроме того, он упрощает точное определение баз данных с высокой и низкой производительностью запросов.

![Запросы службы "Аналитика SQL Azure"](./media/log-analytics-azure-sql/azure-sql-sol-queries.png)

### <a name="analyze-data-and-create-alerts"></a>Анализ данных и создание оповещений

### <a name="creating-alerts-for-azure-sql-database"></a>Создание оповещений для базы данных SQL Azure

[Оповещения можно легко создать](../monitoring-and-diagnostics/monitor-alerts-unified-usage.md) с помощью данных, поступающих из ресурсов службы "База данных SQL Azure". Вот несколько полезных запросов [поиска по журналам](log-analytics-log-searches.md), которые можно использовать с оповещениями журналов:

*Высокий уровень ЦП в Базе данных SQL Azure*

```
AzureMetrics 
| where ResourceProvider=="MICROSOFT.SQL"
| where ResourceId contains "/DATABASES/"
| where MetricName=="cpu_percent" 
| summarize AggregatedValue = max(Maximum) by bin(TimeGenerated, 5m)
| render timechart
```

> [!NOTE]
> - Предварительное требование для настройки этого предупреждения заключается в том, чтобы отслеживаемые базы данных потоком передавали метрики диагностики (вариант "Все метрики") в решение.
> - Замените значение MetricName cpu_percent на dtu_consumption_percent, чтобы получить высокие результаты DTU.

*Высокая загрузка ЦП в эластичных пулах баз данных SQL Azure*

```
AzureMetrics 
| where ResourceProvider=="MICROSOFT.SQL"
| where ResourceId contains "/ELASTICPOOLS/"
| where MetricName=="cpu_percent" 
| summarize AggregatedValue = max(Maximum) by bin(TimeGenerated, 5m)
| render timechart
```

> [!NOTE]
> - Предварительное требование для настройки этого предупреждения заключается в том, чтобы отслеживаемые базы данных потоком передавали метрики диагностики (вариант "Все метрики") в решение.
> - Замените значение MetricName cpu_percent на dtu_consumption_percent, чтобы получить высокие результаты DTU.

*Хранилище Базы данных SQL Azure в среднем было заполнено на 95 % в течение последнего часа*

```
let time_range = 1h;
let storage_threshold = 95;
AzureMetrics
| where ResourceId contains "/DATABASES/"
| where MetricName == "storage_percent"
| summarize max_storage = max(Average) by ResourceId, bin(TimeGenerated, time_range)
| where max_storage > storage_threshold
| distinct ResourceId
```

> [!NOTE]
> - Предварительное требование для настройки этого предупреждения заключается в том, чтобы отслеживаемые базы данных потоком передавали метрики диагностики (вариант "Все метрики") в решение.
> - Для этого запроса требуется такая настройка правила генерации оповещений, чтобы оповещение запускалось при наличии результатов (> 0) запроса, обозначающих, что условие существует в некоторых базах данных. В выходных данных содержится список ресурсов базы данных, которые превышают порог storage_threshold в рамках определенного time_range.
> - В выходных данных содержится список ресурсов базы данных, которые превышают порог storage_threshold в рамках определенного time_range.

*Оповещение об Intelligent Insights*

```
let alert_run_interval = 1h;
let insights_string = "hitting its CPU limits";
AzureDiagnostics
| where Category == "SQLInsights" and status_s == "Active" 
| where TimeGenerated > ago(alert_run_interval)
| where rootCauseAnalysis_s contains insights_string
| distinct ResourceId
```

> [!NOTE]
> - Предварительное требование для настройки этого предупреждения заключается в том, чтобы отслеживаемые базы данных потоком передавали журнал диагностики SQLInsights в решение.
> - Для этого запроса также требуется настроить правило генерации оповещений, которое будет выполняться с той же частотой, что и alert_run_interval, чтобы избежать повторяющихся результатов. Правило должно быть настроено на то, чтобы запускать оповещение, когда для запроса существуют результаты (> 0).
> - Настройте alert_run_interval, чтобы задать диапазон времени для проверки того, произошло ли условие в базах данных, настроенных для потоковой отправки журнала SQLInsights в решение.
> - Настройте insights_string, чтобы записывать текст анализа первопричин, представленный в экземпляре аналитических сведений. Этот же текст отображается в пользовательском интерфейсе решения, который можно использовать из существующих экземпляров аналитических сведений. Кроме того, приведенный ниже запрос можно использовать для просмотра текста всех аналитических сведений, созданных в подписке. В выходных данных запроса содержатся различные строки, которые можно использовать для настройки оповещений в Insights.

```
AzureDiagnostics
| where Category == "SQLInsights" and status_s == "Active" 
| distinct rootCauseAnalysis_s
```

### <a name="creating-alerts-for-managed-instance"></a>Создание оповещений для управляемого экземпляра

Хранилище управляемых экземпляров заполнено более чем на 90 %

```
let storage_percentage_treshold = 90;
AzureDiagnostics
| where Category =="ResourceUsageStats"
| summarize (TimeGenerated, calculated_storage_percentage) = arg_max(TimeGenerated, todouble(storage_space_used_mb_s) *100 / todouble (reserved_storage_mb_s))
   by ResourceId
| where calculated_storage_percentage > storage_percentage_treshold
```

> [!NOTE]
> - Предварительным требованием для настройки этого оповещение предупреждение является включение потоковой передачи журнала ResourceUsageStats управляемого экземпляра, подлежащего мониторингу, в решении.
> - Для этого запроса требуется такая настройка правила генерации оповещений, чтобы оповещение запускалось при наличии результатов (> 0) запроса, обозначающих, что условие существует в управляемом экземпляре. Результатом является уровень загруженности хранилища (в процентах) в управляемом экземпляре.

## <a name="next-steps"></a>Дополнительная информация

- Используйте [поиск по журналам](log-analytics-log-searches.md) в Log Analytics для просмотра подробных данных SQL Azure.
- [Создавайте пользовательские панели мониторинга](log-analytics-dashboards.md), отображающие данные SQL Azure.
- [Создавайте оповещения](log-analytics-alerts.md), предупреждающие о возникновении определенных событий SQL Azure.
