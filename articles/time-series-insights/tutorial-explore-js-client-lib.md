---
title: Изучение клиентской библиотеки JavaScript для службы "Аналитика временных рядов Azure"
description: Сведения о клиентской библиотеке JavaScript для службы "Аналитика временных рядов Azure" и соответствующей модели программирования.
author: BryanLa
manager: timlt
ms.service: time-series-insights
services: time-series-insights
ms.topic: tutorial
ms.date: 06/05/2018
ms.author: bryanla
ms.openlocfilehash: 6bd8b10100f8cdabca5f87addfea1690dc5fac6c
ms.sourcegitcommit: 6cf20e87414dedd0d4f0ae644696151e728633b6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/06/2018
ms.locfileid: "34809504"
---
# <a name="tutorial-explore-the-azure-time-series-insights-javascript-client-library"></a>Руководство. Изучение клиентской библиотеки JavaScript для службы "Аналитика временных рядов Azure"

Чтобы помочь разработчикам запрашивать и визуализировать данные, хранящиеся в службе "Аналитика временных рядов Azure" (TSI), мы разработали библиотеку управления на основе JavaScript D3.  С помощью этого руководства вы сможете изучить клиентскую библиотеку TSI и соответствующую модель программирования, используя пример веб-приложения.

Вы также сможете поэкспериментировать с библиотекой и получить представление о том, как обращаться к данным TSI и использовать элементы управления диаграммой для обработки и визуализации данных. Вы получите достаточно сведений, чтобы использовать библиотеку в собственном веб-приложении.

В этом руководстве вы рассмотрите следующее:

> [!div class="checklist"]
> * пример приложения TSI;
> * клиентскую библиотеку TSI JavaScript;
> * как пример приложения использует библиотеку для визуализации данных TSI.

## <a name="prerequisites"></a>предварительным требованиям

В этом руководстве используется функция "Средства для разработчиков" (другое название — DevTools или F12), которая доступна в большинстве современных веб-браузеров, включая [Edge](/microsoft-edge/devtools-guide), [Chrome](https://developers.google.com/web/tools/chrome-devtools/), [FireFox](https://developer.mozilla.org/en-US/docs/Learn/Common_questions/What_are_browser_developer_tools), [Safari](https://developer.apple.com/safari/tools/) и другие. При необходимости вы можете ознакомиться с ней в своем браузере, прежде чем продолжить.

## <a name="time-series-insights-sample-application"></a>Пример приложения TSI

В этом руководстве пример приложения TSI приведен для изучения исходного кода приложения, включая использование клиентской библиотеки TSI JavaScript. Пример — это одностраничное веб-приложение (SPA), с помощью которого показано, как использовать библиотеку, а также как запрашивать и визуализировать данные из примера среды TSI.

1. Перейдите к примеру приложения [TSI](https://insights.timeseries.azure.com/clientsample). Вы увидите следующую страницу с запросом на вход:

   ![Пример клиента TSI: запрос на вход](media/tutorial-explore-js-client-lib/tcs-sign-in.png)

2. Нажмите кнопку **Вход** и введите или выберите свои учетные данные. Вы можете использовать корпоративную учетную запись предприятия или организации (Azure Active Directory) либо личную учетную запись (учетная запись Майкрософт или MSA).

   ![Пример клиента TSI: запрос на ввод учетных данных](media/tutorial-explore-js-client-lib/tcs-sign-in-enter-account.png)

3. После входа отобразится следующая страница: На странице вы увидите несколько стилей примеров диаграмм, которые заполняются данными TSI. Учетная запись и кнопка **Выход** отображаются в правом верхнем углу:

   ![Пример клиента TSI: главная страница после входа](media/tutorial-explore-js-client-lib/tcs-main-after-signin.png)

### <a name="page-source-and-structure"></a>Исходный код страницы и ее структура

Сначала давайте рассмотрим исходный код HTML и JavaScript страницы, отображаемой в вашем браузере. Мы рассмотрим не все элементы, а только основные разделы, чтобы вы получили представление о том, как функционирует страница:

1. Откройте **средства разработчика** в браузере и просмотрите элементы HTML, из которых состоит текущая страница, также известные как дерево HTML или DOM.

2. Разверните элементы `<head>` и `<body>` и обратите внимание на следующие разделы:

   - В разделе `<head>` вы найдете вспомогательные элементы, которые извлекают дополнительные файлы, обеспечивая функционирование страницы:
     - Элемент `<script>`, который используется для создания ссылки на библиотеку проверки подлинности Azure Active Directory **adal.min.js** (также называется ADAL). ADAL — это библиотека JavaScript, которая позволяет выполнить проверку подлинности OAuth 2.0 (для входа) и получить маркер для доступа к API.
     - Несколько элементов `<link>` для таблиц стилей (также называются CSS), включая **sampleStyles.css** и **tsiclient.css**. Они используются для управления визуальными деталями оформления страниц, такими как цвета, шрифты, интервалы и т. д.
     - Элемент `<script>`, используемый для создания ссылки на библиотеку JavaScript **tsiclient.js** клиента TSI. Эта библиотека используется страницей для вызова API-интерфейсов службы TSI и отображения элементов управления диаграммой на странице.

     >[!NOTE]
     > Исходный код библиотеки ADAL JavaScript можно найти в репозитории [azure-activedirectory-library-for-js](https://github.com/AzureAD/azure-activedirectory-library-for-js).
     > Исходный код библиотеки клиента JavaScript TSI доступен в репозитории [tsiclient](https://github.com/Microsoft/tsiclient).

   - В разделе `<body>` вы найдете элементы `<div>`, которые используются как контейнеры для определения макета элементов на странице, и еще один элемент `<script>`:
     - Первый элемент `<div>` указывает диалоговое окно **Вход** (`id="loginModal"`).
     - Второй элемент `<div>` выступает в качестве родительского для:
       - заголовка `<div>`, используемого для сообщений о состоянии и сведений о входе в верхней части страницы (`class="header"`);
       - элемента `<div>` для остальных элементов текста страницы, включая все диаграммы (`class="chartsWrapper"`);
       - раздела `<script>`, который содержит весь код JavaScript, используемый для управления страницей.

   [![Пример клиента TSI со средствами для разработчиков](media/tutorial-explore-js-client-lib/tcs-devtools-callouts-head-body.png)](media/tutorial-explore-js-client-lib/tcs-devtools-callouts-head-body.png#lightbox)

3. Разверните элемент `<div class="chartsWrapper">`, и вы найдете дополнительные дочерние элементы `<div>`. Они используются для размещения каждого примера элемента управления диаграммой. Обратите внимание, что существует несколько пар элементов `<div>`, по одному для каждого примера диаграммы:

   - Первый элемент (`class="rowOfCardsTitle"`) содержит описательное название содержимого, отображаемого на диаграмме. Например, "Статические графики с полноразмерными условными обозначениями".
   - Второй элемент (`class="rowOfCards"`) является родительским. Он содержит дополнительные дочерние элементы `<div>`, которые определяют позицию фактического элемента управления диаграммой в строке.

   ![Текст элементов div](media/tutorial-explore-js-client-lib/tcs-devtools-callouts-body-divs.png)

4. Теперь разверните элемент `<script type="text/javascript">` непосредственно под элементом `<div class="chartsWrapper">`. Вы увидите начало раздела JavaScript на уровне страницы. Он используется для обработки всей логики страницы, включая проверку подлинности, вызов API-интерфейсов TSI, рендеринг элементов управления диаграммой и многое другое:

   ![Текст скрипта](media/tutorial-explore-js-client-lib/tcs-devtools-callouts-body-script.png)

## <a name="tsi-javascript-client-library-concepts"></a>Основные понятия о клиентской библиотеке TSI JavaScript

Хотя мы не рассматриваем клиентскую библиотеку TSI **tsclient.js** подробно, важно упомянуть, что она обеспечивает абстракцию для двух важных категорий:

- **Методы программы-оболочки для вызова API-интерфейсов для запросов TSI**. REST API, которые позволяют запрашивать данные TSI с использованием статистических выражений и которые организованы в пространстве имен `TsiClient.Server` библиотеки.
- **Методы создания и заполнения нескольких типов элементов управления диаграммами**, которые используются для отображения агрегированных данных TSI на веб-странице и которые организованы в пространстве имен `TsiClient.UX` библиотеки.

Следующие концепции универсальны и применимы к API-интерфейсам клиентской библиотеки TSI в целом.

### <a name="authentication"></a>Authentication

Как упоминалось ранее, этот пример является одностраничным приложением, в котором используется поддержка OAuth 2.0 в ADAL для аутентификации пользователей. Вот некоторые важные моменты в этом разделе скрипта:

1. При использовании ADAL для аутентификации необходимо, чтобы клиентское приложение регистрировалось в реестре приложений Azure Active Directory (Azure AD). Это одностраничное приложение зарегистрировано для использования "неявного" потока предоставления авторизации OAuth 2.0. Соответственно, приложение определяет некоторые свойства регистрации во время выполнения, такие как идентификатор GUID клиента (`clientId`) и URI перенаправления (`postLogoutRedirectUri`), и передает их в поток.

2. Позже приложение запрашивает маркер доступа от Azure AD. Маркер доступа выдается для конечного набора разрешений идентификатору https://api.timeseries.azure.com определенной службы или API (также называется аудиторией маркера). Разрешения для маркеров выдаются от имени пользователя, выполнившего вход в систему. Идентификатором службы или API является еще одно свойство, которое содержится в данных регистрации Azure AD приложения. Когда ADAL возвращает маркер доступа приложению, он передается как маркер носителя при доступе к API-интерфейсам TSI.

   [!code-javascript[head-sample](~/samples-javascript/pages/tutorial/index.html?range=145-204&highlight=4-9,36-39)]

### <a name="control-identification"></a>Идентификация элементов управления

Как упоминалось ранее, элементы `<div>` в элементе `<body>` обеспечивают компоновку всех элементов управления диаграммой, представленных на странице. Каждый элемент `<div>` определяет свойства для размещения и визуальные атрибуты элемента управления диаграммой, включая свойство `id`. Свойство `id` предоставляет уникальный идентификатор, который используется в коде JavaScript для идентификации каждого элемента управления для рендеринга и обновления, а также для привязки к этим элементам.

### <a name="aggregate-expressions"></a>Статистические выражения

API-интерфейсы клиентской библиотеки TSI широко используют статистические выражения. Статистическое выражение предоставляет возможность создать один или несколько условий поиска. API применяют эти условия, так же как [TSI Explorer](https://insights.timeseries.azure.com/demo) использует диапазон поиска, предикат WHERE, меры и значение разбиения. Большинство API-интерфейсов библиотеки принимают массив статистических выражений, которые используются службой для создания запроса данных TSI.

### <a name="call-pattern"></a>Шаблон вызова

Заполнение и рендеринг элементов управления диаграммой выполняются по общему шаблону. Этот шаблон используется по всему коду JavaScript страницы. Он создает и загружает элементы управления примера приложения TSI:

1. Объявите `array` для хранения одного или нескольких статистических выражений TSI:

   ```javascript
   var aes =  [];
   ```

2. Создайте объекты статистических выражений с 1 по n и добавьте их в массив:

   ```javascript
   var ae = new tsiClient.ux.aggregateExpression(predicateObject, measureObject, measureTypes, searchSpan, splitByObject, color, alias, contextMenuActions);
   aes.push(ae);
   ```

   **Параметры aggregateExpression**

   | Параметр | ОПИСАНИЕ | Пример |
   | --------- | ----------- | ------- |
   | `predicateObject` | Выражение для фильтрации данных. |`{predicateString: "Factory = 'Factory3'"}` |
   | `measureObject`   | Имя свойства используемой меры. | `{property: 'Temperature', type: "Double"}` |
   | `measureTypes`    | Требуемые агрегаты свойства меры. | `['avg', 'min']` |
   | `searchSpan`      | Длительность и размер интервала статистического выражения. | `{from: startDate, to: endDate, bucketSize: '2m'}` |
   | `splitByObject`   | Свойство строки, по которому необходимо выполнить разбиение (необязательное; может принимать значение Null). | `{property: 'Station', type: 'String'}` |
   | `color`         | Цвет объектов, которые вы хотите отобразить. | `'pink'` |
   | `alias`           | Понятное имя для статистического выражения. | `'Factory3Temperature'` |
   | `contextMenuActions` | Массив действий, которые следует связать с объектами временных рядов в визуализации (необязательно). | См. дополнительные сведения о [всплывающих контекстных меню](#popup-context-menus) в разделе о дополнительных функциях. |

3. Вызовите запрос TSI, используя API-интерфейсы `TsiClient.Server`, чтобы запросить статистические данные:

   ```javascript
   tsiClient.server.getAggregates(token, envFQDN, aeTsxArray);
   ```

   **параметры getAggregates**

   | Параметр | ОПИСАНИЕ | Пример |
   | --------- | ----------- | ------- |
   | `token`     | Маркер доступа для API-интерфейса TSI |  `authContext.getTsiToken()` См. дополнительные сведения об [аутентификации](#authentication). |
   | `envFQDN`   | Полное доменное имя (FQDN) среды TSI. | На портале Azure, например `10000000-0000-0000-0000-100000000108.env.timeseries.azure.com`: |
   | `aeTsxArray` | Массив выражений запросов TSI. | Используйте переменную `aes`, как описано выше: `aes.map(function(ae){return ae.toTsx()}`. |

4. Преобразуйте сжатые выходные данные, возвращенные из запроса TSI, в JSON для визуализации.

   ```javascript
   var transformedResult = tsiClient.ux.transformAggregatesForVisualization(result, aes);
   ```

5. Создайте элемент управления диаграммой с помощью API-интерфейсов `TsiClient.UX` и привяжите его к одному из элементов `<div>` на странице.

   ```javascript
   var lineChart = new tsiClient.ux.BarChart(document.getElementById('chart3'));
   ```

6. Заполните элемент управления диаграммой преобразованными объектами данных JSON и отобразите его на странице.

   ```javascript
   lineChart.render(transformedResult, {grid: true, legend: 'compact', theme: 'light'}, aes);
   ```

## <a name="rendering-controls"></a>Элементы управления рендерингом

Клиентская библиотека TSI сейчас предлагает восемь уникальных элементов управления для аналитики: график, круговую диаграмму, линейчатую диаграмму, тепловую карту, элементы управления иерархией, доступную сетку, временные шкалы дискретных событий и временные шкалы перехода состояния.

### <a name="line-bar-pie-chart-examples"></a>Примеры графиков, линейчатых и круговых диаграмм

Давайте посмотрим на код некоторых стандартных элементов управления диаграммами, которые продемонстрированы в приложении, а также на модель и шаблоны программирования для их создания. В частности, просмотрите раздел HTML под комментарием `// Example 3/4/5`, который отображает элементы управления со значениями идентификаторов `chart3`, `chart4` и `chart5`.

Вспомните шаг 3 из раздела [Исходный код страницы и ее структура](#page-source-and-structure). Элементы управления диаграммой расположены в строках на странице, каждая из которых имеет описательную строку заголовка. В этом примере три заполняемые диаграммы находятся под элементом заголовка `<div>` "Несколько типов диаграмм из тех же данных". Они связаны с тремя расположенными под заголовком элементами `<div>`:

[!code-javascript[code-sample1-line-bar-pie](~/samples-javascript/pages/tutorial/index.html?range=59-73&highlight=1,5,9,13)]

В следующем разделе кода JavaScript используется описанный ранее шаблон для создания статистических выражений TSI, применения их для запроса данных TSI и отображения трех диаграмм. Обратите внимание на три типа, которые используются из пространства имен `tsiClient.ux` (`LineChart`, `BarChart` и `PieChart`) для создания и отображения соответствующих диаграмм. Также обратите внимание, что все три диаграммы могут использовать одни и те же данные статистических выражений `transformedResult`:

[!code-javascript[code-sample2-line-bar-pie](~/samples-javascript/pages/tutorial/index.html?range=241-262&highlight=13-14,16-17,19-20)]

При отображении три диаграммы выглядят следующим образом:

[![Несколько типов диаграмм одних и тех же данных](media/tutorial-explore-js-client-lib/tcs-multiple-chart-types-from-the-same-data.png)](media/tutorial-explore-js-client-lib/tcs-multiple-chart-types-from-the-same-data.png#lightbox)

## <a name="advanced-features"></a>Дополнительные функции

Клиентская библиотека TSI предоставляет некоторые необязательные дополнительные функции, которые вы можете использовать.

### <a name="states-and-events"></a>Состояния и события

Один из примеров расширенной функциональности — это возможность добавления переходов состояний и дискретных событий в диаграммы. Эта функция полезна для выделения инцидентов, оповещений и переключений состояний, таких как включение и выключение.

Здесь вы видите программный код раздела HTML под комментарием `// Example 10`. Код отображает элемент управления графика в заголовке "Графики с несколькими типами рядов" и привязывает его к `<div>` со значением идентификатора `chart10`:

1. Сначала определяется структура с именем `events4`, содержащая отслеживаемые элементы изменений состояния. Эта структура содержит:

   - Ключ строки с именем `Component States`.
   - Массив объектов-значений, которые представляют состояния. Каждый объект включает:
     - ключ строки, содержащий метку времени JavaScript ISO;
     - массив, содержащий характеристики состояния: цвет и описание.

2. Затем определяется структура `events5` для инцидентов, которая содержит массив элементов событий, подлежащих отслеживанию. Структура массива имеет ту же форму, что и структура, описанная для `events4`.

3. Наконец, отображается график и передаются две структуры с параметрами настроек диаграммы: `events:` и `states:`. Обратите внимание на другие параметры настроек для указания `tooltip:`, `theme:` или `grid:`.

[!code-javascript[code-sample-states-events](~/samples-javascript/pages/tutorial/index.html?range=337-389&highlight=5,26,51)]

Визуально маркеры в форме ромбов и всплывающие окна, которые используются для обозначения инцидентов, а также цветные полосы и всплывающие окна на шкале времени отображают изменения состояния:

[![Графики с несколькими типами рядов](media/tutorial-explore-js-client-lib/tcs-line-charts-with-multiple-series-types.png)](media/tutorial-explore-js-client-lib/tcs-line-charts-with-multiple-series-types.png#lightbox)

### <a name="pop-up-context-menus"></a>Всплывающие контекстные меню

Еще один пример расширенной функциональности — настраиваемые контекстные меню, вызываемые щелчком правой кнопкой мыши. Настраиваемые контекстные меню можно использовать для включения действий и дальнейших логических шагов в пределах приложения.

Здесь вы видите программный код раздела HTML под комментарием `// Example 13/14/15`. Этот код изначально отображает график с заголовком "Графики с контекстным меню для создания круговой или линейчатой диаграммы", который привязан к элементу `<div>` ​​с идентификатором `chart13`. График позволяет с помощью контекстных меню динамически создавать круговые и линейчатые диаграммы, которые привязаны к элементам `<div>` с идентификаторами `chart14` и `chart15`. Кроме того, круговые и линейчатые диаграммы также используют контекстные меню для возможности копировать данные из круговой диаграммы в линейчатую и выводить данные линейчатой диаграммы в окно консоли браузера соответственно.

1. Сначала определяется ряд пользовательских действий. Каждое действие содержит массив с одним или несколькими элементами. Каждый элемент определяет один элемент контекстного меню:

   - `barChartActions`: это действие определяет контекстное меню для круговой диаграммы, которое содержит один элемент для определения одного пункта:
     - `name`: текст, используемый для пункта меню "Вывод параметров на консоль".
     - `action`: действие, которое связано с пунктом меню. Это действие всегда является анонимной функцией, которая принимает три аргумента на основе статистического выражения, используемого для создания диаграммы. В этом случае аргументы записываются в окно консоли браузера:
       - `ae`: массив статистических выражений.
       - `splitBy`: значение, используемое для разделения.
       - `timestamp`: метка времени.

   - `pieChartActions`: это действие определяет контекстное меню для линейчатой диаграммы, которое содержит один элемент для определения одного пункта. Форма и схема аналогичны предыдущему элементу `barChartActions`, но обратите внимание, что функция `action` сильно отличается, так как она создает и отображает линейчатую диаграмму. Также обратите внимание, что используется аргумент `ae`, чтобы указать массив статистических выражений, переданный во время выполнения при открытии пункта меню. Функция также устанавливает свойство `ae.contextMenu` для контекстного меню `barChartActions`.
   - `contextMenuActions`: это действие определяет контекстное меню для графика, которое содержит три элемента для определения трех пунктов меню. Форма и схема для каждого элемента аналогичны описанным выше. Как и `barChartActions`, первый элемент записывает три аргумента функции в окно консоли браузера. Как и в случае с элементом `pieChartActions`, два следующих элемента создают экземпляр и отображают круговую и линейчатую диаграммы соответственно. Два следующих элемента также устанавливают свойства `ae.contextMenu` для контекстных меню `pieChartActions` и `barChartActions` соответственно.

2. Затем два статистических выражения помещаются в массив `aes` с указанием массива `contextMenuActions` для каждого их них. Эти выражения используются с элементом управления графика.

3. Наконец, сначала выводится только график, из которого во время выполнения можно отрисовать круговую и линейчатую диаграммы.

[!code-javascript[code-sample-context-menus](~/samples-javascript/pages/tutorial/index.html?range=461-540&highlight=7,16,29,61-64,78)]

На снимке экрана показаны графики с соответствующими всплывающими контекстными меню. Круговая и линейчатая диаграммы созданы динамически с использованием параметров контекстного меню графика.

[![График с контекстным меню для создания круговой или линейчатой диаграммы](media/tutorial-explore-js-client-lib/tcs-line-chart-with-context-menu-to-create-pie-bar-chart.png)](media/tutorial-explore-js-client-lib/tcs-line-chart-with-context-menu-to-create-pie-bar-chart.png#lightbox)

### <a name="brushes"></a>Кисти

С помощью кистей можно указать диапазон времени для применения таких действий, как масштабирование и рассмотрение.

Код, используемый для отображения кистей, показан в предыдущем примере "График с контекстным меню для создания круговой или линейчатой диаграммы", описанном в разделе [Всплывающие контекстные меню](#popup-context-menus-section).

1. Действия кистей очень похожи на контекстное меню, которое определяет ряд пользовательских действий для кисти. Каждое действие содержит массив с одним или несколькими элементами. Каждый элемент определяет один элемент контекстного меню:
   - `name`: текст, используемый для пункта меню "Вывод параметров на консоль".
   - `action`: действие, связанное с пунктом меню, которое всегда является анонимной функцией, принимающей два аргумента. В этом случае аргументы записываются в окно консоли браузера:
      - `fromTime`: метка времени "от" для выбора кисти.
      - `toTime`: метка времени "до" для выбора кисти.

2. Действия кисти добавляются как еще одно свойство параметра диаграммы. Обратите внимание, что свойство `brushContextMenuActions: brushActions` передается в вызов `linechart.Render`.

[!code-javascript[code-sample-brushes](~/samples-javascript/pages/tutorial/index.html?range=526-540&highlight=1,13)]

![График с контекстным меню для создания круговой или линейчатой диаграммы с использованием кистей](media/tutorial-explore-js-client-lib/tcs-line-chart-with-context-menu-to-create-pie-bar-chart-brushes.png)

## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали, как выполнить следующие задачи:

> [!div class="checklist"]
> * Войти в систему и изучить пример приложения TSI и его исходный код.
> * Использовать API-интерфейсы в клиентской библиотеке TSI JavaScript.
> * Использовать JavaScript для создания элементов управления диаграммами и заполнения их данными TSI.

Как описано выше, пример приложения TSI использует демонстрационный набор данных. Дополнительные сведения о том, как создать собственную среду и набор данных TSI, см. в следующей статье:

> [!div class="nextstepaction"]
> [Руководство. Создание среды службы "Аналитика временных рядов Azure"](tutorial-create-populate-tsi-environment.md)


