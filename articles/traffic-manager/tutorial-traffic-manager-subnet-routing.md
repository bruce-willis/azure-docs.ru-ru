---
title: Настройка метода маршрутизации трафика подсети с помощью диспетчера трафика Azure | Документация Майкрософт
description: В этой статье объясняется, как настроить диспетчер трафика для маршрутизации трафика из пользовательской подсети к определенным конечным точкам.
services: traffic-manager
documentationcenter: ''
author: KumudD
manager: jpconnock
ms.service: traffic-manager
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/24/2018
ms.author: kumud
ms.openlocfilehash: 20c34b820eb326a18be1c4298b0850a58599be64
ms.sourcegitcommit: 32d218f5bd74f1cd106f4248115985df631d0a8c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2018
ms.locfileid: "46956240"
---
# <a name="direct-traffic-to-specific-endpoints-based-on-user-subnet-using-traffic-manager"></a>Перенаправление трафика к определенным конечным точкам на основе пользовательской подсети с помощью диспетчера трафика

В этой статье описывается настройка метода маршрутизации трафика подсети. Метод маршрутизации трафика **подсети** позволяет сопоставлять набор диапазонов IP-адресов с конкретными конечными точками, и когда диспетчер трафика получает запрос, он проверяет исходный IP-адрес запроса и возвращает связанную с ним конечную точку. 

В этом руководстве при использовании маршрутизации подсети трафик перенаправляется либо на внутренний веб-сайт, либо на рабочий, в зависимости от IP-адреса запроса пользователя.


Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Создание двух виртуальных машин для работы базового веб-сайта в IIS.
> * Создание двух тестовых виртуальных машин, чтобы увидеть работу диспетчера трафика в действии.
> * Настройка имени DNS для виртуальных машин, работающих под управлением IIS.
> * Создание профиля диспетчера трафика для маршрутизации трафика на основе подсети пользователя.
> * Добавление конечных точек виртуальной машины в профиль диспетчера трафика.
> * Просмотр диспетчера трафика в действии


Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="prerequisites"></a>Предварительные требования
Чтобы увидеть диспетчер трафика в действии, для этого руководства требуется развернуть следующее:
- Два базовых веб-сайта, работающих в разных регионах Azure — **восточной части США** (служит внутренним веб-сайтом) и **Западной Европы** (служит рабочим веб-сайтом).
- Две тестовые виртуальные машины для тестирования диспетчера трафика — одну виртуальную машину в **восточной части США** и вторую в **Западной Европе**. 

Тестовые виртуальные машины используются для иллюстрации того, как диспетчер трафика направляет трафик пользователя на внутренний или рабочий веб-сайт на основе подсети, из которой возникает запрос пользователя.

### <a name="sign-in-to-azure"></a>Вход в Azure 

Войдите на портал Azure по адресу https://portal.azure.com.

### <a name="create-websites"></a>Создание веб-сайтов

В этом разделе вы создадите два экземпляра веб-сайта, которые предоставляют две конечные точки службы для профиля диспетчера трафика в двух регионах Azure. Создание двух веб-сайтов состоит из следующих этапов:
1. Создайте две виртуальные машины для работающего базового веб-сайта: одну в **восточной части США**, а другую — в **Западной Европе**.
2. Установите сервер IIS на каждой виртуальной машине и обновите страницу по умолчанию веб-сайта, отображающую имя виртуальной машины, к которой пользователь подключается при посещении веб-сайта.

#### <a name="create-vms-for-running-websites"></a>Создание виртуальных машин для работающих веб-сайтов
В этом разделе вы создадите две виртуальные машины *InternalWebsite* и *ProdWebsite* в таких регионах Azure: **восточная часть США** и **Западная Европа**.

1. В верхнем левом углу окна портала Azure выберите **Создать ресурс** > **Вычисления** > **виртуальная машина Windows Server 2016**.
2. Введите или выберите следующие значения в разделе **Основные сведения**, примите значения по умолчанию для остальных параметров и нажмите кнопку **Создать**.

    |Параметр|Значение|
    |---|---|
    |ИМЯ|InternalWebsite|
    |Имя пользователя| Введите выбранное имя пользователя.|
    |Пароль| Введите выбранный пароль. Пароль должен включать минимум 12 символов и соответствовать [определенным требованиям к сложности](../virtual-machines/windows/faq.md?toc=%2fazure%2fvirtual-network%2ftoc.json#what-are-the-password-requirements-when-creating-a-vm).|
    |Группа ресурсов| Выберите **Создать**, а затем введите *myResourceGroupTM1*.|
    |Расположение| Выберите **Восточная часть США**.|
    |||
4. Выберите размер виртуальной машины в области **Выбор размера**.
5. В разделе **Параметры** выберите следующие значения и нажмите кнопку **ОК**.
    
    |Параметр|Значение|
    |---|---|
    |Виртуальная сеть| Выберите **Виртуальная сеть** в области **Создание виртуальной сети**, в качестве **имени** введите *myVNet1*, а для подсети — *mySubnet*.|
    |Группа безопасности сети|Выберите **Базовые**, а затем в раскрывающемся списке **Выберите общедоступные входящие порты** выберите **HTTP** и **RDP**. |
    |Диагностика загрузки|Выберите **Отключено**.|
    |||
6. В разделе **создания** на странице **Сводка** выберите **Создать**, чтобы начать развертывание виртуальной машины.

7. Повторите шаги 1–6 со следующими изменениями.

    |Параметр|Значение|
    |---|---|
    |Группа ресурсов | Выберите **Создать**, а затем введите *myResourceGroupTM2*.|
    |Расположение|Западная Европа|
    |Имя виртуальной машины | ProdWebsite|
    |Виртуальная сеть | Выберите **Виртуальная сеть** в области **Создание виртуальной сети**, в качестве **имени** введите *myVNet2*, а для подсети — *mySubnet*.|
    |||
8. Создание виртуальных машин может занять несколько минут. Прежде чем выполнять оставшиеся шаги, обязательно дождитесь создания обеих виртуальных машин.

#### <a name="install-iis-and-customize-the-default-web-page"></a>Установка IIS и настройка веб-страницы по умолчанию

В этом разделе вы установите сервер IIS на две виртуальные машины — *myIISVMEastUS*  &  и *myIISVMWEurope*, а затем обновите страницу веб-сайта по умолчанию. На настроенной странице веб-сайта отображается имя виртуальной машины, к которой вы подключаетесь при посещении веб-сайта в веб-браузере.

1. В меню слева щелкните **Все ресурсы**, а затем в списке ресурсов выберите виртуальную машину *myIISVMEastUS*, расположенную в группе ресурсов *myResourceGroupTM1*.
2. На странице **Обзор** щелкните **Подключить**, а затем в разделе **подключения к виртуальной машине** выберите **Скачать RDP-файл**. 
3. Откройте этот RDP-файл. При появлении запроса выберите **Подключиться**. Введите имя пользователя и пароль, указанные при создании виртуальной машины. Возможно, потребуется выбрать **More choices** (Дополнительные варианты), а затем **Use a different account** (Использовать другую учетную запись), чтобы указать учетные данные, введенные при создании виртуальной машины. 
4. Нажмите кнопку **ОК**.
5. При входе в систему может появиться предупреждение о сертификате. Если вы получили предупреждение, выберите **Да** или **Продолжить**.
6. На рабочем столе сервера перейдите к **Средства администрирования Windows**>**Диспетчер сервера**.
7. Запустите Windows PowerShell на виртуальной машине *InternalWebsite* и выполните приведенные ниже команды, чтобы установить сервер IIS и обновить стандартный HTM-файл.
    ```powershell-interactive
    # Install IIS
      Install-WindowsFeature -name Web-Server -IncludeManagementTools
    
    # Remove default htm file
     remove-item  C:\inetpub\wwwroot\iisstart.htm
    
    #Add custom htm file
     Add-Content -Path "C:\inetpub\wwwroot\iisstart.htm" -Value $("Hello World from my " + $env:computername)
    ```
8. Закройте RDP-подключение к виртуальной машине *InternalWebsite*.
9. Повторите шаги 1–6 путем создания RDP-подключения к виртуальной машине *ProdWebsite* в группе ресурсов *myResourceGroupTM2*, чтобы установить IIS и настроить веб-страницу по умолчанию.
10. Запустите Windows PowerShell на виртуальной машине *ProdWebsite* и выполните приведенные ниже команды, чтобы установить сервер IIS и обновить стандартный HTM-файл.
    ```powershell-interactive
    # Install IIS
      Install-WindowsFeature -name Web-Server -IncludeManagementTools
    
    # Remove default htm file
     remove-item  C:\inetpub\wwwroot\iisstart.htm
    
    #Add custom htm file
     Add-Content -Path "C:\inetpub\wwwroot\iisstart.htm" -Value $("Hello World from my " + $env:computername)
    ```

#### <a name="configure-dns-names-for-the-vms-running-iis"></a>Настройка имен DNS для виртуальных машин, работающих под управлением IIS

Диспетчер трафика направляет трафик пользователя на основе имени DNS конечных точек службы. В этом разделе вы настроите DNS-имена для серверов IIS *InternalWebsite* и *ProdWebsite*.

1. В меню слева щелкните **Все ресурсы**, а затем в списке ресурсов выберите виртуальную машину *InternalWebsite*, расположенную в группе ресурсов *myResourceGroupTM1*.
2. На странице **Обзор** в разделе **DNS-имя** выберите **Настроить**.
3. На странице **Конфигурация** в разделе метки DNS-имени добавьте уникальное имя, а затем выберите **Сохранить**.
4. Повторите шаги 1–3 для виртуальной машины с именем *ProdWebsite*, расположенной в группе ресурсов *myResourceGroupTM2*.

### <a name="create-test-vms"></a>Создание тестовых виртуальных машин

В этом разделе вы создадите виртуальную машину (*UserVMUS* и *UserVMEurope*) в каждом регионе Azure (**восточная часть США** и **Западная Европа**). Эти виртуальные машины будут использоваться для тестирования того, как диспетчер трафика направляет трафик к ближайшему серверу IIS при переходе к веб-сайту.

1. В верхнем левом углу окна портала Azure выберите **Создать ресурс** > **Вычисления** > **Windows Server 2016 Datacenter**.
2. Введите или выберите следующие значения в разделе **Основные сведения**, примите значения по умолчанию для остальных параметров и нажмите кнопку **Создать**.

    |Параметр|Значение|
    |---|---|
    |ИМЯ|*UserVMUS*|
    |Имя пользователя| Введите выбранное имя пользователя.|
    |Пароль| Введите выбранный пароль. Пароль должен включать минимум 12 символов и соответствовать [определенным требованиям к сложности](../virtual-machines/windows/faq.md?toc=%2fazure%2fvirtual-network%2ftoc.json#what-are-the-password-requirements-when-creating-a-vm).|
    |Группа ресурсов| Щелкните **Existing** (Существующая), а затем выберите *myResourceGroupTM1*.|
    |||

4. Выберите размер виртуальной машины в области **Выбор размера**.
5. В разделе **Параметры** выберите следующие значения и нажмите кнопку **ОК**.
    |Параметр|Значение|
    |---|---|
    |Виртуальная сеть| Выберите **Виртуальная сеть** в области **Создание виртуальной сети**, в качестве **имени** введите *myVNet3*, а для подсети — *mySubnet3*.|
    |Группа безопасности сети|Выберите **Базовые**, а затем в раскрывающемся списке **Выберите общедоступные входящие порты** выберите **HTTP** и **RDP**. |
    |Диагностика загрузки|Выберите **Отключено**.|
    |||

6. В разделе **создания** на странице **Сводка** выберите **Создать**, чтобы начать развертывание виртуальной машины.

7. Повторите шаги 1–5 со следующими изменениями.

    |Параметр|Значение|
    |---|---|
    |Имя виртуальной машины | *UserVMEurope*|
    |Группа ресурсов | Щелкните **Existing** (Существующая), а затем выберите *myResourceGroupTM2*.|
    |Виртуальная сеть | Выберите **Виртуальная сеть** в области **Создание виртуальной сети**, в качестве **имени** введите *myVNet4*, для подсети — *mySubnet4*.|
    |||

8. Создание виртуальных машин может занять несколько минут. Прежде чем выполнять оставшиеся шаги, обязательно дождитесь создания обеих виртуальных машин.

## <a name="create-a-traffic-manager-profile"></a>Создание профиля диспетчера трафика
Создайте профиль диспетчера трафика, который позволит вернуть определенные конечные точки на основе исходного IP-адреса запроса.

1. В верхней левой части экрана выберите **Создать ресурс** > **Сети** > **Профиль диспетчера трафика** > **Создать**.
2. В разделе **Создание профиля диспетчера трафика** введите или выберите следующие сведения, примите значения по умолчанию для остальных параметров и нажмите кнопку **Создать**:
    | Параметр                 | Значение                                              |
    | ---                     | ---                                                |
    | ИМЯ                   | Оно должно быть уникальным в пределах зоны trafficmanager.net. В результате будет создано DNS-имя trafficmanager.net, которое будет использоваться для доступа к профилю диспетчера трафика.                                   |
    | Метод маршрутизации          | Выберите метод маршрутизации **Подсеть**.                                       |
    | Подписка            | Выберите свою подписку.                          |
    | Группа ресурсов          | Выберите **Существующий** и введите *myResourceGroupTM1*. |
    | |                              |
    |
  
    ![Создание профиля диспетчера трафика](./media/tutorial-traffic-manager-subnet-routing/create-traffic-manager-profile.png)

## <a name="add-traffic-manager-endpoints"></a>Добавление конечных точек диспетчера трафика

Добавьте две виртуальные машины, на которых запущены серверы IIS (*InternalWebsite*  &  и *ProdWebsite*), для маршрутизации трафика на основе подсети, из которой поступил запрос пользователя.

1. На панели поиска портала выполните поиск имени профиля диспетчера трафика, созданного в предыдущем разделе, и выберите профиль в отображаемых результатах.
2. В колонке **Профиль диспетчера трафика** в разделе **Параметры** щелкните **Конечные точки**, а затем выберите **Добавить**.
3. Введите или выберите следующие значения, примите значения по умолчанию для остальных параметров и нажмите кнопку **ОК**:

    | Параметр                 | Значение                                              |
    | ---                     | ---                                                |
    | type                    | Конечная точка Azure                                   |
    | ИМЯ           | myInternalWebSiteEndpoint                                        |
    | Тип целевого ресурса           | Общедоступный IP-адрес                          |
    | Целевой ресурс          | **Выберите общедоступный IP-адрес**, чтобы показать список ресурсов с общедоступными IP-адресами в этой же подписке. В разделе **Ресурс** выберите общедоступный IP-адрес с именем *InternalWebsite-ip*. Это общедоступный IP-адрес виртуальной машины сервера IIS в восточной части США.|
    |  Параметры маршрутизации подсети    |   Добавьте IP-адрес тестовой виртуальной машины *UserVMUS*. Любой пользовательский запрос, исходящий из этой виртуальной машины, будет перенаправлен в конечную точку *InternalWebSiteEndpoint*.    |

4. Повторите шаги 2 и 3, чтобы добавить другую конечную точку с именем *ProdWebsiteEndpoint* для общедоступного IP-адреса *ProdWebsite-ip*, связанного с виртуальной машиной *ProdWebsite* сервера IIS. Для **параметров маршрутизации подсети** добавьте IP-адрес тестовой виртуальной машины *UserVMEurope*. Любой пользовательский запрос из этой тестовой виртуальной машины будет перенаправлен в конечную точку *myProdWebsiteEndpoint*.
5.  После добавления обе конечные точки отобразятся в колонке **Профиль диспетчера трафика** с состоянием **В сети**.

 
## <a name="test-traffic-manager-profile"></a>Тестирование профиля диспетчера трафика
В этом разделе вы проверите, как диспетчер трафика направляет трафик пользователя из данной подсети в определенную конечную точку. Чтобы увидеть диспетчер трафика в действии, выполните следующие действия:
1. Определите DNS-имя профиля диспетчера трафика.
2. Просмотрите диспетчер трафика в действии следующим образом:
    - В веб-браузере из тестовой виртуальной машины (*UserVMUS*), расположенной в регионе **восточная часть США**, перейдите к DNS-имени вашего профиля диспетчера трафика.
    - В веб-браузере из тестовой виртуальной машины (*UserVMEurope*), расположенной в регионе **Западная Европа**, перейдите к DNS-имени вашего профиля диспетчера трафика.

### <a name="determine-dns-name-of-traffic-manager-profile"></a>Определение DNS-имени профиля диспетчера трафика
В этом руководстве для простоты используется DNS-имя профиля диспетчера трафика для посещения веб-сайтов. 

Вы можете определить DNS-имя профиля диспетчера трафика следующим образом:

1.  На панели поиска портала выполните поиск имени **профиля диспетчера трафика**, созданного в предыдущем разделе. В отображенных результатах щелкните профиль диспетчера трафика.
1. Нажмите **Обзор**.
2. В **профиле диспетчера трафика** отображается DNS-имя только что созданного профиля диспетчера трафика. В рабочей среде, используя запись DNS CNAME, настройте имя личного домена, которое указывает на имя домена диспетчера трафика.

### <a name="view-traffic-manager-in-action"></a>Просмотр диспетчера трафика в действии
В этом разделе вы увидите диспетчер трафика в действии. 

1. В меню слева выберите **Все ресурсы**, а затем в списке ресурсов щелкните виртуальную машину *myUserVMUS*, расположенную в группе ресурсов *myResourceGroupTM1*.
2. На странице **Обзор** щелкните **Подключить**, а затем в разделе **подключения к виртуальной машине** выберите **Скачать RDP-файл**. 
3. Откройте этот RDP-файл. При появлении запроса выберите **Подключиться**. Введите имя пользователя и пароль, указанные при создании виртуальной машины. Возможно, потребуется выбрать **More choices** (Дополнительные варианты), а затем **Use a different account** (Использовать другую учетную запись), чтобы указать учетные данные, введенные при создании виртуальной машины. 
4. Нажмите кнопку **ОК**.
5. При входе в систему может появиться предупреждение о сертификате. Если вы получили предупреждение, выберите **Да** или **Продолжить**. 
1. В веб-браузере на виртуальной машине *UserVMUS* введите DNS-имя вашего профиля диспетчера трафика, чтобы просмотреть веб-сайт. Так как IP-адрес виртуальной машины *UserVMUS* связан с конечной точкой *myProductionWebsiteEndpoint*, веб-браузер запускает сервер тестового веб-сайта — *InternalWebsite*.

2. Затем подключитесь к виртуальной машине *UserVMEurope*, расположенной в **Западной Европе**, выполнив шаги 1–5, и найдите имя домена профиля диспетчера трафика на этой виртуальной машине. IP-адрес виртуальной машины *UserVMEurope* связан с конечной точкой *myProductionWebsiteEndpoint*, поэтому веб-браузер запускает сервер тестового веб-сайта — *ProdWebsite*. 
  
## <a name="delete-the-traffic-manager-profile"></a>Удаление профиля диспетчера трафика
Если больше не нужны, удалите группы ресурсов (**ResourceGroupTM1** и **ResourceGroupTM2**). Чтобы это сделать, выберите группу ресурсов (**ResourceGroupTM1** или **ResourceGroupTM2**), а затем щелкните **Удалить**.

## <a name="next-steps"></a>Дополнительная информация

- Узнайте о [методе взвешенной маршрутизации трафика](traffic-manager-configure-weighted-routing-method.md).
- Узнайте о [методе маршрутизации по приоритету](traffic-manager-configure-priority-routing-method.md).
- Узнайте о [методе географической маршрутизации](traffic-manager-configure-geographic-routing-method.md).


