---
title: Аудит в хранилище данных SQL Azure | Документация Майкрософт
description: Сведения об аудите и настройке аудита в хранилище данных SQL Azure.
services: sql-data-warehouse
author: kavithaj
manager: craigg-msft
ms.service: sql-data-warehouse
ms.topic: conceptual
ms.component: manage
ms.date: 04/11/2018
ms.author: kavithaj
ms.reviewer: igorstan
ms.openlocfilehash: 3630d4d694452f2c619e707d1e2e58f1bfe71c0e
ms.sourcegitcommit: 0b4da003fc0063c6232f795d6b67fa8101695b61
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/05/2018
ms.locfileid: "37858958"
---
# <a name="auditing-in-azure-sql-data-warehouse"></a>Аудит в хранилище данных SQL Azure

Сведения об аудите и настройке аудита в хранилище данных SQL Azure.

## <a name="what-is-auditing"></a>Что такое аудит?
Аудит хранилища данных SQL позволяет фиксировать события, происходящие в базе данных, в журнале аудита в вашей учетной записи хранения Azure. Аудит может помочь вам соблюсти стандарты, проанализировать работу с базой данных и получить представление о расхождениях и аномалиях, которые могут указывать на бизнес-проблемы или предполагаемые нарушения безопасности.

Средства аудита позволяют и способствуют соблюдению стандартов, но не гарантируют соответствия им. Дополнительную информацию о программах Azure, поддерживающих проверку соблюдения стандартов, см. в [Центре управления безопасностью Azure](https://azure.microsoft.com/support/trust-center/compliance/).

## <a id="subheading-1"></a>Основы аудита
Аудит базы данных хранилища данных SQL позволяет:

* **Сохранить** журнал аудита выбранных событий. Вы можете указать, какие категории действий базы данных должны проходить аудит.
* **Создавать отчеты** по действиям, производимым с базой данных. Вы можете использовать предварительно настроенные отчеты и панель мониторинга для быстрого начала работы с отчетностью по действиям и событиям.
* **Анализировать** отчеты. Вы можете искать подозрительные события, необычную деятельность и тенденции.

Журналы аудита хранятся в учетной записи хранения Azure. Срок хранения журнала аудита можно установить.


## <a id="subheading-4"></a>Определение политики аудита уровня сервера и базы данных

Политику аудита можно определить для конкретной базы данных или как политику сервера по умолчанию.

* Политика сервера **применяется ко всем существующим и новым базам данных на сервере**.

* Если *включен аудит больших двоичных объектов для сервера*, он *обязательно применяется к базе данных*. Аудит базы данных будет выполнен независимо от его параметров.

* Включение аудита для базы данных (помимо его включения для сервера) *не* приводит к переопределению или изменению настроек аудита больших двоичных объектов для сервера. Оба аудита будут выполняться параллельно. Таким образом, аудит базы данных выполняется дважды: один раз в соответствии с политикой сервера и еще раз в соответствии с политикой базы данных.

> [!NOTE]
> Мы рекомендуем включать **аудит больших двоичных объектов только на уровне сервера**, а на уровне баз данных отключить все параметры аудита для всех баз данных.
> Не включайте аудит одновременно для сервера и базы данных, за исключением следующих случаев.
> * Если для определенной базы данных нужно использовать другую *учетную запись хранения* или другой *срок хранения*.
> * Нужно провести аудит типов событий или категорий для конкретной базы данных, которая отличается от остальных баз данных на сервере. Например, может потребоваться выполнить аудит вставки данных в таблицу только для конкретной базы данных.
> * Вам нужно использовать обнаружение угроз, которое сейчас поддерживается только при аудите на уровне базы данных.

> [!IMPORTANT]
>Если включить аудит в Хранилище данных SQL Azure или на сервере, где размещено Хранилище данных SQL Azure, **его работа возобновляется**, даже если ранее она была приостановлена. **После включения аудита обязательно повторно приостановите работу Хранилища данных SQL Azure.**

## <a id="subheading-5"></a>Настройка аудита на уровне сервера для всех баз данных

Политика аудита сервера применяется ко **всем существующим и новым базам данных** на сервере.

В следующем разделе описывается настройка аудита на портале Azure.

1. Перейдите на [портал Azure](https://portal.azure.com).
2. Перейдите к серверу **SQL Server**, для которого нужно выполнить аудит (важно: убедитесь, что вы просматриваете SQL Server, а не конкретную базу данных или хранилище данных). В меню **Безопасность** выберите пункт **Аудит и обнаружение угроз**.

    ![Область навигации][6]
4. В колонке *Аудит и обнаружение угроз* в разделе **Аудит** щелкните **Вкл.** Эта политика аудита применяется ко всем существующим и новым базам данных на этом сервере.

    ![Область навигации][7]
5. Выберите **Сведения о хранилище**, чтобы открыть колонку **Хранилище журналов аудита**. Выберите учетную запись хранения Azure, в которой будут сохраняться журналы, или создайте новую. Затем выберите срок хранения, по истечении которого старые журналы будут удаляться. Нажмите кнопку **ОК**.

    ![Область навигации][8]

    > [!IMPORTANT]
    > Журналы аудита на уровне сервера записываются в **добавочные большие двоичные объекты** в хранилище BLOB-объектов Azure в подписке Azure.
    >
    > * Поддержка добавочных больших двоичных объектов в **хранилище класса Premium** сейчас **не предоставляется**.
    > * **Хранилище в виртуальной сети** в настоящее время **не поддерживается**.

8. Выберите команду **Сохранить**.



## <a id="subheading-2"></a>Настройка аудита на уровне базы данных для отдельной базы данных

Политику аудита можно определить для конкретной базы данных или как политику сервера по умолчанию.

Настоятельно рекомендуется использовать политику аудита на уровне сервера, а не на уровне базы данных, как описано в разделе, посвященном [определению политики аудита на уровне сервера и на уровне базы данных](#subheading-4).

Если вы пользуетесь [клиентом прежних версий](sql-data-warehouse-auditing-downlevel-clients.md), перед настройкой аудита проверьте контроль аудирования.


1. Запустите [портал Azure](https://portal.azure.com).
2. Перейдите в колонку **Параметры** хранилища данных SQL, для которого нужно выполнить аудит. Выберите **Аудит SQL и обнаружение угроз**.

    ![][1]
3. Затем включите аудит, нажав кнопку **ВКЛ** .

    ![][3]
4. На панели конфигурации аудита выберите **Сведения о хранилище**, чтобы открыть панель "Хранилище журналов аудита". Выберите учетную запись хранения Azure для журналов и укажите срок хранения.
    >[!TIP]
    >Чтобы воспользоваться всеми возможностями шаблонов предварительно настроенных отчетов, используйте одну и ту же учетную запись хранения для всех баз данных.

    ![][4]

5. Нажмите кнопку **ОК** , чтобы сохранить сведения о конфигурации хранилища.
6. В разделе **ВЕДЕНИЕ ЖУРНАЛА ПО СОБЫТИЯМ** щелкните **УСПЕШНО** и **СБОЙ**, чтобы включить в журнал все события, или выберите отдельные категории событий.
7. При настройке аудита для базы данных может потребоваться изменить строку подключения вашего клиента, чтобы убедиться в правильном сборе данных аудита. Ознакомьтесь с разделом [Изменение FDQN сервера в строке подключения](sql-data-warehouse-auditing-downlevel-clients.md) , чтобы узнать больше о подключениях клиентов нижнего уровня.
8. Последовательно выберите **ОК**.

## <a id="subheading-3"></a>Анализ журналов и отчетов аудита

###<a name="server-level-policy-audit-logs"></a>Журналы аудита на уровне сервера
Журналы аудита на уровне сервера записываются в **добавочные большие двоичные объекты** в хранилище BLOB-объектов Azure в подписке Azure. Они сохраняются в виде коллекции файлов больших двоичных объектов в контейнере **sqldbauditlogs**.

Дополнительные сведения об иерархии папки для хранения, соглашении об именовании и формате журнала см. в [документации по формату журнала аудита больших двоичных объектов](https://go.microsoft.com/fwlink/?linkid=829599).

Просмотреть журналы аудита больших двоичных объектов можно несколькими способами:

* Используйте **объединение файлов аудита** в SQL Server Management Studio (начиная с SSMS 17):
    1. В меню SSMS выберите **Файл** > **Открыть** > **Объединение файлов аудита**.

    2. Откроется диалоговое окно **Добавление файлов аудита**. Выберите один из способов **добавления**. Вы можете использовать объединение файлов аудита из локального диска или импортировать их из службы хранилища Azure. Необходимо предоставить сведения о службе хранилища Azure и ключ учетной записи.

    3. После добавления всех файлов для слияния нажмите кнопку **OK** для завершения операции слияния.

    4. Объединенный файл откроется в SSMS, где вы сможете его просмотреть и проанализировать, а также экспортировать в XEL- или CSV-файл или в таблицу.

* Используйте созданное [приложение синхронизации](https://github.com/Microsoft/Azure-SQL-DB-auditing-OMS-integration). Оно работает в Azure и использует общедоступные API-интерфейсы службы Log Analytics для передачи журналов аудита SQL в Log Analytics. Приложение синхронизации отправляет журналы аудита SQL в Log Analytics для использования через панель мониторинга Log Analytics.

* Используйте Power BI. Вы можете просматривать и анализировать данные журнала аудита в Power BI. Вы можете узнать больше о [Power BI, а также скачать шаблон](https://blogs.msdn.microsoft.com/azuresqldbsupport/2017/05/26/sql-azure-blob-auditing-basic-power-bi-dashboard/).

* Скачайте файлы журналов из контейнера больших двоичных объектов хранилища Azure из портала или с помощью [обозревателя хранилища Azure](http://storageexplorer.com/).
    * После загрузки файла дважды щелкните по нему, чтобы открыть, просмотреть и проанализировать файл в среде SSMS.
    * Вы также можете загрузить одновременно несколько файлов через обозреватель хранилища Azure. Щелкните правой кнопкой мыши конкретную вложенную папку и выберите **Сохранить как**, чтобы сохранить ее в локальной папке.

* Дополнительные методы
   * После загрузки нескольких файлов или вложенной папки, содержащей файлы журнала, можно объединить их локально, как описано выше в инструкциях по объединению файлов аудита в SSMS.

   * Чтобы просмотреть журналы аудита больших двоичных объектов программным способом:

     * Используйте библиотеку C# [для считывания расширенных событий](https://blogs.msdn.microsoft.com/extended_events/2011/07/20/introducing-the-extended-events-reader/).
     * Используйте [запросы к файлам расширенных событий](https://sqlscope.wordpress.com/2014/11/15/reading-extended-event-files-using-client-side-tools-only/) с помощью PowerShell.



<br>
###<a name="database-level-policy-audit-logs"></a>Журналы аудита на уровне базы данных
Журналы аудита на уровне базы данных объединяются в коллекцию таблиц хранилища с префиксом **SQLDBAuditLogs** в учетной записи хранилища Azure, выбранной во время установки. Просматривать файлы журнала можно с помощью таких инструментов, как [обозреватель хранилищ Azure](http://azurestorageexplorer.codeplex.com).

Для скачивания доступен предварительно настроенный шаблон отчета панели мониторинга в виде [таблицы Excel](http://go.microsoft.com/fwlink/?LinkId=403540), что позволит быстро проанализировать данные журнала. Чтобы использовать шаблон с журналами аудита, вам потребуется Excel 2013 или более поздней версии и надстройка Power Query, которую можно скачать по [этой ссылке](http://www.microsoft.com/download/details.aspx?id=39379).

В шаблоне приведен пример вымышленных данных, вы можете настроить Power Query для импорта журнала аудита непосредственно в учетную запись хранения Azure.

## <a id="subheading-4"></a>Повторное создание ключа к хранилищу данных
Обычно в рабочей среде приходится периодически обновлять ключи хранилища. При обновлении ключей необходимо сохранить политику. Процесс таков:

1. На панели конфигурации аудита (описанной выше в разделе о настройке аудита) измените значение параметра **Ключ доступа к хранилищу** с *Первичный* на *Вторичный* и нажмите кнопку **Сохранить**.

   ![][4]
2. Перейдите на панель конфигурации хранилища и **повторно создайте** *первичный ключ доступа*.
3. Вернитесь на панель конфигурации аудита,
4. измените значение параметра **Ключ доступа к хранилищу** с *Вторичный* на *Первичный* и нажмите кнопку **Сохранить**.
4. В интерфейсе хранилища **повторно создайте***вторичный ключ доступа* (для подготовки к следующему циклу обновления ключей).

## <a id="subheading-5"></a>Автоматизация (PowerShell или REST API)
Аудит в хранилище данных SQL Azure также можно настроить с помощью следующих средств автоматизации:

* **Командлеты PowerShell**

   * [Get-AzureRMSqlDatabaseAuditingPolicy](/powershell/module/azurerm.sql/get-azurermsqldatabaseauditingpolicy)
   * [Get-AzureRMSqlServerAuditingPolicy](/powershell/module/azurerm.sql/Get-AzureRMSqlServerAuditingPolicy)
   * [Remove-AzureRMSqlDatabaseAuditing](/powershell/module/azurerm.sql/Remove-AzureRMSqlDatabaseAuditing)
   * [Remove-AzureRMSqlServerAuditing](/powershell/module/azurerm.sql/Remove-AzureRMSqlServerAuditing)
   * [Set-AzureRMSqlDatabaseAuditingPolicy](/powershell/module/azurerm.sql/Set-AzureRMSqlDatabaseAuditingPolicy)
   * [Set-AzureRMSqlServerAuditingPolicy](/powershell/module/azurerm.sql/Set-AzureRMSqlServerAuditingPolicy)
   * [Use-AzureRMSqlServerAuditingPolicy](/powershell/module/azurerm.sql/Use-AzureRMSqlServerAuditingPolicy)


## <a name="downlevel-clients-support-for-auditing-and-dynamic-data-masking"></a>Поддержка клиентов прежних версий для аудита и динамического маскирования данных
Аудит работает с клиентами SQL, которые поддерживают перенаправление TDS.

Любой клиент, который реализует TDS 7.4, также должен поддерживать перенаправление. К исключениям относятся JDBC 4.0, где функция перенаправления поддерживается не полностью, и Tedious для Node.JS, где перенаправление не реализовано.

Для клиентов прежних версий, которые поддерживают TDS 7.3 и более ранних версий, измените полное доменное имя сервера в строке подключения, как показано ниже.

- Полное доменное имя сервера-источника в строке подключения: <*имя сервера*>.database.windows.net.
- Измененное полное доменное имя сервера в строке подключения: <*имя сервера*>.database.**secure**.windows.net.

Частичный список клиентов прежних версий включает:

* .NET 4.0 и ниже
* ODBC 10.0 и ниже
* JDBC (хотя JDBC поддерживает TDS 7.4, но функция перенаправления TDS поддерживается не полностью)
* Tedious (для Node.JS)

**Примечание.** Описанное выше изменение полного доменного имени сервера можно использовать также для применения политики аудита уровня SQL Server без необходимости настройки в каждой базе данных (временное устранение рисков).     




<!--Anchors-->
[Database Auditing basics]: #subheading-1
[Set up auditing for your database]: #subheading-2
[Analyze audit logs and reports]: #subheading-3
[Define server-level vs. database-level auditing policy]: #subheading-4
[Set up server-level auditing for all databases]: #subheading-5

<!--Image references-->
[1]: ./media/sql-data-warehouse-auditing-overview/sql-data-warehouse-auditing.png
[2]: ./media/sql-data-warehouse-auditing-overview/sql-data-warehouse-auditing-inherit.png
[3]: ./media/sql-data-warehouse-auditing-overview/sql-data-warehouse-auditing-enable.png
[4]: ./media/sql-data-warehouse-auditing-overview/sql-data-warehouse-auditing-storage-account.png
[5]: ./media/sql-data-warehouse-auditing-overview/sql-data-warehouse-auditing-dashboard.png
[6]: ./media/sql-data-warehouse-auditing-overview/sql-data-warehouse-auditing-server_1_overview.png
[7]: ./media/sql-data-warehouse-auditing-overview/sql-data-warehouse-auditing-server_2_enable.png
[8]: ./media/sql-data-warehouse-auditing-overview/sql-data-warehouse-auditing-server_3_storage.png
