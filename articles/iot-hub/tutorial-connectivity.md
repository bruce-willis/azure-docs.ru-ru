---
title: Проверка подключения устройства к Центру Интернета вещей Azure
description: При разработке используйте инструменты Центра Интернета вещей для устранения проблем с подключением устройств к Центру Интернета вещей.
services: iot-hub
author: dominicbetts
manager: timlt
ms.author: dobett
ms.custom: mvc
ms.date: 05/29/2018
ms.topic: tutorial
ms.service: iot-hub
ms.openlocfilehash: dc857760cf0d3fa2e146f22196b7bc36d119df5f
ms.sourcegitcommit: ab3b2482704758ed13cccafcf24345e833ceaff3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/06/2018
ms.locfileid: "37869592"
---
# <a name="tutorial-use-a-simulated-device-to-test-connectivity-with-your-iot-hub"></a>Руководство. Проверка подключения к центру Интернета вещей с помощью имитированного устройства

В этом руководстве описано, как применять инструменты на портале Центра Интернета вещей Azure и команды Azure CLI для проверки возможности подключения устройств. В этом руководстве используется простая имитация устройства, выполняемая на обычном компьютере.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/), прежде чем начинать работу.

Из этого руководства вы узнаете, как выполнять такие задачи:
> [!div class="checklist"]
> * проверка аутентификации устройств;
> * проверка подключения с устройства в облако;
> * проверка подключения из облака на устройство;
> * проверка синхронизации двойников устройств.

[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

## <a name="prerequisites"></a>предварительным требованиям

Скрипты CLI, которые вы будете выполнять при работе с этим руководством, используют [расширение Интернета вещей Microsoft Azure для Azure CLI 2.0](https://github.com/Azure/azure-iot-cli-extension/blob/master/README.md). Чтобы установить это расширение, выполните следующую команду CLI:

```azurecli-interactive
az extension add --name azure-cli-iot-ext
```

Приложение имитации устройства, которое вы выполните в этом руководстве, создано на основе Node.js. Вам потребуется установить Node.js 4.x.x или более позднюю версию на компьютере для разработки.

Node.js, предназначенный для нескольких платформ, можно скачать здесь: [nodejs.org](https://nodejs.org).

Текущую версию Node.js на компьютере, на котором ведется разработка, можно проверить, используя следующую команду:

```cmd/sh
node --version
```

Скачайте пример имитации устройства в виде проекта Node.js по адресу https://github.com/Azure-Samples/azure-iot-samples-node/archive/master.zip и разверните этот ZIP-архив.

## <a name="create-an-iot-hub"></a>Создание Центра Интернета вещей

Если вы уже создали Центр Интернета вещей бесплатной или стандартной категории при работе с любым предыдущим руководством, этот шаг можно пропустить.

[!INCLUDE [iot-hub-tutorials-create-free-hub](../../includes/iot-hub-tutorials-create-free-hub.md)]

## <a name="check-device-authentication"></a>Проверка аутентификации устройств

Прежде чем обмениваться данными с Центром Интернета вещей, устройство должно пройти на нем аутентификацию. Вы можете применить инструмент **Устройства Интернета вещей** из раздела **Управление устройствами** на портале управления, чтобы изменить параметры устройств и (или) проверить их ключи аутентификации. В этом разделе руководства описано, как добавить тестовое устройство, получить его ключ и проверить возможность его подключения к концентратору. Позже вы сбросите ключ аутентификации и узнаете, что происходит при попытке устройства подключиться с устаревшим ключом. В этом разделе руководства применяется портал Azure для создания, администрирования и мониторинга устройства, а также используется пример имитации устройства Node.js.

Войдите на портал и перейдите к своему Центру Интернета вещей. Затем откройте средство **Устройства Интернета вещей**:

![Средство "Устройства Интернета вещей"](media/tutorial-connectivity/iot-devices-tool.png)

Чтобы зарегистрировать новое устройство, щелкните **+Добавить**, введите в поле **Идентификатор устройства** значение **MyTestDevice** и щелкните **Сохранить**:

![Добавление нового устройства](media/tutorial-connectivity/add-device.png)

Чтобы получить строку подключения для **MyTestDevice**, щелкните это устройство в списке устройств и скопируйте значение **Строка подключения — первичный ключ**. Строка подключения содержит *общий ключ доступа* для устройства.

![Получение строки подключения для устройства](media/tutorial-connectivity/copy-connection-string.png)

Чтобы имитировать отправку телеметрии от **MyTestDevice** в Центр Интернета вещей, запустите приложение Node.js для имитации устройства, которое вы скачали ранее.

На компьютере разработки в окне терминала перейдите в корневую папку скачанного тестового проекта Node.js. Затем перейдите в ней к вложенной папке **iot-hub\Tutorials\ConnectivityTests\simulated-device**.

Установите необходимые библиотеки и запустите приложение имитированного устройства, выполнив в окне терминала следующие команды: Используйте строку подключения для устройства, которую вы записали при добавлении устройства на портале.

```cmd/sh
npm install
node SimulatedDevice-1.js "{your device connection string}"
```

В окне терминала отображаются сведения о попытке подключиться к Центру Интернета вещей:

![Подключение имитированного устройства](media/tutorial-connectivity/sim-1-connected.png)

Итак, вы успешно прошли аутентификацию при подключении устройства с помощью ключа устройства, созданного Центром Интернета вещей.

### <a name="reset-keys"></a>Сброс ключей

В этом разделе описано, как сбросить ключ устройства и узнать, какая ошибка выдается при попытке подключить имитированное устройство.

Чтобы сбросить первичный ключ устройства для **MyTestDevice**, выполните следующие команды:

```azurecli-interactive
# Generate a new Base64 encoded key using the current date
read key < <(date +%s | sha256sum | base64 | head -c 32)

# Requires the IoT Extension for Azure CLI 2.0
# az extension add --name azure-cli-iot-ext

# Reset the primary device key for MyTestDevice
az iot hub device-identity update --device-id MyTestDevice --set authentication.symmetricKey.primaryKey=$key --hub-name {YourIoTHubName}
```

В окне терминала на компьютере разработки снова запустите приложение имитированного устройства:

```cmd/sh
npm install
node SimulatedDevice-1.js "{your device connection string}"
```

Теперь при попытке подключения вы увидите следующую ошибку аутентификации:

![Ошибка подключения](media/tutorial-connectivity/sim-1-fail.png)

### <a name="generate-shared-access-signature-sas-token"></a>Создание маркера подписанного URL-адреса (SAS)

Если устройство использует один из пакетов SDK для устройств Центра Интернета вещей, код библиотеки из этого пакета SDK создает маркер SAS для аутентификации в Центре Интернета вещей. Маркер SAS создается на основе имени Центра Интернета вещей, имени устройства и ключа устройства.

В некоторых сценариях, например при использовании облачного шлюза протоколов или пользовательских систем аутентификации, вам придется самостоятельно создавать маркер SAS. Для устранения ошибок, возникающих в коде создания SAS, нужно обеспечить возможность создать правильный тестовый маркер SAS.

> [!NOTE]
> Пример SimulatedDevice 2.js включает инструкции по созданию маркера SAS с помощью пакета SDK и без него.

Чтобы создать правильный тестовый маркер SAS через интерфейс командной строки, выполните следующую команду:

```azurecli-interactive
az iot hub generate-sas-token --device-id MyTestDevice --hub-name {YourIoTHubName}
```

Запишите полный текст созданного маркера SAS. Этот маркер SAS выглядит примерно так: `'SharedAccessSignature sr=tutorials-iot-hub.azure-devices.net%2Fdevices%2FMyTestDevice&sig=....&se=1524155307'`

На компьютере разработки в окне терминала перейдите в корневую папку скачанного тестового проекта Node.js. Затем перейдите в ней к вложенной папке **iot-hub\Tutorials\ConnectivityTests\simulated-device**.

Установите необходимые библиотеки и запустите приложение имитированного устройства, выполнив в окне терминала следующие команды:

```cmd/sh
npm install
node SimulatedDevice-2.js "{Your SAS token}"
```

В окне терминала отображаются сведения о попытке подключиться к Центру Интернета вещей с использованием маркера SAS.

![Подключение имитированного устройства с помощью маркера](media/tutorial-connectivity/sim-2-connected.png)

Итак, вы успешно прошли аутентификацию при подключении устройства с помощью маркера SAS, созданного командой интерфейса командной строки. Файл **SimulatedDevice 2.js** содержит пример кода, создающего маркер SAS.

### <a name="protocols"></a>Протоколы

Для подключения к Центру Интернета вещей устройство можно использовать любой из следующих протоколов:

| Протокол | Исходящий порт |
| --- | --- |
| MQTT |8883 |
| MQTT через WebSocket |443 |
| AMQP |5671 |
| AMQP через WebSocket |443 |
| HTTPS |443 |

Если исходящий порт заблокирован брандмауэром, устройство не сможет подключиться:

![Порт заблокирован](media/tutorial-connectivity/port-blocked.png)

## <a name="check-device-to-cloud-connectivity"></a>Проверка подключения с устройства в облако

После подключения устройство обычно пытается отправить данные телеметрии в Центр Интернета вещей. В этом разделе описано, как проверить получение данных телеметрии, отправленных устройством.

Для начала получите используемую строку подключения для имитированного устройства, выполнив следующую команду:

```azurecli-interactive
az iot hub device-identity show-connection-string --device-id MyTestDevice --output table --hub-name {YourIoTHubName}
```

Чтобы запустить имитированное устройство для отправки сообщений, перейдите в папку **iot-hub\Tutorials\ConnectivityTests\simulated-device** в скачанном примере кода.

Установите необходимые библиотеки и запустите приложение имитированного устройства, выполнив в окне терминала следующие команды:

```cmd/sh
npm install
node SimulatedDevice-3.js "{your device connection string}"
```

В окне терминала отображаются сведения о попытке отправить телеметрию в Центр Интернета вещей.

![Отправка сообщений от имитированного устройства](media/tutorial-connectivity/sim-3-sending.png)

С помощью раздела **Метрики** на портале вы можете убедиться, что сообщения телеметрии успешно поступают в Центр Интернета вещей:

![Переход к разделу метрик Центра Интернета вещей](media/tutorial-connectivity/metrics-portal.png)

Выберите используемый Центр Интернета вещей в раскрывающемся списке **Ресурс**, выберите метрику **Число отправленных сообщений телеметрии** и задайте период **За последний час**. Откроется диаграмма, отображающая совокупное число сообщений, отправленных имитированным устройством:

![Отображение метрик Центра Интернета вещей](media/tutorial-connectivity/metrics-active.png)

После запуска имитированного устройства потребуется несколько минут, прежде чем метрики станут доступны.

## <a name="check-cloud-to-device-connectivity"></a>Проверка подключения из облака на устройство

В этом разделе показано, как выполнить на устройстве тестовый вызов прямого метода, чтобы проверить возможность подключения из облака на устройство. Запустите имитированное устройство на компьютере разработки в режиме прослушивания прямых вызовов от Центра Интернета вещей.

В окне терминала запустите приложение имитированного устройства, выполнив следующую команду:

```cmd/sh
node SimulatedDevice-3.js "{your device connection string}"
```

С помощью команды интерфейса командной строки вызовите прямой метод на устройстве:

```azurecli-interactive
az iot hub invoke-device-method --device-id MyTestDevice --method-name TestMethod --timeout 10 --method-payload '{"key":"value"}' --hub-name {YourIoTHubName}
```

Имитированное устройство выводит в консоль следующее сообщение, когда получает вызов прямого метода:

![Вызов прямого метода на имитированном устройстве](media/tutorial-connectivity/receive-method-call.png)

Когда имитированное устройство успешно принимает вызов прямого метода, оно возвращает подтверждение в Центр Интернета вещей:

![Подтверждение получения прямого метода](media/tutorial-connectivity/method-acknowledgement.png)

## <a name="check-twin-synchronization"></a>Проверка синхронизации двойников

Двойники устройств применяются для синхронизации состояний между устройством и Центром Интернета вещей. В этом разделе описано, как применить команды CLI для отправки _требуемых свойств_ на устройство и считывания _сообщаемых свойств_, передаваемых устройством.

Имитированное устройство, которое вы используете в этом разделе, при каждом запуске отправляет сообщаемые свойства в Центр Интернета вещей, а при получении требуемых свойств выводит их значения в консоль.

В окне терминала запустите приложение имитированного устройства, выполнив следующую команду:

```cmd/sh
node SimulatedDevice-3.js "{your device connection string}"
```

Чтобы убедиться, что Центр Интернета вещей получил сообщаемые свойства от устройства, используйте следующую команду CLI:

```azurecli-interactive
az iot hub device-twin show --device-id MyTestDevice --hub-name {YourIoTHubName}
```

В выходных данных команды вы увидите свойство **devicelaststarted** в разделе сообщаемых свойств. Это свойство содержит дату и время последнего запуска имитированного устройства.

![Просмотр сообщаемых свойств](media/tutorial-connectivity/reported-properties.png)

Чтобы убедиться, что Центр Интернета вещей может отправлять на устройство требуемые свойства, используйте следующую команду CLI:

```azurecli-interactive
az iot hub device-twin update --set properties.desired='{"mydesiredproperty":"propertyvalue"}' --device-id MyTestDevice --hub-name {YourIoTHubName}
```

Имитированное устройство выводит следующее сообщение, когда получает обновленное значение требуемого свойства от Центра Интернета вещей:

![Получение требуемых свойств](media/tutorial-connectivity/desired-properties.png)

Помимо получения внесенных изменений в значения требуемых свойств, имитированное устройство автоматически проверяет значения требуемых свойств при каждом запуске.

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вам больше не требуется Центр Интернета вещей, удалите его и группу ресурсов на портале. Для этого выберите группу ресурсов **tutorials-iot-hub-rg**, содержащую Центр Интернета вещей, и щелкните **Удалить**.

## <a name="next-steps"></a>Дополнительная информация

В этом руководстве описано, как можно проверить ключи устройства, подключение с устройства в облако, подключение из облака на устройство и синхронизацию двойников устройств. Дополнительные сведения о мониторинге для Центра Интернета вещей вы можете найти в статье с практическими примерами.

> [!div class="nextstepaction"]
> [Мониторинг и диагностика](iot-hub-monitor-resource-health.md)
