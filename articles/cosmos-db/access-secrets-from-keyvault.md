---
title: Хранение ключей Azure Cosmos DB и получение доступа к ним в Key Vault | Документация Майкрософт
description: Хранение строк подключения, ключей и универсальных кодов ресурса (URI) Azure Cosmos DB, а также получение доступа к ним в Key Vault.
services: cosmos-db
author: rafats
manager: kfile
ms.service: cosmos-db
ms.devlang: dotnet
ms.topic: conceptual
ms.date: 08/21/2018
ms.author: rafats
ms.openlocfilehash: 11aac0ab4476494f74453ca64a1b77964197adaa
ms.sourcegitcommit: b5ac31eeb7c4f9be584bb0f7d55c5654b74404ff
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/23/2018
ms.locfileid: "42751581"
---
# <a name="use-key-vault-to-store-and-access-azure-cosmos-db-keys"></a>Хранение ключей Azure Cosmos DB и получение доступа к ним в Key Vault

Используя Azure Cosmos DB для приложений, вы можете получать доступ к базе данных, коллекциям и документам с помощью URI конечной точки и ключа в файле конфигурации приложения.  Тем не менее помещать ключи и URI прямо в код приложения небезопасно, так как они доступны в текстовом формате всем пользователям. Нужно гарантировать, что URI и ключи доступны, но через защищенный механизм. Azure Key Vault может помочь в надежном хранении секретов приложения и в управлении ими.

Чтобы сохранить ключи доступа Azure Cosmos DB в Key Vault и читать их оттуда, требуются следующие шаги:

* создать хранилище ключей;  
* добавление ключей доступа Azure Cosmos DB в Key Vault;  
* создание веб-приложения Azure;  
* регистрация приложения и предоставление ему разрешений на чтение из Key Vault.  


## <a name="create-a-key-vault"></a>создать хранилище ключей;

1. Вход на [портал Azure](https://portal.azure.com/).  
2. Выберите **Создать ресурс > Безопасность > Key Vault**.  
3. В разделе **Создать Key Vault** введите приведенные ниже сведения.  
   * **Имя**. Укажите уникальное имя для Key Vault.  
   * **Подписка**. Выберите подписку, которую нужно использовать.  
   * В разделе **Группа ресурсов** выберите **Создать** и введите имя группы ресурсов.  
   * Выберите расположение в раскрывающемся меню "Расположение".  
   * Для других параметров оставьте значения по умолчанию.  
4. Указав приведенные выше сведения, выберите **Создать**.  

## <a name="add-azure-cosmos-db-access-keys-to-the-key-vault"></a>Добавление в Key Vault ключей доступа Azure Cosmos DB
1. Перейдите в хранилище Key Vault, созданное на предыдущем шаге, и откройте вкладку **Секреты**.  
2. Выберите **+ Создать или импортировать**. 

   * Выберите **параметр отправки** **Вручную**.
   * Укажите **имя** для секрета.
   * Укажите строку подключения вашей учетной записи Cosmos DB в поле **Значение**. Затем нажмите кнопку **Создать**.

   ![Создание секрета](./media/access-secrets-from-keyvault/create-a-secret.png)

4. После того как секрет будет создан, откройте его и скопируйте **идентификатор секрета в следующем формате. Этот идентификатор понадобится вам в следующем разделе. 

   `https://<Key_Vault_Name>.vault.azure.net/secrets/<Secret _Name>/<ID>`

## <a name="create-an-azure-web-application"></a>Создание веб-приложения Azure

1. Создайте веб-приложение Azure или загрузите его из [репозитория GitHub](https://github.com/rsarosh/CosmosDB-KeyVault). Это простое приложение MVC.  

2. Распакуйте загруженное приложение и откройте файл **HomeController.cs**. Обновите идентификатор секрета в следующей строке:

   `var secret = await keyVaultClient.GetSecretAsync("<Your Key Vault’s secret identifier>")`

3. **Сохраните** файл и выполните **сборку** решения.  
4. Затем разверните приложение в Azure. Щелкните проект правой кнопкой мыши и выберите **Опубликовать**. Создайте новый профиль службы приложения (вы можете назвать приложение WebAppKeyVault1) и выберите **Опубликовать**.   

5. После этого приложение будет развернуто. На портале Azure перейдите к развернутому веб-приложению и включите **управляемое удостоверение службы** этого приложения.  

   ![Управляемое удостоверение службы](./media/access-secrets-from-keyvault/turn-on-managed-service-identity.png)

Если вы запустите приложение сейчас, отобразится следующая ошибка. Она возникает, потому что вы не предоставили этому приложению прав на использование Key Vault.

![Приложение развернуто без доступа](./media/access-secrets-from-keyvault/app-deployed-without-access.png)

## <a name="register-the-application--grant-permissions-to-read-the-key-vault"></a>Регистрация приложения и предоставление ему разрешений на чтение из Key Vault

В этом разделе вы регистрируете приложение в Azure Active Directory и предоставляете ему разрешения на чтение из Key Vault. 

1. Перейдите на портал Azure и откройте **Key Vault**, созданное в предыдущем разделе.  

2. Откройте **политики доступа**, выберите **+ Добавить**, найдите развернутое веб-приложение, выберите разрешения и нажмите кнопку **ОК**.  

   ![Добавление политики доступа](./media/access-secrets-from-keyvault/add-access-policy.png)

Теперь, запустив приложение, вы сможете прочитать секрет из Key Vault.

![Развернутое приложение, в котором отображается секрет](./media/access-secrets-from-keyvault/app-deployed-with-access.png)
 
Аналогичным образом вы можете предоставить пользователю доступ к Key Vault. Вам нужно добавить себя в Key Vault. Для этого щелкните "Политики доступа", а затем предоставьте все необходимые разрешения для запуска приложения из Visual Studio. Если это приложение запускается с вашего рабочего стола, оно использует ваш идентификатор.

## <a name="next-steps"></a>Дополнительная информация

* Чтобы настроить брандмауэр для Azure Cosmos DB, см. статью [Поддерживаемые брандмауэры](firewall-support.md).
* Чтобы настроить конечную точку службы виртуальной сети, перейдите к статье [Безопасный доступ к учетной записи Azure Cosmos DB с использованием конечной точки службы виртуальной сети Azure](vnet-service-endpoint.md).


