---
title: Пакетная служба Microsoft Azure и перемещение данных для рендеринга
description: Возможности хранения данных и перемещения данных для рабочих нагрузок рендеринга
services: batch
author: mscurrell
ms.author: markscu
ms.date: 08/02/2018
ms.topic: conceptual
ms.openlocfilehash: d5b006fd744e463c73ee0a32388f254017e96354
ms.sourcegitcommit: 387d7edd387a478db181ca639db8a8e43d0d75f7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/10/2018
ms.locfileid: "40036756"
---
# <a name="storage-and-data-movement-options-for-rendering-asset-and-output-files"></a>Возможности хранения данных и перемещения данных для ресурсов рендеринга и выходных файлов

У вас есть много вариантов предоставлять файлы сцен и ресурсов для приложений рендеринга на виртуальных машинах в пуле:

* [Хранилище BLOB-объектов Azure](https://docs.microsoft.com/azure/storage/blobs/storage-blobs-introduction).
  * Файлы сцен и ресурсов передаются в хранилище BLOB-объектов из локальной файловой системы. Когда задача выполняет приложение, нужные файлы копируются из хранилища BLOB-объектов на виртуальную машину, чтобы приложение получило к ним доступ. Выходные файлы записываются приложением рендеринга на диск виртуальной машины, а затем копируются в хранилище BLOB-объектов.  При необходимости выходные файлы можно скачать из хранилища BLOB-объектов в локальную файловую систему.
  * Хранилище больших двоичных объектов — это простой и экономный вариант для небольших проектов.  Все файлы ресурсов должны быть доступными в каждом пуле виртуальных машин, поэтому при увеличении числа и (или) размера файлов ресурсов следует принять меры для максимально эффективной передачи этих файлов.  
* Хранилище Azure в качестве файловой системы с использованием [blobfuse](https://docs.microsoft.com/azure/storage/blobs/storage-how-to-mount-container-linux):
  * На виртуальных машинах Linux учетные записи хранения можно предоставлять и использовать в качестве файловой системы, если используется драйвер виртуальной файловой системы blobfuse.
  * Этот вариант отличается очень низким уровнем затрат, так как не требует создания виртуальных машин для файловой системы. Кроме того, кэширование blobfuse на виртуальных машинах позволяет не скачивать повторно одни и те же файлы для нескольких заданий и (или) задач.  Перемещение данных также выполняется очень просто, так как файлы имеют обычный формат больших двоичных объектов, следовательно, для копирования файлов между локальной файловой системы и хранилищем Azure можно использовать стандартные API и такие средства, как azcopy.
* Файловая система или общий файловый ресурс.
  * В зависимости от операционной системы и требований к производительности и масштабированию для виртуальной машины, сюда могут относиться [файлы Azure](https://docs.microsoft.com/azure/storage/files/storage-files-introduction), использование виртуальной машины с подключенными дисками для NFS, использование нескольких виртуальных машин с подключенными дисками для распределенной файловой системы (например, Gluster) или использование предложений третьих сторон.
  * [Avere Systems](http://www.averesystems.com/) теперь входит в корпорацию Microsoft. В ближайшем будущем планируется выпуск решений, идеально подходящих для крупномасштабных и высокопроизводительных операций рендеринга.  Решение Avere позволит создать NFS на платформе Azure или кэш SMB, которые работают в сочетании с хранилищем BLOB-объектов или с локальными устройствами NAS.
  * Файловая система позволяет считывать или записывать файлы напрямую в файловой системе или копировать их между файловой системой и пулом виртуальных машин.
  * Файловая система, предоставленная в общий доступ, позволяет использовать большое число ресурсов для нескольких проектов и заданий, при этом задачи рендеринга будут обращаться только к необходимым ресурсам.

## <a name="using-azure-blob-storage"></a>Использование хранилища BLOB-объектов Azure

Следует использовать учетную запись хранилища BLOB-объектов или учетную запись хранения общего назначения версии 2.  Для этих двух типов учетных записей хранения можно настроить значительно более высокие ограничения по сравнению с учетной записью хранения общего назначения версии 1, как описано в [этой записи блога](https://azure.microsoft.com/blog/announcing-larger-higher-scale-storage-accounts/).  Более высокие ограничения позволят значительно повысить производительность и масштабируемость, особенно при обращении большого числа виртуальных машин пула к одной учетной записи хранения.

### <a name="copying-files-between-client-and-blob-storage"></a>Копирование файлов между клиентом и хранилищем больших двоичных объектов

Чтобы скопировать файлы в хранилище Azure и обратно, можно использовать разные механизмы, в том числе API хранилища BLOB-объектов, [библиотеку перемещения данных службы хранилища Azure](https://github.com/Azure/azure-storage-net-data-movement), средство командной строки azcopy для [Windows](https://docs.microsoft.com/azure/storage/common/storage-use-azcopy) или [Linux](https://docs.microsoft.com/azure/storage/common/storage-use-azcopy-linux), [Обозреватель службы хранилища Azure](https://azure.microsoft.com/features/storage-explorer/) и (или) [Azure Batch Explorer](https://azure.github.io/BatchExplorer/).

Например, можно передать все ресурсы в папке с помощью azcopy следующим образом:


`azcopy /source:. /dest:https://account.blob.core.windows.net/rendering/project /destsas:"?st=2018-03-30T16%3A26%3A00Z&se=2020-03-31T16%3A26%3A00Z&sp=rwdl&sv=2017-04-17&sr=c&sig=sig" /Y`

Чтобы скопировать только измененные файлы, добавьте параметр /XO:

`azcopy /source:. /dest:https://account.blob.core.windows.net/rendering/project /destsas:"?st=2018-03-30T16%3A26%3A00Z&se=2020-03-31T16%3A26%3A00Z&sp=rwdl&sv=2017-04-17&sr=c&sig=sig" /XO /Y`

### <a name="copying-input-asset-files-from-blob-storage-to-batch-pool-vms"></a>Копирование входных файлов ресурсов из хранилища BLOB-объектов на виртуальные машины пула пакетной службы

Есть несколько подходов к копированию файлов, и выбор оптимального из них зависит от размера ресурсов для задания.
Самым простой вариант — копирование всех файлов ресурсов на виртуальные машины пула для каждого задания:

* Если есть уникальные для задания файлы, которые требуются для выполнения всех задач в задании, вы можете создать [задачу подготовки задания](https://docs.microsoft.com/rest/api/batchservice/job/add#jobpreparationtask) для копирования всех файлов.  Задача подготовки задания выполняется только один раз при выполнении первой задачи на виртуальной машине, но не для последующих задач в задании.
* Следует создать [задачу освобождения задания](https://docs.microsoft.com/rest/api/batchservice/job/add#jobreleasetask) для удаления файлов задания после его завершения. Это позволит избежать переполнения диска виртуальной машины файлами ресурсов для заданий.
* Если же несколько заданий используют одинаковые ресурсы и каждое из них вносит только добавочные изменения, файлы ресурсов все равно копируются, даже если не все из них обновлялись.  Это крайне неэффективно, если есть большое число больших файлов ресурсов.

Когда файлы ресурсов используются повторно для следующих заданий,которые вносят только добавочные изменения, более эффективным подходом будет хранение ресурсов в общей папке на виртуальной машине с синхронизацией измененных файлов.

* Задача подготовки задания должна выполнять копирование с помощью средства azcopy с параметром /XO в общую папку виртуальной машины, которая указана в переменной среды AZ_BATCH_NODE_SHARED_DIR.  Таким образом на каждую виртуальную машину копируются только измененные файлы.
* Нужно внимательно оценить общий размер ресурсов, чтобы они поместились на временном диске для виртуальных машин пула.

Пакетная служба Azure изначально поддерживает копирование файлов между учетной записью хранения и виртуальными машинами пула пакетной службы.  Задача [файлов ресурсов](https://docs.microsoft.com/rest/api/batchservice/job/add#resourcefile) копирует файлы из хранилища на виртуальные машины пула. Ее можно указать для задачи подготовки задания.  К сожалению, если файлов сотни, есть риск достигнуть лимита, что приведет к сбою задачи.  Если ресурсов очень много, мы рекомендуем использовать в задаче подготовки задания средство azcopy, которое поддерживает подстановочные знаки и не имеет ограничений.

### <a name="copying-output-files-to-blob-storage-from-batch-pool-vms"></a>Копирование выходных файлов в хранилище BLOB-объектов из виртуальных машин пула пакетной службы

[Выходные файлы](https://docs.microsoft.com/rest/api/batchservice/task/add#outputfile) можно использовать для копирования файлов из виртуальных машин пула в хранилище.  После завершения задачи один или несколько файлов можно скопировать из виртуальной машины в указанную учетную запись хранения.  Например, нужно копировать выводимые данные, а иногда и файлы журналов.

## <a name="using-a-blobfuse-virtual-file-system-for-linux-vm-pools"></a>Использование виртуальной файловой системы blobfuse для пулов виртуальных машин Linux

Blobfuse — это драйвер виртуальной файловой системы для хранилища BLOB-объектов Azure, который позволяет обращаться к файлам, сохраненным в виде BLOB-объектов в учетной записи хранения в файловой системе Linux.

Узлы пула могут подключать файловую систему при запуске или в задаче подготовки задания, которая выполняется только при запуске первой задачи на определенном узле.  Настройки Blobfuse позволяют использовать одновременно диск ramdisk и локальные диски SSD на виртуальных машинах для кэширования файлов, что существенно повышает производительность при обращении нескольких задач на узле к некоторым из файлов.

[Доступны примеры шаблонов](https://github.com/Azure/BatchExplorer-data/tree/master/ncj/vray/render-linux-with-blobfuse-mount) для запуска автономных средств рендеринга V-Ray с файловой системой blobfuse, на основе которых можно создать шаблоны для других приложений.

### <a name="accessing-files"></a>Доступ к файлам

Задачи в заданиях указывают пути для входных и выходных файлов в пределах подключенной файловой системы.

### <a name="copying-input-asset-files-from-blob-storage-to-batch-pool-vms"></a>Копирование входных файлов ресурсов из хранилища BLOB-объектов на виртуальные машины пула пакетной службы

Файлы являются обычными BLOB-объектами в службе хранилища Azure, поэтому вы можете использовать для копирования файлов между локальной системы и хранилищем BLOB-объектов стандартные API-интерфейсы, средства и пользовательские интерфейсы, поддерживающие BLOB-объекты: средство azcopy, Обозреватель службы хранилища, Batch Explorer и т. д.

## <a name="using-azure-files-with-windows-vms"></a>Использование службы файлов Azure с виртуальными машинами Windows

[Служба файлов Azure](https://docs.microsoft.com/azure/storage/files/storage-files-introduction) предоставляет полностью управляемые общие файловые ресурсы в облаке, доступные по протоколу SMB.  Служба файлов Azure реализована на основе хранилища BLOB-объектов Azure. Она очень [экономична](https://azure.microsoft.com/pricing/details/storage/files/) и поддерживает репликацию данных в другой регион для создания глобальной избыточности.  Следует оценить [целевые показатели масштабирования](https://docs.microsoft.com/azure/storage/files/storage-files-scale-targets#azure-files-scale-targets) для достижения ожидаемого размера пула и числа файлов ресурсов, чтобы определить, нужно ли использовать службу файлов Azure.

Вы можете изучить [эту запись блога](https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/) и [документацию](https://docs.microsoft.com/azure/storage/files/storage-how-to-use-files-windows), посвященные подключению общего файлового ресурса службы файлов Azure.

### <a name="mounting-an-azure-files-share"></a>Подключение общего ресурса службы файлов Azure

Чтобы использовать пакетную службу, следует выполнять операцию монтирования при каждом запуске задачи, так как подключения не сохраняются между задачами.  Для этого проще всего настроить cmdkey для сохранения учетных данных в задаче запуска для пула, а затем перед каждой задачей подключать общий ресурс.

В этом примере cmdkey используется в шаблоне пула (экранировано для использования в JSON-файле). Учтите, что при разделении вызовов cmdkey и net use контекст пользователя для задачи запуска должны совпадать с контекстом для запуска задач:

```
"startTask": {
  "commandLine": "cmdkey /add:storageaccountname.file.core.windows.net
    /user:AZURE\\markscuscusbatch /pass:storage_account_key",
  "userIdentity":{
    "autoUser": {
      "elevationLevel": "nonadmin",
      "scope": "pool"
    }
}
```

Пример командной строки для задачи задания:
```
"commandLine":"net use S:
  \\\\storageaccountname.file.core.windows.net\\rendering &
3dsmaxcmdio.exe -v:5 -rfw:0 -10 -end:10
  -bitmapPath:\"s:\\3dsMax\\Dragon\\Assets\"
  -outputName:\"s:\\3dsMax\\Dragon\\RenderOutput\\dragon.jpg\"
  -w:1280 -h:720
  \"s:\\3dsMax\\Dragon\\Assets\\Dragon_Character_Rig.max\""
```

### <a name="accessing-files"></a>Доступ к файлам

Задачи в заданиях указывают пути для входных и выходных файлов в пределах подключенной файловой системы. Это может быть подключенный диск или UNC-путь.

### <a name="copying-input-asset-files-from-blob-storage-to-batch-pool-vms"></a>Копирование входных файлов ресурсов из хранилища BLOB-объектов на виртуальные машины пула пакетной службы

Служба файлов Azure поддерживается всеми основными API и средствами, которые умеют работать с хранилищем Azure (azcopy, Azure CLI, Обозреватель службы хранилища, Azure PowerShell, Batch Explorer и т. д.)

[Служба синхронизации файлов Azure](https://docs.microsoft.com/azure/storage/files/storage-sync-files-planning) позволяет автоматически синхронизировать файлы между локальной файловой системой и общим файловым ресурсом Azure.

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения о вариантах хранения, вы найдете в подробной документации:

* [Хранилище BLOB-объектов Azure](https://docs.microsoft.com/azure/storage/blobs/storage-blobs-introduction)
* [Blobfuse](https://docs.microsoft.com/azure/storage/blobs/storage-how-to-mount-container-linux)
* [Файлы Azure](https://docs.microsoft.com/azure/storage/files/storage-files-introduction)
