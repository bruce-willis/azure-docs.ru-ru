---
title: Часто задаваемые вопросы. Репликация Hyper-V в Azure с помощью Azure Site Recovery | Документация Майкрософт
description: В этой статье перечислены часто задаваемые вопросы о репликации локальных виртуальных машин Hyper-V в Azure с помощью Azure Site Recovery.
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.date: 09/12/2018
ms.topic: conceptual
ms.author: raynew
ms.openlocfilehash: 16c4ab4601dbe57e014bfcb06ff9b35d02c60cfa
ms.sourcegitcommit: c29d7ef9065f960c3079660b139dd6a8348576ce
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/12/2018
ms.locfileid: "44721914"
---
# <a name="common-questions---hyper-v-to-azure-replication"></a>Часто задаваемые вопросы по репликации Hyper-V в Azure

В этой статье приведены ответы на часто задаваемые вопросы, которые возникают при репликации локальных виртуальных машин Hyper-V в Azure. 


## <a name="general"></a>Общие сведения

### <a name="how-is-site-recovery-priced"></a>Как образуются цены на Site Recovery?
Ознакомьтесь со сведениями о [расценках на Azure Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).

### <a name="how-do-i-pay-for-azure-vms"></a>Как оплачивается использование виртуальных машин Azure?
Во время репликации данные реплицируются в хранилище Azure, и вы не платите за любые изменения виртуальной машины. При выполнении отработки отказа в Azure служба Site Recovery автоматически создаст виртуальные машины IaaS Azure. После этого вам будет выставлен счет за вычислительные ресурсы, использованные в Azure.

## <a name="azure"></a>Таблицы Azure

### <a name="what-do-i-need-in-azure"></a>Что нужно в Azure?
Требуется подписка Azure, хранилище служб восстановления, учетная запись хранения и виртуальная сеть. Хранилище, учетная запись хранения и сеть должны находиться в одном регионе.

### <a name="what-azure-storage-account-do-i-need"></a>Какая учетная запись хранения Azure требуется?
Требуется учетная запись хранения LRS или GRS. Рекомендуется использовать учетную запись хранения GRS, чтобы обеспечить устойчивость данных в случае отключения электричества в регионе или при отсутствии возможности восстановления основного региона. Поддерживается хранилище класса Premium.

### <a name="does-my-azure-account-need-permissions-to-create-vms"></a>Требуются ли учетной записи Azure разрешения на создание виртуальных машин?
Если вы являетесь администратором подписки, у вас есть необходимые разрешения на репликацию. Если нет, вам нужны разрешения на создание виртуальной машины Azure в группе ресурсов и виртуальной сети, которые указываются при настройке Site Recovery, и разрешения на запись в выбранную учетную запись хранения. [Узнайте больше](site-recovery-role-based-linked-access-control.md#permissions-required-to-enable-replication-for-new-virtual-machines).

### <a name="is-replication-data-sent-to-site-recovery"></a>Отправляются ли данные репликации в Site Recovery?
Нет, служба Site Recovery не перехватывает реплицируемые данные и не получает сведения о компонентах, запущенных на ваших виртуальных машинах. Данные репликации передаются между узлами Hyper-V и хранилищем Azure. Служба Site Recovery не обладает способностью перехватывать эти данные. В службу Site Recovery передаются только метаданные, необходимые для управления репликацией и отработкой отказа.  

Site Recovery имеет сертификаты ISO 27001:2013, 27018, HIPAA, DPA и сейчас проходит проверки на соответствие SOC2 и FedRAMP JAB.

### <a name="can-we-keep-on-premises-metadata-within-a-geographic-regions"></a>Можно ли хранить локальные метаданные в пределах географических регионов?
Да. При создании хранилища в регионе мы гарантируем, что все метаданные, используемые Site Recovery, остаются в пределах географических границ региона.

### <a name="does-site-recovery-encrypt-replication"></a>Выполняет ли служба Site Recovery шифрование репликации?
Да, поддерживается и шифрование в процессе передачи, и [шифрование в Azure](https://docs.microsoft.com/azure/storage/storage-service-encryption).


## <a name="deployment"></a>Развертывание

### <a name="what-can-i-do-with-hyper-v-to-azure-replication"></a>Что можно сделать с помощью репликации Hyper-V в Azure?

- **Аварийное восстановление.** Можно настроить полное аварийное восстановление. В этом сценарии выполняется репликация локальных виртуальных машин Hyper-V в хранилище Azure.
    - Вы можете реплицировать виртуальные машины в Azure. Если ваша локальная инфраструктура недоступна, выполняется отработка отказа в Azure.
    - При выполнении отработки отказа создаются виртуальные машины Azure с реплицируемыми данными. Вы можете получить доступ к приложениям и рабочим нагрузкам на виртуальных машинах Azure.
    - Когда локальный центр обработки данных снова станет доступным, можно восстановить размещение из Azure на локальный сайт.
- **Миграция.** Site Recovery можно использовать для миграции локальных виртуальных машин Hyper-V в хранилище Azure. Затем выполняется отработка отказа из локальной среды в Azure. После отработки отказа приложения и рабочие нагрузки доступны и выполняются на виртуальных машинах Azure.


### <a name="what-do-i-need-on-premises"></a>Что требуется в локальной среде?

Требуется одна или несколько виртуальных машин, работающих на одном или нескольких изолированных или кластеризованных узлах Hyper-V. Можно также реплицировать виртуальные машины, запущенные на узлах под управлением System Center Virtual Machine Manager (VMM).
    - Если вы не используете VMM, то во время развертывания Site Recovery узлы и кластеры Hyper-V собираются в сайты Hyper-V. Вы устанавливаете агенты Azure Site Recovery (поставщик Azure Site Recovery и агент служб восстановления) на каждом узле Hyper-V.
    - Если узлы Hyper-V расположены в облаке VMM, можно управлять репликацией в VMM. Нужно установить поставщик Site Recovery на сервер VMM, а также агент служб восстановления на каждый узел Hyper-V. Вы сопоставляете логическую сеть VMM или сеть виртуальных машин и виртуальные сети Azure.
    - 
[Дополнительные сведения](hyper-v-azure-architecture.md) об архитектуре репликации из Hyper-V в Azure.

### <a name="can-i-replicate-vms-located-on-a-hyper-v-cluster"></a>Можно ли реплицировать виртуальные машины, расположенные в кластере Hyper-V?

Да, Site Recovery поддерживает кластеризованные узлы Hyper-V. Обратите внимание на следующее.

- Все узлы кластера должны быть зарегистрированы в том же хранилище.
- Если вы не используете VMM, все узлы Hyper-V в кластере должны быть добавлены на сайт Hyper-V.
- Установите поставщик Azure Site Recovery и агент служб восстановления на каждый хост Hyper-V и добавьте каждый узел на сайт Hyper-V.
- В кластере не нужно выполнять никаких специальных шагов.
- Если средство "Планировщик развертывания" запущено для Hyper-V, оно собирает данные профиля из запущенного узла, на котором работает виртуальная машина. Средство не может собирать данные из отключенного узла, но оно будет отслеживать этот узел. После включения и запуска узла средство начнет собирать из него данные профиля виртуальной машины (если виртуальная машина является частью списка виртуальных машин профиля и запущена на узле).
- Перенос виртуальной машины с настроенного в Site Recovery хранилища Hyper-V на другой узел Hyper-V в том же кластере или на изолированный узел не влияет на репликацию виртуальной машины. Узел Hyper-V должен быть настроен в хранилище Site Recovery и соответствовать [предварительным требованиям](hyper-v-azure-support-matrix.md#on-premises-servers). 


### <a name="can-i-protect-vms-when-hyper-v-is-running-on-a-client-operating-system"></a>Можно ли защитить виртуальные машины при запуске Hyper-V на клиентской операционной системе?
Нет, виртуальные машины должны быть расположены на сервере узла Hyper-V, который работает на компьютере под управлением поддерживаемой версии Windows Server. Если вам нужно защитить клиентский компьютер, то вы можете [реплицировать его как физический компьютер](physical-azure-disaster-recovery.md) в Azure.

### <a name="can-i-replicate-hyper-v-generation-2-virtual-machines-to-azure"></a>Можно ли реплицировать виртуальные машины Hyper-V второго поколения в Azure?
Да. Во время отработки отказа Site Recovery преобразует машины второго поколения в первое. При восстановлении размещения машина преобразуется обратно во второе поколение.

### <a name="can-i-automate-site-recovery-scenarios-with-an-sdk"></a>Можно ли автоматизировать сценарии Site Recovery с помощью пакета SDK?
Да. Рабочие процессы службы Site Recovery можно автоматизировать с помощью интерфейса REST API, PowerShell или пакета SDK для Azure. В настоящее время поддерживаются такие сценарии для репликации Hyper-V в Azure с помощью PowerShell:

- [репликация Hyper-V без VMM с использованием PowerShell](hyper-v-azure-powershell-resource-manager.md);
- [репликация Hyper-V с VMM с использованием PowerShell](hyper-v-vmm-powershell-resource-manager.md).

## <a name="replication"></a>Репликация

### <a name="where-do-on-premises-vms-replicate-to"></a>Куда реплицируются локальные виртуальные машины?
Данные реплицируются в хранилище Azure. При выполнении отработки Site Recovery автоматически создаст виртуальные машины Azure из учетной записи хранения.

### <a name="what-apps-can-i-replicate"></a>Какие приложения можно реплицировать?
Можно реплицировать любые приложения или рабочие нагрузки, выполняемые в виртуальной машине Hyper-V, которые соответствуют [требованиям к репликации](hyper-v-azure-support-matrix.md#replicated-vms). Служба Site Recovery также поддерживает репликацию уровня приложения, позволяя выполнять отработку отказа приложений и восстанавливать их размещение до программируемого состояния. Site Recovery интегрируется с приложениями Майкрософт, включая SharePoint, Exchange, Dynamics, SQL Server и Active Directory, а также тесно взаимодействует с решениями ведущих производителей, в том числе Oracle, SAP, IBM и Red Hat. [Подробнее](site-recovery-workload.md) о защите рабочей нагрузки.

### <a name="whats-the-replication-process"></a>Что представляет собой процесс репликации?

1. При запуске начальной репликации создается моментальный снимок виртуальной машины Hyper-V.
2. Виртуальные жесткие диски на виртуальной машине реплицируются по одному, пока все они не будут скопированы в Azure. В зависимости от размера виртуальной машины и пропускной способности сети это может занять некоторое время. Узнайте, как увеличить пропускную способность сети.
3. В случае возникновения изменений на диске при выполнении начальной репликации модуль отслеживания репликации реплики Hyper-V регистрирует их в журналах репликации Hyper-V (HRL), которые находятся в одной папке с дисками. С каждым диском связан HRL-файл, который отправляется в дополнительное хранилище. При начальной репликации файлы моментальных снимков и журналов потребляют ресурсы диска.
4. После завершения начальной репликации моментальный снимок виртуальной машины удаляется.
5. Любые изменения на диске в журнале синхронизируются и объединяются в родительском диске.
6. После завершения начальной репликации запускается задача "Завершить подготовку защиты на виртуальной машине". Она выполняет настройку сети и других параметров, действующих после репликации, для защиты виртуальной машины.
7. На этом этапе можно проверить параметры виртуальной машины, чтобы убедиться в ее готовности к отработке отказа. Вы можете запустить отработку аварийного восстановления (тестовая отработка отказа) для виртуальной машины, чтобы проверить правильность отработки отказа.
8. После начальной репликации начинается разностная репликация в соответствии с политикой репликации.
9. Изменения регистрируются в HRL-файлах. Для каждого диска, предназначенного для репликации, создается связанный HRL-файл.
10. Этот журнал передается в учетную запись хранения клиента. При передаче журнала в Azure изменения на основном диске фиксируются в дополнительном журнале, который находится в той же папке.
11. Во время и начальной, и разностной репликаций вы можете отслеживать состояние виртуальной машины на портале Azure.

[Дополнительные сведения](hyper-v-azure-architecture.md#replication-process) о процессе репликации.

### <a name="can-i-replicate-to-azure-with-a-site-to-site-vpn"></a>Можно выполнить репликацию через VPN-подключение "сеть — сеть" в Azure?

Site Recovery реплицирует данные из локальной среды в хранилище Azure через общедоступную конечную точку или с помощью общедоступного пиринга ExpressRoute. Репликация через VPN-подключение "сеть — сеть" не поддерживается.

### <a name="can-i-replicate-to-azure-with-expressroute"></a>Можно ли реплицировать в Azure с помощью ExpressRoute?

Да, ExpressRoute можно использовать для репликации виртуальных машин в Azure. Site Recovery реплицирует данные в учетную запись хранения Azure через общедоступную конечную точку. Для этого вам требуется настроить [общедоступный пиринг](../expressroute/expressroute-circuit-peerings.md#azure-public-peering). После отработки отказа виртуальных машин в виртуальную сеть Azure к ним можно получить доступ с помощью [частного пиринга](../expressroute/expressroute-circuit-peerings.md#azure-private-peering).


### <a name="why-cant-i-replicate-over-vpn"></a>Почему я не могу выполнить репликацию через VPN?

При репликации в Azure трафик репликации достигает общедоступных конечных точек учетной записи хранения Azure. Таким образом, репликацию можно выполнять только через общедоступный Интернет с помощью ExpressRoute (общедоступный пиринг), а VPN не будет работать. 

### <a name="what-are-the-replicated-vm-requirements"></a>Каковы требования к реплицируемой виртуальной машине?

Для репликации виртуальная машина Hyper-V должна работать под управлением поддерживаемой операционной системы. Кроме того, она должна соответствовать требованиям к виртуальным машинам Azure. [Дополнительные сведения см. в матрице поддержки.](hyper-v-azure-support-matrix.md#replicated-vms)

###<a name="how-often-can-i-replicate-to-azure"></a>Как часто можно выполнять репликацию в Azure?

Виртуальные машины Hyper-V можно реплицировать каждые 30 секунд (но не для хранилища класса Premium), 5 или 15 минут.

###<a name="can-i-extend-replication"></a>Можно ли расширить репликацию?
Расширенная репликация и цепочка репликации не поддерживаются. Запросите эту функцию на [форуме отзывов и предложений](http://feedback.azure.com/forums/256299-site-recovery/suggestions/6097959-support-for-exisiting-extended-replication).

### <a name="can-i-do-an-offline-initial-replication"></a>Можно ли выполнить начальную репликацию в автономном режиме?
Эта возможность не поддерживается. Запросите эту функцию на [форуме отзывов и предложений](http://feedback.azure.com/forums/256299-site-recovery/suggestions/6227386-support-for-offline-replication-data-transfer-from).

### <a name="can-i-exclude-disks"></a>Можно ли исключать диски?
Да, из репликации можно исключать диски. 

### <a name="can-i-replicate-vms-with-dynamic-disks"></a>Можно ли реплицировать виртуальные машины с динамическими дисками?
Динамические диски могут быть реплицированы. Диск операционной системы должен представлять собой базовый диск.



## <a name="security"></a>Безопасность

### <a name="what-access-does-site-recovery-need-to-hyper-v-hosts"></a>Какой доступ к узлам Hyper-V требуется Site Recovery?

Site Recovery требуется доступ к узлам Hyper-V для репликации выбранных виртуальных машин. Site Recovery устанавливает на узлах Hyper-V следующее:

- Если вы не используете VMM, на каждом узле устанавливаются поставщик Azure Site Recovery и агент служб восстановления.
- Если вы используете VMM, на каждом узле устанавливается агент служб восстановления. Поставщик запускается на сервере VMM.


### <a name="what-does-site-recovery-install-on-hyper-v-vms"></a>Что именно Site Recovery устанавливает на виртуальные машины Hyper-V?

Site Recovery явно не устанавливает ничего на виртуальных машинах Hyper-V, включенных для репликации.




## <a name="failover-and-failback"></a>Отработка отказа и восстановление размещения


### <a name="how-do-i-fail-over-to-azure"></a>Как мне выполнить отработку отказа в Azure?

Вы можете запустить плановую или внеплановую отработку отказа с локальных виртуальных машин Hyper-V в Azure.
    - Чтобы не допустить потери данных при выполнении плановой отработки отказа, выключите исходные виртуальные машины.
    - Вы можете выполнять незапланированную отработку отказа, если основной сайт недоступен.
    - Вы можете выполнить отработку отказа одного компьютера или создать планы восстановления для координации отработки отказа нескольких компьютеров.
    - Вы запускаете отработку отказа. По окончании ее первого этапа в Azure должны отобразиться созданные виртуальные машины реплик. При необходимости виртуальной машине можно назначить общедоступный IP-адрес. Затем требуется зафиксировать отработку отказа для получения доступа к рабочей нагрузке из виртуальной машины реплики Azure.
   

### <a name="how-do-i-access-azure-vms-after-failover"></a>Как получить доступ к виртуальным машина Azure после отработки отказа?
После отработки отказа доступ к виртуальным машинам Azure можно получить через безопасное подключение к Интернету, VPN-подключение "сеть — сеть" или с помощью Azure ExpressRoute. Для подключения потребуется выполнить несколько подготовительных действий. [Подробнее](site-recovery-test-failover-to-azure.md#prepare-to-connect-to-azure-vms-after-failover)

### <a name="is-failed-over-data-resilient"></a>Устойчивы ли данные, для которых была выполнена отработка отказа?
Среда Azure разработана для обеспечения отказоустойчивости. Служба Site Recovery рассчитана на отработку отказа в дополнительный центр обработки данных Azure в соответствии с соглашением об уровне обслуживания Azure. Когда происходит отработка отказа, Azure обеспечивает хранение метаданных и хранилищ в географическом регионе, выбранном для хранилища.

### <a name="is-failover-automatic"></a>Отработка отказа выполняется автоматически?
[Отработка отказа](site-recovery-failover.md) не выполняется автоматически. Чтобы активировать ее, необходимо щелкнуть в соответствующем месте на портале или воспользоваться [PowerShell](/powershell/module/azurerm.siterecovery).

### <a name="how-do-i-fail-back"></a>Как восстановить размещение?

Восстановив работоспособность локальной инфраструктуры, вы можете восстановить размещение. Восстановление размещения выполняется в три этапа:

1. Запустите плановую отработку отказа из Azure на локальный сайт, используя несколько различных вариантов.

    - Минимизировать простой. Если выбран этот параметр, Site Recovery синхронизирует данные перед отработкой отказа. Эта система проверяет наличие измененных блоков данных и скачивает их на локальный сайт, при этом виртуальная машина Azure продолжает работать, что сводит время простоя к минимуму. Если вы вручную указываете, что требуется выполнение отработки отказа, завершается работа виртуальной машины Azure, копируются все окончательные разностные изменения и начинается отработка отказа.
    - Скачать полностью. Если выбран этот параметр, данные синхронизируются во время отработки отказа. При этом скачивается весь диск. В этом случае работа идет быстрее, так как не нужно вычислять контрольные суммы, однако увеличивается время простоя. Используйте этот параметр, если вы уже некоторое время работаете с виртуальными машинами Azure реплики или была удалена локальная виртуальная машина.

2. Этот параметр можно выбрать, чтобы восстановить размещение в той же или другой виртуальной машине. Вы можете указать, что системе Site Recovery следует создать виртуальную машину, если она еще не существует.
3. После завершения начальной синхронизации вы решаете выполнить отработку отказа. После ее завершения вы можете войти в локальную виртуальную машину, чтобы проверить, правильно ли работают все компоненты. На портале Azure видно, что виртуальные машины Azure остановлены.
4. Вы фиксируете отработку отказа для завершения и снова получаете доступ к рабочей нагрузке из локальной виртуальной машины.
5. После отработки отказа рабочих нагрузок вы включаете обратную репликацию, чтобы локальные виртуальные машины снова реплицировались в Azure.

### <a name="can-i-fail-back-to-a-different-location"></a>Можно ли выполнить восстановление размещения в другое расположение?
Да, если отработка отказа выполнена в Azure, можно восстановить размещение в другом расположении, если изначальное расположение недоступно. [Узнайте больше](hyper-v-azure-failback.md#failback-to-an-alternate-location-in-hyper-v-environment).



