---
title: Репликация виртуальных машин Azure Stack в Azure с помощью Azure Site Recovery | Документация Майкрософт
description: Узнайте, как настраивать аварийное восстановление в Azure для виртуальных машин Azure Stack с помощью службы Azure Site Recovery.
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.topic: conceptual
ms.service: site-recovery
ms.date: 08/30/2018
ms.author: raynew
ms.openlocfilehash: c71f683355a09c8ba2381db406eeb1ccabdb7afa
ms.sourcegitcommit: cb61439cf0ae2a3f4b07a98da4df258bfb479845
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/05/2018
ms.locfileid: "43697702"
---
# <a name="replicate-azure-stack-vms-to-azure-preview"></a>Репликация виртуальных машин Azure Stack в Azure (предварительная версия)

В этой статье показано, как настроить аварийное восстановление в Azure для виртуальных машин Azure Stack с помощью [службы Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-overview).

Служба Site Recovery помогает реализовать стратегию непрерывности бизнес-процессов и аварийного восстановления (BCDR). Служба гарантирует, что рабочие нагрузки ваших виртуальных машин остаются доступными, когда происходят ожидаемые и неожиданные сбои.

- Site Recovery оркеструет репликацию виртуальных машин в хранилище Azure и управляет ею.
- Когда происходит сбой на вашем основном сайте, используйте Site Recovery, чтобы выполнить отработку отказа в Azure.
- При отработке отказа виртуальные машины Azure создаются на основе сохраненных данных, и пользователи могут и дальше получать доступ к рабочим нагрузкам, запущенным на этих виртуальных машинах Azure.
- Когда все снова будет настроено и запущено, вы можете восстановить размещение виртуальных машин Azure на основном сайте и снова начать репликацию в хранилище Azure.


> [!NOTE]
> Site Recovery для Azure Stack в настоящее время находится в общедоступной предварительной версии.


В этой статье раскрываются следующие темы:

> [!div class="checklist"]
> * **Шаг 1. Подготовка репликации виртуальных машин Azure Stack**. Убедитесь, что виртуальные машины соответствуют требованиям Site Recovery, и подготовьте их к установке службы Site Recovery Mobility. Она устанавливается на каждой виртуальной машине, которую нужно реплицировать.
> * **Шаг 2. Настройка хранилища Служб восстановления**. Настройте хранилище для Site Recovery и укажите, что вы хотите реплицировать. Компоненты и действия Site Recovery настраиваются и управляются в хранилище.
> * **Шаг 3. Настройка исходной среды репликации**. Настройте сервер конфигурации Site Recovery. Сервер конфигурации представляет собой единую виртуальную машину Azure Stack, где выполняются все компоненты, необходимые для Site Recovery. После настройки сервера конфигурации зарегистрируйте его в хранилище.
> * **Шаг 4. Настройка целевой среды репликации**. Выберите свою учетную запись Azure, учетную запись хранения Azure и сеть, которые вы хотите использовать. Во время репликации данные виртуальной машины копируются в службу хранилища Azure. После отработки отказа виртуальные машины Azure подключаются к указанной сети.
> * **Шаг 5. Включение репликации**. Настройте параметры репликации и включите репликацию виртуальных машин. Служба Mobility будет установлена ​​на виртуальную машину, когда репликация включена. Site Recovery выполняет начальную репликацию виртуальной машины, а затем начинается текущая репликация.
> * **Шаг 6. Выполнение тестового аварийного восстановления**. После настройки и запуска репликации убедитесь, что отработка отказа будет работать правильно, выполнив тестовую отработку. Для этого запустите тестовую отработку отказа в Site Recovery. Тестовая отработка отказа не влияет на рабочую среду.

По завершении этих шагов вы сможете запускать полную отработку отказа Azure по мере необходимости.

## <a name="architecture"></a>Архитектура

![Архитектура](./media/azure-stack-site-recovery/architecture.png)

**Местоположение.** | **Компонент** |**Дополнительные сведения**
--- | --- | ---
**Сервер конфигурации** | Выполняется на одной виртуальной машине Azure Stack. | В каждой подписке настройте виртуальную машину сервера конфигурации. Эта виртуальная машина запускает следующие компоненты Site Recovery:<br/><br/> Сервер конфигурации используется для управления обменом данными между локальной средой и Azure, а также репликацией данных. Сервер обработки выступает в качестве шлюза репликации. Он получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования и отправляет эти данные в службу хранилища Azure.<br/><br/> Если виртуальные машины, которые вы хотите реплицировать, превышают ограничения, указанные ниже, вы можете настроить отдельный автономный сервер обработки. [Узнайте больше](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-process-server-scale).
**Служба Mobility Service** | Устанавливается на каждой виртуальной машине, которую нужно реплицировать. | В шагах в этой статье мы подготавливаем учетную запись, чтобы служба Mobility была установлена ​​автоматически на виртуальной машине, когда репликация включена. Если вы не хотите автоматически устанавливать службу, существует ряд других методов, которые можно использовать. [Узнайте больше](https://docs.microsoft.com/azure/site-recovery/vmware-azure-install-mobility-service).
**Таблицы Azure** | В Azure вам необходимо хранилище Служб восстановления, учетная запись хранения и виртуальная сеть. |  Реплицированные данные хранятся в учетной записи хранения. Виртуальные машины Azure добавляются в сеть Azure при отработке отказа. 


Репликация работает следующим образом:

1. В хранилище нужно указать источник и целевой объект репликации, настроить сервер конфигурации, создать политику репликации и включить репликацию.
2. Служба Mobility устанавливается ​​на компьютере (если вы использовали принудительную установку), и компьютеры выполняют репликацию в соответствии с политикой репликации.
3. Начальная копия данных сервера реплицируется в службу хранилища Azure.
4. После завершения начальной репликации начинается репликация разностных изменений в Azure. Отслеживаемые изменения для компьютера хранятся в HRL-файле.
5. Сервер конфигурации выполняет оркестрацию управления репликацией с Azure (через порт HTTPS 443 для исходящих подключений).
6. Сервер обработки получает данные с исходных компьютеров, оптимизирует и зашифровывает их, а затем отправляет в службу хранилища Azure (через порт 443 для исходящих подключений).
7. Реплицируемые компьютеры обмениваются данными с сервером конфигурации (через порт HTTPS 443 для входящих подключений) для управления репликацией. Компьютеры отправляют данные репликации на сервер обработки через порт HTTPS 9443 для входящих подключений (можно изменить).
8. Трафик реплицируется в общедоступные конечные точки службы хранилища Azure через Интернет. Кроме того, можно использовать общедоступный пиринг Azure ExpressRoute. Репликация трафика через VPN типа "сеть — сеть" с локального сайта в Azure не поддерживается.

## <a name="prerequisites"></a>Предварительные требования

Для настройки этого сценария вам потребуются следующие компоненты:

**Требование** | **Дополнительные сведения**
--- | ---
**Учетная запись подписки Azure** | Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial/).
**Разрешения учетной записи Azure** | Используемой учетной записи Azure должны быть предоставлены разрешения на:<br/><br/> — создание хранилища Служб восстановления;<br/><br/> — создание виртуальной машины в группе ресурсов и виртуальной сети, используемой в сценарии;<br/><br/> — запись в выбранной учетной записи хранения.<br/><br/> Обратите внимание на следующее.<br/><br/> — Если вы создаете учетную запись, вы являетесь администратором своей подписки и можете выполнять любые действия.<br/><br/> — Если вы используете существующую подписку, в которой не являетесь администратором, администратор должен назначить вам права владельца или участника.<br/><br/> — Если вам требуются более детализированные разрешения, ознакомьтесь с [этой статьей](https://docs.microsoft.com/azure/site-recovery/site-recovery-role-based-linked-access-control). 
**Виртуальная машина Azure Stack** | В подписке клиента вам потребуется виртуальная машина Azure Stack, которая будет развернута в качестве сервера конфигурации Site Recovery. 


### <a name="prerequisites-for-the-configuration-server"></a>Предварительные требования для сервера конфигурации

[!INCLUDE [site-recovery-config-server-reqs-physical](../../includes/site-recovery-config-server-reqs-physical.md)]


 
## <a name="step-1-prepare-azure-stack-vms"></a>Шаг 1. Подготовка виртуальных машин Azure Stack

### <a name="verify-the-operating-system"></a>Проверка операционной системы

Убедитесь, что виртуальные машины работают с одной из операционных систем, указанных в таблице.


**Операционная система** | **Дополнительные сведения**
--- | ---
**64-разрядная версия Windows** | Windows Server 2016, Windows Server 2012 R2, Windows Server 2012, Windows Server 2008 R2 (с пакетом приложения 1)
**CentOS** | 5.2–5.11, 6.1–6.9, 7.0–7.3
**Ubuntu** | Сервер LTS версии 14.04 или 16.04. Просмотрите список [поддерживаемых ядер](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#ubuntu-kernel-versions)

### <a name="prepare-for-mobility-service-installation"></a>Подготовка к установке службы Mobility Service

На все виртуальные машины, которые требуется реплицировать, необходимо установить службу Mobility. Чтобы сервер обработки мог автоматически установить службу на виртуальной машине при включенной репликации, проверьте параметры виртуальной машины.

#### <a name="windows-machines"></a>Компьютеры Windows

- Вам нужно сетевое подключение между виртуальной машиной, на которой вы хотите включить репликацию, и машиной, на которой запущен сервер обработки (по умолчанию это виртуальная машина сервера конфигурации).
- Вам нужна учетная запись с правами администратора (доменная или локальная) на компьютере, для которого вы включаете репликацию.
    - Вам потребуется указать эту учетную запись при настройке Site Recovery. Затем сервер обработки использует эту учетную запись для установки службы Mobility, когда репликация включена.
    - Эта учетная запись будет использоваться службой Site Recovery только для принудительной установки и обновления службы Mobility.
    - Если учетная запись домена не используется, на виртуальной машине потребуется отключить контроль удаленного доступа пользователей.
        - В реестре создайте значение DWORD **LocalAccountTokenFilterPolicy** в разделе HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System.
        - Присвойте ему значение 1.
        - Для этого в командной строке введите следующую команду: **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System Добавьте REG /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1**.
- В брандмауэре Windows на виртуальной машине, которую требуется реплицировать, разрешите общий доступ к файлам и принтерам и инструментарий WMI.
    - Для этого выполните **wf.msc**, чтобы открыть консоль брандмауэра Windows. Щелкните правой кнопкой мыши **Правила для входящих подключений** > **Новое правило**. Щелкните **Предопределенные** и выберите пункт **общего доступа к файлам и принтерам** в списке. Завершите работу мастера, разрешите подключение и нажмите кнопку **Готово**.
    - Для компьютеров домена для этого можно использовать объект групповой политики.

    
#### <a name="linux-machines"></a>Компьютеры Linux

- Убедитесь, что между компьютером Linux и сервером обработки установлено сетевое подключение.
- На компьютере, для которого вы включаете репликацию, необходима учетная запись, которая принадлежит привилегированному пользователю на исходном сервере Linux:
    - Вам потребуется указать эту учетную запись при настройке Site Recovery. Затем сервер обработки использует эту учетную запись для установки службы Mobility, когда репликация включена.
    - Эта учетная запись будет использоваться службой Site Recovery только для принудительной установки и обновления службы Mobility.
- Убедитесь, что файл /etc/hosts на исходном сервере Linux содержит записи, которые связывают имя локального узла с IP-адресами всех сетевых адаптеров.
- Установите на реплицируемом компьютере последние версии пакетов openssh, openssh-server и openssl.
- Убедитесь, что протокол Secure Shell (SSH) включен и работает через порт 22.
- Включите подсистему SFTP и аутентификацию на основе пароля в файле sshd_config.
    1. Для этого войдите как привилегированный пользователь.
    2. В файле /etc/ssh/sshd_config найдите строку, которая начинается с **PasswordAuthentication**. Раскомментируйте строку и измените значение на **yes**.
    3. Найдите строку, которая начинается с **Subsystem**, и раскомментируйте ее.

        ![Служба Mobility в Linux](./media/azure-stack-site-recovery/linux-mobility.png)

    4. Перезапустите службу SSHD.


### <a name="note-the-vm-private-ip-address"></a>Запишите частный IP-адрес виртуальной машины

Для каждой машины, которую требуется реплицировать, найдите IP-адрес:

1. На портале Azure Stack щелкните виртуальную машину.
2. В меню **Ресурсы** щелкните **Сетевые интерфейсы**.
3. Запишите частный IP-адрес.

    ![Частный IP-адрес](./media/azure-stack-site-recovery/private-ip.png)


## <a name="step-2-create-a-vault-and-select-a-replication-goal"></a>Шаг 2. Создание хранилища и выбор цели репликации

1. На портале Azure выберите **Создать ресурс** > **Мониторинг и управление** > **Backup and Site Recovery** (Backup и Site Recovery).
2. В поле **Имя**введите понятное имя для идентификации хранилища. 
3. В поле **Группа ресурсов** создайте или выберите группу ресурсов. Мы используем **contosoRG**.
4. В поле **Расположение** введите регион Azure. выбираем значение **Западная Европа**.
5. Для быстрого доступа к новому хранилищу с панели мониторинга выберите **Закрепить на панели мониторинга** > **Create** (Создать).

   ![Создание хранилища](./media/azure-stack-site-recovery/new-vault-settings.png)

   Новое хранилище появится в колонке **Dashboard** (Панель мониторинга)  > **All resources** (Все ресурсы) и на основной странице **Хранилища служб восстановления**.

### <a name="select-a-replication-goal"></a>Выбор цели репликации

1. В колонке **Хранилища служб восстановления** укажите имя хранилища. Мы используем **ContosoVMVault**.
2. В разделе **Приступая к работе** выберите Site Recovery. Затем выберите **Подготовка инфраструктуры**.
3. Выберите **Protection goal** (Цель защиты)  > **Where are your machines located** (Где находятся компьютеры?), а затем — **On-premises** (Локально).
4. В разделе **Куда следует реплицировать компьютеры?** выберите **To Azure** (В Azure).
5. В разделе **Ваши компьютеры виртуализированы?** выберите **Без виртуализации или иное**. Нажмите кнопку **ОК**.

    ![Цель защиты](./media/azure-stack-site-recovery/protection-goal.png)

## <a name="step-3-set-up-the-source-environment"></a>Шаг 3. Настройка исходной среды

Настройте сервер конфигурации, зарегистрируйте его в хранилище и найдите виртуальные машины для репликации.

1. Выберите **Подготовка инфраструктуры** > **Источник**.
2. В разделе **Prepare source** (Подготовка источника) щелкните **+ Configuration Server** (+ Сервер конфигурации).

    ![Настройка источника](./media/azure-stack-site-recovery/plus-config-srv.png)

3. В колонке **Добавление сервера** в поле **Тип сервера** должно быть указано **Сервер конфигурации**.
5. Скачайте файл единой установки Site Recovery.
6. Скачайте ключ регистрации хранилища. При запуске программы единой установки вам потребуется ключ регистрации. Ключ действителен в течение пяти дней после создания.

    ![Настройка источника](./media/azure-stack-site-recovery/set-source2.png)


### <a name="run-azure-site-recovery-unified-setup"></a>Выполнение единой установки Azure Site Recovery

Чтобы установить и зарегистрировать сервер конфигурации, выполните RDP-подключение к виртуальной машине, которую вы хотите использовать для сервера конфигурации, и запустите единую установку.

Перед началом работы убедитесь, что часы на виртуальной машине [синхронизированы с сервером времени](https://technet.microsoft.com/windows-server-docs/identity/ad-ds/get-started/windows-time-service/windows-time-service). Если время отличается от местного более чем на пять минут, то регистрация завершится сбоем.

Теперь можно установить сервер конфигурации:

[!INCLUDE [site-recovery-add-configuration-server](../../includes/site-recovery-add-configuration-server.md)]

> [!NOTE]
> Сервер конфигурации можно также установить с помощью командной строки. [Узнайте больше](http://aka.ms/installconfigsrv).

> Имя учетной записи появится на портале через 15 (или больше) минут. Чтобы выполнить обновление немедленно, выберите **Серверы конфигурации** > ***имя сервера*** > **Обновить сервер**.

## <a name="step-4-set-up-the-target-environment"></a>Шаг 4. Настройка целевой среды

Выберите и проверьте целевые ресурсы.

1. В разделе **Подготовка инфраструктуры** > **Цель** выберите требуемую подписку Azure.
2. Укажите целевую модель развертывания.
3. Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure. Если она не находит их, вам необходимо создать хотя бы одну учетную запись и виртуальную сеть для завершения работы мастера.


## <a name="step-5-enable-replication"></a>Шаг 5. Включение репликации

### <a name="create-a-replication-policy"></a>Создание политики репликации

1. Щелкните **Prepare infrastructure** (Подготовка инфраструктуры) > **Параметры репликации**.
2. На странице **Создать политику репликации** укажите имя политики.
3. В разделе **Пороговое значение RPO** укажите ограничение целевой точки восстановления (RPO).
    - Точки восстановления для реплицируемых данных создаются в соответствии с заданным временем.
    - Этот параметр не влияет на репликацию, которая выполняется непрерывно. Он просто выдает предупреждение, если пороговое ограничение достигается без создания точки восстановления.
4. В поле **Хранение точки восстановления** укажите, сколько времени нужно хранить каждую точку восстановления. Реплицированные виртуальные машины можно восстановить до любой точки в рамках указанного периода времени.
5. В поле **Периодичность создания моментальных снимков с согласованием приложений** укажите, с какой периодичностью будут создаваться моментальные снимки, согласованные на уровне приложений.

    - Моментальный снимок с согласованием приложений представляет собой созданный на определенный момент времени снимок данных приложения в виртуальной машине.
    - Служба теневого копирования томов (VSS) обеспечивает согласованное состояние приложения в виртуальной машине при создании моментального снимка.
6. Нажмите кнопку **OK**, чтобы создать политику.


### <a name="confirm-deployment-planning"></a>Подтверждение планирования развертывания

Пока этот шаг можно пропустить. В раскрывающемся списке **Планирование развертывания** выберите **Yes, I have done it** (Да, выполнено).



### <a name="enable-replication"></a>Включение репликации

Убедитесь, что вы завершили все задачи из раздела [Шаг 1. Подготовка компьютера](#step-1-prepare-azure-stack-vms). Включите репликацию следующим образом:

1. Выберите **Репликация приложения** > **Источник**.
2. В колонке **Источник** выберите нужный сервер конфигурации.
3. В поле **Тип компьютера** выберите параметр **Физические компьютеры**.
4. Выберите сервер обработки (сервер конфигурации). Нажмите кнопку **ОК**.
5. В поле **Цель** выберите подписку и группу ресурсов, в которых вы хотите создавать виртуальные машины после отработки отказа. Выберите модель развертывания, которая будет использоваться для виртуальных машин после отработки отказа.
6. Выберите учетную запись хранения Azure, в которой вы хотите хранить реплицированные данные.
7. Выберите сеть и подсеть Azure для подключения виртуальных машин Azure, созданных после отработки отказа.
8. Выберите **Настроить сейчас для всех выбранных компьютеров**, чтобы применить параметр сети ко всем защищаемым компьютерам. Выберите **Отложить настройку**, если вы хотите выбрать сеть Azure отдельно для каждого компьютера.
9. В разделе **Физические компьютеры** щелкните **+Physical machine** (+Физический компьютер). Укажите имя IP-адреса каждого компьютера и операционной системы, которую требуется реплицировать.

    - Используйте внутренний IP-адрес компьютера.
    - Если указать общедоступный IP-адрес, репликация может не работать должным образом.

10. В разделе **Свойства** > **Настройка свойств** выберите учетную запись, которая будет использоваться сервером обработки для автоматической установки службы Mobility Service на компьютере.
11. Выберите **Параметры репликации** > **Настройка параметров репликации** и убедитесь, что выбрана правильная политика репликации.
12. Щелкните **Включить репликацию**.
13. Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Параметры** > **Задания** > **Site Recovery Jobs** (Задания Site Recovery). После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.

> [!NOTE]
> Site Recovery установит службу Mobility Service, если репликация включена для виртуальной машины.

> Может пройти более 15 минут, прежде чем изменения вступят в силу и появятся на портале.

> Для мониторинга добавляемых виртуальных машин укажите последнее время обнаружения, выбрав **Серверы конфигурации** > **Последний контакт в**. Чтобы добавить виртуальные машины, не дожидаясь запланированного обнаружения, выделите сервер конфигурации (не выбирая его) и нажмите кнопку **Обновить**.


## <a name="step-6-run-a-disaster-recovery-drill"></a>Шаг 6. Выполнение тестового аварийного восстановления в Azure

Запустите тестовую отработку отказа в Azure, чтобы убедиться в надлежащей работе всех компонентов. Эта отработка отказа не влияет на рабочую среду.

### <a name="verify-machine-properties"></a>Проверка свойств виртуальной машины

Перед запуском тестовой отработки отказа проверьте свойства виртуальной машины и убедитесь, что виртуальная машина соответствует [требованиям Azure](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#azure-vm-requirements). Можно просмотреть и изменить свойства следующим образом:

1. В разделе **Защищенные элементы** щелкните **Реплицированные элементы** и выберите виртуальную машину.
2. В области **Реплицированный элемент** находятся сводные данные о виртуальной машине, включая состояние работоспособности и последние доступные точки восстановления. Щелкните **Свойства**, чтобы просмотреть дополнительные сведения.
3. В разделе **Вычисления и сеть** измените необходимые параметры.

    - Можно изменить имя виртуальной машины Azure, группу ресурсов, целевой размер, [группу доступности](../virtual-machines/windows/tutorial-availability-sets.md) и параметры управляемого диска.
    - Можно также просмотреть и изменить параметры сети. К ним относятся сеть и подсеть, к которым присоединяется виртуальная машина Azure после отработки отказа, и IP-адрес, который будет назначен виртуальной машине.
1. В разделе **Диски** отображаются сведения о дисках операционной системы и дисках данных на виртуальной машине.
   

### <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа

При запуске тестовой отработки отказа происходит следующее:

1. выполняется проверка на соблюдение всех необходимых условий для отработки отказа;
2. Операция отработки отказа обрабатывает данные с помощью указанной точки восстановления:
    - **Последняя обработанная.** Отработка отказа выполняется до последней точки восстановления компьютера, которая была обработана Site Recovery. Для нее отображается метка времени. Этот вариант не требует времени на обработку данных, обеспечивая низкий показатель целевого времени восстановления.
    - **Последняя точка во времени согласованности приложений**. Отработка отказа виртуальной машины выполняется до последней точки восстановления с согласованным состоянием приложений.
    - **Настраиваемая**. Выберите точку восстановления, используемую для отработки отказа.

3. Виртуальная машина Azure создается с использованием обработанных данных.
4. Тестовая отработка отказа автоматически очищает созданные во время ее выполнения виртуальные машины Azure.

Запустите тестовую отработку отказа для виртуальной машины следующим образом:

1. В разделе **Параметры** > **Реплицированные элементы** выберите виртуальную машину и щелкните **+Тестовая отработка отказа**.
2. В этом пошаговом руководстве выберите **последнюю отработанную** точку восстановления. 
3. В разделе **Тестовая отработка отказа** выберите целевую сеть Azure.
4. Нажмите кнопку **ОК** , чтобы запустить отработку отказа.
5. За ходом выполнения можно следить в окне свойств, которое можно открыть, щелкнув виртуальную машину. Также можно щелкнуть задание **Тестовая отработка отказа** в разделе *Имя хранилища* > **Параметры** > **Задания** >**Задания Site Recovery**.
6. Когда отработка отказа завершится, на вкладке **Виртуальные машины** портала Azure появится реплика виртуальной машины. Они проверяют, работает ли виртуальная машина, имеет ли она соответствующий размер и подключена ли к соответствующей сети.
7. Теперь вы можете подключиться к реплицированной виртуальной машине в Azure. [Узнайте больше](https://docs.microsoft.com/azure/site-recovery/site-recovery-test-failover-to-azure#prepare-to-connect-to-azure-vms-after-failover).
8. Чтобы удалить виртуальные машины Azure, созданные во время тестовой отработки отказа, щелкните **Очистить тестовую отработку отказа** на виртуальной машине. При необходимости в разделе **Примечания** можно сохранить ваши наблюдения касательно тестовой отработки отказа.

## <a name="fail-over-and-fail-back"></a>Отработка отказа и восстановление размещения

После того как вы настроили репликацию и запустили тестовую отработку, чтобы убедиться, что все работает, вы можете выполнять отработку отказа в Azure по мере необходимости.

Если вы хотите подключиться к компьютеру в Azure после отработки отказа, [подготовьтесь к этому](https://docs.microsoft.com/azure/site-recovery/site-recovery-test-failover-to-azure#prepare-to-connect-to-azure-vms-after-failover), прежде чем запустить отработку отказа.

Запустите отработку отказа, выполнив следующую команду:


1. В разделе **Параметры** > **Реплицированные элементы** выберите компьютер и щелкните **Отработка отказа**.
2. Выберите точку восстановления, которую следует использовать.
3. В разделе **Тестовая отработка отказа** выберите целевую сеть Azure.
4. Выберите **Завершение работы виртуальной машины перед началом отработки отказа**. Если этот параметр включен, Site Recovery попытается завершить работу исходного компьютера перед запуском отработки отказа. Однако отработка отказа продолжится, даже если их не удастся отключить. 
5. Нажмите кнопку **ОК** , чтобы запустить отработку отказа. На странице **Задания** можно следить за ходом выполнения отработки отказа.
6. Когда отработка отказа завершится, на вкладке **Виртуальные машины** портала Azure появится реплика виртуальной машины. Если настроили подключение после отработки отказа, проверьте, работает ли виртуальная машина, имеет ли она соответствующий размер и подключена ли к соответствующей сети.
7. Затем нажмите кнопку **Зафиксировать**, чтобы завершить отработку отказа. При этом будут удалены все доступные точки восстановления.

> [!WARNING]
> Не отменяйте выполняющуюся отработку отказа. Перед запуском отработки отказа останавливается репликация виртуальной машины. Если отменить выполняющуюся отработку отказа, она остановится, но виртуальная машина не будет реплицирована повторно.


### <a name="fail-back-to-azure-stack"></a>Восстановление размещения в Azure Stack

Когда первичный сайт восстановится и заработает, можно восстановить размещение из Azure в Azure Stack. Чтобы сделать это, необходимо загрузить виртуальный жесткий диск виртуальной машины Azure и отправить его в Azure Stack.

1. Завершите работу виртуальной машины Azure, чтобы можно было загрузить виртуальный жесткий диск. 
2. Чтобы начать загрузку виртуального жесткого диска, установите [Обозреватель службы хранилища Azure](https://azure.microsoft.com/features/storage-explorer/).
3. Перейдите к виртуальной машине (с использованием ее имени) на портале Azure.
4. В разделе **Диски** щелкните имя диска и выберите параметры.

    - Например, URI виртуального жесткого диска, используемый в тесте (https://502055westcentralus.blob.core.windows.net/wahv9b8d2ceb284fb59287/copied-3676553984.vhd), можно разделить для получения следующих входных параметров, используемых для скачивания виртуального жесткого диска.
        - Учетная запись хранения: 502055westcentralus.
        - Контейнер: wahv9b8d2ceb284fb59287.
        - Имя виртуального жесткого диска: copied-3676553984.vhd.

5. Теперь можно использовать Обозреватель службы хранилища Azure, чтобы скачать виртуальный жесткий диск.
6. Передайте виртуальный жесткий диск в Azure Stack с помощью [этих действий](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-manage-vm-disks#use-powershell-to-add-multiple-unmanaged-disks-to-a-vm).
7. На существующей или новой виртуальной машине подключите переданные виртуальные жесткие диски.
8. Убедитесь, что диск ОС правильный, и запустите виртуальную машину.


На этом этапе восстановление размещения будет завершено.


## <a name="conclusion"></a>Заключение

В этой статье мы реплицировали виртуальные машины Azure Stack в Azure. Настроив репликацию, мы выполнили тестовое аварийное восстановление, чтобы убедиться в том, что отработка отказа в Azure работает ожидаемым образом. В этой статье также описаны шаги для выполнения полной отработки отказа в Azure и восстановления размещения в Azure Stack.

## <a name="next-steps"></a>Дополнительная информация

После восстановления размещения можно повторно включить защиту виртуальной машины и начать ее репликацию в Azure еще раз. Чтобы сделать это, повторите действия, описанные в этой статье.

