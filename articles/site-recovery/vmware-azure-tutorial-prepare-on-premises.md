---
title: Подготовка локальных серверов VMware для аварийного восстановления виртуальных машин VMware в Azure | Документация Майкрософт
description: Узнайте, как подготовить локальные сервера VMware для аварийного восстановления виртуальных машин VMware в Azure с помощью службы Azure Site Recovery.
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: tutorial
ms.date: 07/06/2018
ms.author: raynew
ms.custom: MVC
ms.openlocfilehash: facf8895770f890bfbbef946a32cc681f685e998
ms.sourcegitcommit: a06c4177068aafc8387ddcd54e3071099faf659d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2018
ms.locfileid: "37915208"
---
# <a name="prepare-on-premises-vmware-servers-for-disaster-recovery-to-azure"></a>Подготовка локальных серверов VMware для аварийного восстановления в Azure

Служба [Azure Site Recovery](site-recovery-overview.md) помогает реализовать стратегию непрерывности бизнес-процессов и аварийного восстановления (BCDR), обеспечивая работоспособность бизнес-приложений во время запланированных и незапланированных простоев. Site Recovery управляет аварийным восстановлением локальных компьютеров и виртуальных машин Azure, включая операции репликации, отработки отказа и восстановления.

- Это второе руководство в серии, в которой показано, как настроить аварийное восстановление для локальных виртуальных машин VMware в Azure. В [первом руководстве](tutorial-prepare-azure.md) рассмотрена настройка компонентов Azure, необходимых для аварийного восстановления VMware.
- В руководствах приводится самый простой способ развертывания для сценария. В них везде, где возможно, используются значения по умолчанию, и описаны не все возможные параметры и пути. 

В этой статье показано, как подготовить локальную среду VMware для репликации виртуальных машин VMware в Azure с помощью Azure Site Recovery. Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Подготовить учетную запись сервера vCenter или узла vSphere ESXi, чтобы автоматизировать виртуальную машину.
> * Подготовить учетную запись для автоматической установки службы Mobility Service на виртуальные машины VMware.
> * Проверка сервера VMware и требований виртуальной машины
> * Подготовка к подключению виртуальных машин Azure после отработки отказа



## <a name="prepare-an-account-for-automatic-discovery"></a>Подготовка учетной записи для автоматического обнаружения

Site Recovery требуется доступ к серверам VMware, чтобы:

- Автоматически обнаруживать виртуальные машины. Требуется по крайней мере учетная запись только для чтения.
- Управлять репликацией, отработкой отказа и восстановлением размещения. Необходима учетная запись, которая позволяет выполнять операции, такие как создание и удаление дисков и включение виртуальных машин.

Создайте учетную запись следующим образом:

1. Чтобы использовать выделенную учетную запись, создайте роль на уровне vCenter. Присвойте роли имя, например **Azure_Site_Recovery**.
2. Назначьте роли разрешения, представленные в следующей таблице.
3. Создайте пользователя на сервере vCenter или узле vSphere. Назначьте роль для пользователя.

### <a name="vmware-account-permissions"></a>Разрешения учетной записи VMware

**Задача.** | **Роль/Разрешения** | **Дополнительные сведения**
--- | --- | ---
**Обнаружение виртуальных машин** | Пользователь только для чтения (минимум).<br/><br/> Объект центра обработки данных –> Распространение на дочерний объект, роль Read-only | Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.<br/><br/> Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Propagate to child** (Распространить на дочерний объект).
**Полная репликация, отработка отказа, восстановление размещения** |  Создайте роль VMware (Azure_Site_Recovery) с необходимыми разрешениями и назначьте эту роль пользователю или группе VMware.<br/><br/> Объект центра обработки данных –> распространение на дочерний объект, роль Azure_Site_Recovery<br/><br/> Хранилище данных -> выделение места, обзор хранилища данных, низкоуровневые операции с файлами, удаление файлов, обновление файлов виртуальной машины<br/><br/> Сеть -> Назначение сети<br/><br/> Ресурс -> назначение виртуальной машины в пул ресурсов, миграция отключенной виртуальной машины, миграция включенной виртуальной машины<br/><br/> Задачи -> Создание задач, Обновление задач<br/><br/> Виртуальная машина -> конфигурация<br/><br/> Виртуальная машина -> взаимодействие -> ответ на вопрос, подключение устройства, настройка компакт-диска носителя, настройка дискеты носителя, отключение, включение, установка средств VMware<br/><br/> Виртуальная машина -> инвентаризация -> создание, регистрация, отмена регистрации<br/><br/> Виртуальная машина -> подготовка -> разрешение загрузки виртуальной машины, разрешение отправки файлов виртуальной машины<br/><br/> виртуальная машина -> моментальные снимки -> удаление моментальных снимков. | Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.<br/><br/> Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Propagate to child** (Распространить на дочерний объект).

## <a name="prepare-an-account-for-mobility-service-installation"></a>Подготовка учетной записи к установке службы Mobility Service

На компьютерах, которые нужно реплицировать, должна быть установлена служба Mobility Service. Site Recovery может выполнить принудительную установку этой службы, если будет включена репликация для этого компьютера, или ее можно установить вручную или с помощью инструментов установки.

- В этом руководстве рассматривается принудительная установка службы Mobility Service.
- Для принудительной установки необходимо подготовить учетную запись, которую Site Recovery сможет использовать для доступа к виртуальной машине. Укажите эту учетную запись при настройке аварийного восстановления в консоли Azure.

Подготовьте учетную запись описанным ниже способом.

Подготовьте домен или локальную учетную запись с этими разрешениями для установки на виртуальной машине.

- **Виртуальные машины Windows**. Если при установке Windows на виртуальные машины не используется учетная запись домена, отключите контроль удаленного доступа пользователей на локальном компьютере. Для этого в разделе реестра > **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System** добавьте запись DWORD **LocalAccountTokenFilterPolicy** и задайте для нее значение 1.
- **Виртуальные машины Linux**. Для установки Linux на виртуальные машины необходимо подготовить учетную запись суперпользователя на исходном сервере Linux.


## <a name="check-vmware-requirements"></a>Проверка соответствия требованиям к VMware

Убедитесь, что серверы и виртуальные машины VMware соответствуют требованиям.

1. [Проверьте](vmware-physical-azure-support-matrix.md#on-premises-virtualization-servers) соответствие требованиям сервера VMware.
2. Если вы используете виртуальные машины Linux, [проверьте](vmware-physical-azure-support-matrix.md#linux-file-systemsguest-storage) соответствие требованиям к файловой системе и хранилищу. 
3. Проверьте поддержку локальных [сетей](vmware-physical-azure-support-matrix.md#network) и [хранилищ](vmware-physical-azure-support-matrix.md#storage). 
4. Проверьте возможности, которые поддерживаются для [сети Azure](vmware-physical-azure-support-matrix.md#azure-vm-network-after-failover), [хранилища](vmware-physical-azure-support-matrix.md#azure-storage) и [вычислительных ресурсов](vmware-physical-azure-support-matrix.md#azure-compute) после отработки отказа.
5. Локальные виртуальные машины, которые реплицируются в Azure, должны соответствовать [требованиям к виртуальным машинам Azure](vmware-physical-azure-support-matrix.md#azure-vm-requirements).


## <a name="prepare-to-connect-to-azure-vms-after-failover"></a>Подготовка к подключению виртуальных машин Azure после отработки отказа

После отработки отказа может потребоваться подключение к виртуальным машинам Azure из локальной сети.

Чтобы подключиться к виртуальным машинам Windows с помощью RDP после отработки отказа, сделайте следующее:

- **Доступ к Интернету**. Включите службу RDP на локальных виртуальных машинах перед отработкой отказа. Убедитесь в том, что правила для протоколов TCP и UDP для **общедоступного** профиля добавлены, а протокол RDP разрешен в разделе **Брандмауэр Windows** > **Разрешенные программы** для всех профилей.
- **VPN-подключение типа "сеть — сеть"**:
    - Перед отработкой отказа включите протокол удаленного рабочего стола на локальном компьютере.
    - Протокол удаленного рабочего стола должен быть разрешен в разделе **Брандмауэр Windows** -> **Allowed apps and features** (Разрешенные приложения и компоненты) для сетей **домена и частных сетей**.
    - Убедитесь, что для политики сети SAN операционной системы задано значение **OnlineAll**. [Узнайте больше](https://support.microsoft.com/kb/3031135).
- Убедитесь, что на виртуальной машине нет ожидающих установки обновлений Windows, прежде чем активировать отработку отказа. Если они есть, вы не сможете войти в виртуальную машину до завершения обновления.
- После отработки отказа на виртуальной машине Windows Azure проверьте **диагностику загрузки**, чтобы просмотреть снимок экрана виртуальной машины. Если вы не можете подключиться к виртуальной машине, убедитесь, что она запущена, и ознакомьтесь с [рекомендациями по устранению неполадок](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).

Чтобы подключиться к виртуальной машине Linux с помощью SSH после отработки отказа, сделайте следующее:

- На локальном компьютере перед отработкой отказа убедитесь, что для службы Secure Shell настроен автоматический запуск при загрузке системы.
- Убедитесь, что правила брандмауэра разрешают SSH-подключение.
- Правила группы безопасности сети на виртуальной машине Azure, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения к порту SSH.
- [Добавьте общедоступный IP-адрес](site-recovery-monitoring-and-troubleshooting.md) для виртуальной машины.
- Чтобы просмотреть снимок виртуальной машины, можно проверить **диагностику загрузки**.

## <a name="useful-links"></a>Полезные ссылки

Перед началом репликации нескольких виртуальных машин необходимо выделить пространство для хранения и создать план развертывания. [Узнайте больше](site-recovery-deployment-planner.md).



## <a name="next-steps"></a>Дополнительная информация

> [!div class="nextstepaction"]
> [Настройка аварийного восстановления в Azure для локальных виртуальных машин VMware](vmware-azure-tutorial.md)
