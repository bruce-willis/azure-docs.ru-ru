---
title: Правила для исходящего трафика в Azure Load Balancer | Документация Майкрософт
description: Используйте правила для исходящего трафика, чтобы определить исходящие преобразования сетевых адресов (NAT).
services: load-balancer
documentationcenter: na
author: KumudD
manager: jpconnock
tags: azure-resource-manager
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/24/2018
ms.author: kumud
ms.openlocfilehash: 63c193b4757c28f809a33b917058df36467d4db4
ms.sourcegitcommit: 51a1476c85ca518a6d8b4cc35aed7a76b33e130f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/25/2018
ms.locfileid: "47163024"
---
# <a name="load-balancer-outbound-rules"></a>Правила для исходящего трафика Load Balancer

Кроме входящего трафика, Azure Load Balancer обеспечивает исходящие подключения из виртуальной сети.  С помощью правил для исходящего трафика можно легко настроить общедоступное исходящее преобразование сетевых адресов (NAT) [Load Balancer (цен. категория "Стандартный")](load-balancer-standard-overview.md).  Вы получаете полный декларативный контроль над исходящим подключением для масштабирования и настройки этой возможности в соответствии с определенными потребностями.

![Правила для исходящего трафика Load Balancer](media/load-balancer-outbound-rules-overview/load-balancer-outbound-rules.png)

С помощью правил для исходящего трафика можно использовать Load Balancer для следующих целей: 
- определения NAT для исходящего трафика с нуля;
- масштабирования и настройки поведения имеющегося NAT для исходящего трафика. 

Правила для исходящего трафика позволяют управлять следующим:
- тем, какие виртуальные машины нужно преобразовать в определенные общедоступные IP-адреса; 
- как распределить [исходящие порты SNAT](load-balancer-outbound-connections.md#snat);
- для каких протоколов обеспечить исходящее преобразование;
- какую длительность использовать для времени ожидания перед переходом в режим простоя для исходящего подключения;
- инициировать ли сброс TCP-подключений во время ожидания в режиме простоя (в общедоступной предварительной версии). 

Правила для исходящего трафика расширяют [сценарий 2](load-balancer-outbound-connections.md#lb), описанный в статье об [исходящих подключениях](load-balancer-outbound-connections.md), а приоритет сценария остается как есть.

## <a name="outbound-rule"></a>Правило исходящих подключений

Как и все правила Load Balancer, правила для исходящего трафика соответствуют тому же знакомому синтаксису, что и правила балансировки нагрузки и NAT для входящего трафика:

**внешний интерфейс** + **параметры** + **серверный пул**

Правило для исходящего трафика настраивает NAT для исходящего трафика, предусматривающее преобразование _всех виртуальных машин, определенных с помощью серверного пула_, во _внешний интерфейс_.  _Параметры_ обеспечивают дополнительное детальное управление алгоритмом NAT для исходящего трафика.

Версия API "2018-07-01" разрешает определение правила для исходящего трафика, структурированное следующим образом:

```json
      "outboundRules": [
        {
          "frontendIPConfigurations": [ list_of_frontend_ip_configuations ],
          "allocatedOutboundPorts": number_of_SNAT_ports,
          "idleTimeoutInMinutes": 4 through 66,
          "enableTcpReset": true | false,
          "protocol": "Tcp" | "Udp" | "All",
          "backendAddressPool": backend_pool_reference,
        }
      ]
```

>[!NOTE]
>Эффективная конфигурация NAT для исходящего трафика является составной частью всех правил для исходящего трафика и правил балансировки нагрузки. Правила для исходящего трафика являются добавочными по отношению к правилам балансировки нагрузки. Ознакомьтесь со сведениями об [отключении NAT для исходящего трафика для правила балансировки нагрузки](#disablesnat). Таким образом можно управлять эффективным преобразованием NAT для исходящего трафика при применении к виртуальной машине нескольких правил. Вы должны [отключить SNAT исходящего трафика](#disablesnat) при определении правила для исходящего трафика, которое использует тот же общедоступный IP-адрес, что и правило балансировки нагрузки.

### <a name="scale"></a> Масштабирование NAT для исходящего трафика при использовании нескольких IP-адресов

Хотя правило для исходящего трафика можно использовать только с одним общедоступным IP-адресом, правила для исходящего трафика облегчают настройку для масштабирования NAT для исходящего трафика. Вы можете использовать несколько IP-адресов для планирования крупномасштабных сценариев, а также применять правила для исходящего трафика для обхода шаблонов, подверженных [нехватке SNAT](load-balancer-outbound-connections.md#snatexhaust).  

Каждый дополнительный IP-адрес, предоставляемый внешним интерфейсом, обеспечивает 64 000 эфемерных портов для использования экземпляром Load Balancer в качестве портов SNAT. В то время как правила балансировки нагрузки или NAT для входящего трафика включают единый внешний интерфейс, правило для исходящего трафика расширяет понятие внешнего интерфейса и позволяет использовать несколько таких интерфейсов для каждого правила.  При наличии нескольких внешних интерфейсов на каждое правило количество доступных портов SNAT умножается с каждым общедоступным IP-адресом. Кроме того, могут поддерживаться очень большие сценарии.

Можно также использовать [префикс общедоступного IP-адреса](https://aka.ms/lbpublicipprefix) непосредственно с правилом для исходящего трафика.  Это упрощает масштабирование и добавление в список разрешений потоков, которые поступают из развертывания Azure. Вы можете настроить внешнюю IP-конфигурацию в ресурсе Load Balancer, чтобы напрямую ссылаться на префикс общедоступного IP-адреса.  Это обеспечивает отдельный контроль Load Balancer над префиксом общедоступного IP-адреса, а правило для исходящего трафика будет автоматически использовать все общедоступные IP-адреса, содержащиеся в префиксе общедоступного IP-адреса, для исходящих подключений.  Каждый из IP-адресов в диапазоне префикса общедоступного IP-адреса обеспечивает 64 000 эфемерных портов на каждый IP-адрес для использования экземпляром Load Balancer в качестве портов SNAT.   

При использовании этого параметра вы не можете создавать индивидуальные ресурсы общедоступного IP-адреса из префикса общедоступного IP-адреса, так как правило для исходящего трафика должно полностью контролировать префикс общедоступного IP-адреса.  Если вам нужен более детализированный элемент управления, вы можете создать отдельный ресурс общедоступного IP-адреса из префикса общедоступного IP-адреса и назначить несколько общедоступных IP-адресов индивидуально для внешнего интерфейса правила для исходящего трафика.

### <a name="snatports"></a> Настройка распределения портов SNAT

Вы можете использовать правила для исходящего трафика для настройки [автоматического распределения портов SNAT на основе размера серверного пула](load-balancer-outbound-connections.md#preallocatedports) и выделить больше или меньше портов, чем предусмотрено автоматическим распределением портов SNAT.

Используйте следующий параметр для выделения 10 000 портов SNAT на каждую виртуальную машину (IP-конфигурация NIC).
 

          "allocatedOutboundPorts": 10000

Каждый общедоступный IP-адрес из всех внешних интерфейсов правила для исходящего трафика обеспечивает до 64 000 эфемерных портов в качестве портов SNAT.  Load Balancer выделяет порты SNAT в количестве, кратном 8. Если вы предоставляете значение, которое не делится на 8, операция конфигурации будет отклонена.  Если вы попытаетесь выделить больше портов SNAT, чем доступно на основе количества общедоступных IP-адресов, операция конфигурации будет отклонена.  Например, если вы выделяете 10 000 портов на каждую виртуальную машину, и 7 виртуальных машин в серверном пуле будет совместно использовать один общедоступный IP-адрес, конфигурация будет отклонена (7 x 10 000 портов SNAT > 64 000 портов SNAT).  Для реализации этого сценария можно добавить больше общедоступных IP-адресов во внешний интерфейс правила для исходящего трафика.

Вы можете вернуться к [автоматическому распределению SNAT-портов на основе размера серверного пула](load-balancer-outbound-connections.md#preallocatedports), указав значение 0 для количества портов.

### <a name="idletimeout"></a> Управление временем ожидания перед переходом в режим простоя для исходящего потока

Правила для исходящего трафика обеспечивают параметр конфигурации для управления временем ожидания перед переходом исходящего потока в режим простоя и сопоставляют его с потребностями приложения.  По умолчанию время ожидания перед переходом исходящего потока в режим простоя составляет 4 минуты.  Параметр принимает значение от 4 до 66 для задания количества минут для времени ожидания перед переходом потоков, соответствующих этому правилу, в режим простоя.

Используйте следующий параметр, чтобы задать время ожидания в режиме простоя для исходящего потока в 1 час:

          "idleTimeoutInMinutes": 60

### <a name="tcprst"></a> <a name="tcpreset"></a> Включение сброса подключений TCP при истечении времени ожидания простоя (предварительная версия)

Поведение по умолчанию Load Balancer заключается в том, чтобы автоматически отключить поток по истечении времени ожидания перехода в режим простоя для исходящего потока.  С помощью параметра enableTCPReset можно включить более предсказуемое поведение приложения и контролировать, отправлять ли двунаправленный сброс подключений TCP (TCP RST) в момент истечения времени ожидания для исходящего потока. 

Используйте следующий параметр, чтобы включить сброс подключений TCP в правиле для исходящего трафика:

           "enableTcpReset": true

Ознакомьтесь со статьей [Load Balancer со сбросом TCP-подключений при истечении времени ожидания простоя (общедоступная предварительная версия)](https://aka.ms/lbtcpreset), в которой также содержатся сведения о доступности в регионах.

### <a name="proto"></a> Поддержка транспортных протоколов TCP и UDP с помощью единого правила

Вероятно, вы захотите использовать значение "Все" для транспортного протокола в правиле для исходящего трафика, но вы также можете при необходимости применить это правило к определенному транспортному протоколу.

Используйте следующий параметр для установки протокола для подключений TCP и UDP:

          "protocol": "All"

### <a name="disablesnat"></a> Отключение NAT для исходящего трафика для правила балансировки нагрузки

Как уже говорилось ранее, правила балансировки нагрузки обеспечивают автоматическое программирование NAT для исходящего трафика. Однако некоторые сценарии включают преимущества или требуют отключить автоматическое программирование NAT для исходящего трафика с помощью правила балансировки нагрузки, чтобы вы могли управлять поведением или настраивать его.  Правила для исходящего трафика включают сценарии, в которых важно остановить автоматическое программирование NAT для исходящего трафика.

Этот параметр можно использовать двумя способами:
- Дополнительное подавление использования входящего IP-адреса для NAT для исходящего трафика.  Правила для исходящего трафика являются добавочными для правил балансировки нагрузки, и с помощью этого набора параметров правилом для исходящего трафика можно управлять.
  
- Настройте параметры NAT исходящего трафика для IP-адреса, используемого для входящего и исходящего трафика.  Автоматическое программирование NAT для исходящего трафика должно быть отключено, чтобы предоставить управление правилу для исходящего трафика.  Например, чтобы изменить распределение порта SNAT адреса, также используемого для входящего трафика, этому параметру должно быть задано значение true.  Если вы попытаетесь использовать правило для исходящего трафика для переопределения параметров IP-адреса, также используемого для входящего трафика, без использования программирования NAT для исходящего трафика правила балансировки нагрузки, операция по настройке правила для исходящего трафика завершится сбоем.

>[!IMPORTANT]
> Виртуальной машине не будет доступно исходящее подключение, если для этого параметра задано значение true и нет правила для исходящего трафика (или [общедоступный IP-адрес уровня экземпляра](load-balancer-outbound-connections.md#ilpip)), определяющего исходящее подключение.  Некоторые операции на виртуальной машине или в приложении могут зависеть от доступности исходящего подключения. Ознакомьтесь с зависимостями сценария и проанализируйте влияние этого изменения.

Вы можете отключить исходящие SNAT-подключения в правиле балансировки нагрузки с помощью этого параметра конфигурации:

```json
      "loadBalancingRules": [
        {
          "disableOutboundSnat": true
        }
      ]
```

Для параметра disableOutboundSNAT по умолчанию задано значение false. Это означает, что правило балансировки нагрузки **предоставляет** автоматическое преобразование NAT для исходящего трафика как зеркальное отображение конфигурации правила балансировки нагрузки.  

Если в правиле балансировки нагрузки для параметра disableOutboundSnat установить значение true, это правило перестанет управлять автоматическим программированием NAT для исходящего трафика.  Исходящие SNAT-подключения как результат правила балансировки нагрузки отключены.

### <a name="reuse-existing-or-define-new-backend-pools"></a>Повторное использование имеющихся серверных пулов или определение новых

Правила для исходящего трафика не включают новую концепцию определения группы виртуальных машин, к которой должно применяться правило.  Вместо этого они повторно используют концепцию серверного пула, которая также используется для правил балансировки нагрузки. Таким образом можно упростить конфигурацию путем повторного использования определения имеющегося серверного пула или создания такого пула специально для правила для исходящего трафика.

## <a name="scenarios"></a>Сценарии

### <a name="groom"></a> Оптимизация исходящих подключений для определенного набора общедоступных IP-адресов

Вы можете использовать правило для исходящего трафика, разрешающее принятие исходящих подключений из определенного набора общедоступных IP-адресов, чтобы упростить сценарии со списком разрешений.  Общедоступный IP-адрес источника может быть IP-адресом, который используется правилом балансировки нагрузки, или другим набором общедоступных IP-адресов.  

1. Создайте [префикс общедоступного IP-адреса](https://aka.ms/lbpublicipprefix) (или общедоступный IP-адрес из префикса общедоступного IP-адреса).
2. Создание общедоступного Load Balancer уровня "Стандартный"
3. Создайте внешние интерфейсы, ссылающиеся на префикс общедоступного IP-адреса (или общедоступные IP-адреса), которые вы хотите использовать.
4. Повторно используйте серверный пул или создайте его и разместите в этом пуле общедоступного Load Balancer виртуальные машины.
5. Настройте в общедоступном Load Balancer правило для исходящего трафика, позволяющее программно управлять NAT для исходящего трафика этих виртуальных машин с помощью внешних интерфейсов.
   
Если вы не хотите, чтобы правило балансировки нагрузки использовалось для исходящих подключений, вам необходимо [отключить исходящие SNAT-подключения](#disablesnat) в правиле балансировки нагрузки.

### <a name="modifysnat"></a> Изменение распределения портов SNAT

Вы можете использовать правила для исходящего трафика, чтобы настроить [автоматическое распределение SNAT-портов на основе размера серверного пула](load-balancer-outbound-connections.md#preallocatedports).

Например, если у вас есть две виртуальные машины, совместно использующие один общедоступный IP-адрес NAT для исходящего трафика, вы можете увеличить количество портов SNAT, выделенных из 1024 портов по умолчанию, в случае нехватки SNAT. Каждый общедоступный IP-адрес может принимать участие в работе до 64 000 эфемерных портов.  Если вы настроите правило для исходящего трафика с внешним интерфейсом единого общедоступного IP-адреса, вы можете распределить в целом 64 000 портов SNAT для виртуальных машин в серверном пуле.  Для двух виртуальных машин с помощью правила для исходящего трафика можно выделить максимум 32 000 портов SNAT (2 x 32 000 = 64 000).

Ознакомьтесь со сведениями об [исходящих подключениях](load-balancer-outbound-connections.md), а также сведениями о том, как распределяются и используются порты [SNAT](load-balancer-outbound-connections.md#snat).

### <a name="outboundonly"></a> Включение только NAT для исходящего трафика

Вы можете использовать общедоступный Load Balancer (цен. категория "Стандартный"), чтобы обеспечить NAT для исходящего трафика для группы виртуальных машин. В этом случае вы можете использовать только правило для исходящего трафика без какой-либо необходимости в дополнительных правилах.

#### <a name="outbound-nat-for-vms-only-no-inbound"></a>NAT для исходящего трафика только для виртуальных машин (без входящего трафика)

Определите общедоступный Load Balancer (цен. категория "Стандартный"), разместите виртуальные машины в серверный пул и настройте правило для исходящего трафика для программирования NAT для исходящего трафика и принятие исходящих подключений из определенного общедоступного IP-адреса. Вы также можете использовать префикс общедоступного IP-адреса, чтобы упростить размещение источника исходящих подключений в списке разрешений.

1. Создайте общедоступный Load Balancer (цен. категория "Стандартный").
2. Создайте серверный пул и разместите в этом пуле общедоступного Load Balancer виртуальные машины.
3. Настройте в общедоступном Load Balancer правило для исходящего трафика, позволяющее программно управлять NAT для исходящего трафика этих виртуальных машин.

#### <a name="outbound-nat-for-internal-standard-load-balancer-scenarios"></a>NAT для исходящего трафика для внутренних сценариев Load Balancer (цен. категория "Стандартный")

При использовании внутреннего Load Balancer (цен. категория "Стандартный") преобразование NAT для исходящего трафика недоступно до тех пор, пока не будет настроен общедоступный Load Balancer (цен. категория "Стандартный"). Вы можете изменить это, используя правило для исходящего трафика, чтобы создать исходящее подключение для виртуальных машин за внутренним Load Balancer (цен. категория "Стандартный").

1. Создайте общедоступный Load Balancer (цен. категория "Стандартный").
2. Создайте серверный пул и разместите в этом пуле общедоступного Load Balancer виртуальные машины.
3. Настройте в общедоступном Load Balancer правило для исходящего трафика, позволяющее программно управлять NAT для исходящего трафика этих виртуальных машин.

#### <a name="enable-both-tcp--udp-protocols-for-outbound-nat-with-a-public-standard-load-balancer"></a>Включение протоколов TCP и UDP для NAT для исходящего трафика при использовании общедоступного Load Balancer (цен. категория "Стандартный")

- При использовании общедоступного Load Balancer (цен. категория "Стандартный") предоставленное автоматическое программирование NAT для исходящего трафика сопоставляет транспортный протокол правила балансировки нагрузки.  

   1. Отключите исходящие SNAT-подключения в правиле балансировки нагрузки.
   2. Настройте правило для исходящего трафика в одной подсистеме Load Balancer.
   3. Повторно используйте серверный пул, который уже использовался для виртуальных машин.
   4. Укажите для протокола значение "Все" как часть правила для исходящего трафика.

- Если используются только правила NAT для входящего трафика, NAT для исходящего трафика обеспечиваться не будет.

   1. Поместите виртуальные машины в серверный пул.
   2. Определите одну или несколько интерфейсных IP-конфигураций с общедоступными IP-адресами или префиксом общедоступного IP-адреса.
   3. Настройте правило для исходящего трафика в одной подсистеме Load Balancer.
   4. Укажите для протокола значение "Все" как часть правила для исходящего трафика.

## <a name="limitations"></a>Ограничения

- Максимальное количество используемых эфемерных портов на один интерфейсный IP-адрес составляет 64 000.
- Диапазон настраиваемого времени ожидания перед переходом исходящих подключений в режим простоя составляет 4–66 минут (240–4000 секунд).
- Load Balancer не поддерживает ICMP для NAT для исходящего трафика.
- С помощью портала нельзя настраивать или просматривать правила для исходящего трафика.  Вместо этого используйте шаблоны, REST API, Azure CLI 2.0 или PowerShell.

## <a name="next-steps"></a>Дополнительная информация

- Дополнительные сведения о [Load Balancer для исходящих подключений](load-balancer-outbound-connections.md).
- Сведения о [Load Balancer ценовой категории "Стандартный"](load-balancer-standard-overview.md).
- Ознакомьтесь со сведениями о [двунаправленном сбросе подключений TCP во время ожидания перед переходом в режим простоя](load-balancer-tcp-reset.md).
- [Configure load balancing and outbound rules in Standard Load Balancer using Azure CLI](configure-load-balancer-outbound-cli.md) (Настройка правил балансировки нагрузки и правил для исходящего трафика в подсистеме Load Balancer (цен. категория "Стандартный") с помощью Azure CLI).
