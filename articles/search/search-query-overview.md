---
title: Типы запросов и составление запросов в Поиске Azure | Документация Майкрософт
description: Основы создания поисковых запросов в Поиске Azure с помощью параметров для фильтрации, выбора и сортировки результатов.
author: HeidiSteen
manager: cgronlun
ms.author: heidist
services: search
ms.service: search
ms.topic: conceptual
ms.date: 08/03/2018
ms.openlocfilehash: a1dad30148da9f6b322c75fd40dc01098c4d6b63
ms.sourcegitcommit: a2ae233e20e670e2f9e6b75e83253bd301f5067c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/13/2018
ms.locfileid: "42146015"
---
# <a name="query-types-and-composition-in-azure-search"></a>Типы запросов и составление запросов в Поиске Azure

Запрос в Поиске Azure содержит полную спецификацию операции приема-передачи данных. Его параметры содержат условия для поиска документов в индексе, инструкции по выполнению для подсистемы и директивы для формирования ответа. Проще говоря, вы можете указать поля, входящие в область поиска, метод поиска, возвращаемые поля, правила сортировки и (или) фильтрации и т. д. Если запрос не уточнен, поиск выполняется по всем полям, как операция полнотекстового поиска, и возвращается результирующий набор без оценок в произвольном порядке.

## <a name="a-first-look-at-query-requests"></a>Первое знакомство с запросами

Новые концепции лучше всего изучать на конкретных примерах. В этом примере представлен типичный запрос, составленный для [REST API](https://docs.microsoft.com/rest/api/searchservice/search-documents), который обращается к [демоверсии индекса по недвижимости](search-get-started-portal.md) и содержит несколько стандартных параметров.

```
{  
    "queryType": "simple" 
    "search": "seattle townhouse* +\"lake\"", 
    "searchFields": "description, city",  
    "count": "true", 
    "select": "listingId, street, status, daysOnMarket, description",
    "top": "10",
    "orderby": "daysOnMarket"
 } 
```

+ **`queryType`** позволяет задать средство синтаксического анализа. В Поиске Azure можно использовать [средство синтаксического анализа по умолчанию](search-query-simple-examples.md) (подходит для полнотекстового поиска) или [средство полного синтаксического анализа запросов Lucene](search-query-lucene-examples.md), которое позволяет применить в запросе расширенные конструкции, например регулярные выражения, поиск с учетом расположения, нечеткие соответствия и подстановочные знаки.

+ **`search`** содержит условия для поиска, обычно это искомый текст часто с дополнительными логическими операторами. Запрос с одним самостоятельным термином называется запросом *термина*. Запрос с несколькими частями, заключенными в кавычки, считается запросом *ключевой фразы*. Поиск может быть неопределенным, как например **`search=*`**, но чаще состоит из терминов, фраз и операторов, как в нашем примере.

+ **`searchFields`** — необязательное ограничение запроса по определенным полям.

Формат ответа также определяется параметрами, включенными в запрос. В этом примере результирующий набор включает поля, перечисленные в инструкции **`select`**. Этот запрос возвращает только 10 лучших совпадений, но **`count`** содержит общее количество соответствующих запросу документов. В этом запросе строки сортируются по полю daysOnMarket.

В Поиске Azure запрос всегда выполняется по одному индексу, доступ к которому предоставляется по включенному в запрос ключу api-key. В интерфейсах REST эти данные передаются в заголовках запроса.

### <a name="how-to-run-this-query"></a>Процесс выполнения запроса

Чтобы выполнить этот запрос, следуйте инструкциям из [руководства по использованию встроенных инструментов для отправки запросов и индексирования в службе поиска Azure](search-get-started-portal.md). 

Строку запроса можно вставить прямо в панель поиска обозревателя: `search=seattle townhouse +lake&searchFields=description, city&$count=true&$select=listingId, street, status, daysOnMarket, description&$top=10&$orderby=daysOnMarket`

### <a name="how-query-operations-are-enabled-by-the-index"></a>Как индекс влияет на операции запросов

В Поиске Azure структура индекса тесно связана со структурой запросов. Здесь важно сразу понять, что именно *схема индекса* с атрибутами для каждого поля определяет, какие типы запросов вы сможете создавать. 

Атрибуты индекса задают допустимые операции для набора полей в индексе, например возможность поиска (*searchable*), извлечения (*retrievable*), сортировки (*sortable*) и фильтрации (*filterable*). В этом примере строки запроса можно применить `"$orderby": "daysOnMarket"` только потому, что поле daysOnMarket имеет в схеме индекса метку *sortable*. 

![Определение индекса для набора данных по недвижимости](./media/search-query-overview/realestate-sample-index-definition.png "Index definition for the real estate sample")

На снимке экрана выше показан неполный список атрибутов индекса для примера набора данных по недвижимости. Полную схему индекса вы можете изучить на портале. Дополнительные сведения об атрибутах индекса см. в статье [Create Index (Azure Search Service REST API)](https://docs.microsoft.com/rest/api/searchservice/create-index) (Создание индекса (REST API службы "Поиск Azure")).

> [!Note]
> Некоторые функции обработки запросов включаются на уровне всего индекса, а не для отдельных полей. К ним, например, относятся [карты синонимов](https://docs.microsoft.com/rest/api/searchservice/synonym-map-operations), [пользовательские анализаторы](https://docs.microsoft.com/rest/api/searchservice/custom-analyzers-in-azure-search), [средство подбора конструкции (для автодополнения и автозаполнения)](https://docs.microsoft.com/rest/api/searchservice/suggesters) и [логика оценки для ранжирования результатов](https://docs.microsoft.com/rest/api/searchservice/add-scoring-profiles-to-a-search-index).

## <a name="elements-of-a-query-request"></a>Элементы запроса

Запросы всегда направляются в один индекс. Невозможно объединить индексы или создать пользовательские или временные структуры данных и указать их в качестве цели запроса. 

Обязательные элементы в запросе перечислены ниже:

+ конечные точки службы и коллекция документов индекса, выраженные как URL-адрес с фиксированными и определенными пользователем компонентами: **`https://<your-service-name>.search.windows.net/indexes/<your-index-name>/docs`**;
+ параметр **`api-version`** (только для REST) является обязательным, так как всегда доступно несколько версий API; 
+ параметр **`api-key`** с ключом API запроса или администратора, который проверяет подлинности запроса для доступа к службе;
+ параметр **`queryType`** со значением simple или full, который можно опустить, если нужно использовать простой встроенный синтаксис по умолчанию;
+ **`search`** или **`filter`** с условием поиска, который можно не указывать при поиске пустого значения. Оба типа запросов рассматриваются на примере простого средства синтаксического анализа, но даже в сложных запросах используется параметр поиска для передачи сложных выражений запроса.

Все остальные параметры поиска являются необязательными. Полный список атрибутов приводится в статье [Create Index (Azure Search Service REST API)](https://docs.microsoft.com/rest/api/searchservice/create-index) (Создание индекса (REST API службы "Поиск Azure")). Использование параметров во время обработки более подробно рассматривается в статье [Как работает полнотекстовый поиск в службе поиска Azure](search-lucene-query-architecture.md).

## <a name="choose-a-parser-simple--full"></a>Выберите средство синтаксического анализа: simple (простое) или full (полное)

В основе Поиска Azure лежит платформа Apache Lucene, что позволяет выбрать между двумя средствами синтаксического анализа запросов для обработки типичных и специализированных запросов. Запросы для простого средства синтаксического анализа должны использовать [простой синтаксис запросов](https://docs.microsoft.com/rest/api/searchservice/Simple-query-syntax-in-Azure-Search). Этот вариант используется по умолчанию, так как обеспечивает высокую скорость и эффективность для запросов в свободной текстовой форме. Этот синтаксис поддерживает ряд общих операторов поиска, включая AND, OR, NOT, а также фразы, суффиксы и операторы приоритета.

[Полный синтаксис запросов Lucene](https://docs.microsoft.com/rest/api/searchservice/Lucene-query-syntax-in-Azure-Search#bkmk_syntax), который включается при добавлении параметра `queryType=full` в запрос, позволяет применить широко распространенный и выразительный язык запросов, разработанный в составе библиотеки [Apache Lucene](https://lucene.apache.org/core/4_10_2/queryparser/org/apache/lucene/queryparser/classic/package-summary.html). Полный синтаксис расширяет простой синтаксис. Средство полного синтаксического анализа Lucene поймет любой запрос, созданный для простого средства синтаксического анализа. 

Этот аспект демонстрируется в следующих примерах: один и тот же запрос с разными значениями параметра queryType возвращает разные результаты. В первом запросе `^3` рассматривается как часть условия поиска.

```
queryType=simple&search=mountain beach garden ranch^3&searchFields=description&$count=true&$select=listingId, street, status, daysOnMarket, description&$top=10&$orderby=daysOnMarket
```

Средство полного синтаксического анализа Lucene в этом запросе применяет boost к слову ranch, то есть повышает ранг результатов поиска с этим конкретным термином.

```
queryType=simple&search=mountain beach garden ranch^3&searchFields=description&$count=true&$select=listingId, street, status, daysOnMarket, description&$top=10&$orderby=daysOnMarket
```

<a name="types-of-queries"></a>

## <a name="types-of-queries"></a>Типы запросов

Поиск Azure поддерживает широкий спектр типов запросов. 

| Тип запроса | Использование | Дополнительные сведения и примеры |
|------------|--------|-------------------------------|
| Текстовый поиск со свободной формой записи | Параметр поиска и любое средство синтаксического анализа| Полнотекстовый поиск позволяет найти один или несколько терминов во всех полях индекса с меткой *searchable*, примерно так же, как поисковая система Google или Bing. В примере во введении представлен именно полнотекстовый поиск.<br/><br/>Для полнотекстового поиска применяется анализ текста через стандартный анализатор Lucene (по умолчанию), с переводом всех терминов в нижний регистр и удалением стоп-слов (например, артиклей). Вместо этого анализатора по умолчанию вы можете использовать [анализаторы языков, отличных от английского](https://docs.microsoft.com/rest/api/searchservice/language-support#analyzer-list) или [специализированные анализаторы](https://docs.microsoft.com/rest/api/searchservice/custom-analyzers-in-azure-search#AnalyzerTable), которые применяют другие правила анализа текста. Например, [keyword](https://lucene.apache.org/core/4_10_3/analyzers-common/org/apache/lucene/analysis/core/KeywordAnalyzer.html) позволяет использовать все содержимое поля как один токен. Это полезно для данных некоторых типов, таких как почтовые индексы, идентификаторы и названия продуктов. | 
| Поиск с фильтрацией | [Выражение фильтра OData](https://docs.microsoft.com/rest/api/searchservice/OData-Expression-Syntax-for-Azure-Search) и любое средство синтаксического анализа | Запросы фильтрации оценивают логическое выражение по всем полям индекса с меткой *filterable*. В отличие от поиска, запрос фильтрации проверяет точное содержимое поля, в том числе учитывает регистр для строковых полей. Еще одно важное различие — запросы фильтрации выражаются в синтаксисе OData. <br/>[Пример поиска с фильтрацией](search-query-simple-examples.md#example-3-filter-queries) |
| Геопространственный поиск | [Тип Edm.GeographyPoint](https://docs.microsoft.com/rest/api/searchservice/supported-data-types) для поля, выражение фильтра и любое средство синтаксического анализа | Координаты, хранящиеся в поле с типом Edm.GeographyPoint, используются для "поиска соседних объектов" и для элементов управления со встроенными картами. <br/>[Пример поиска геообъектов](search-query-simple-examples.md#example-5-geo-search)|
| Поиск по диапазону | Выражение фильтра и средство простого синтаксического анализа | В Поиске Azure запросы по диапазонам создаются на основе параметра фильтра. <br/>[Пример фильтра по диапазону](search-query-simple-examples.md#example-4-range-filters) | 
| [Фильтрация внутри поля](https://docs.microsoft.com/rest/api/searchservice/Lucene-query-syntax-in-Azure-Search#bkmk_fields) | Параметр поиска и средство полного синтаксического анализа | Создайте сложное выражение запроса, предназначенное для одного поля. <br/>[Пример фильтрации внутри поля](search-query-lucene-examples.md#example-2-intra-field-filtering) |
| [поиск нечетких соответствий](https://docs.microsoft.com/rest/api/searchservice/Lucene-query-syntax-in-Azure-Search#bkmk_fuzzy); | Параметр поиска и средство полного синтаксического анализа | Находит совпадения с терминами, которые имеют сходную конструкцию или орфографию. <br/>[Пример поиска нечетких соответствий](search-query-lucene-examples.md#example-3-fuzzy-search) |
| [поиск с учетом расположения](https://docs.microsoft.com/rest/api/searchservice/Lucene-query-syntax-in-Azure-Search#bkmk_proximity); | Параметр поиска и средство полного синтаксического анализа | Находит термины, которые расположены в документе рядом друг с другом. <br/>[Пример поиска с учетом расположения](search-query-lucene-examples.md#example-4-proximity-search) |
| [повышение приоритета терминов](https://docs.microsoft.com/rest/api/searchservice/Lucene-query-syntax-in-Azure-Search#bkmk_termboost); | Параметр поиска и средство полного синтаксического анализа | Присваивает более высокий приоритет документам, которые содержат определенный термин. <br/>[Пример повышения приоритета термина](search-query-lucene-examples.md#example-5-term-boosting) |
| [поиск с использованием регулярного выражения](https://docs.microsoft.com/rest/api/searchservice/Lucene-query-syntax-in-Azure-Search#bkmk_regex); | Параметр поиска и средство полного синтаксического анализа | Находит совпадения на основе содержимого регулярного выражения. <br/>[Пример поиска с использованием регулярного выражения](search-query-lucene-examples.md#example-6-regex) |
|  [Поиск с подстановочным знаком или префиксом](https://docs.microsoft.com/rest/api/searchservice/Lucene-query-syntax-in-Azure-Search#bkmk_wildcard) | Параметр поиска и средство полного синтаксического анализа | Находит совпадения с учетом префикса и символа тильды (`~`) или одного символа (`?`). <br/>[Пример поиска с использованием подстановочных знаков](search-query-lucene-examples.md#example-7-wildcard-search) |

## <a name="manage-search-results"></a>Управление результатами поиска 

Результаты запроса передаются потоком в виде документов JSON в API REST, хотя если вы используете интерфейсы API .NET, то функции сериализации будут встроенными. Используя параметры запроса, вы можете задать формат результатов и выбрать определенные поля для отображения в результатах.

Параметры запроса можно использовать для структурирования результирующего набора одним из следующих способов.

+ Ограничение числа документов или группирование определенного числа документов в результатах (50 по умолчанию).
+ Выбор полей для включения в результаты.
+ Установка порядка сортировки.
+ Выделение вхождений для привлечения внимания к найденным терминам в тексте результатов поиска.

### <a name="tips-for-unexpected-results"></a>Советы по непредвиденным результатам

В некоторых случаях непредвиденным является содержимое, а не структура результатов. Если результаты запроса не соответствует ожиданиям, можно попробовать изменить запрос и проверить, не улучшились ли результаты, как описано ниже.

+ Измените **`searchMode=any`** (по умолчанию) на **`searchMode=all`**, чтобы потребовать соответствие всем указанным условиям, а не любому из них. Это особенно важно, если запрос содержит логические операторы.

+ Измените логику запроса, если требуется анализ текста или лексический анализа, но тип запроса исключает лингвистическую обработку. При полнотекстовом поиске алгоритм анализа текста или лексического анализа автоматически исправляет орфографические ошибки, формы множественного и единственного числа слов и даже неправильные глаголы и существительные. Для некоторых запросов, таких как поиск нечетких соответствий или поиск с использованием подстановочных знаков, анализ текста не входит в конвейер анализа запроса. Для некоторых сценариев в качестве временного решения используются регулярные выражения. 

### <a name="paging-results"></a>Разбиение результатов по страницам
Служба поиска Azure позволяет легко разбить результаты поиска по страницам. С помощью параметров **`top`** и **`skip`** вы можете формировать такие поисковые запросы, результаты которых возвращаются в управляемых упорядоченных подмножествах. В них поиск можно выполнять проверенными способами с помощью пользовательского интерфейса. При получении этих маленьких подмножеств вы можете получать также сведения о количестве документов во всех результатах поиска.

Дополнительные сведения о разбивке результатов поиска на страницы см. в статье [Разбивка результатов поиска на страницы в службе поиска Azure](search-pagination-page-layout.md).

### <a name="ordering-results"></a>Упорядочение результатов
Вы можете запросить, чтобы служба поиска Azure упорядочила результаты поискового запроса по значениям в определенном поле. По умолчанию служба поиска Azure упорядочивает результаты поиска, руководствуясь важностью суммы поиска документа. Это значение вычисляется на основании меры [TF-IDF](https://en.wikipedia.org/wiki/Tf%E2%80%93idf).

Если нужно, чтобы служба "Поиск Azure" упорядочивала результаты не по значению оценки, а по другому значению, вы можете воспользоваться поисковым параметром **`orderby`**. Вы можете включить в значение параметра **`orderby`** имена полей и вызовов [**функции `geo.distance()`**](https://docs.microsoft.com/rest/api/searchservice/OData-Expression-Syntax-for-Azure-Search) для геопространственных значений. После каждого выражения можно поставить символ `asc`, чтобы указать, что результаты требуется представить по возрастанию, или символ **`desc`**, если результаты нужно упорядочить по убыванию. По умолчанию результаты сортируются по возрастанию.


### <a name="hit-highlighting"></a>Выделение совпадений
В службе "Поиск Azure" вы можете легко выделить конкретную часть результатов поиска, которые соответствуют поисковому запросу, используя параметры **`highlight`**, **`highlightPreTag`** и **`highlightPostTag`**. Вы можете указать, в каких *поддерживающих поиск* полях следует выделять вхождения. Кроме того, можно указать конкретные теги строк, которые нужно добавлять к началу и концу вхождений, которые возвращает служба поиска Azure.

## <a name="apis-and-tools-for-testing"></a>Интерфейсы API и инструменты для тестирования

В таблице ниже представлены интерфейсы API и методы на основе инструментов для отправки запросов.

| Методика | ОПИСАНИЕ |
|-------------|-------------|
| [SearchIndexClient (.NET)](https://docs.microsoft.com/dotnet/api/microsoft.azure.search.searchindexclient?view=azure-dotnet) | Клиент, который может использоваться для отправки запроса к индексу Поиска Azure.  <br/>[Подробнее.](search-howto-dotnet-sdk.md#core-scenarios)  |
| [Поиск по документам (REST API)](https://docs.microsoft.com/rest/api/searchservice/search-documents) | Методы GET или POST для индекса, допускающие использование параметров запроса для ввода дополнительных данных.  |
| [Fiddler, Postman или другой инструмент тестирования HTTP](search-fiddler.md) | Описывается настройка заголовка и текста запроса для отправки запросов к Поиску Azure.  |
| [Обозреватель поиска на портале Azure](search-explorer.md) | Предоставляет панель поиска и параметры для выбора индекса и значения api-version. Будут возвращены результаты в виде документов JSON. <br/>[Подробнее.](search-get-started-portal.md#query-index) | 

## <a name="see-also"></a>См. также

+ [Как работает полнотекстовый поиск в службе поиска Azure (архитектура анализа запросов)](search-lucene-query-architecture.md)
+ [Обозреватель поиска](search-explorer.md)
+ [Выполнение запроса в .NET](search-query-dotnet.md)
+ [Выполнение запроса в REST](search-query-rest-api.md)
