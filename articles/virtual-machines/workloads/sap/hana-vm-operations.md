---
title: Конфигурации инфраструктуры SAP HANA и работа с ней в Azure | Документация Майкрософт
description: Руководство по использованию систем SAP HANA, развернутых на виртуальных машинах Azure.
services: virtual-machines-linux,virtual-machines-windows
documentationcenter: ''
author: juergent
manager: patfilot
editor: ''
tags: azure-resource-manager
keywords: ''
ms.service: virtual-machines-linux
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 09/27/2018
ms.author: msjuergent
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: db2d7fbe395a6d7e332d79183a331b45f7767f51
ms.sourcegitcommit: 7c4fd6fe267f79e760dc9aa8b432caa03d34615d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/28/2018
ms.locfileid: "47434066"
---
# <a name="sap-hana-infrastructure-configurations-and-operations-on-azure"></a>Конфигурации инфраструктуры SAP HANA и работа с ней в Azure
Этот документ содержит рекомендации по настройке архитектуры и работе с системами SAP HANA, развернутыми на виртуальных машинах Azure. Здесь также приведены сведения о настройке горизонтального масштабирования SAP HANA для номера SKU виртуальных машин M128s. Он не предназначен для замены стандартной документации SAP, к которой относятся следующие ресурсы:

- [SAP HANA Administration Guide](https://help.sap.com/viewer/6b94445c94ae495c83a19646e7c3fd56/2.0.02/330e5550b09d4f0f8b6cceb14a64cd22.html) (Руководство по администрированию SAP HANA);
- [SAP Installation Guides](https://service.sap.com/instguides) (Руководство по установке SAP);
- [Примечания к SAP](https://sservice.sap.com/notes).

## <a name="prerequisites"></a>Предварительные требования
Чтобы воспользоваться приведенными в этом руководстве сведениями, необходимо иметь базовые знания об использовании следующих компонентов Azure:

- [Виртуальные машины Azure](https://docs.microsoft.com/azure/virtual-machines/linux/tutorial-manage-vm)
- [Сети и виртуальные сети Azure](https://docs.microsoft.com/azure/virtual-machines/linux/tutorial-virtual-network).
- [Хранилище Azure](https://docs.microsoft.com/azure/virtual-machines/linux/tutorial-manage-disks)

Дополнительные сведения по SAP NetWeaver и другим компонентам SAP на базе Azure см. в статье [Using Azure for hosting and running SAP workload scenarios](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/get-started) (Размещение и выполнение сценариев рабочей нагрузки SAP с помощью Azure) и [документации по Azure](https://docs.microsoft.com/azure/).

## <a name="basic-setup-considerations"></a>Рекомендации по основной настройке
В следующих разделах описаны рекомендации по основной настройке развертывания систем SAP HANA на виртуальных машинах Azure.

### <a name="connect-into-azure-virtual-machines"></a>Подключение к виртуальным машинам Azure
Как описано в статье [SAP NetWeaver на виртуальных машинах Windows. Руководство по планированию и внедрению](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/planning-guide), есть два основных метода подключения к виртуальным машинам Azure:

- Подключение через Интернет и общедоступные конечные точки на виртуальной машине перехода или виртуальной машине, работающей под управлением SAP HANA.
- Подключение через [VPN](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal) или Azure [ExpressRoute](https://azure.microsoft.com/services/expressroute/).

Подключение "сеть — сеть" через VPN или ExpressRoute необходимо для производственных сценариев. Этот тип подключения также необходим для нерабочих сценариев, связанных с производственными сценариями, в которых используется программное обеспечение SAP. Пример межсайтового подключения приведен на следующем рисунке:

![Межсайтовые подключения](media/virtual-machines-shared-sap-planning-guide/300-vpn-s2s.png)


### <a name="choose-azure-vm-types"></a>Выбор типов виртуальных машин Azure
Типы виртуальных машин Azure, которые можно использовать для производственных сценариев, можно найти [в документации SAP для IAAS](https://www.sap.com/dmc/exp/2014-09-02-hana-hardware/enEN/iaas.html). Для нерабочих сценариев доступен более широкий спектр собственных типов виртуальных машин Azure.

>[!NOTE]
> Используйте для этих сценариев типы виртуальных машин, которые указаны в [примечании к SAP № 1928533](https://launchpad.support.sap.com/#/notes/1928533). В рабочей среде можно использовать виртуальные машины Azure, сертифицированные для SAP HANA. Они указаны в опубликованном [списке сертифицированных платформ IaaS](https://www.sap.com/dmc/exp/2014-09-02-hana-hardware/enEN/iaas.html#categories=Microsoft%20Azure) для SAP.

Разверните виртуальные машины в Azure с помощью:

- портала Azure;
- командлетов Azure PowerShell;
- Azure CLI.

Вы также можете развернуть полностью установленную платформу SAP HANA в службы виртуальных машин Azure через [облачную платформу SAP](https://cal.sap.com/). Сведения о процессе установки см. в статье [Развертывание SAP S/4HANA или BW/4HANA в Azure](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/cal-s4h), а сведения об автоматизации — на сайте [GitHub](https://github.com/AzureCAT-GSI/SAP-HANA-ARM).

### <a name="choose-azure-storage-type"></a>Выбор типа службы хранилища Azure
Azure предоставляет два типа хранилища, подходящих для виртуальных машин Azure, работающих под управлением SAP HANA:

- [Хранилище Azure уровня "Стандартный"](https://docs.microsoft.com/azure/virtual-machines/windows/standard-storage)
- [Хранилище Azure Premium](https://docs.microsoft.com/azure/virtual-machines/windows/premium-storage)

Azure предлагает два метода развертывания виртуальных жестких дисков (VHD) в хранилище Azure класса "Стандартный" и хранилище Azure класса Premium. Рекомендуется использовать развертывания [управляемых дисков Azure](https://azure.microsoft.com/services/managed-disks/), если общий сценарий это допускает.

Список типов хранилища и их соглашения об уровне обслуживания в отношении операций ввода-вывода в секунду (IOPS) и пропускной способности хранилища см. на странице [Цены на управляемые диски](https://azure.microsoft.com/pricing/details/managed-disks/).

### <a name="configuring-the-storage-for-azure-virtual-machines"></a>Настройка хранилища для виртуальных машин Azure

Если вы покупаете оборудование SAP HANA для локальной среды, вам не нужно заботиться о подсистемах ввода-вывода и их функционировании. Это связано с тем, что поставщику оборудования необходимо убедиться в том, что для SAP HANA соблюдены минимальные требования к хранению. При самостоятельном создании инфраструктуры Azure вам следует знать некоторые из этих требований, а также понять требования к конфигурации, указанные в следующих разделах. Кроме того, это необходимо в случае настройки виртуальных машин, на которых будет выполняться SAP HANA. Для некоторых запрашиваемых характеристик необходимо выполнить следующее.

- Включите том чтения и записи для **/hana/log** с пропускной способностью 250 МБ/с и минимальным размером операций ввода-вывода в 1 МБ.
- Включите действие чтения с пропускной способностью не менее 400 МБ/с для **/hana/data** для размеров операций ввода-вывода 16 МБ и 64 МБ.
- Включите действие записи с пропускной способностью не менее 250 МБ/с для **/hana/data** для размеров операций ввода-вывода 16 МБ и 64 МБ.

Так как небольшая задержка хранилища для систем СУБД является критической, даже такие системы, как SAP HANA, хранят данные в памяти. Критический путь в хранилище обычно находится рядом с записями журналов транзакций систем СУБД. Кроме того, такие операции, как запись точек сохранения или загрузка данных в памяти после восстановления из-за сбоя, могут быть критическими. Таким образом обязательно необходимо использовать диски Azure класса Premium для томов **/hana/data** и **/hana/log**. Чтобы добиться минимальной пропускной способности **/hana/log** и **/hana/data** в соответствии с требованиями SAP, создайте RAID 0 с помощью MDADM или LVM на нескольких дисках хранилища Azure класса Premium и используйте тома RAID в качестве томов **/hana/data** и **/hana/log**. В качестве размеров блоков для RAID 0 рекомендуем использовать следующие:

- 64 КБ или 128 КБ для **/hana/data**
- 32 KБ для **/hana/log**

> [!NOTE]
> Нет необходимости настраивать уровень избыточности с помощью томов RAID, так как хранилища Azure класса Premium и Standard хранят три образа виртуального жесткого диска. Использование тома RAID предназначено исключительно для настройки томов, которые предоставляют достаточную пропускную способность операций ввода-вывода.

Использование нескольких VHD Azure в RAID влияет на число операций ввода-вывода в секунду и пропускную способность хранилища. Таким образом, если вы добавите в RAID 0 3 диска P30 хранилища Azure класса Premium, число операций ввода-вывода в секунду и пропускная способность увеличатся в три раза, исходя из показателей одного диска P30 хранилища класса Premium.

Приведенные ниже рекомендации по кэшированию даны исходя из следующих характеристик ввода-вывода для SAP HANA:

- Практически отсутствует рабочая нагрузка чтения файлов данных HANA. Исключениями являются большие по размеру операции ввода-вывода после перезапуска экземпляра HANA или когда данные загружаются в HANA. Еще одним случаем большего размера операций чтения файлов данных является резервное копирование базы данных HANA. В этом случае кэширование чтения практически не имеет смысла, поскольку в большинстве случаев все тома файлов данных необходимо считать полностью.
- Запись в файлы данных возникает скачкообразно в связи с созданием точек сохранения HANA и восстановления после сбоя. Запись точек сохранения выполняется асинхронно и не задерживает выполнение пользовательских транзакций. При записи данных во время восстановления после сбоя производительность является критически важной, поскольку необходимо восстановить работу системы как можно быстрее. Однако восстановление после сбоя происходит только в исключительных ситуациях
- Вряд ли возникнут другие ситуации, когда понадобится чтение из файлов повторяемых операций HANA. Исключениями являются большие операции ввода-вывода при выполнении резервных копий журналов транзакций, восстановления после сбоя или во время перезапуска экземпляра HANA.  
- Основной нагрузкой на файл журнала повторяемых операций SAP HANA являются операции записи. В зависимости от характера рабочей нагрузки можно иметь операции ввода-вывода размером 4 КБ, тогда как в других случаях размер может превышать 1 МБ. Задержки записи для журнала повторяемых операций SAP HANA являются критическими для производительности.
- Все операции записи необходимо сохранить на диске надежным образом

В зависимости от представленных шаблонов операций ввода-вывода SAP HANA кэширование для разных томов, использующих хранилища Azure класса Premium, должно устанавливаться следующим образом:

- **/hana/data** — без кэширования.
- **/hana/log** — без кэширования, за исключением серии M (см. далее в этом документе).
- **/hana/shared** — кэширование чтения.


Кроме того, при выборе виртуальной машины или изменении ее размера учитывайте пропускную способность ввода-вывода. Общие сведения о пропускной способности хранилища виртуальной машины см. в статье [Размеры виртуальных машин, оптимизированных для операций в памяти](https://docs.microsoft.com/azure/virtual-machines/linux/sizes-memory).

#### <a name="cost-conscious-azure-storage-configuration"></a>Стоимость конфигурации хранилища Azure
В следующей таблице показана конфигурация типов виртуальных машин, которые клиенты часто используют для размещения SAP HANA на виртуальных машинах Azure. Некоторые типы виртуальных машин не соответствуют всем требованиям для SAP HANA. Но пока эти виртуальные машины отлично работали в нерабочих средах. 

> [!NOTE]
> Для рабочих сред проверьте [в документации SAP для IAAS](https://www.sap.com/dmc/exp/2014-09-02-hana-hardware/enEN/iaas.html), поддерживает ли SAP определенный тип виртуальной машины для SAP HANA.


| SKU виртуальной машины | ОЗУ | Макс. пропускная способность<br /> Пропускная способность | /hana/data и /hana/log,<br /> чередующиеся с диспетчером логических томов или MDADM | /hana/shared | том /root | /usr/sap | hana/backup |
| --- | --- | --- | --- | --- | --- | --- | -- |
| DS14v2 | 128 ГБ | 768 МБ/с | 3 x P20 | 1 x S20 | 1 x S6 | 1 x S6 | 1 x S15 |
| E16v3 | 128 ГБ | 384 МБ/с | 3 x P20 | 1 x S20 | 1 x S6 | 1 x S6 | 1 x S15 |
| E32v3 | 256 Гиб | 768 МБ/с | 3 x P20 | 1 x S20 | 1 x S6 | 1 x S6 | 1 x S20 |
| E64v3 | 443 ГиБ | 1200 МБ/с | 3 x P20 | 1 x S20 | 1 x S6 | 1 x S6 | 1 x S30 |
| GS5 | 448 ГиБ | 2000 МБ/с | 3 x P20 | 1 x S20 | 1 x S6 | 1 x S6 | 1 x S30 |
| M32ts | 192 ГиБ | 500 МБ/с | 3 x P20 | 1 x S20 | 1 x S6 | 1 x S6 | 1 x S20 |
| M32ls | 256 Гиб | 500 МБ/с | 3 x P20 | 1 x S20 | 1 x S6 | 1 x S6 | 1 x S20 |
| M64ls | 512 ГБ | 1000 МБ/с | 3 x P20 | 1 x S20 | 1 x S6 | 1 x S6 |1 x S30 |
| M64s | 1000 ГиБ | 1000 МБ/с | 2 x P30 | 1 x S30 | 1 x S6 | 1 x S6 |2 x S30 |
| M64ms | 1750 Гиб | 1000 МБ/с | 3 x P30 | 1 x S30 | 1 x S6 | 1 x S6 | 3 x S30 |
| M128s | 2000 ГиБ | 2000 МБ/с |3 x P30 | 1 x S30 | 1 x S6 | 1 x S6 | 2 x S40 |
| M128ms | 3800 Гиб | 2000 МБ/с | 5 x P30 | 1 x S30 | 1 x S6 | 1 x S6 | 2 x S50 |


Диски 3 x P20, рекомендуемые для типов виртуальных машин меньшего размера, превышают размер томов согласно рекомендациям относительно дискового пространства, указанным в [техническом документе для хранилища SAP TDI](https://www.sap.com/documents/2015/03/74cdb554-5a7c-0010-82c7-eda71af511fa.html). Тем не менее этот вариант, как показано в таблице, был выбран, чтобы обеспечить необходимую пропускную способность диска для SAP HANA. При необходимости вы можете изменить размер тома **/hana/backup**, подобранный для хранения резервных копий, которые в два раза превышают объем памяти тома.   
Проверьте, будет ли пропускная способность хранилища для разных предлагаемых томов соответствовать рабочей нагрузке, которую вы хотите запустить. Если для рабочей нагрузки необходимы большие тома **/hana/data** и **/hana/log**, нужно увеличить количество виртуальных жестких дисков хранилища Azure класса Premium. Изменение размера тома с большим количеством VHD, чем указано, увеличит пропускную способность операций ввода-вывода и число IOPS в пределах ограничений типа виртуальной машины Azure. 

> [!NOTE]
> В приведенных выше конфигурациях было бы невыгодно использовать [соглашение об уровне обслуживания для отдельной виртуальной машины Azure](https://azure.microsoft.com/support/legal/sla/virtual-machines/v1_6/), так как оно использует хранилища класса Standard и Premium одновременно. Однако выбор был сделан для оптимизации затрат.


#### <a name="azure-storage-configuration-to-benefit-for-meeting-single-vm-sla"></a>Конфигурация хранилища Azure для использования соглашения об уровне обслуживания для отдельной виртуальной машины
Если вы хотите воспользоваться преимуществами [соглашения об уровне обслуживания для отдельной виртуальной машины Azure](https://azure.microsoft.com/support/legal/sla/virtual-machines/v1_6/), необходимо использовать только VHD хранилища Azure класса Premium.

> [!NOTE]
> Для рабочих сред проверьте [в документации SAP для IAAS](https://www.sap.com/dmc/exp/2014-09-02-hana-hardware/enEN/iaas.html), поддерживает ли SAP определенный тип виртуальной машины для SAP HANA.

| SKU виртуальной машины | ОЗУ | Макс. пропускная способность<br /> Пропускная способность | /hana/data и /hana/log,<br /> чередующиеся с диспетчером логических томов или MDADM | /hana/shared | том /root | /usr/sap | hana/backup |
| --- | --- | --- | --- | --- | --- | --- | -- |
| DS14v2 | 128 ГБ | 768 МБ/с | 3 x P20 | 1 x P20 | 1 x P6 | 1 x P6 | 1 x P15 |
| E16v3 | 128 ГБ | 384 МБ/с | 3 x P20 | 1 x P20 | 1 x P6 | 1 x P6 | 1 x P15 |
| E32v3 | 256 Гиб | 768 МБ/с | 3 x P20 | 1 x P20 | 1 x P6 | 1 x P6 | 1 x P20 |
| E64v3 | 443 ГиБ | 1200 МБ/с | 3 x P20 | 1 x P20 | 1 x P6 | 1 x P6 | 1 x P30 |
| GS5 | 448 ГиБ | 2000 МБ/с | 3 x P20 | 1 x P20 | 1 x P6 | 1 x P6 | 1 x P30 |
| M32ts | 192 ГиБ | 500 МБ/с | 3 x P20 | 1 x P20 | 1 x P6 | 1 x P6 | 1 x P20 |
| M32ls | 256 Гиб | 500 МБ/с | 3 x P20 | 1 x P20 | 1 x P6 | 1 x P6 | 1 x P20 |
| M64ls | 512 ГБ | 1000 МБ/с | 3 x P20 | 1 x P20 | 1 x P6 | 1 x P6 | 1 x P30 |
| M64s | 1000 ГиБ | 1000 МБ/с | 2 x P30 | 1 x P30 | 1 x P6 | 1 x P6 |2 x P30 |
| M64ms | 1750 Гиб | 1000 МБ/с | 3 x P30 | 1 x P30 | 1 x P6 | 1 x P6 | 3 x P30 |
| M128s | 2000 ГиБ | 2000 МБ/с |3 x P30 | 1 x P30 | 1 x P6 | 1 x P6 | 2 x P40 |
| M128ms | 3800 Гиб | 2000 МБ/с | 5 x P30 | 1 x P30 | 1 x P6 | 1 x P6 | 2 x P50 |


Диски 3 x P20, рекомендуемые для типов виртуальных машин меньшего размера, превышают размер томов согласно рекомендациям относительно дискового пространства, указанным в [техническом документе для хранилища SAP TDI](https://www.sap.com/documents/2015/03/74cdb554-5a7c-0010-82c7-eda71af511fa.html). Тем не менее этот вариант, как показано в таблице, был выбран, чтобы обеспечить необходимую пропускную способность диска для SAP HANA. При необходимости вы можете изменить размер тома **/hana/backup**, подобранный для хранения резервных копий, которые в два раза превышают объем памяти тома.  
Проверьте, будет ли пропускная способность хранилища для разных предлагаемых томов соответствовать рабочей нагрузке, которую вы хотите запустить. Если для рабочей нагрузки необходимы большие тома **/hana/data** и **/hana/log**, нужно увеличить количество виртуальных жестких дисков хранилища Azure класса Premium. Изменение размера тома с большим количеством VHD, чем указано, увеличит пропускную способность операций ввода-вывода и число IOPS в пределах ограничений типа виртуальной машины Azure. 




#### <a name="storage-solution-with-azure-write-accelerator-for-azure-m-series-virtual-machines"></a>Решение хранилища с ускорителем записи Azure для виртуальных машин Azure серии M
Ускоритель записи Azure — это функция, которая предназначена исключительно для виртуальных машин серии M. Как очевидно из названия, целью функции является уменьшение задержки операций ввода-вывода записей в хранилище Azure класса Premium. В SAP HANA ускоритель записи нужно использовать только для тома **/hana/log**. Поэтому приведенные выше конфигурации необходимо изменить. Основное изменение — настроить использование ускорителя записи Azure между томами **/hana/data** и **/hana/log** только для тома **/hana/log**. 

> [!IMPORTANT]
> Сертификация SAP HANA для виртуальных машин Azure серии M предоставлена исключительно для конфигурации, где ускоритель записи Azure используется только для тома **/hana/log**. В результате ожидается, что в развертываниях производственного сценария SAP HANA на виртуальных машинах Azure серии M ускоритель записи Azure будет настроен для тома **/hana/log**.  

> [!NOTE]
> Для рабочих сред проверьте [в документации SAP для IAAS](https://www.sap.com/dmc/exp/2014-09-02-hana-hardware/enEN/iaas.html), поддерживает ли SAP определенный тип виртуальной машины для SAP HANA.

Рекомендуемые конфигурации выглядят следующим образом.

| SKU виртуальной машины | ОЗУ | Макс. пропускная способность<br /> Пропускная способность | hana/data; | hana/log; | /hana/shared | том /root | /usr/sap | hana/backup |
| --- | --- | --- | --- | --- | --- | --- | --- | -- |
| M32ts | 192 ГиБ | 500 МБ/с | 3 x P20 | 2 x P20 | 1 x P20 | 1 x P6 | 1 x P6 |1 x P20 |
| M32ls | 256 Гиб | 500 МБ/с | 3 x P20 | 2 x P20 | 1 x P20 | 1 x P6 | 1 x P6 |1 x P20 |
| M64ls | 512 ГБ | 1000 МБ/с | 3 x P20 | 2 x P20 | 1 x P20 | 1 x P6 | 1 x P6 |1 x P30 |
| M64s | 1000 ГиБ | 1000 МБ/с | 4 x P20 | 2 x P20 | 1 x P30 | 1 x P6 | 1 x P6 |2 x P30 |
| M64ms | 1750 Гиб | 1000 МБ/с | 3 x P30 | 2 x P20 | 1 x P30 | 1 x P6 | 1 x P6 | 3 x P30 |
| M128s | 2000 ГиБ | 2000 МБ/с |3 x P30 | 2 x P20 | 1 x P30 | 1 x P6 | 1 x P6 | 2 x P40 |
| M128ms | 3800 Гиб | 2000 МБ/с | 5 x P30 | 2 x P20 | 1 x P30 | 1 x P6 | 1 x P6 | 2 x P50 |

Проверьте, будет ли пропускная способность хранилища для разных предлагаемых томов соответствовать рабочей нагрузке, которую вы хотите запустить. Если для рабочей нагрузки необходимы большие тома **/hana/data** и **/hana/log**, нужно увеличить количество виртуальных жестких дисков хранилища Azure класса Premium. Изменение размера тома с большим количеством VHD, чем указано, увеличит пропускную способность операций ввода-вывода и число IOPS в пределах ограничений типа виртуальной машины Azure.

Ускоритель записи Azure работает только с [управляемыми дисками Azure](https://azure.microsoft.com/services/managed-disks/). Поэтому в качестве управляемых дисков необходимо развернуть по крайней мере диски хранилища Azure класса Premium, формирующие том **/hana/log**.

Есть ограничения на число виртуальных жестких дисков хранилища Azure класса Premium для каждой виртуальной машины, которые могут поддерживаться ускорителем записи Azure. Сейчас действуют такие ограничения:

- 16 виртуальных жестких дисков для виртуальной машины серии M128xx;
- 8 виртуальных жестких дисков для виртуальной машины серии M64xx.
- 4 виртуальных жестких диска для виртуальной машины серии M32xx.

Подробные инструкции по включению ускорителя записи Azure см. в статье [Write Accelerator](https://docs.microsoft.com/azure/virtual-machines/linux/how-to-enable-write-accelerator) (Ускоритель записи).

Подробные сведения и ограничения для ускорителя записи Azure можно найти в той же статье.

> [!NOTE]
> Приведенные рекомендации по конфигурации диска нацелены на минимальные требования, которые SAP выражает в отношении своих поставщиков инфраструктуры. В реальных сценариях развертывания и рабочей нагрузки клиентов возникали ситуации, когда эти рекомендации по-прежнему не обеспечивали достаточно возможностей. Это могут быть ситуации, когда клиенту нужна более быстрая перезагрузка данных после перезапуска HANA или когда для конфигураций резервного копирования требуется более высокая пропускная способность в хранилище. Другие случаи включали **/hana/log**, в которых 5000 операций ввода-вывода в секунду было недостаточно для конкретной рабочей нагрузки. Поэтому примите эти рекомендации в качестве отправной точки и адаптируйте в соответствии с требованиями своей рабочей нагрузки.
>  

### <a name="set-up-azure-virtual-networks"></a>Настройка виртуальных сетей Azure
Если у вас есть подключение типа "сеть — сеть" в Azure через VPN или ExpressRoute, у вас должна быть как минимум одна виртуальная сеть Azure, которая подключается через виртуальный шлюз к сети VPN или ExpressRoute. В простых развертываниях виртуальный шлюз может быть развернут в подсети виртуальной сети Azure, в которой также размещаются экземпляры SAP HANA. Чтобы установить SAP HANA, необходимо создать две дополнительные подсети в виртуальной сети Azure. Одну подсеть, в которой размещаются виртуальные машины, на которых будут работать экземпляры SAP HANA, и другую подсеть, в которой будут работать виртуальная машина Jumpbox или виртуальная машина управления, для размещения SAP HANA Studio или другого программного обеспечения для управления или ПО приложения.

При установке виртуальных машин для запуска SAP HANA они должны иметь следующее:

- Два виртуальных сетевых адаптера, один из которых подключается к подсети управления, а другой используется для подключения из локальной сети или других сетей к экземпляру SAP HANA на виртуальной машине Azure.
- Статические частные IP-адреса, развернутые для обоих виртуальных сетевых адаптеров.

> [!NOTE]
> Отдельным виртуальным сетевым адаптерам следует назначить статические IP-адреса с помощью Azure. Не следует назначать статические IP-адреса для виртуальных сетевых адаптеров в гостевой ОС. Некоторые службы Azure, такие как служба Azure Backup, полагаются на тот факт, что по крайней мере для основного виртуального сетевого адаптера используется DHCP, а не статические IP-адреса. См. дополнительные сведения в статье [Устранение неполадок при архивации виртуальных машин Azure](https://docs.microsoft.com/azure/backup/backup-azure-vms-troubleshoot#networking). Если виртуальной машине нужно присвоить несколько статических IP-адресов, ей также необходимо присвоить несколько виртуальных сетевых адаптеров.
>
>

Однако для долгосрочных развертываний вам необходимо создать сетевую архитектуру виртуального центра обработки данных в Azure. Для такой архитектуры рекомендуется разделить шлюз виртуальной сети Azure, который подключается к локальной сети, разместив его в отдельной виртуальной сети Azure. В этой отдельной виртуальной сети должен размещаться весь входящий трафик локальной сети либо Интернета. Этот подход позволяет развернуть программное обеспечение для аудита и регистрации трафика, который входит в виртуальный центр обработки данных в Azure в этой отдельной центральной виртуальной сети. Таким образом, у вас есть одна виртуальная сеть, в которой размещается все программное обеспечение и конфигурации, относящиеся ко входящему и исходящему трафику развертывания Azure.

Статьи [Виртуальный центр обработки данных Microsoft Azure с точки зрения сети](https://docs.microsoft.com/azure/architecture/vdc/networking-virtual-datacenter) и [Виртуальный центр обработки данных Azure и плоскость управления предприятием](https://docs.microsoft.com/azure/architecture/vdc/) предоставляют дополнительные сведения о работе с виртуальным центром обработки данных и соответствующей структуре виртуальной сети Azure.


>[!NOTE]
>Трафик, который проходит между центральной и периферийной виртуальными сетями с использованием [пиринга виртуальных сетей Azure](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview), [оплачивается](https://azure.microsoft.com/pricing/details/virtual-network/) отдельно. Исходя из этих затрат, может потребоваться рассмотреть возможность компромиссов между использованием строгой звездообразной топологии сети и запуском нескольких [шлюзов Azure ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-about-virtual-network-gateways), которые вы подключаете к периферийным зонам, чтобы обойти пиринг виртуальных сетей. Тем не менее использование шлюзов Azure ExpressRoute также сопровождается дополнительными [расходами](https://azure.microsoft.com/pricing/details/vpn-gateway/). Вы также можете столкнуться с дополнительными расходами на стороннее программное обеспечение, используемое для регистрации, аудита и мониторинга трафика. В зависимости от затрат на обмен данными с помощью пиринга виртуальных сетей с одной стороны и затрат, связанных с дополнительными шлюзами Azure ExpressRoute и дополнительными лицензиями на программное обеспечение, можно выполнить микросегментацию в пределах одной виртуальной сети, используя в качестве изолирующей единицы подсеть, а не виртуальную сеть.


Общие сведения о различных методах назначения IP-адресов см. в статье [Типы IP-адресов и методы распределения в Azure](https://docs.microsoft.com/azure/virtual-network/virtual-network-ip-addresses-overview-arm). 

Для виртуальных машин, работающих под управлением SAP HANA, необходимо назначить статические IP-адреса. Причиной является то, что некоторые атрибуты конфигурации для HANA ссылаются на IP-адреса.

С помощью [групп безопасности сети (NSG) Azure](https://docs.microsoft.com/azure/virtual-network/virtual-networks-nsg) можно перенаправить трафик, поступающий к экземпляру SAP HANA или Jumpbox. Группы безопасности сети и [группы безопасности приложений](https://docs.microsoft.com/azure/virtual-network/security-overview#application-security-groups) связаны с подсетью SAP HANA и подсетью управления.

На следующем рисунке представлен обзор приблизительной схемы развертывания SAP HANA со звездообразной архитектурой виртуальной сети:

![Приблизительная схема развертывания SAP HANA](media/hana-vm-operations/hana-simple-networking.PNG)

Чтобы развернуть SAP HANA в Azure без подключения типа "сеть — сеть", следует изолировать экземпляр SAP HANA от общедоступного Интернета и скрыть его за прокси-сервером. В этом стандартном сценарии для развертывания используются встроенные DNS-службы Azure для разрешения имен узлов. Встроенные DNS-службы Azure особо важны при более сложном развертывании, в котором используются общедоступные IP-адреса. Используйте группы безопасности сети Azure и [виртуальные сетевые модули Azure](https://azure.microsoft.com/solutions/network-appliances/) для контроля и отслеживания маршрутизации из Интернета в архитектуру виртуальной сети в Azure. На следующем рисунке показана примерная схема для развертывания SAP HANA без подключения типа "сеть — сеть" в звездообразной архитектуре виртуальной сети:
  
![Примерная схема развертывания SAP HANA без подключения "сеть — сеть"](media/hana-vm-operations/hana-simple-networking2.PNG)
 

Еще одно описание того, как использовать виртуальные сетевые модули Azure для контроля и мониторинга доступа из Интернета без звездообразной архитектуры виртуальной сети, можно найти в статье [Развертывание высокодоступных виртуальных сетевых модулей](https://docs.microsoft.com/azure/architecture/reference-architectures/dmz/nva-ha).


## <a name="configuring-azure-infrastructure-for-sap-hana-scale-out"></a>Настройка инфраструктуры Azure для горизонтального масштабирования SAP HANA
У корпорации Майкрософт есть виртуальная машина серии M, сертифицированная для конфигурации горизонтального масштабирования SAP HANA. Виртуальная машина M128s сертифицирована для горизонтального масштабирования до 16 узлов. Изменения сертификатов горизонтального масштабирования SAP HANA на виртуальных машинах Azure см. в [списке сертифицированных платформ IaaS](https://www.sap.com/dmc/exp/2014-09-02-hana-hardware/enEN/iaas.html#categories=Microsoft%20Azure).

Минимальные выпуски ОС для развертывания конфигураций горизонтального масштабирования на виртуальных машинах Azure:

- SUSE Linux 12 с пакетом обновления 3 (SP3);
- Red Hat Linux 7.4.

Для сертификации горизонтального масштабирования с 16 узлами:

- Один узел должен являться главным.
- Максимум 15 рабочих узлов.

>[!NOTE]
>В горизонтально масштабируемых развертываниях виртуальных машин Azure нет возможности использовать резервный узел.
>

Есть две причины, по которым невозможно настроить резервный узел:

- Azure на данный момент не имеет собственной службы NFS. В результате общедоступные ресурсы NFS необходимо настроить с помощью сторонних функций.
- Ни одна из сторонних конфигураций NFS не может выполнить условия задержки хранилища SAP HANA, когда их решения развернуты в Azure.

В результате тома **/hana/data** и **/hana/log** не могут использоваться совместно. Из-за раздельного использования этих томов отдельных узлов в конфигурации горизонтального масштабирования не может использоваться резервный узел SAP HANA.

В результате базовая архитектура для одного узла в конфигурации горизонтального масштабирования будет выглядеть так:

![Основы горизонтального масштабирования одного узла](media/hana-vm-operations/scale-out-basics.PNG)

Базовая конфигурация узла виртуальной машины для горизонтального масштабирования SAP HANA выглядит так:

- Для **/hana/shared** вы можете создать высокодоступный кластер NFS под управлением SUSE Linux 12 SP3. В этом кластере будут размещаться общие ресурсы NFS **/hana/shared** вашей конфигурации горизонтального масштабирования и центральные службы SAP NetWeaver или BW/4HANA. Документация для создания такой конфигурации доступна в статье [Обеспечение высокого уровня доступности NFS на виртуальных машинах Azure в SUSE Linux Enterprise Server](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/high-availability-guide-suse-nfs).
- Все остальные тома диска **НЕ** используются совместно различными узлами и **НЕ** основаны на NFS. Конфигурации и этапы установки для горизонтально масштабируемых установок HANA с раздельными томами **/hana/data** и **/hana/log** приведены ниже в этом документе.

>[!NOTE]
>Отображаемый на рисунке высокодоступный кластер NFS пока поддерживается только в SUSE Linux. В ближайшее время будет предложено высокодоступное решение NFS на базе Red Hat.

Определение размеров томов для узлов такое же, как для масштабирования, за исключением **/hana/shared**. Для номера SKU виртуальной машины M128s предлагаемые размеры и типы выглядят так:

| SKU виртуальной машины | ОЗУ | Макс. пропускная способность<br /> Пропускная способность | hana/data; | hana/log; | том /root | /usr/sap | hana/backup |
| --- | --- | --- | --- | --- | --- | --- | --- |
| M128s | 2000 ГиБ | 2000 МБ/с |3 x P30 | 2 x P20 | 1 x P6 | 1 x P6 | 2 x P40 |


Проверьте, будет ли пропускная способность хранилища для разных предлагаемых томов соответствовать рабочей нагрузке, которую вы хотите запустить. Если для рабочей нагрузки необходимы большие тома **/hana/data** и **/hana/log**, нужно увеличить количество виртуальных жестких дисков хранилища Azure класса Premium. Изменение размера тома с большим количеством VHD, чем указано, увеличит пропускную способность операций ввода-вывода и число IOPS в пределах ограничений типа виртуальной машины Azure. Также примените ускоритель записи Azure к дискам, которые формируют том **/hana/log**.
 
В документе с [требованиями к хранилищу SAP HANA TDI](https://www.sap.com/documents/2015/03/74cdb554-5a7c-0010-82c7-eda71af511fa.html) описана формула, которая определяет размер тома **/hana/shared** для горизонтального масштабирования как размер памяти одного главного узла на 4 рабочих узла.

При условии, что вы выбрали виртуальную машину Azure M128s с сертифицированным горизонтально масштабируемым развертыванием SAP HANA и примерно 2 ТБ памяти, рекомендации по SAP можно представить следующим образом.

- Один главный узел и до четырех рабочих узлов: том **/hana/shared** должен иметь размер 2 ТБ. 
- Один главный узел и от 5 до 8 рабочих узлов: том **/hana/shared** должен иметь размер 4 ТБ. 
- Один главный узел и от 9 до 12 рабочих узлов: том **/hana/shared** должен иметь размер 6 ТБ. 
- Один главный узел и от 12 до 15 рабочих узлов: том **/hana/shared** должен иметь размер 8 ТБ.

Еще одной важной архитектурой, представленной на рисунке одноузловой конфигурации горизонтального масштабирования виртуальной машины SAP HANA, является конфигурация виртуальной сети или, что важнее, подсети. SAP настоятельно рекомендует отделить трафик к клиенту или приложению от трафика между узлами HANA. Как показано на рисунке, эта цель достигается за счет наличия двух разных виртуальных сетевых адаптеров, подключенных к виртуальной машине. Оба адаптера находятся в разных подсетях и имеют два разных IP-адреса. Затем вы будете управлять потоком трафика с помощью правил маршрутизации с использованием групп безопасности сети или определенных пользователем маршрутов.

В частности, в Azure нет средств и методов для обеспечения качества обслуживания и квот для конкретных виртуальных сетевых адаптеров. В результате разделение обращений к клиенту или приложению и внутриузловой коммуникации не открывает никаких возможностей для определения приоритетности одного потока трафика над другим. Вместо этого разделение остается мерой безопасности, изолирующей внутриузловые связи конфигураций горизонтального масштабирования.  

>[!IMPORTANT]
>SAP настоятельно рекомендует отделять трафик к клиенту и приложению от внутриузлового трафика, как описано в этом документе. Поэтому настоятельно рекомендуется реализовать архитектуру, показанную на последнем рисунке.
>

С точки зрения сети минимальная требуемая архитектура сети будет выглядеть так:

![Основы горизонтального масштабирования одного узла](media/hana-vm-operations/scale-out-networking-overview.PNG)

Поддерживаемые в данный момент ограничения — 15 рабочих и один главный узел.

С точки зрения хранения архитектура хранилища будет выглядеть так:


![Основы горизонтального масштабирования одного узла](media/hana-vm-operations/scale-out-storage-overview.PNG)

Том **/hana/shared** расположен в высокодоступной конфигурации общего ресурса NFS. При этом все остальные диски локально подключены к отдельным виртуальным машинам. 

### <a name="highly-available-nfs-share"></a>Общий ресурс NFS с высокой доступностью
К настоящему времени высокодоступный кластер NFS работает только с SUSE Linux. В документе [Обеспечение высокого уровня доступности NFS на виртуальных машинах Azure в SUSE Linux Enterprise Server](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/high-availability-guide-suse-nfs) описано, как это настроить. Если вы не используете кластер NFS совместно с другими конфигурациями HANA за пределами виртуальной сети Azure, где выполняются экземпляры SAP HANA, установите его в ту же виртуальную сеть. Установите его в свою подсеть и убедитесь, что не весь произвольный трафик может получить доступ к подсети. Вместо этого ограничьте трафик к этой подсети IP-адресами виртуальных машин, которые управляют трафиком в томе **/hana/shared**.

Что касается виртуального сетевого адаптера виртуальной машины горизонтального масштабирования HANA, которая должна маршрутизировать трафик **/hana/shared**, выполните следующее.

- Так как входящий трафик **/hana/shared** умеренный, направляйте его через виртуальный сетевой адаптер, который назначается клиентской сети в минимальной конфигурации.
- Далее для входящего трафика **/hana/shared** разверните третью подсеть в виртуальной сети, где развернута конфигурация горизонтального масштабирования SAP HANA, и назначьте третий виртуальный сетевой адаптер, размещенный в этой подсети. Используйте третий виртуальный сетевой адаптер и связанный с ним IP-адрес для трафика в общий ресурс NFS. Затем вы можете применять отдельные правила доступа и маршрутизации.

>[!IMPORTANT]
>Трафик между виртуальными машинами, на которых развернуты экземпляры SAP HANA с конфигурацией горизонтального масштабирования и имеется высокодоступная NFS, ни при каких обстоятельствах не может быть перенаправлен ​​через [виртуальные сетевые модули](https://azure.microsoft.com/solutions/network-appliances/) или аналогичные виртуальные устройства. Группы безопасности сети Azure не являются такими устройствами. Проверьте правила маршрутизации, чтобы убедиться, что виртуальные сетевые модули или подобные виртуальные устройства игнорируются при доступе к высокодоступному общему ресурсу NFS из виртуальных машин, где выполняется SAP HANA.
> 

Если вы хотите совместно использовать высокодоступный кластер NFS в конфигурациях SAP HANA, переместите все эти конфигурации HANA в одну и ту же виртуальную сеть. 
 

### <a name="installing-sap-hana-scale-out-n-azure"></a>Установка конфигурации горизонтального масштабирования SAP HANA в Azure
При установке конфигурации горизонтального масштабирования SAP вам необходимо выполнить приблизительно следующие шаги:

- Развертывание новой инфраструктуры виртуальной сети Azure или адаптация существующей.
- Развертывание новых виртуальных машин, использующих управляемые Azure тома хранилищ класса Premium.
- Развертывание нового высокодоступного кластера NFS или адаптация существующего.
- Адаптация сетевой маршрутизации, чтобы внутриузловая связь между виртуальными машинами не маршрутизировалась через [виртуальный сетевой модуль](https://azure.microsoft.com/solutions/network-appliances/). То же самое верно для трафика между виртуальными машинами и высокодоступным кластером NFS.
- Установка главного узла SAP HANA.
- Адаптация параметров конфигурации главного узла SAP HANA.
- Продолжение установки рабочих узлов SAP HANA.

#### <a name="installation-of-sap-hana-in-scale-out-configuration"></a>Установка SAP HANA с конфигурацией горизонтального масштабирования
По мере развертывания инфраструктуры виртуальных машин Azure и выполнения всех других подготовительных работ вам необходимо установить конфигурации горизонтального масштабирования SAP HANA следующим образом:

- Установите главный узел SAP HANA в соответствии с документацией SAP.
- **После установки вам необходимо изменить файл global.ini и добавить в него параметр basepath_shared = no**. Этот параметр позволит SAP HANA запускаться в режиме горизонтального масштабирования без общих томов **/hana/data** и **/hana/log** между узлами. Дополнительные сведения см. в [примечании к SAP № 2080991](https://launchpad.support.sap.com/#/notes/2080991).
- После изменения параметра global.ini перезапустите экземпляр SAP HANA.
- Добавьте дополнительные рабочие узлы. Ознакомьтесь с командой <https://help.sap.com/viewer/6b94445c94ae495c83a19646e7c3fd56/2.0.00/en-US/0d9fe701e2214e98ad4f8721f6558c34.html>. Укажите внутреннюю сеть для межузлового обмена данными SAP HANA во время установки или позже, используя, к примеру, локальное средство hdblcm. Дополнительные сведения см. в [примечании к SAP № 2183363](https://launchpad.support.sap.com/#/notes/2183363). 

Следуя этой процедуре настройки, установленная конфигурация горизонтального масштабирования будет применять не используемые совместно диски для выполнения томов **/hana/data** и **/hana/log**. При этом том **/hana/shared** будет размещен в высокодоступном общем ресурсе NFS.


## <a name="sap-hana-dynamic-tiering-20-for-azure-virtual-machines"></a>Использование SAP HANA Dynamic Tiering 2.0 для виртуальных машин Azure

Кроме сертификации SAP HANA на виртуальных машинах Azure серии M, в Microsoft Azure поддерживается решение SAP HANA Dynamic Tiering 2.0 (подробнее см. приведенную ниже ссылку на соответствующую документацию). Нет никакой разницы между установкой продукта и использованием его через, например, панель SAP HANA на виртуальной машине Azure. Но есть несколько важных аспектов, которые нужно обязательно соблюдать для включения официальной поддержки в Azure. Эти важные замечания описаны ниже. Далее в этой статье вместо полного названия Dynamic Tiering 2.0 используется сокращение DT 2.0.

SAP HANA Dynamic Tiering 2.0 не поддерживается в SAP BW или S4HANA. Это решение сейчас используется в основном с собственными приложениями HANA.


### <a name="overview"></a>Обзор

На рисунке ниже представлены сведения о поддержке DT 2.0 на платформе Microsoft Azure. Есть набор обязательных требований, которые нужно соблюдать для официальной сертификации:

- DT 2.0 необходимо устанавливать на выделенной виртуальной машине Azure (нельзя запускать это решение на той же виртуальной машине, где выполняется SAP HANA);
- виртуальные машины для SAP HANA и 2.0 DT должны быть развернуты в одной и той же виртуальной сети Azure;
- виртуальные машины для SAP HANA и DT 2.0 должны развертываться с включенной функцией ускорения сети Azure;
- для виртуальных машин DT 2.0 нужно использовать хранилище Azure класса Premium;
- к виртуальной машине DT 2.0 нужно подключить несколько дисков Azure;
- необходимо настроить программный RAID-массив или чередование томов (с помощью диспетчера логических томов или средства mdadm), используя чередование на дисках Azure.

Подробнее эти требования поясняются в следующих разделах.

![Обзор архитектуры SAP HANA DT 2.0](media/hana-vm-operations/hana-dt-20.PNG)



### <a name="dedicated-azure-vm-for-sap-hana-dt-20"></a>Выделенная виртуальная машина Azure для SAP HANA DT 2.0

В системах IaaS Azure DT 2.0 поддерживается только на выделенной виртуальной машине. DT 2.0 нельзя выполнять на той же виртуальной машине Azure, где запущен экземпляр HANA. Изначально для запуска SAP HANA DT 2.0 можно использовать два типа виртуальных машин:

M64-32ms и E32sv3. 

См. [описание типов виртуальных машин](https://docs.microsoft.com/azure/virtual-machines/linux/sizes-memory).

Исходя из того, что основная задача DT 2.0 заключается в разгрузке "теплых" данных для снижения расходов, есть смысл всегда использовать правильные размеры виртуальных машин. Но для возможных сочетаний нет строгих правил и ограничений. Все зависит от конкретной рабочей нагрузки.

Мы рекомендуем использовать примерно следующие конфигурации.

| Тип виртуальной машины для SAP HANA | Тип виртуальной машины для DT 2.0 |
| --- | --- | 
| M128ms | M64-32ms |
| M128s | M64-32ms |
| M64ms | E32sv3 |
| M64s | E32sv3 |


Поддерживаются любые сочетания виртуальных машин серии M, сертифицированных для SAP HANA, с поддерживаемыми для DT 2.0 типами виртуальных машин (M64 32ms, E32sv3).


### <a name="azure-networking-and-sap-hana-dt-20"></a>Сети Azure и SAP HANA DT 2.0

Для установки DT 2.0 на выделенной виртуальной машине требуется пропускная способность сети не менее 10 ГБ между виртуальными машинами для DT 2.0 и SAP HANA. Поэтому все виртуальные машины необходимо поместить в одну виртуальную сеть Azure, а также включить функцию ускорения сети Azure.

См. дополнительные сведения об [ускорении сети Azure](https://docs.microsoft.com/azure/virtual-network/create-vm-accelerated-networking-cli).

### <a name="vm-storage-for-sap-hana-dt-20"></a>Хранилище виртуальной машины для SAP HANA DT 2.0

В соответствии с рекомендациями для DT 2.0 на каждое физическое ядро следует выделить пропускную способность дискового ввода-вывода не менее 50 МБ/с. Изучая спецификации двух типов виртуальных машин Azure, которые поддерживаются для DT 2.0, можно заметить ограничения на максимальное значение пропускной способности дискового ввода-вывода:

- E32sv3: 768 МБ/c (без кэширования), то есть по 48 МБ/с на физическое ядро;
- M64-32ms: 1000 МБ/c (без кэширования), то есть по 62,5 МБ/с на физическое ядро.

Необходимо присоединить к виртуальной машине для DT 2.0 несколько дисков Azure и создать программный RAID-массив (с чередованием) на уровне операционной системы, чтобы достичь необходимого уровня пропускной способности дисков для этой виртуальной машины. Один диск Azure не может обеспечить пропускную способность, соответствующую максимальному ограничению для виртуальной машины. Для работы DT 2.0 необходимо использовать хранилище Azure класса Premium. 

- См. дополнительные сведения о [доступных типах дисков Azure](https://docs.microsoft.com/azure/virtual-machines/windows/premium-storage).
- См. дополнительные сведения о [создании программного RAID-массива с помощью средства mdadm](https://docs.microsoft.com/azure/virtual-machines/linux/configure-raid).
- См. дополнительные сведения о [настройке диспетчера логических томов для создания чередующегося тома, позволяющего обеспечить максимальную пропускную способность](https://docs.microsoft.com/azure/virtual-machines/linux/configure-lvm).

В зависимости от требований к размеру есть несколько вариантов, позволяющих достичь максимальной пропускной способности для виртуальной машины. Ниже приведены возможные конфигурации дисков для томов данных по каждому типу виртуальной машины для DT 2.0, позволяющие достичь верхнего предела пропускной способности для виртуальной машины. Виртуальную машину E32sv3 следует рассматривать как начальный уровень, пригодный лишь для небольших рабочих нагрузок. Если будет очевидно, что ее скорости недостаточно, следует перейти на виртуальную машину размера M64-32ms.
M64-32ms имеет много памяти, поэтому нагрузка операций ввода-вывода может не достигать установленного предела, особенно для рабочих нагрузок с большой нагрузкой на чтение. В этом случае число дисков в чередующемся наборе можно уменьшить с учетом требований для конкретной рабочей нагрузки. Но если вы не хотите рисковать, используйте перечисленные ниже конфигурации дисков, обеспечивающие максимальную пропускную способность.


| SKU виртуальной машины | Конфигурация дисков 1 | Конфигурация дисков 2 | Конфигурация дисков 3 | Конфигурация дисков 4 | Конфигурация дисков 5 | 
| ---- | ---- | ---- | ---- | ---- | ---- | 
| M64-32ms | 4 x P50 -> 16 ТБ | 4 x P40 -> 8 ТБ | 5 x P30 -> 5 ТБ | 7 x P20 -> 3,5 ТБ | 8 x P15 -> 2 ТБ | 
| E32sv3 | 3 x P50 -> 12 ТБ | 3 x P40 -> 6 ТБ | 4 x P30 -> 4 ТБ | 5 x P20 -> 2,5 ТБ | 6 x P15 -> 1,5 ТБ | 


В некоторых случаях, особенно если рабочая нагрузка создает большую нагрузку на чтение, производительность операций ввода-вывода можно увеличить включением кэширования узла Azure в режиме "только для чтения", как рекомендуется для томов данных программного обеспечения для базы данных. В этом случае для дискового кэша журнала транзакций Azure следует выбрать значение none. 

Что касается размера тома для журнала, мы рекомендуем использовать примерно 15 % от размера данных. Чтобы создать том журнала, можно использовать другой тип дисков Azure с учетом ограничений по бюджету и требований к пропускной способности. Для обеспечения высокой пропускной способности тома журнала (при использовании виртуальной машины M64-32ms) также рекомендуется включить ускоритель записи (обязательно для SAP HANA). Это обеспечит оптимальное значение задержки для записи на диск журнала транзакций (доступно только для серии M). Но при этом нужно учитывать несколько важных аспектов, например максимальное число дисков для используемого типа виртуальной машины. См. дополнительные сведения об [ускорителе записи](https://docs.microsoft.com/azure/virtual-machines/windows/how-to-enable-write-accelerator).


Вот несколько примеров, иллюстрирующих выбор размера для тома журнала.

| Размер тома данных и тип дисков | Конфигурация 1 для объема и типа диска для журнала | Конфигурация 2 для объема и типа диска для журнала |
| --- | --- | --- |
| 4 x P50 -> 16 ТБ | 5 x P20 -> 2,5 ТБ | 3 x P30 -> 3 ТБ |
| 6 x P15 -> 1,5 ТБ | 4 x P6 -> 256 ТБ | 1 x P15 -> 256 ТБ |


Как и для горизонтального масштабирования SAP HANA, каталог/hana/shared должен быть предоставлен в совместный доступ виртуальным машинам для SAP HANA и DT 2.0. Мы рекомендуем использовать ту же архитектуру, что и для горизонтального масштабирования SAP HANA, с выделенными виртуальными машинами, которые выполняют роль NFS-сервера с высоким уровнем доступности. Чтобы создать общий том для резервного копирования, можно использовать аналогичную схему. Клиенту следует самостоятельно решить, нужен ли ему высокий уровень доступности или в качестве сервера для резервного копирования можно использовать выделенную виртуальную машину с достаточной емкостью хранилища.



### <a name="links-to-dt-20-documentation"></a>Ссылки на документацию по DT 2.0 

- [SAP HANA Dynamic Tiering: Installation and Update Guide (Руководство по установке и обновлению SAP HANA Dynamic Tiering)](https://help.sap.com/viewer/88f82e0d010e4da1bc8963f18346f46e/2.0.03/en-US)
- [Official SAP HANA Dynamic Tiering tutorials and resources](https://www.sap.com/developer/topics/hana-dynamic-tiering.html) (Официальные руководства и ресурсы по SAP HANA Dynamic Tiering)
- [Подтверждение концепции для SAP HANA Dynamic Tiering](https://blogs.sap.com/2017/12/08/sap-hana-dynamic-tiering-delivering-on-low-tco-with-impressive-performance/)
- [SAP HANA 2.0 SPS 02 dynamic tiering enhancements](https://blogs.sap.com/2017/07/31/sap-hana-2.0-sps-02-dynamic-tiering-enhancements/) (Улучшения SAP HANA Dynamic Tiering SPS 02)




## <a name="operations-for-deploying-sap-hana-on-azure-vms"></a>Операции развертывания SAP HANA на виртуальных машинах Azure
В следующих разделах описаны некоторые операции, связанные с развертыванием систем SAP HANA на виртуальных машинах Azure.

### <a name="back-up-and-restore-operations-on-azure-vms"></a>Операции архивации и восстановления на виртуальных машинах Azure
Следующие документы содержат сведения об архивации и восстановлении развертывания SAP HANA:

- [Обзор резервного копирования SAP HANA](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/sap-hana-backup-guide)
- [Резервное копирование SAP HANA на уровне файлов](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/sap-hana-backup-file-level)
- [Резервное копирование SAP HANA на основе моментальных снимков хранилища](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/sap-hana-backup-storage-snapshots)


### <a name="start-and-restart-vms-that-contain-sap-hana"></a>Запуск и перезапуск виртуальных машин с SAP HANA
Отличительной чертой общедоступного облака Azure является то, что плата взимается только за время вычисления. Например, при завершении работы виртуальной машины под управлением SAP HANA будет выставлен счет только за расходы на хранение за это время. Другая функция доступна при указании статических IP-адресов для виртуальных машин в начальном развертывании. Если перезагрузить виртуальную машину с SAP HANA, она перезапустится с предыдущим IP-адресом. 


### <a name="use-saprouter-for-sap-remote-support"></a>Удаленная поддержка SAP с помощью SAPRouter
Если вы установили подключение "сеть — сеть" между локальными расположениями и Azure и используете компоненты SAP, вероятно, у вас уже есть SAProuter. В этом случае выполните следующие действия для включения удаленной поддержки:

- Сохраните частный и статический IP-адрес виртуальной машины, на которой размещается SAP HANA, в конфигурации SAProuter.
- Настройте группу безопасности сети подсети, в которой размещена виртуальная машина HANA, чтобы разрешить трафик через порт TCP/IP 3299.

Если вы подключаетесь к Azure через Интернет и у вас нет маршрутизатора SAP для виртуальной машины с SAP HANA, необходимо установить компонент. Установите SAProuter на отдельной виртуальной машине в подсети управления. На следующем рисунке показана примерная схема для развертывания SAP HANA с SAProuter и без подключения "сеть — сеть":

![Примерная схема развертывания SAP HANA без подключения "сеть — сеть" и SAProuter](media/hana-vm-operations/hana-simple-networking3.PNG)

SAProuter следует установить на отдельной виртуальной машине, а не на виртуальной машине Jumpbox. Отдельная виртуальная машина должна иметь статический IP-адрес. Чтобы подключить ваш SAProuter к SAProuter, размещенный в SAP, обратитесь к SAP для получения IP-адреса. (SAProuter, размещенный в SAP, является аналогом экземпляра SAProuter, установленного на виртуальной машине.) С помощью IP-адреса SAP можно настроить экземпляр SAProuter. В параметрах конфигурации требуется только TCP-порт 3299.

Дополнительные сведения о том, как настроить и поддерживать подключения удаленной поддержки через SAProuter, см. [в документации по SAP](https://support.sap.com/en/tools/connectivity-tools/remote-support.html).

### <a name="high-availability-with-sap-hana-on-azure-native-vms"></a>Высокий уровень доступности SAP HANA на собственных виртуальных машинах Azure
Если вы используете SUSE Linux Enterprise Server для SAP Applications 12 с пакетом обновления 1 (SP1) или более поздней версии, можно установить кластер Pacemaker с устройствами STONITH. С помощью этих устройств можно настроить конфигурацию SAP HANA, которая использует синхронную репликацию с репликацией системы HANA и автоматическим переходом на другой ресурс. Дополнительные сведения об установке см. в статье [Руководство по обеспечению высокого уровня доступности SAP HANA на виртуальных машинах Azure](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/sap-hana-availability-overview).
