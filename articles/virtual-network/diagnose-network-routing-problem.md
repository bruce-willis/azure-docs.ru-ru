---
title: Диагностика проблемы с маршрутизацией виртуальной машины Azure | Документация Майкрософт
description: Узнайте, как диагностировать проблему с маршрутизацией трафика виртуальной машины, просмотрев действующие маршруты для этой виртуальной машины.
services: virtual-network
documentationcenter: na
author: jimdial
manager: jeconnoc
editor: ''
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/30/2018
ms.author: jdial
ms.openlocfilehash: 695d5f1507f766cf0a2ad96d7dcd25f45f98c20e
ms.sourcegitcommit: 32d218f5bd74f1cd106f4248115985df631d0a8c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2018
ms.locfileid: "46994723"
---
# <a name="diagnose-a-virtual-machine-routing-problem"></a>Диагностика проблем с маршрутизацией виртуальной машины

В этой статье вы узнаете, как диагностировать проблемы с маршрутизацией, просмотрев действующие маршруты для сетевого интерфейса в виртуальной машине. Azure создает несколько маршрутов по умолчанию для каждой подсети в виртуальной сети. Маршруты по умолчанию Azure можно переопределить, определив маршруты в таблице маршрутов, а затем связав эту таблицу маршрутов с подсетью. Созданные вами маршруты, маршруты по умолчанию Azure и все маршруты, распространяемые из локальной сети через VPN-шлюз Azure (если виртуальная сеть подключена к локальной сети) через протокол BGP, являются действующими маршрутами для всех сетевых интерфейсов в подсети. Если вам неизвестны приведенные здесь понятия, ознакомьтесь с общими сведениями о [виртуальных сетях](virtual-networks-overview.md), [сетевом интерфейсе](virtual-network-network-interface.md) и [маршрутизации](virtual-networks-udr-overview.md).

## <a name="scenario"></a>Сценарий

При попытке подключиться к виртуальной машине происходит сбой. Чтобы определить, почему не удается подключиться к виртуальной машине, вы можете просмотреть действующие маршруты для сетевого интерфейса с помощью [портала](#diagnose-using-azure-portal) Azure, [PowerShell](#diagnose-using-powershell) или [Azure CLI](#diagnose-using-azure-cli).

Чтобы выполнить приведенные ниже инструкции, требуется виртуальная машина, для которой будут просматриваться действующие маршруты. Если у вас ее нет, разверните виртуальную машину [Linux](../virtual-machines/linux/quick-create-portal.md?toc=%2fazure%2fvirtual-network%2ftoc.json) или [Windows](../virtual-machines/windows/quick-create-portal.md?toc=%2fazure%2fvirtual-network%2ftoc.json) для выполнения задач, описанных в этой статье. Примеры в этой статье относятся к виртуальной машине *myVM* с сетевым интерфейсом *myVMVMNic*. Виртуальная машина и сетевой интерфейс находятся в группе ресурсов *myResourceGroup* в регионе *Восточная часть США*. Измените значения в инструкциях, чтобы они соответствовали значениям для виртуальной машины, проблема с которой диагностируется.

## <a name="diagnose-using-azure-portal"></a>Диагностика с помощью портала Azure

1. Войдите на [портал Azure](https://portal.azure.com) с помощью учетной записи Azure, которая предоставляет необходимые [разрешения](virtual-network-network-interface.md#permissions).
2. В верхней части окна портала Azure введите в поле поиска имя запущенной виртуальной машины. Когда в результатах поиска появится имя виртуальной машины, щелкните его.
3. Выберите **Диагностика и решение проблем**, а затем в разделе **Рекомендуемые действия** щелкните **фактические маршруты** в пункте 7, как показано на следующем рисунке.

    ![Просмотр действующих маршрутов](./media/diagnose-network-routing-problem/view-effective-routes.png)

4. Отобразятся действующие маршруты для сетевого интерфейса **myVMVMNic**, как показано ниже.

     ![Просмотр действующих маршрутов](./media/diagnose-network-routing-problem/effective-routes.png)

    Если к виртуальной машине подключено несколько сетевых интерфейсов, можно просмотреть действующие маршруты для любого из них, выбрав соответствующий сетевой интерфейс. Так как сетевые интерфейсы могут находиться в разных подсетях, у них могут быть разные действующие маршруты.

    В примере, показанном на предыдущем рисунке, перечислены маршруты по умолчанию, создаваемые Azure для каждой подсети. Ваш список содержит по крайней мере эти маршруты. Он может также содержать дополнительные маршруты, в зависимости от включенных возможностей виртуальной сети: пиринга с другой виртуальной сетью или подключения к локальной сети через VPN-шлюз Azure. Дополнительные сведения о каждом этом маршруте и других маршрутах, которые могут отображаться для сетевого интерфейса, приведены в разделе [Маршрутизация трафика в виртуальной сети](virtual-networks-udr-overview.md). Если в списке большое количество маршрутов, удобно будет щелкнуть **Скачать**, чтобы скачать CSV-файл со списком маршрутов.

На предыдущем шаге мы просмотрели действующие маршруты с помощью виртуальной машины. Но их можно просмотреть и другими способами:
- **Отдельный сетевой интерфейс**. Узнайте, как [просмотреть сведения о сетевом интерфейсе](virtual-network-network-interface.md#view-network-interface-settings).
- **Отдельная таблица маршрутов**. Узнайте, как [просмотреть таблицу маршрутов](manage-route-table.md#view-details-of-a-route-table).

## <a name="diagnose-using-powershell"></a>Диагностика с помощью PowerShell

Вы можете выполнить приведенные ниже команды в [Azure Cloud Shell](https://shell.azure.com/powershell) или с помощью PowerShell на своем компьютере. Azure Cloud Shell — это бесплатная интерактивная оболочка. Она включает предварительно установленные общие инструменты Azure и настроена для использования с вашей учетной записью. Если вы решили запустить PowerShell на своем компьютере, вам потребуется модуль PowerShell *AzureRM* 6.0.1 или более поздней версии. Выполните `Get-Module -ListAvailable AzureRM` на компьютере, чтобы получить сведения об установленной версии. Если вам необходимо выполнить обновление, ознакомьтесь со статьей, посвященной [установке модуля Azure PowerShell](/powershell/azure/install-azurerm-ps). Если PowerShell работает локально, необходимо также выполнить `Login-AzureRmAccount`, чтобы войти в Azure с учетной записью, предоставляющей [необходимые разрешения](virtual-network-network-interface.md#permissions).

Получите действующие маршруты для сетевого интерфейса, выполнив командлет [Get-AzureRmEffectiveRouteTable](/powershell/module/azurerm.network/get-azurermeffectiveroutetable). В следующем примере извлекаются действующие маршруты для сетевого интерфейса *myVMVMNic*, который находится в группе ресурсов *myResourceGroup*.

```azurepowershell-interactive
Get-AzureRmEffectiveRouteTable `
  -NetworkInterfaceName myVMVMNic `
  -ResourceGroupName myResourceGroup `
  | Format-Table
```

Чтобы понять сведения, возвращенные в выходных данных, ознакомьтесь с разделом [Маршрутизация трафика в виртуальной сети](virtual-networks-udr-overview.md). Выходные данные возвращаются только в том случае, если виртуальная машина запущена. Если к виртуальной машине подключено несколько сетевых интерфейсов, можно просмотреть действующие маршруты для каждого из них. Так как сетевые интерфейсы могут находиться в разных подсетях, у них могут быть разные действующие маршруты. Если у вас по-прежнему возникают проблемы с подключением, прочитайте разделы [Дополнительная диагностика](#additional-diagnosis) и [Рекомендации](#considerations).

Если вы не знаете имя сетевого интерфейса, но знаете имя виртуальной машины, к которой он подключен, вы можете получить идентификаторы всех сетевых интерфейсов, подключенных к виртуальной машине. Для этого выполните следующие команды.

```azurepowershell-interactive
$VM = Get-AzureRmVM -Name myVM `
  -ResourceGroupName myResourceGroup
$VM.NetworkProfile
```

Вы получите примерно такой результат:

```powershell
NetworkInterfaces
-----------------
{/subscriptions/<ID>/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myVMVMNic
```

В предыдущих выходных данных имя сетевого интерфейса было *myVMVMNic*.

## <a name="diagnose-using-azure-cli"></a>Диагностика с помощью Azure CLI

Вы можете выполнить приведенные ниже команды в [Azure Cloud Shell](https://shell.azure.com/bash) или с помощью интерфейса командной строки на своем компьютере. Для этой статьи требуется Azure CLI 2.0.32 или более поздней версии. Выполните командлет `az --version`, чтобы узнать установленную версию. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0](/cli/azure/install-azure-cli). Если Azure CLI работает локально, необходимо также выполнить `az login` и войти в Azure с учетной записью, предоставляющей [необходимые разрешения](virtual-network-network-interface.md#permissions).

Получите действующие маршруты для сетевого интерфейса с помощью команды [az network nic show-effective-route-table](/cli/azure/network/nic#az-network-nic-show-effective-route-table). В следующем примере извлекаются действующие маршруты для сетевого интерфейса *myVMVMNic*, который находится в группе ресурсов *myResourceGroup*.

```azurecli-interactive
az network nic show-effective-route-table \
  --name myVMVMNic \
  --resource-group myResourceGroup
```

Чтобы понять сведения, возвращенные в выходных данных, ознакомьтесь с разделом [Маршрутизация трафика в виртуальной сети](virtual-networks-udr-overview.md). Выходные данные возвращаются только в том случае, если виртуальная машина запущена. Если к виртуальной машине подключено несколько сетевых интерфейсов, можно просмотреть действующие маршруты для каждого из них. Так как сетевые интерфейсы могут находиться в разных подсетях, у них могут быть разные действующие маршруты. Если у вас по-прежнему возникают проблемы с подключением, прочитайте разделы [Дополнительная диагностика](#additional-diagnosis) и [Рекомендации](#considerations).

Если вы не знаете имя сетевого интерфейса, но знаете имя виртуальной машины, к которой он подключен, вы можете получить идентификаторы всех сетевых интерфейсов, подключенных к виртуальной машине. Для этого выполните следующие команды.

```azurecli-interactive
az vm show \
  --name myVM \
  --resource-group myResourceGroup
```

## <a name="resolve-a-problem"></a>Устранение проблемы

Устранение проблем с маршрутизацией обычно включает в себя следующие действия.

- Добавление настраиваемого маршрута для переопределения маршрутов по умолчанию Azure. Узнайте, как [добавить настраиваемый маршрут](manage-route-table.md#create-a-route).
- Изменение или удаление настраиваемого маршрута, который может привести к маршрутизации в нежелательное расположение. Узнайте, как [изменить](manage-route-table.md#change-a-route) или [удалить](manage-route-table.md#delete-a-route) настраиваемый маршрут.
- Обеспечение привязки таблицы маршрутов, которая содержит определенные вами настраиваемые маршруты, к подсети сетевого интерфейса. Узнайте, как [связать таблицу маршрутов с подсетью](manage-route-table.md#associate-a-route-table-to-a-subnet).
- Обеспечение работоспособности устройств, таких как развернутые вами VPN-шлюз Azure или сетевые виртуальные модули. Используйте возможности [диагностики VPN](../network-watcher/diagnose-communication-problem-between-networks.md?toc=%2fazure%2fvirtual-network%2ftoc.json) в службе "Наблюдатель за сетями", чтобы выявить проблемы с VPN-шлюзом Azure.

Если у вас по-прежнему возникают проблемы с подключениями, ознакомьтесь с разделами [Рекомендации](#considerations) и [Дополнительная диагностика](#additional-dignosis).

## <a name="considerations"></a>Рекомендации

При устранении проблем с подключениями необходимо учитывать следующие аспекты.

- Маршрутизация основана на совпадении наиболее длинного префикса (LPM) среди определенных вами маршрутов, протоколе BGP и системных маршрутах. При наличии более одного маршрута с совпадающими значениями LPM маршрут выбирается по источнику в порядке, указанном в разделе [Маршрутизация трафика в виртуальной сети](virtual-networks-udr-overview.md#how-azure-selects-a-route). Функция действующих маршрутов позволяет просмотреть только действующие маршруты, выделенные из доступных маршрутов при помощи совпадающего значения LPM. Отображение способа вычисления маршрутов для сетевого интерфейса сильно упрощает устранение неполадок с определенными маршрутами, которые могут влиять на подключения из виртуальной машины.
- Если вы определили настраиваемые маршруты к сетевому виртуальному модулю и при этом типом следующего прыжка является *Виртуальный модуль*, обязательно включите IP-пересылку на принимающем трафик сетевом виртуальном модуле, иначе пакеты будут удаляться. Узнайте больше о способах [включения IP-пересылки для сетевого интерфейса](virtual-network-network-interface.md#enable-or-disable-ip-forwarding). Кроме того, операционная система или приложение в сетевом виртуальном модуле должны иметь возможность пересылать трафик и поддерживать настройку этой функции.
- Если вы создали маршрут 0.0.0.0/0, то весь исходящий трафик Интернета направляется по указанному вами следующему прыжку, например, в сетевой виртуальный модуль или VPN-шлюз. Создание таких маршрутов часто называют принудительным туннелированием. Удаленные подключения по протоколу RDP или SSH из Интернета к вашей виртуальной машине могут не работать с этим маршрутом. Это зависит от обработки трафика при выполнении следующего прыжка. Принудительное туннелирование можно включить:
    - Если используется VPN типа "сеть — сеть" путем создания маршрута с типом следующего прыжка *VPN-шлюз*. Узнайте больше о настройке [принудительного туннелирования](../vpn-gateway/vpn-gateway-forced-tunneling-rm.md?toc=%2fazure%2fvirtual-network%2ftoc.json).
    - Если маршрут 0.0.0.0/0 (маршрут по умолчанию) объявляется по протоколу BGP через шлюз виртуальной сети при использовании VPN типа "сеть — сеть" или канала ExpressRoute. Узнайте больше об использовании протокола BGP с [VPN типа "сеть — сеть"](../vpn-gateway/vpn-gateway-bgp-overview.md?toc=%2fazure%2fvirtual-network%2ftoc.json) или [ExpressRoute](../expressroute/expressroute-routing.md?toc=%2fazure%2fvirtual-network%2ftoc.json#ip-addresses-used-for-azure-private-peering).
- Для правильной работы пирингового трафика виртуальной сети системный маршрут с типом следующего прыжка *Пиринг VNet* должен действовать в диапазоне префиксов пиринговой виртуальной сети. Если такого маршрута не существует и пиринговая связь виртуальной сети **подключена**, возможны два сценария.
    - Подождите несколько секунд и повторите попытку. Если это новая пиринговая связь, иногда требуется больше времени, чтобы распространить маршруты для всех сетевых интерфейсов в подсети. Чтобы узнать больше о пиринге виртуальных сетей, ознакомьтесь с разделами [Пиринг между виртуальными сетями](virtual-network-peering-overview.md) и [Создание, изменение и удаление пиринга в виртуальной сети](virtual-network-manage-peering.md).
    - Правила групп безопасности сети могут влиять на подключения. Дополнительные сведения см. в разделе [Диагностика проблемы с фильтрацией трафика на виртуальной машине](diagnose-network-traffic-filter-problem.md).
- Хотя Azure назначает маршруты по умолчанию каждому сетевому интерфейсу Azure, если к виртуальной машине подключено несколько сетевых интерфейсов, то маршрут по умолчанию (0.0.0.0/0) назначается только основному сетевому интерфейсу или шлюзу в операционной системе виртуальной машины. Узнайте, как создать маршрут по умолчанию для дополнительных сетевых интерфейсов, подключенных к виртуальной машине [Windows](../virtual-machines/windows/multiple-nics.md?toc=%2fazure%2fvirtual-network%2ftoc.json#configure-guest-os-for-multiple-nics) или [Linux](../virtual-machines/linux/multiple-nics.md?toc=%2fazure%2fvirtual-network%2ftoc.json#configure-guest-os-for-multiple-nics). Узнайте больше об [основных и дополнительных сетевых интерфейсах](virtual-network-network-interface-vm.md#constraints).

## <a name="additional-diagnosis"></a>Дополнительная диагностика

* Чтобы выполнить быстрый тест для определения типа следующего прыжка для трафика, предназначенного для определенного расположения, используйте функцию [следующего прыжка](../network-watcher/diagnose-vm-network-routing-problem.md?toc=%2fazure%2fvirtual-network%2ftoc.json) службы "Наблюдатель за сетями Azure". С ее помощью можно узнать тип следующего прыжка для трафика, предназначенного для указанного расположения.
* Если маршруты, вызывающие сбой работы сети виртуальной машины, отсутствуют, возможно, проблема возникла из-за программного обеспечения брандмауэра, запущенного в операционной системе виртуальной машины.
* Если вы используете [принудительное туннелирование](../vpn-gateway/vpn-gateway-forced-tunneling-rm.md?toc=%2fazure%2fvirtual-network%2ftoc.json) трафика на локальное устройство через VPN-шлюз или сетевой виртуальный модуль, может отсутствовать возможность подключения к виртуальной машине из Интернета в зависимости от настройки маршрутизации для этих устройств. Убедитесь, что маршрутизация для этих устройств направляет трафик на общедоступный или частный IP-адрес виртуальной машины.
* Используйте функцию [устранения неполадок подключения](../network-watcher/network-watcher-connectivity-portal.md?toc=%2fazure%2fvirtual-network%2ftoc.json) службы "Наблюдатель за сетями", чтобы определить параметры маршрутизации, фильтрации и ОС, вызывающие проблему с подключением.

## <a name="next-steps"></a>Дополнительная информация

- Узнайте больше о всех задачах, свойствах и параметрах для [маршрутов и таблицы маршрутов](manage-route-table.md).
- Узнайте о всех [типах следующего прыжка, системных маршрутах и способах выбора маршрута в Azure](virtual-networks-udr-overview.md).
