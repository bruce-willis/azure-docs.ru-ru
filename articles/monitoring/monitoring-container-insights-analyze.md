---
title: Мониторинг производительности кластера AKS с Azure Monitor для контейнеров | Документация Майкрософт
description: В этой статье описывается, как можно просматривать и анализировать производительность и данные журналов с помощью Azure Monitor для контейнеров.
services: azure-monitor
documentationcenter: ''
author: mgoedtel
manager: carmonm
editor: ''
ms.assetid: ''
ms.service: azure-monitor
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/14/2018
ms.author: magoedte
ms.openlocfilehash: 6df7d42bc291713a815cac9f719f53136ed35b19
ms.sourcegitcommit: 32d218f5bd74f1cd106f4248115985df631d0a8c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2018
ms.locfileid: "46956682"
---
## <a name="understand-aks-cluster-performance-with-azure-monitor-for-containers"></a>Общие сведения о производительности кластера AKS с Azure Monitor для контейнеров
Просмотр производительности кластеров Службы контейнеров Azure (AKS) можно наблюдать с двух перспектив с помощью Azure Monitor для контейнеров, напрямую из кластера AKS или представления всех AKS кластеров в подписке из Azure Monitor. 

Эта статья поможет вам понять, как взаимодействуют две перспективы и как быстро оценить, изучить и устранить обнаруженные проблемы работоспособности.

Дополнительные сведения о включении Azure Monitor для контейнеров см. в статье [How to onboard Azure Monitor for containers](monitoring-container-insights-onboard.md) (Подключение Azure Monitor для контейнеров).

Azure Monitor предоставляет мультикластерное представление, показывающее состояние работоспособности всех отслеживаемых кластеров AKS, развернутых в группах ресурсов в подписках. Кластеры AKS не отслеживаются решением.  Вы сразу же сможете получить сведения о работоспособности кластера. Отсюда можно перейти на страницу производительности узла и контроллера или перейти к диаграммам производительности для кластера.  Для кластеров AKS, обнаруженных и определенных как неотслеживаемые, вы можете в любой момент включить мониторинг.  

## <a name="sign-in-to-the-azure-portal"></a>Вход на портал Azure
Войдите на [портале Azure](https://portal.azure.com). 

## <a name="multi-cluster-view-from-azure-monitor"></a>Мультикластерное представление из Azure Monitor 
Чтобы просмотреть состояние работоспособности всех развернутых кластеров AKS, в области слева на портале Azure выберите **Монитор**.  В разделе **Аналитические сведения** выберите **Контейнеры (предварительная версия)**.  

![Пример мультикластерной панели мониторинга Azure Monitor](./media/monitoring-container-insights-analyze/azmon-containers-multiview.png)

На вкладке **Monitored clusters** (Отслеживаемые кластеры) можно получить следующие сведения.

1. Сколько кластеров находятся в критическом состоянии или в состоянии неработоспособности, а сколько — работоспособны или не передают данные (то есть имеют неизвестное состояние).
2. Сколько узлов, пользовательских и системных модулей pod развертывается на кластер.  

Определены следующие состояния работоспособности: 

1. **Исправно.** Для виртуальной машины не обнаружено никаких проблем, и она работает так, как нужно. 
2. **Critical** (Критическое). Обнаружена одна или несколько критических проблем, которые необходимо устранить для восстановления рабочего состояния.
3. **Предупреждение.** Обнаружена одна или несколько проблем, без устранения которых состояние работоспособности может стать критическим.
4. **Unknown** (Неизвестно). Если службе не удается установить соединение с узлом или модулем pod, устанавливается "неизвестное" состояние работоспособности.

Состояние работоспособности вычисляет общее состояние кластера как *наихудшее из* трех состояний с одним исключением: если любое из трех состояний *неизвестно*, общее состояние кластера будет отображаться как **Неизвестно**.  

В следующей таблице приведена разбивка вычисления, управляющего состояниями работоспособности для отслеживаемого кластера в мультикластерном представлении.

| |Status |Доступность |  
|-------|-------|-----------------|  
|**Пользовательский модуль pod**| | |  
| |Healthy |100 % |  
| |Предупреждение |90–99 % |  
| |критические ошибки. |<90 % |  
| |Unknown |Если данные не предоставляются в течение последних 30 минут |  
|**Системный модуль pod**| | |  
| |Healthy |100 % |
| |Предупреждение |Недоступно |
| |критические ошибки. |<100 % |
| |Unknown |Если данные не предоставляются в течение последних 30 минут |
|**Node** | | |
| |Healthy |>85 % |
| |Предупреждение |60–84 % |
| |критические ошибки. |<60 % |
| |Unknown |Если данные не предоставляются в течение последних 30 минут |

Из списка кластеров можно перейти на страницу **Кластер**, щелкнув имя кластера, на страницу производительности **Узлы**, щелкнув свертку узлов в столбце **Узлы** для определенного кластера, или перейти на страницу производительности **Контроллер**, выбрав свертку столбца **User pods** (Пользовательские модули pod) или **System pods** (Системные модули pod).   

## <a name="view-performance-directly-from-an-aks-cluster"></a>Просмотр производительности непосредственно из кластера AKS
Доступ к Azure Monitor для контейнеров можно получить непосредственно из кластера AKS, выбрав **Insights (preview)** (Аналитические сведения (предварительная версия)) в области слева. Просмотреть сведения о кластере AKS можно посредством четырех перспектив:

- HDInsight
- Nodes 
- Controllers;  
- Контейнеры

Страница, которая по умолчанию открывается при выборе **Аналитические сведения (предварительная версия)**, — это **Кластер**. Она включает четыре линейные диаграммы производительности, отображающие ключевые метрики производительности кластера. 

![Пример диаграммы производительности на вкладке "Кластер"](./media/monitoring-container-insights-analyze/containers-cluster-perfview.png)

На диаграмме производительности отображаются четыре метрики производительности:

- **Node CPU Utilization&nbsp;%** (Доля загрузки ЦП узла): статистическая перспектива загрузки ЦП для всего кластера. Результаты для диапазона времени можно отфильтровать, выбрав **Avg**, **Min**, **Max**, **50**, **90** и **95** в селекторе процентилей над диаграммой (по отдельности или вместе). 
- **Node memory utilization&nbsp;%** (Доля использования памяти узла): статистическая перспектива использования памяти для всего кластера. Результаты для диапазона времени можно отфильтровать, выбрав **Avg**, **Min**, **Max**, **50**, **90** и **95** в селекторе процентилей над диаграммой (по отдельности или вместе). 
- **Число узлов**: число узлов и сведения о состоянии, полученные из Kubernetes. Состояние узлов кластера может быть: *Все*, *Готово* и *Не готово*. Используя селектор над диаграммой, их можно отфильтровать по отдельности или вместе. 
- **Activity pod count** (Число модулей pod): число модулей pod и сведения о состоянии, полученные из Kubernetes. Состояние модулей pod может быть: *Все*, *Ожидание*, *Выполняется* и *Неизвестно*. Используя селектор над диаграммой, их можно отфильтровать по отдельности или вместе. 

При переключении на вкладку **Узлы**, **Контроллеры** и **Контейнеры** в правой области страницы автоматически отображается панель свойств.  На ней показаны свойства выбранного элемента, включая метки, которые вы определяете для упорядочивания объектов Kubernetes. Щелкните на панели ссылку **>>**, чтобы просмотреть или скрыть панель.  

![Пример панели свойств перспектив Kubernetes](./media/monitoring-container-insights-analyze/perspectives-preview-pane-01.png)

При развертывании объектов в иерархии панель свойств обновляется на основе выбранного объекта. На панели вы также можете просмотреть события Kubernetes с заранее определенными поисками по журналам. Для этого щелкните ссылку **просмотра журналов событий Kubernetes** в верхней части панели. Дополнительные сведения о просмотре данных журнала Kubernetes см. в разделе [Поиск по журналам для анализа данных](#search-logs-to-analyze-data).

Используйте параметр **+ Добавить фильтр** в верхней части страницы, чтобы отфильтровать результаты для представления по **службе**, **узлу** или **пространству имен**. После выбора области фильтра выбирается одно из значений, показанных в поле **Выбрать значения**.  После настройки фильтра он применяется глобально при просмотре любой перспективы кластера AKS.  Формула поддерживает только знак равенства.  Поверх первого фильтра можно добавить дополнительные фильтры, чтобы сузить диапазон результатов.  Например, если указана фильтрация по **узлу**, вторым фильтром можно выбрать только **службу** или **пространство имен**.  

![Пример с использованием фильтра, чтобы сузить диапазон результатов](./media/monitoring-container-insights-analyze/add-filter-option-01.png)

Если задать фильтр на одной вкладке, он продолжает применяться при выборе другого фильтра. Он удаляется после того, как вы щелкните символ **х** рядом с указанным фильтром.   

Перейдите на вкладку **Узлы**. Иерархия строк будет соответствовать объектной модели Kubernetes, начиная с узла в кластере. Разверните узел, и вы увидите один или несколько запущенных на нем модулей pod. Если в модуль pod сгруппировано несколько контейнеров, они будут отображаться как последняя строка в иерархии. Вы также можете увидеть количество рабочих нагрузок, отличных от модулей pod, которые выполняются на узле, если узел испытывает нехватку ресурсов процессора или памяти.

![Пример иерархии узлов Kubernetes в представлении производительности](./media/monitoring-container-insights-analyze/containers-nodes-view.png)

Можно выбрать контроллеры или контейнеры в верхней части страницы и просмотреть для них состояние и данные об использовании ресурсов.  Если вместо этого требуется просмотреть данные об использовании памяти, из раскрывающегося списка **метрики** выберите **Memory RSS** (Память (RSS)) или **рабочий набор памяти**. Параметр **Memory RSS** (Память (RSS)) поддерживается только для Kubernetes версии 1.8 и более поздних. В противном случае значения **Min&nbsp;%** отображаются как *NaN&nbsp;%*. Это значение числового типа данных, представляющее неопределенное значение или значение, которое невозможно представить. 

![Представление производительности узлов контейнера](./media/monitoring-container-insights-analyze/containers-node-metric-dropdown.png)

По умолчанию используются данные о производительности за последние шесть часов, но вы можете изменить этот период с помощью параметра **TimeRange**, который расположен в верхнем левом углу. Также в диапазоне времени можно отфильтровать результаты, выбрав **Avg**, **Min**, **Max**, **50**, **90** и **95** в селекторе процентилей. 

![Выбор процентилей для фильтрации данных](./media/monitoring-container-insights-analyze/containers-metric-percentile-filter.png)

В следующем примере обратите внимание, что для узла *aks-nodepool1-* значение параметра **контейнеров** равно 14. Это сводное общее число развернутых контейнеров.

![Пример сводного числа контейнеров на узел](./media/monitoring-container-insights-analyze/containers-nodes-containerstotal.png)

Это поможет быстро выявить соответствующее распределение контейнеров между узлами в кластере. 

В следующей таблице описаны сведения, отображаемые при просмотре узлов.

| столбец | ОПИСАНИЕ | 
|--------|-------------|
| ИМЯ | Имя узла. |
| Status | Представление Kubernetes о состоянии узла. |
| Avg&nbsp;%, Min&nbsp;%, Max&nbsp;%, 50&nbsp;%, 90&nbsp;% | Средний процент для узла на основе процентиля в течение выбранного периода времени. |
| Avg, Min, Max, 50, 90 | Среднее фактическое значение для узла на основе процентиля в течение выбранного периода времени. Среднее значение измеряется на основании лимита ЦП и памяти, установленного для узла. Для модулей pod и контейнеров это среднее значение, сообщаемое узлом. |
| Контейнеры | Число контейнеров. |
| Время доступности | Представляет время с момента запуска или перезапуска узла. |
| Controllers; | Только для контейнеров и модулей pod. Показывает, в каком контроллере размещен контейнер или pod. Не все модули pod будут размещаться в контроллере, поэтому для некоторых может отображаться значение **Н/Д**. | 
| Avg&nbsp;%, Min&nbsp;%, Max&nbsp;%, 50&nbsp;%, 90&nbsp;% | Гистограмма тренда, представляющая процент метрики процентиля контроллера. |

Выберите **Контроллеры** в селекторе.

![Представление выбора контроллеров](./media/monitoring-container-insights-analyze/containers-controllers-tab.png)

Здесь можно просмотреть состояние производительности контроллеров.

![Представление производительности контейнеров <Имя>](./media/monitoring-container-insights-analyze/containers-controllers-view.png)

Иерархия строк начинается с контроллера, развернув который, можно увидеть один или несколько контейнеров. Разверните pod, и в последней строке отобразится контейнер, сгруппированный в этот pod.  

В следующей таблице описаны сведения, отображаемые при просмотре контроллеров.

| столбец | ОПИСАНИЕ | 
|--------|-------------|
| ИМЯ | Имя контроллера.|
| Status | Состояние сводного числа контейнеров после завершения выполнения, например *ОК*, *Завершено*, *Сбой*, *Остановлено* или *Приостановлено*. Если контейнер выполняется, но его состояние было неправильно представлено или не было выбрано агентом и не передавалось более 30 минут, то значением состояния будет *Неизвестно*. В таблице ниже приведены дополнительные сведения о значке состояния.|
| Avg&nbsp;%, Min&nbsp;%, Max&nbsp;%, 50&nbsp;%, 90&nbsp;% | Сводное среднее значение среднего процента каждой сущности для выбранной метрики и процентиля. |
| Avg, Min, Max, 50, 90  | Сводное среднее значение производительности ЦП (в миллиядрах) или памяти для контейнера для выбранного процентиля. Среднее значение измеряется на основании лимита ресурсов ЦП и памяти, установленного для pod. |
| Контейнеры | Общее число контейнеров для контроллера или pod. |
| "Restarts" (Число перезапусков) | Сводное количество перезапусков из контейнеров. |
| Время доступности | Представляет время с момента запуска контейнера. |
| Узел | Только для контейнеров и модулей pod. Показывает, в каком контроллере размещен контейнер или pod. | 
| Avg&nbsp;%, Min&nbsp;%, Max&nbsp;%, 50&nbsp;%, 90&nbsp;%| Гистограмма тренда, представляющая метрику процентиля контроллера. |

Значки в поле состояния указывают состояние контейнеров:
 
| Значок | Status | 
|--------|-------------|
| ![Значок состояния выполнения (готовности)](./media/monitoring-container-insights-analyze/containers-ready-icon.png) | Выполняется (готово)|
| ![Значок состояния ожидания или паузы](./media/monitoring-container-insights-analyze/containers-waiting-icon.png) | Ожидается или приостановлено|
| ![Значок состояния последнего зарегистрированного выполнения](./media/monitoring-container-insights-analyze/containers-grey-icon.png) | Последнее выполнение зарегистрировано, но нет ответа более 30 минут|
| ![Значок состояния успешного выполнения](./media/monitoring-container-insights-analyze/containers-green-icon.png) | Успешно остановлено или не удалось остановить|

Значок состояния отображает число на основе сведений, предоставляемых модулем pod. Он показывает два худших состояния и, при наведении указателя мыши на значок состояния, сводный показатель состояния всех модулей pod в контейнере. Если это не состояние готовности, отображается значение состояния **(0)**. 

Выберите **Контейнеры** в селекторе.

![Представление выбора контейнеров](./media/monitoring-container-insights-analyze/containers-containers-tab.png)

Здесь можно просмотреть состояние производительности контейнеров Azure Kubernetes.  

![Представление производительности контейнеров <Имя>](./media/monitoring-container-insights-analyze/containers-containers-view.png)

В следующей таблице описаны сведения, отображаемые при просмотре контейнеров.

| столбец | ОПИСАНИЕ | 
|--------|-------------|
| ИМЯ | Имя контроллера.|
| Status | Состояния контейнеров (при наличии). В таблице ниже приведены дополнительные сведения о значке состояния.|
| Avg&nbsp;%, Min&nbsp;%, Max&nbsp;%, 50&nbsp;%, 90&nbsp;% | Сводное значение среднего процента каждой сущности для выбранной метрики и процентиля. |
| Avg, Min, Max, 50, 90  | Сводное среднее значение производительности ЦП (в миллиядрах) или памяти контейнера для выбранного процентиля. Среднее значение измеряется на основании лимита ресурсов ЦП и памяти, установленного для pod. |
| Pod | Контейнер, в котором находится pod.| 
| Узел |  Узел, на котором размещен контейнер. | 
| "Restarts" (Число перезапусков) | Представляет время с момента запуска контейнера. |
| Время доступности | Представляет время с момента запуска или перезапуска контейнера. |
| Avg&nbsp;%, Min&nbsp;%, Max&nbsp;%, 50&nbsp;%, 90&nbsp;% | Гистограмма тренда, представляющая средний процент показателей контейнера. |

Значки в поле состояния указывают состояния модулей pod в режиме реального времени, как описано в следующей таблице:
 
| Значок | Status |  
|--------|-------------|  
| ![Значок состояния выполнения (готовности)](./media/monitoring-container-insights-analyze/containers-ready-icon.png) | Выполняется (готово)|  
| ![Значок состояния ожидания или паузы](./media/monitoring-container-insights-analyze/containers-waiting-icon.png) | Ожидается или приостановлено|  
| ![Значок состояния последнего зарегистрированного выполнения](./media/monitoring-container-insights-analyze/containers-grey-icon.png) | Последнее выполнение зарегистрировано, но ответа нет более 30 минут|  
| ![Значок состояния "Завершено"](./media/monitoring-container-insights-analyze/containers-terminated-icon.png) | Успешно остановлено или не удалось остановить|  
| ![Значок состояния "Сбой"](./media/monitoring-container-insights-analyze/containers-failed-icon.png) | Состояние сбоя |  

## <a name="container-data-collection-details"></a>Сведения о сборе данных из контейнеров
Служба аналитики для контейнеров собирает данные различных метрик производительности и данные журналов из узлов контейнеров и контейнеров. Эти данные собираются каждые три минуты.

### <a name="container-records"></a>Записи контейнеров

В таблице ниже приведены примеры записей, собранных Azure Monitor для контейнеров, и типов данных, которые отображаются в результатах поиска по журналам.

| Тип данных | Тип данных, используемый для поиска в журналах | Поля |
| --- | --- | --- |
| Производительность узлов и контейнеров | `Perf` | Computer, ObjectName, CounterName &#40;%Processor Time, Disk Reads MB, Disk Writes MB, Memory Usage MB, Network Receive Bytes, Network Send Bytes, Processor Usage sec, Network&#41;, CounterValue, TimeGenerated, CounterPath, SourceSystem |
| Список контейнеров | `ContainerInventory` | TimeGenerated, Computer, container name, ContainerHostname, Image, ImageTag, ContainerState, ExitCode, EnvironmentVar, Command, CreatedTime, StartedTime, FinishedTime, SourceSystem, ContainerID, ImageID |
| Список образов контейнеров | `ContainerImageInventory` | TimeGenerated, Computer, Image, ImageTag, ImageSize, VirtualSize, Running, Paused, Stopped, Failed, SourceSystem, ImageID, TotalContainer |
| Журнал контейнеров | `ContainerLog` | TimeGenerated, Computer, image ID, container name, LogEntrySource, LogEntry, SourceSystem, ContainerID |
| Журнал службы контейнеров | `ContainerServiceLog`  | TimeGenerated, Computer, TimeOfCommand, Image, Command, SourceSystem, ContainerID |
| Список узлов контейнеров | `ContainerNodeInventory_CL`| TimeGenerated, Computer, ClassName_s, DockerVersion_s, OperatingSystem_s, Volume_s, Network_s, NodeRole_s, OrchestratorType_s, InstanceID_g, SourceSystem|
| Процесс контейнера | `ContainerProcess_CL` | TimeGenerated, Computer, Pod_s, Namespace_s, ClassName_s, InstanceID_s, Uid_s, PID_s, PPID_s, C_s, STIME_s, Tty_s, TIME_s, Cmd_s, Id_s, Name_s, SourceSystem |
| Список модулей pod в кластере Kubernetes | `KubePodInventory` | TimeGenerated, Computer, ClusterId, ContainerCreationTimeStamp, PodUid, PodCreationTimeStamp, ContainerRestartCount, PodRestartCount, PodStartTime, ContainerStartTime, ServiceName, ControllerKind, ControllerName, ContainerStatus, ContainerID, ContainerName, Name, PodLabel, Namespace, PodStatus, ClusterName, PodIp, SourceSystem |
| Список узлов кластера Kubernetes | `KubeNodeInventory` | TimeGenerated, Computer, ClusterName, ClusterId, LastTransitionTimeReady, Labels, Status, KubeletVersion, KubeProxyVersion, CreationTimeStamp, SourceSystem | 
| События Kubernetes | `KubeEvents_CL` | TimeGenerated, Computer, ClusterId_s, FirstSeen_t, LastSeen_t, Count_d, ObjectKind_s, Namespace_s, Name_s, Reason_s, Type_s, TimeGenerated_s, SourceComponent_s, ClusterName_s, Message,  SourceSystem | 
| Службы в кластере Kubernetes | `KubeServices_CL` | TimeGenerated, ServiceName_s, Namespace_s, SelectorLabels_s, ClusterId_s, ClusterName_s, ClusterIP_s, ServiceType_s, SourceSystem | 
| Метрики производительности для узлов кластера Kubernetes | Perf &#124; where ObjectName == "K8SNode" | Computer, ObjectName, CounterName &#40;cpuUsageNanoCores, , memoryWorkingSetBytes, memoryRssBytes, networkRxBytes, networkTxBytes, restartTimeEpoch, networkRxBytesPerSec, networkTxBytesPerSec, cpuAllocatableNanoCores, memoryAllocatableBytes, cpuCapacityNanoCores, memoryCapacityBytes&#41;,CounterValue, TimeGenerated, CounterPath, SourceSystem | 
| Метрики производительности контейнеров кластера Kubernetes | Perf &#124; where ObjectName == “K8SContainer” | CounterName &#40;cpuUsageNanoCores, memoryWorkingSetBytes, memoryRssBytes, restartTimeEpoch, cpuRequestNanoCores, memoryRequestBytes, cpuLimitNanoCores, memoryLimitBytes&#41;,CounterValue, TimeGenerated, CounterPath, SourceSystem | 

## <a name="search-logs-to-analyze-data"></a>Поиск по журналам для анализа данных
Log Analytics помогает выявлять тренды, диагностировать узкие места, составлять прогнозы и сопоставлять данные, с помощью которых можно определить, оптимальна ли текущая конфигурация кластера. Вам доступны предопределенные запросы поиска по журналам, которые можно использовать без изменений или настроить для получения сведений нужным вам образом. 

Можно выполнить интерактивный анализ данных в рабочей области, выбрав параметр **просмотра журналов событий Kubernetes** или **просмотра журналов контейнера**, доступный в области предварительного просмотра. Страница **поиска по журналам** появится в правой области страницы портала Azure, которую вы использовали.

![Анализ данных в Log Analytics](./media/monitoring-container-insights-analyze/container-health-log-search-example.png)   

Выходные данные журналов контейнеров, которые передаются в Log Analytics: STDOUT и STDERR. Так как Azure Monitor отслеживает среду Kubernetes (AKS) под управлением Azure, сейчас сведения о системе Kube не собираются ввиду большого объема создаваемых данных. 

### <a name="example-log-search-queries"></a>Примеры запросов для поиска по журналам
При создании запросов часто бывает полезно начать с одного-двух примеров, внося затем в них изменения в соответствии со своими требованиями. Можно поэкспериментировать с приведенными ниже примерами запросов, чтобы научиться создавать более сложные запросы.

| Запрос | ОПИСАНИЕ | 
|-------|-------------|
| ContainerInventory<br> &#124; project Computer, Name, Image, ImageTag, ContainerState, CreatedTime, StartedTime, FinishedTime<br> &#124; render table | Вывод всех сведений о жизненном цикле контейнера| 
| KubeEvents_CL<br> &#124; where not(isempty(Namespace_s))<br> &#124; sort by TimeGenerated desc<br> &#124; render table | События Kubernetes|
| ContainerImageInventory<br> &#124; summarize AggregatedValue = count() by Image, ImageTag, Running | Инвентаризация образа | 
| **В службе "Расширенная аналитика" выберите графики**:<br> Perf<br> &#124; where ObjectName == "Container" and CounterName == "% Processor Time"<br> &#124; summarize AvgCPUPercent = avg(CounterValue) by bin(TimeGenerated, 30m), InstanceName | Ресурсы ЦП контейнера. | 
| **В службе "Расширенная аналитика" выберите графики**:<br> Perf &#124; where ObjectName == "Container" and CounterName == "Memory Usage MB"<br> &#124; summarize AvgUsedMemory = avg(CounterValue) by bin(TimeGenerated, 30m), InstanceName | Память контейнера |
