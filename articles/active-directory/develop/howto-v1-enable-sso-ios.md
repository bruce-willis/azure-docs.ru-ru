---
title: Включение единого входа в нескольких приложениях в iOS с помощью ADAL | Документация Майкрософт
description: Использование функций ADAL SDK для включения единого входа в приложениях.
services: active-directory
author: CelesteDG
manager: mtillman
ms.assetid: d042d6da-7503-4e20-bb55-06917de01fcd
ms.service: active-directory
ms.component: develop
ms.workload: identity
ms.tgt_pltfrm: ios
ms.devlang: objective-c
ms.topic: article
ms.date: 09/24/2018
ms.author: celested
ms.reviewer: brandwe
ms.custom: aaddev
ms.openlocfilehash: e9598cb464360e35a86b6fe35d8c965a5e7fb51d
ms.sourcegitcommit: 32d218f5bd74f1cd106f4248115985df631d0a8c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2018
ms.locfileid: "46963038"
---
# <a name="how-to-enable-cross-app-sso-on-ios-using-adal"></a>Практическое руководство. Включение единого входа в нескольких приложениях iOS с помощью ADAL

[!INCLUDE [active-directory-develop-applies-v1-adal](../../../includes/active-directory-develop-applies-v1-adal.md)]

Единый вход (SSO) позволяет пользователям ввести свои учетные данные единожды и автоматически входить под ними в приложения и на платформы, которые могут использовать другие приложения (например, учетные записи Майкрософт или рабочая учетная запись Microsoft 365), независимо от издателя.

Платформа удостоверений Майкрософт вместе с пакетами SDK упрощает включение единого входа в собственный набор приложений или на всем устройстве с помощью брокера и приложений Authenticator.

В этом пошаговом руководстве описывается, как настроить пакет SDK в приложении, чтобы ваши пользователи смогли воспользоваться функцией единого входа.

Это практическое руководство применяется к:

* Azure Active Directory (Azure Active Directory).
* Azure Active Directory B2C
* Azure Active Directory B2B
* Условный доступ к Azure Active Directory

## <a name="prerequisites"></a>Предварительные требования

В этом практическом руководстве предполагается, что вы знаете, как:

* Подготовить приложения с помощью предыдущей версии портала для Azure AD. Дополнительные сведения см. в статье [Quickstart: Register an app with the Azure Active Directory v1.0 endpoint](quickstart-v1-add-azure-ad-app.md) (Краткое руководство по регистрации приложения с помощью конечной точки Azure AD версии 1.0).
* Интегрировать приложение с помощью [пакета SDK Azure AD для iOS](https://github.com/AzureAD/azure-activedirectory-library-for-objc).

## <a name="single-sign-on-concepts"></a>Основные понятия единого входа

### <a name="identity-brokers"></a>Брокеры удостоверений

Корпорация Майкрософт предоставляет приложения для всех мобильных платформ, которые позволяют привязывать учетные данные к приложениям разных поставщиков и использовать расширенные возможности, требующие единого безопасного расположения для проверки учетных данных. Такие расположения называются **брокерами**.

В iOS и Android брокеры доступны в скачиваемых приложениях, которые пользователи устанавливают самостоятельно, либо их может передавать на устройство сотрудника компания, частично или полностью управляющая такими устройствами. Брокеры поддерживают управление безопасностью только для некоторых приложений или для всего устройства в зависимости от конфигурации ИТ-администратора. В Windows этот компонент предоставляется средством выбора учетной записи, встроенным в операционную систему (его техническое название — брокер веб-аутентификации).

### <a name="patterns-for-logging-in-on-mobile-devices"></a>Способы входа на мобильные устройства

Доступ к учетным данным на устройствах осуществляется с применением двух основных подходов:

* вход без брокера;
* вход с брокером.

#### <a name="non-broker-assisted-logins"></a>вход без брокера;

Вход без брокера — это встроенная возможность входа в приложение с использованием локального хранилища на устройстве. Хотя доступ к этом хранилищу может осуществляться из других приложений, учетные данные строго привязаны к использующему их приложению или набору приложений. Скорее всего, вы уже встречали такой подход во многих мобильных приложениях, в которых имя пользователя и пароль вводятся непосредственно в приложении.

Такой способ входа отличается следующими преимуществами:

* пользовательский интерфейс полностью реализован в приложении;
* учетные данные можно передавать в приложения, подписанные с использованием одного и того же сертификата, что создает возможность единого входа во все ваши приложения;
* управление процедурой входа в рамках приложения возможно как до, так и после входа.

Такой способ входа имеет следующие недостатки:

* единый вход будет доступен пользователю не во всех приложениях, в которых используются удостоверения Майкрософт, а только для тех удостоверений Майкрософт, которые настроены в вашем приложении;
* нет возможности использовать для приложения расширенные бизнес-функции и компоненты, например условный доступ или набор продуктов Intune;
* приложение не поддерживает аутентификацию бизнес-пользователей на основе сертификата.

Ниже показано, как с помощью пакетов SDK можно включить единый вход, используя общее хранилище приложений.

```
+------------+ +------------+  +-------------+
|            | |            |  |             |
|   App 1    | |   App 2    |  |   App 3     |
|            | |            |  |             |
|            | |            |  |             |
+------------+ +------------+  +-------------+
| ADAL SDK  |  |  ADAL SDK  |  |  ADAL SDK   |
+------------+-+------------+--+-------------+
|                                            |
|            App Shared Storage              |
+--------------------------------------------+
```

#### <a name="broker-assisted-logins"></a>вход с брокером.

Так называется вход, выполняемый в приложении брокера с использованием хранилища и системы безопасности брокера, что позволяет применить на устройстве один набор учетных данных для всех приложений, которые используют платформу удостоверений. Это означает, что ваши приложения используют брокер для входа пользователей в систему. В iOS и Android брокеры доступны в виде скачиваемых приложений. Эти приложения устанавливаются пользователями самостоятельно либо принудительно передаются на устройство компанией, которая управляет устройствами. Пример этого типа приложений — приложение Microsoft Authenticator в iOS. В Windows этот компонент предоставляется средством выбора учетной записи, встроенным в операционную систему (его техническое название — брокер веб-проверки подлинности).

Этот способ входа зависит от платформы. При неправильном управлении он может мешать работе пользователей. Возможно, вы знакомы с этим способом входа, если у вас установлено приложение Facebook и вы используете Facebook Connect для входа в другие приложения. Платформа удостоверений использует этот же принцип.

В iOS это реализовано в виде анимированного "перехода", в рамках которого ваше приложение переходит на задний план, а приложения Microsoft Authenticator — на передний, что позволяет пользователю выбрать учетную запись для входа.

В Android и Windows для удобства пользователя средство выбора учетной записи отображается поверх приложения.

#### <a name="how-the-broker-gets-invoked"></a>Способы вызова брокера

При установке совместимого брокера на устройство, например приложения Microsoft Authenticator, пакеты SDK автоматически будут выполнять вызов брокера, когда пользователь укажет, что хочет войти с помощью любой учетной записи платформы удостоверений. Это может быть личная учетная запись Майкрософт, рабочая или учебная учетная запись либо любая другая учетная запись, которую вы предоставили и разместили в Azure с использованием продуктов B2C и B2B.

#### <a name="how-we-ensure-the-application-is-valid"></a>Как мы проверяем, что приложение является допустимым

Идентификация приложений, обращающихся к брокеру, имеет решающее значение для обеспечения безопасности при входе с брокером. Ни iOS, ни Android не предоставляют уникальные идентификаторы, действующие только для конкретного приложения. Это означает, что любое вредоносное ПО может имитировать идентификатор уполномоченного приложения и получать предназначенные для него маркеры. Чтобы убедиться, что во время выполнения мы всегда взаимодействуем с надежным приложением, мы просим разработчиков при регистрации приложений в корпорации Майкрософт предоставлять собственный универсальный код ресурса (URI) для перенаправления. Ниже подробно описано, как разработчикам следует создавать этот универсальный код ресурса (URI) для перенаправления. Этот пользовательский универсальный код ресурса (URI) для перенаправления содержит идентификатор пакета, и его уникальность для приложения гарантируется магазином Apple App Store. Когда приложение вызывает брокер, он запрашивает у операционной системы iOS идентификатор пакета, с которым был вызван этот брокер. Затем брокер передает этот идентификатор пакета в корпорацию Майкрософт в вызове к системе удостоверений. Если идентификатор пакета приложения не соответствует идентификатору пакета, который разработчик предоставил нам во время регистрации, то приложению будет отказано в выдаче запрашиваемых маркеров доступа к ресурсам. Такая проверка гарантирует, что только зарегистрированные разработчиком приложения получат маркеры.

**Разработчик может выбрать, будет ли пакет SDK вызывать брокер или использовать последовательность без помощи брокера.** Если разработчик не желает использовать последовательность с брокером, он не сможет предоставить пользователям единый вход с помощью учетных данных, уже добавленных на устройство. Кроме того, приложение не сможет использовать такие бизнес-функции корпорации Майкрософт, как условный доступ, возможности управления Intune и проверка подлинности на основе сертификата.

Такой способ входа отличается следующими преимуществами:

* пользователь выполняет единый вход во всех приложениях независимо от поставщика;
* в приложении можно использовать расширенные бизнес-функции и компоненты, включая условный доступ и набор продуктов Intune;
* приложение может поддерживать аутентификацию бизнес-пользователей на основе сертификата;
* более безопасная процедура входа — удостоверение приложения и пользователь проверяются приложением брокера с использованием шифрования и дополнительных алгоритмов безопасности.

Такой способ входа имеет следующие недостатки:

* в iOS пользователь выходит из приложения во время выбора учетных данных;
* невозможность управления процедурой входа пользователей в приложении.

Ниже показано, как с помощью пакетов SDK можно включить единый вход, используя приложение брокера.

```
+------------+ +------------+   +-------------+
|            | |            |   |             |
|   App 1    | |   App 2    |   |   Someone   |
|            | |            |   |    Else's   |
|            | |            |   |     App     |
+------------+ +------------+   +-------------+
| Azure SDK  | | Azure SDK  |   | Azure SDK   |
+-----+------+-+-----+------+-  +-------+-----+
      |              |                  |
      |       +------v------+           |
      |       |             |           |
      |       | Microsoft   |           |
      +-------> Broker      |^----------+
              | Application
              |             |
              +-------------+
              |             |
              |   Broker    |
              |   Storage   |
              |             |
              +-------------+
```

## <a name="enabling-cross-app-sso-using-adal"></a>Включение единого входа в нескольких приложениях с помощью ADAL

Здесь пакет SDK iOS для ADAL используется в следующих целях:

* включение единого входа без помощи брокера для набора приложений;
* включить поддержку единого входа с помощью брокера.

### <a name="turning-on-sso-for-non-broker-assisted-sso"></a>Включение единого входа без брокера

Когда для приложений включен единый вход без брокера, большей частью связанных с этой функцией процессов управляют пакеты SDK. Сюда входит поиск нужного пользователя в кэше, а также хранение списка вошедших пользователей для выполнения запросов.

Включить единый вход для своих приложений можно так:

1. Убедитесь, что все приложения используют один идентификатор клиента или приложения.
2. Убедитесь, что все приложения имеют один и тот же самозаверяющий сертификат от Apple для общего доступа к цепочкам ключей.
3. Запросите одинаковое назначение цепочки ключей для каждого из приложений.
4. Сообщите пакету SDK об общей цепочке ключей, которую вы хотите использовать.

#### <a name="using-the-same-client-id--application-id-for-all-the-applications-in-your-suite-of-apps"></a>Использование одного идентификатора клиента или приложения для всех приложений в наборе

Чтобы платформа удостоверений получила разрешение на использование общих токенов в приложениях, каждому из приложений потребуется предоставить один идентификатор клиента или приложения. Это уникальный идентификатор, предоставленный вам при регистрации первого приложения на портале.

URI перенаправления позволяют службе идентификации Майкрософт различать разные приложения, если она использует только один идентификатор приложения. Каждое приложение может иметь несколько кодов URI перенаправления, зарегистрированных на портале подключения. Каждое приложение в наборе получит уникальный код URI перенаправления. Вот как это выглядит:

URI перенаправления App1: `x-msauth-mytestiosapp://com.myapp.mytestapp`

URI перенаправления App2: `x-msauth-mytestiosapp://com.myapp.mytestapp2`

URI перенаправления App3: `x-msauth-mytestiosapp://com.myapp.mytestapp3`

....

Эти элементы вложены в один и тот же идентификатор клиента или приложения. Найти их можно по коду URI перенаправления, возвращаемого нам в конфигурации пакета SDK.

```
+-------------------+
|                   |
|  Client ID        |
+---------+---------+
          |
          |           +-----------------------------------+
          |           |  App 1 Redirect URI               |
          +----------^+                                   |
          |           +-----------------------------------+
          |
          |           +-----------------------------------+
          +----------^+  App 2 Redirect URI               |
          |           |                                   |
          |           +-----------------------------------+
          |
          +----------^+-----------------------------------+
                      |  App 3 Redirect URI               |
                      |                                   |
                      +-----------------------------------+

```

Формат URI перенаправления представлен ниже. Вы можете использовать любой URI перенаправления, если не хотите поддерживать брокер: в этом случае он будет выглядеть, как показано выше*

#### <a name="create-keychain-sharing-between-applications"></a>Создание общей цепочки ключей между приложениями

Включение общей цепочки ключей не описано в этом документе. См. документ Apple [Adding Capabilities](https://developer.apple.com/library/ios/documentation/IDEs/Conceptual/AppDistributionGuide/AddingCapabilities/AddingCapabilities.html) (Добавление возможностей). Важно, что именно вы решаете, как следует назвать цепочку ключей, и добавляете эту возможность во всех приложениях.

Если у вас правильно настроены назначения, в каталоге проекта появится файл `entitlements.plist`, содержимое которого аналогично следующему:

```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>keychain-access-groups</key>
    <array>
        <string>$(AppIdentifierPrefix)com.myapp.mytestapp</string>
        <string>$(AppIdentifierPrefix)com.myapp.mycache</string>
    </array>
</dict>
</plist>
```

Если вы включили назначение цепочки ключей в каждом из приложений и готовы использовать единый вход, используйте цепочку ключей в пакете SDK в `ADAuthenticationSettings` с помощью следующего параметра:

```
defaultKeychainSharingGroup=@"com.myapp.mycache";
```

> [!WARNING]
> При предоставлении цепочки ключей в приложениях любое приложение может удалить пользователей или даже все токены в приложении. Это особенно катастрофично, если фоновая работа некоторых приложений зависит от токенов. Общий доступ к цепочке ключей означает, что вы должны быть очень аккуратны при операциях удаления, выполняемых через пакеты SDK для удостоверений.

Вот и все! Теперь пакет SDK передаст учетные данные во все приложения. Кроме того, во все экземпляры приложений будет отправлен список пользователей.

### <a name="turning-on-sso-for-broker-assisted-sso"></a>Включение единого входа с брокером

Возможность приложения использовать любой брокер, который установлен на устройстве, **по умолчанию отключена**. Чтобы пользоваться приложением с брокером, необходимо выполнить дополнительную настройку и добавить код в приложение.

Шаги для выполнения:

1. Включите режим брокера в вызове MS SDK кода приложения.
2. Установите новый URI перенаправления и предоставьте его приложению и для регистрации приложения.
3. Регистрация схемы URL-адреса.
4. Поддержка iOS9: добавление разрешения в файл info.plist.

#### <a name="step-1-enable-broker-mode-in-your-application"></a>Шаг 1. Включение режима брокера в приложении

Возможность для приложения использовать брокера включена при создании "контекста" и первоначальной настройке объекта проверки подлинности. Она выполняется путем настройки типа учетных данных в коде.

```
/*! See the ADCredentialsType enumeration definition for details */
@propertyADCredentialsType credentialsType;
```
Параметр `AD_CREDENTIALS_AUTO` позволит пакету SDK попытаться выполнить вызов брокера, а `AD_CREDENTIALS_EMBEDDED` будет препятствовать ему вызвать брокер.

#### <a name="step-2-registering-a-url-scheme"></a>Шаг 2. Регистрация схемы URL-адреса

Платформа удостоверений использует URL-адреса для вызова брокера, а затем возвращает элемент управления в приложение. Чтобы завершить этот цикл, требуется схема URL-адреса, зарегистрированная для приложения, о котором платформа удостоверений узнает. Она может быть дополнением к другим схемам безопасности, которые вы зарегистрировали в приложении.

> [!WARNING]
> Рекомендуется сделать схему URL-адреса уникальной, чтобы свести к минимуму вероятность использования той же схемы URL-адреса другим приложением. Apple не обеспечивает уникальность схем URL-адреса, зарегистрированных в магазине приложений.

Ниже представлен пример того, как это показано в конфигурации проекта. Также это можно сделать в XCode:

```
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleTypeRole</key>
        <string>Editor</string>
        <key>CFBundleURLName</key>
        <string>com.myapp.mytestapp</string>
        <key>CFBundleURLSchemes</key>
        <array>
            <string>x-msauth-mytestiosapp</string>
        </array>
    </dict>
</array>
```

#### <a name="step-3-establish-a-new-redirect-uri-with-your-url-scheme"></a>Шаг 3. Установка нового URI перенаправления в схеме URL-адреса

Чтобы обеспечить обязательный возврат токенов учетных данных в нужное приложение, необходимо убедиться, что мы выполняем обратный вызов в приложение таким способом, который операционная система iOS может проверить. Операционная система iOS передает идентификатор набора вызывающего приложения в приложения брокера Майкрософт. Стороннее приложение не может подделать его. Следовательно, мы будем использовать его с кодом URI приложения брокера, обеспечивая тем самым возврат маркеров в нужное приложение. Вам нужно указать этот уникальный код URI перенаправления в приложении, а также выбрать его в качестве URI перенаправления на нашем портале разработчиков.

Формат кода URI перенаправления должен быть таким:

`<app-scheme>://<your.bundle.id>`

Пример: *x-msauth-mytestiosapp://com.myapp.mytestapp*

Этот URI перенаправления должен быть указан при регистрации приложения на [портале Azure](https://portal.azure.com/). Дополнительные сведения о регистрации приложения Azure AD см. в статье, посвященной [интеграции с Azure Active Directory](active-directory-how-to-integrate.md).

##### <a name="step-3a-add-a-redirect-uri-in-your-app-and-dev-portal-to-support-certificate-based-authentication"></a>Шаг 3а. Добавление URI перенаправления в приложение и на портал разработчика для поддержки проверки подлинности на основе сертификатов

Чтобы обеспечить проверку подлинности на основе сертификатов, необходимо зарегистрировать второй файл msauth в приложении и на [портале Azure](https://portal.azure.com/) для обработки проверки подлинности сертификатов, если вы хотите добавить эту поддержку в приложение.

`msauth://code/<broker-redirect-uri-in-url-encoded-form>`

ex: *msauth://code/x-msauth-mytestiosapp%3A%2F%2Fcom.myapp.mytestapp*

#### <a name="step-4-ios9-add-a-configuration-parameter-to-your-app"></a>Шаг 4. iOS9: добавление параметра конфигурации в приложение

ADAL использует –canOpenURL для проверки того, установлен ли брокер на устройстве. В iOS 9 Apple заблокированы схемы, которые может запрашивать приложение. Вам потребуется вручную добавить msauth в раздел LSApplicationQueriesSchemes файла `info.plist file`.

```
<key>LSApplicationQueriesSchemes</key> <array><string>msauth</string></array>
```

### <a name="youve-configured-sso"></a>Вы настроили единый вход!

Теперь пакет SDK для удостоверений будет автоматически предоставлять учетные данные в приложения и вызывать брокер, если он есть на устройстве.

## <a name="next-steps"></a>Дополнительная информация

* Дополнительные сведения см. в статье [Протокол единого входа SAML](single-sign-on-saml-protocol.md).