---
title: Настройка автоматического ускорения входа для приложения с помощью политики обнаружения домашней области | Документация Майкрософт
description: В этом разделе объясняется, что такое клиент Azure AD и как управлять Azure с помощью Azure Active Directory.
services: active-directory
documentationcenter: ''
author: barbkess
manager: mtillman
ms.service: active-directory
ms.component: app-mgmt
ms.workload: infrastructure-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: it-pro
ms.date: 06/08/2018
ms.author: barbkess
ms.openlocfilehash: f2ab0a4458c83aa9e5c9cee4875e41c24f615018
ms.sourcegitcommit: ea5193f0729e85e2ddb11bb6d4516958510fd14c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/21/2018
ms.locfileid: "36301205"
---
# <a name="configure-azure-active-directory-sign-in-behavior-for-an-application-by-using-a-home-realm-discovery-policy"></a>Настройка поведения при входе в Azure Active Directory для приложения с помощью политики обнаружения домашней области

В данном документе содержатся вводные сведения о настройке поведения функции проверки подлинности Azure Active Directory для федеративных пользователей.   В нем рассказывается о настройке ограничений автоматического ускорения входа и проверки подлинности для пользователей в федеративных доменах.

## <a name="home-realm-discovery"></a>Обнаружение домашней области
Обнаружение домашней области (HRD) — это процесс, благодаря которому служба Azure Active Directory (Azure AD) может определять области, в которых пользователь должен пройти проверку подлинности во время входа пользователя систему.  При входе в клиент Azure AD для доступа к ресурсу или на общую страницу входа Azure AD пользователь вводит имя пользователя (имя участника-пользователя). Azure AD использует его для обнаружения областей, где пользователь должен выполнить вход. 

Чтобы пройти аутентификацию, пользователь должен быть перенаправлен в одно из приведенных ниже расположений.

- Домашний клиент пользователя (может использоваться тот же, которому принадлежит ресурс, к которому пользователь пытается получить доступ). 

- Учетную запись Майкрософт.  В клиенте ресурса пользователь является гостем.

-  Локальный поставщик удостоверений, например службы федерации Active Directory (AD FS).

- Другой поставщик удостоверений, включенный в федерацию с клиентом Azure AD.

## <a name="auto-acceleration"></a>Автоматическое ускорение 
Для проверки подлинности пользователя некоторые организации настраивают домены в своих клиентах Azure Active Directory, чтобы выполнить объединение с другим поставщиком удостоверений, например с AD FS.  

Когда пользователь входит в систему в приложении, он сначала попадает на страницу входа в Azure AD. После того как он введет свое имя участника-пользователя (если оно есть в федеративном домене), он попадает на страницу входа поставщика удостоверений, обслуживающего этот домен. При определенных обстоятельствах у администраторов может возникнуть необходимость направлять пользователей на страницу входа, когда они пытаются войти в определенные приложения. 

В результате пользователь может пропустить начальную страницу Azure Active Directory. Этот процесс называется автоматическим ускорением входа.

В случаях, когда клиент является федеративным в отношении другого поставщика удостоверений для входа, автоматическое ускорение позволяет упростить вход пользователей.  Автоматическое ускорение входа можно настроить для отдельных приложений.

>[!NOTE]
>При настройке приложения для автоматического ускорения гостевые пользователи не могут выполнить вход. Когда пользователь будет перенаправлен непосредственно к федеративному поставщику удостоверений для аутентификации, он больше не сможет вернуться на страницу входа Azure Active Directory. Гостевые пользователи, которых требуется направить в другие клиенты или внешние поставщики удостоверений, например учетную запись Майкрософт, не смогут выполнить вход в это приложение, так как шаг обнаружения домашней области пропускается.  

Существуют два способа управления автоматическим ускорением входа в федеративный поставщик удостоверений.   

- Можно использовать указание домена в запросах на аутентификацию для приложения. 
- Можно настроить политику обнаружения домашней области для включения автоматического ускорения входа.

### <a name="domain-hints"></a>Указания домена    
Указания домена представляют собой директивы, включенные в запрос на аутентификацию из приложения. Их можно использовать для ускорения входа пользователя на страницу входа федеративного поставщика удостоверений. Или они могут использоваться мультитенантным приложением, чтобы ускорить для клиента вход пользователя непосредственно на страницу входа Azure AD с фирменной символикой.  

Например, приложение largeapp.com дает возможность клиентам получить доступ к приложению с помощью пользовательского URL-адреса contoso.largeapp.com. Приложение может также включать указание домена contoso.com в запрос на аутентификацию. 

Синтаксис указания домена может быть разным в зависимости от используемого протокола и обычно настраивается в приложении.

**WS-Federation**:  whr=contoso.com в строке запроса.

**SAML**: либо запрос на аутентификацию SAML, содержащий указание домена, либо строка запроса whr=contoso.com.

**Open ID Connect**: строка запроса domain_hint=contoso.com. 

Если указание домена включено в запрос на аутентификацию из приложения, а клиент входит в федерацию с этим доменом, Azure AD предпринимает попытку перенаправить операцию входа на страницу поставщика удостоверений, настроенного для этого домена. 

Если указание домена не ссылается на проверенный федеративный домен, оно игнорируется и активируется стандартное обнаружение домашней области.

Дополнительные сведения об автоматическом ускорении с помощью указаний домена, поддерживаемых службой Azure Active Directory, см. в блоге [Enterprise Mobility + Security](https://cloudblogs.microsoft.com/enterprisemobility/2015/02/11/using-azure-ad-to-land-users-on-their-custom-login-page-from-within-your-app/).

>[!NOTE]
>Если указание домена включено в запрос на проверку подлинности, то его наличие переопределяет автоматическое ускорение, настроенное для приложения в политике обнаружения домашней области (HRD).

### <a name="home-realm-discovery-policy-for-auto-acceleration"></a>Политика обнаружения домашней области для автоматического ускорения входа
Некоторые приложения не предоставляют возможность настроить выдаваемый ими запрос на аутентификацию. В таких случаях невозможно использовать указания домена для управления автоматическим ускорением. Автоматическое ускорение можно настроить с помощью политики, чтобы добиться нужного поведения.  

## <a name="enable-direct-authentication-for-legacy-applications"></a>Включение прямой проверки подлинности для приложений прежних версий
Рекомендации для приложений заключаются в использовании библиотек AAD и интерактивного входа для проверки подлинности пользователей. Библиотеки обеспечивают работу потоков федеративных пользователей.  Иногда приложения прежних версий не предназначены для поддержки федерации. Они не выполняют обнаружение домашней области и не взаимодействуют с правильной федеративной конечной точкой для проверки подлинности пользователя. При желании вы можете использовать политику обнаружения домашней области, чтобы включить определенные приложения прежних версий, которые отправляют учетные данные в формате "имя пользователя и пароль" для проверки подлинности непосредственно в Azure Active Directory. У вас должна быть включена функция синхронизации хэша паролей. 

> [!IMPORTANT]
> Если у вас включена функция синхронизации хэша паролей и вы знаете, что можно выполнять проверку подлинности этого приложения без использования политик, реализованных локальным поставщиком удостоверений, то достаточно включить только прямую проверку подлинности. Если по какой-либо причине вы отключите синхронизацию хэша паролей или синхронизацию каталогов с помощью AD Connect, вам следует удалить эту политику, чтобы не допустить возможность прямой проверки подлинности с использованием устаревшего хэша пароля.

## <a name="set-hrd-policy"></a>Задание политики обнаружения домашней области (HRD)
Настройка политики обнаружения домашней области в приложении для автоматического ускорения федеративного входа или для непосредственных облачных приложений включает три указанных ниже этапа.

1. Создание политики обнаружения домашней области.

2. Поиск субъекта-службы, к которому будет применена эта политика.

3. Применение политики к субъекту-службе. 

Политики вступают в силу для определенного приложения, только если они применены к субъекту-службе. 

В любой момент времени для субъекта-службы может быть активна только одна политика обнаружения домашней области.  

Для создания политики обнаружения домашней области и управления ею вы можете использовать либо непосредственно API Graph Microsoft Azure Active Directory, либо командлеты PowerShell для Azure Active Directory.

API Graph, который позволяет управлять политикой, описан в статье [Operations on policy](https://msdn.microsoft.com/library/azure/ad/graph/api/policy-operations) (Операции с политикой) на сайте MSDN.

Ниже приведен пример определения политики обнаружения домашней области.
    
 ```
   {  
    "HomeRealmDiscoveryPolicy":
    {  
    "AccelerateToFederatedDomain":true,
    "PreferredDomain":"federated.example.edu",
    "AllowCloudPasswordValidation":true
    }
   }
```

Тип политики — "HomeRealmDiscoveryPolicy".

Параметр **AccelerateToFederatedDomain** — необязательный. Если параметр **AccelerateToFederatedDomain** имеет значение False (Ложь), то политика не влияет на автоматическое ускорение входа. Если параметр **AccelerateToFederatedDomain** имеет значение True (Истина), и в клиенте имеется только один проверенный федеративный домен, то система будет сразу переводить пользователей на федеративный поставщик удостоверений для входа в систему. Если этот параметр имеет значение True (Истина), и в клиенте имеется несколько проверенных доменов, необходимо задать значение для параметра **PreferredDomain**.

Параметр **PreferredDomain** — необязательный. В параметре **PreferredDomain** следует указать домен, вход на который требуется ускорить. Его можно опустить, если клиент использует только один федеративный домен.  Если его не указать, но при этом имеется более одного проверенного федеративного домена, политика не будет действовать.

 Если указан параметр **PreferredDomain**, он должен соответствовать проверенному федеративному домену для клиента. Все пользователи приложения должны иметь возможность выполнить вход на этот домен.

Параметр **AllowCloudPasswordValidation** — необязательный. Если параметр **AllowCloudPasswordValidation** имеет значение True (Истина), это значит, что приложению разрешено выполнять проверку подлинности федеративного пользователя путем предоставления учетных данных в формате "имя пользователя и пароль" непосредственно в конечную точку маркера Azure Active Directory. Этот способ работает, только если включена синхронизация хэша паролей.

### <a name="priority-and-evaluation-of-hrd-policies"></a>Приоритетность и оценка политик HRD
Вы можете создать политики HRD, а затем назначить их отдельным организациям и субъектам-службам. Это означает, что к определенному приложению может применяться сразу несколько политик. Политика HRD оказывает влияние согласно следующим правилам:


- Если в запросе на проверку подлинности присутствует указание домена, то любая политика обнаружения домашней области будет проигнорирована для автоматического ускорения входа. В этом случае используется поведение, заданное указанием домена.

- В противном случае, если политика явно назначена субъекту-службе, применяется именно она. 

- Если отсутствует указание домена и нет политики, явно назначенной субъекту-службе, применяется политика, явно назначенная родительской организации субъекта-службы. 

- Если отсутствует указание домена и нет политики, назначенной субъекту-службе или организации, используется стандартное поведение HRD.

## <a name="tutorial-for-setting-hrd-policy-on-an-application"></a>Руководство по настройке политики обнаружения домашней области в приложении 
Мы будем использовать командлеты PowerShell для Azure AD, чтобы изучить несколько сценариев, включая:


- настройку политики обнаружения домашней области для выполнения автоматического ускорения входа для приложения в клиенте с одним федеративным доменом;

- настройку политики обнаружения домашней области для выполнения автоматического ускорения входа для приложения для одного из нескольких доменов, проверенных для вашего клиента;

- настройку политики обнаружения домашней области для разрешения приложениям прежних версий выполнять прямую проверку подлинности с использованием имени пользователя и пароля в Azure Active Directory для федеративного пользователя;

- получение списка приложений, для которых настроена политика.


### <a name="prerequisites"></a>предварительным требованиям
В примерах ниже создаются, обновляются, связываются и удаляются политики для субъектов-служб приложения в Azure AD.

1.  Чтобы начать, скачайте последнюю предварительную версию командлетов PowerShell для Azure AD. 

2.  После этого выполните команду Connect для входа в Azure AD с помощью учетной записи администратора.

    ``` powershell
    Connect-AzureAD -Confirm
    ```
3.  Выполните следующую команду для просмотра всех политик в организации.

    ``` powershell
    Get-AzureADPolicy
    ```

Если результат не возвращается, в клиенте нет созданных политик.

### <a name="example-set-hrd-policy-for-an-application"></a>Пример: настройка политики обнаружения домашней области для приложения 

В этом примере показано, как создать политику, которая при назначении ее приложению выполняет одно из указанных ниже действий. 
- Выполняет автоматическое ускорение входа пользователей и переводит их на экран входа AD FS (когда они выполняют вход в систему в приложении), если в клиенте имеется один домен. 
- Выполняет автоматическое ускорение входа пользователей и переводит их на экран входа AD FS, если в клиенте имеется несколько федеративных доменов.
- Разрешает неинтерактивный вход с использованием имени пользователя и пароля непосредственно в Azure Active Directory для федеративных пользователей для приложений, которым назначена политика.

#### <a name="step-1-create-an-hrd-policy"></a>Шаг 1. Создание политики обнаружения домашней области

Указанная ниже политика выполняет автоматическое ускорение входа пользователей и переводит их на экран входа AD FS (когда они выполняют вход в систему в приложении), если в клиенте имеется один домен.

``` powershell
New-AzureADPolicy -Definition @("{`"HomeRealmDiscoveryPolicy`":{`"AccelerateToFederatedDomain`":true}}") -DisplayName BasicAutoAccelerationPolicy -Type HomeRealmDiscoveryPolicy
```
Указанная ниже политика выполняет автоматическое ускорение входа пользователей и переводит их на экран входа AD FS, если в клиенте имеется несколько федеративных доменов. Если у вас несколько федеративных доменов, выполняющих проверку подлинности пользователей для приложений, вам потребуется указать домен, для которого необходимо использовать автоматическое ускорение входа.

``` powershell
New-AzureADPolicy -Definition @("{`"HomeRealmDiscoveryPolicy`":{`"AccelerateToFederatedDomain`":true, `"PreferredDomain`":`"federated.example.edu`"}}") -DisplayName MultiDomainAutoAccelerationPolicy -Type HomeRealmDiscoveryPolicy
```

Чтобы создать политику, разрешающую проверку подлинности с использованием имени пользователя и пароля для федеративных пользователей непосредственно в Azure Active Directory для определенных приложений, выполните следующую команду:

``` powershell
New-AzureADPolicy -Definition @("{`"HomeRealmDiscoveryPolicy`":{`"AllowCloudPasswordValidation`":true}}") -DisplayName EnableDirectAuthPolicy -Type HomeRealmDiscoveryPolicy
```


Чтобы просмотреть созданную политику и получить для нее идентификатор **ObjectID**, выполните следующую команду.

``` powershell
Get-AzureADPolicy
```


Чтобы применить политику обнаружения домашней области после ее создания, можно назначить ее нескольким субъектам-службам приложения.

#### <a name="step-2-locate-the-service-principal-to-which-to-assign-the-policy"></a>Шаг 2. Поиск субъекта-службы для назначения политики  
Чтобы назначить политику субъектам-службам, необходимо знать их идентификаторы **ObjectID**. Существует несколько способов получения идентификатора **ObjectID** субъектов-служб.    

Можно использовать портал или отправить запрос к [Microsoft Graph](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity). Можно также открыть [Graph Explorer Tool](https://graphexplorer.cloudapp.net/) и войти в учетную запись Azure AD, чтобы просмотреть список всех субъектов-служб в своей организации. Так как вы используете PowerShell, можно использовать командлет get-AzureADServicePrincipal, чтобы вывести список субъектов-служб и их идентификаторов.

#### <a name="step-3-assign-the-policy-to-your-service-principal"></a>Шаг 3. Назначение политики для субъекта-службы  
Получив идентификатор **ObjectID** субъекта-службы приложения, для которого требуется настроить автоматическое ускорение, выполните следующую команду. Эта команда привязывает политику обнаружения домашней области, созданную на шаге 1, к субъекту-службе, определенному на шаге 2.

``` powershell
Add-AzureADServicePrincipalPolicy -Id <ObjectID of the Service Principal> -RefObjectId <ObjectId of the Policy>
```

Эту команду можно повторить для каждого субъекта-службы, для которого необходимо добавить политику.

Если приложению уже назначена политика HomeRealmDiscovery, вам не удастся назначить ему еще одну такую политику.  В этом случае измените определение политики обнаружения домашней области, которая назначена приложению, чтобы добавить дополнительные параметры.

#### <a name="step-4-check-which-application-service-principals-your-hrd-policy-is-assigned-to"></a>Шаг 4. Проверка субъектов-служб приложения, которым назначена политика обнаружения домашней области
Чтобы проверить, для каких приложений настроена политика обнаружения домашней области, воспользуйтесь командлетом **Get-AzureADPolicyAppliedObject**. Передайте в него идентификатор **ObjectID** политики, которую нужно проверить.

``` powershell
Get-AzureADPolicyAppliedObject -ObjectId <ObjectId of the Policy>
```
#### <a name="step-5-youre-done"></a>Шаг 5. Готово!
Испытайте приложение, чтобы проверить новую политику в действии.

### <a name="example-list-the-applications-for-which-hrd-policy-is-configured"></a>Пример: получение списка приложений, для которых настроена политика обнаружения домашней области

#### <a name="step-1-list-all-policies-that-were-created-in-your-organization"></a>Шаг 1. Получение списка всех политик, созданных в организации 

``` powershell
Get-AzureADPolicy
```

Запишите идентификатор **ObjectID** политики, для которой вы хотите получить список назначений.

#### <a name="step-2-list-the-service-principals-to-which-the-policy-is-assigned"></a>Шаг 2. Получение списка субъектов-служб, которым назначена политика  

``` powershell
Get-AzureADPolicyAppliedObject -ObjectId <ObjectId of the Policy>
```

### <a name="example-remove-an-hrd-policy-for-an-application"></a>Пример: удаление политики обнаружения домашней области для приложения
#### <a name="step-1-get-the-objectid"></a>Шаг 1. Получение идентификатора ObjectID
Используйте предыдущий пример, чтобы получить идентификатор **ObjectID** политики, а также идентификатор ObjectID субъекта-службы приложения, из которого нужно удалить эту политику. 

#### <a name="step-2-remove-the-policy-assignment-from-the-application-service-principal"></a>Шаг 2. Удаление назначения политики из субъекта-службы приложения  

``` powershell
Remove-AzureADApplicationPolicy -ObjectId <ObjectId of the Service Principal>  -PolicyId <ObjectId of the policy>
```

#### <a name="step-3-check-removal-by-listing-the-service-principals-to-which-the-policy-is-assigned"></a>Шаг 3. Проверка удаления путем получения списка субъектов-служб, которым назначена политика 

``` powershell
Get-AzureADPolicyAppliedObject -ObjectId <ObjectId of the Policy>
```
## <a name="next-steps"></a>Дополнительная информация
- Дополнительные сведения о принципах работы аутентификации в Azure AD см. в статье [Сценарии аутентификации в Azure Active Directory](../develop/active-directory-authentication-scenarios.md).
- Дополнительные сведения о едином входе пользователей см. в статье [Управление параметрами единого входа для корпоративных приложений](configure-single-sign-on-portal.md).
- Сведения для разработчиков см. в [руководстве разработчика по Active Directory](../develop/active-directory-developers-guide.md).
