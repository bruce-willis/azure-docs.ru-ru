---
title: Управляемые удостоверения для ресурсов Azure
description: Общие сведения об управляемых удостоверениях для ресурсов Azure.
services: active-directory
documentationcenter: ''
author: daveba
manager: mtillman
editor: ''
ms.assetid: 0232041d-b8f5-4bd2-8d11-27999ad69370
ms.service: active-directory
ms.component: msi
ms.devlang: ''
ms.topic: overview
ms.custom: mvc
ms.date: 03/28/2018
ms.author: daveba
ms.openlocfilehash: 43bfe3abcbe6a66f124565cde8ddb839ba76d045
ms.sourcegitcommit: cc4fdd6f0f12b44c244abc7f6bc4b181a2d05302
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/25/2018
ms.locfileid: "47107256"
---
# <a name="what-is-managed-identities-for-azure-resources"></a>Что такое управляемые удостоверения для ресурсов Azure?

[!INCLUDE [preview-notice](../../../includes/active-directory-msi-preview-notice.md)]

Распространенная проблема при создании облачных приложений — управление учетными данными в коде для проверки подлинности в облачных службах. Обеспечение безопасности учетных данных является важной задачей. В идеальном случае учетные данные никогда не передаются на рабочие станции разработчиков и не проверяются после изменения в системе управления версиями. Azure Key Vault позволяет обеспечить безопасное хранение учетных данных, секретов, а также других ключей, но для их получения код должен выполнять проверку подлинности в Key Vault. 

Функция управляемых удостоверений для ресурсов Azure в Azure Active Directory решает эту проблему. Функция предоставляет службам Azure автоматически управляемое удостоверение в Azure AD. Удостоверение можно использовать для проверки подлинности в любой службе, которая поддерживает проверку подлинности Azure AD, включая Key Vault, при этом не сохраняя каких-либо учетных данных в коде.

Использование функции управляемых удостоверений для ресурсов Azure предоставляется AAD бесплатно для подписок Azure. Дополнительные затраты отсутствуют.

> [!NOTE]
> Управляемые удостоверения для ресурсов Azure — это новое имя службы "Управляемое удостоверение службы" (MSI).

## Принципы работы функции<a name="how-does-it-work"></a>

Существует два типа управляемых удостоверений.

- **Назначаемое системой управляемое удостоверение** включается непосредственно в экземпляре службы Azure. Если удостоверение включено, Azure создает удостоверение для экземпляра службы в клиенте Azure AD, который является доверенным в подписке этого экземпляра. После создания удостоверения учетные данные подготавливаются для передачи в экземпляр. Жизненный цикл назначаемого системой удостоверения напрямую связан с экземпляром службы Azure, в которой оно включено. При удалении экземпляра Azure автоматически очищает учетные данные и удостоверение в Azure AD.
- **Назначаемое пользователем управляемое удостоверение** создается как изолированный ресурс Azure. При этом Azure создает удостоверение в доверенном клиенте Azure AD используемой подписки. После создания удостоверения оно может быть назначено одному или нескольким экземплярам служб Azure. Управление жизненным циклом назначаемого пользователем удостоверения осуществляется отдельно от жизненного цикла экземпляров служб Azure, для которых оно назначено.

Затем ваш код может использовать управляемое удостоверение для запроса на получение маркеров доступа для служб, которые поддерживают аутентификацию Azure AD. Azure выполняет развертывание учетных данных, используемых экземпляром службы.

Работа управляемых удостоверений служб с виртуальными машинами Azure показана на следующей схеме.

![Управляемые удостоверения служб и виртуальные машины Azure](media/overview/msi-vm-vmextension-imds-example.png)

### <a name="how-a-system-assigned-managed-identity-works-with-an-azure-vm"></a>Использование назначаемого системой управляемого удостоверения с виртуальной машиной Azure

1. Azure Resource Manager получает запрос на включение назначаемого системой управляемого удостоверения MSI в виртуальной машине.
2. Azure Resource Manager создает субъект-службу в Azure AD для удостоверения виртуальной машины. В клиенте Azure AD, который является доверенным для этой подписки, создается субъект-служба.
3. Azure Resource Manager настраивает удостоверение на виртуальной машине;
    1. Обновляет конечную точку удостоверения Службы метаданных экземпляров Azure с помощью идентификатора клиента субъект-службы и сертификата.
    1. Предоставляет расширение виртуальной машины (в январе 2019 года будет объявлено устаревшим) и добавляет идентификатор клиента субъект-службы и сертификат. (Этот шаг планируется объявить устаревшим).
4. После того как виртуальной машине было назначено удостоверение, для предоставления доступа виртуальной машины к ресурсам Azure используются сведения о субъекте-службе. Чтобы назначить соответствующую роль субъект-службе виртуальной машины, используйте Azure Resource Manager. Его можно вызвать с помощью управления доступом на основе ролей RBAC в Azure AD. Для вызова Key Vault следует предоставить доступ к определенному секрету или ключу в Key Vault.
5. Код, выполняющийся на виртуальной машине, может выполнить запрос на получение маркера из двух конечных точек, доступных только на виртуальной машине.

    - Конечная точка удостоверения Службы метаданных экземпляров Azure (рекомендуется): `http://169.254.169.254/metadata/identity/oauth2/token`.
        - Параметр ресурса указывает службу, в которую отправляется маркер. Для проверки подлинности в Azure Resource Manager необходимо использовать `resource=https://management.azure.com/`.
        - Параметр версии API указывает версию IMDS. Используйте api-version=2018-02-01 или более позднюю версию.
    - Конечная точка расширения виртуальной машины (в январе 2019 года будет объявлено устаревшим): `http://localhost:50342/oauth2/token` 
        - Параметр ресурса указывает службу, в которую отправляется маркер. Для проверки подлинности в Azure Resource Manager необходимо использовать `resource=https://management.azure.com/`.

6. В Azure AD выполняется вызов для запроса маркера доступа (как указано в шаге 5) с использованием идентификатора клиента и сертификата, настроенных на шаге 3. Azure AD возвращает маркер доступа JSON Web Token (JWT).
7. Код отправляет этот маркер доступа при вызове службы, которая поддерживает аутентификацию Azure AD.

### <a name="how-a-user-assigned-managed-identity-works-with-an-azure-vm"></a>Использование назначаемого пользователем управляемого удостоверения на виртуальной машине Azure

1. Azure Resource Manager получает запрос на создание назначаемого пользователем управляемого удостоверения.
2. Azure Resource Manager создает субъект-службу в Azure AD для назначаемого пользователем управляемого удостоверения. В клиенте Azure AD, который является доверенным для этой подписки, создается субъект-служба.
3. Azure Resource Manager получает запрос на настройку назначаемого пользователем управляемого удостоверения в виртуальной машине.
    1. Обновляет конечную точку удостоверения Службы метаданных экземпляров Azure с помощью идентификатора клиента и сертификата субъекта-службы назначаемого пользователем управляемого удостоверения.
    1. Подготавливает расширения виртуальной машины и добавляет идентификатор клиента и сертификат субъекта-службы назначаемого пользователем управляемого удостоверения. (Этот шаг планируется объявить устаревшим).
4. Создав назначаемое пользователем управляемое удостоверение, примените сведения о субъекте-службе, чтобы предоставить этому удостоверению доступ к ресурсам Azure. Чтобы назначить соответствующую роль субъекту-службе назначаемого пользователем удостоверения, используйте вызов Azure Resource Manager с помощью RBAC в Azure AD. Для вызова Key Vault следует предоставить доступ к определенному секрету или ключу в Key Vault.

   > [!Note]
   > Также данное действие можно выполнить перед шагом 3.

5. Код, выполняющийся на виртуальной машине, может выполнить запрос на получение маркера из двух конечных точек, доступных только на виртуальной машине.

    - Конечная точка удостоверения Службы метаданных экземпляров Azure (рекомендуется): `http://169.254.169.254/metadata/identity/oauth2/token`.
        - Параметр ресурса указывает службу, в которую отправляется маркер. Для проверки подлинности в Azure Resource Manager необходимо использовать `resource=https://management.azure.com/`.
        - Параметр идентификатора клиента определяет удостоверение, для которого запрашивается маркер. Это значение необходимо для устранения неоднозначности, когда на одной виртуальной машине доступны несколько назначаемых пользователем удостоверений.
        - Параметры версии API указывают версию Службы метаданных экземпляров Azure. Используйте `api-version=2018-02-01` или более поздней версии.

    - Конечная точка расширения виртуальной машины (в январе 2019 года будет объявлено устаревшим): `http://localhost:50342/oauth2/token`
        - Параметр ресурса указывает службу, в которую отправляется маркер. Для проверки подлинности в Azure Resource Manager необходимо использовать `resource=https://management.azure.com/`.
        - Параметр идентификатора клиента определяет удостоверение, для которого запрашивается маркер. Это значение необходимо для устранения неоднозначности, когда на одной виртуальной машине доступны несколько назначаемых пользователем удостоверений.
6. В Azure AD выполняется вызов для запроса маркера доступа (как указано в шаге 5) с использованием идентификатора клиента и сертификата, настроенных на шаге 3. Azure AD возвращает маркер доступа JSON Web Token (JWT).
7. Код отправляет этот маркер доступа при вызове службы, которая поддерживает аутентификацию Azure AD.

## <a name="how-can-i-use-managed-identities-for-azure-resources"></a>Как применять управляемые удостоверения для ресурсов Azure?

Дополнительные сведения об использовании управляемых удостоверений для получения доступа к разным ресурсам Azure приведены в следующих руководствах.

См. дополнительные сведения об использовании управляемого удостоверения для виртуальной машины Windows:

* [Доступ к Azure Data Lake Store](tutorial-windows-vm-access-datalake.md)
* [Получение доступа к Azure Resource Manager с помощью управляемого удостоверения службы виртуальной машины Linux](tutorial-windows-vm-access-arm.md)
* [Доступ к Azure SQL](tutorial-windows-vm-access-sql.md)
* [Доступ к службе хранилища Azure с помощью управляемого удостоверения виртуальной машины Linux](tutorial-windows-vm-access-storage.md)
* [Руководство по использованию управляемого удостоверения службы виртуальной машины Linux для доступа к службе хранилища Azure с учетными данными SAS](tutorial-windows-vm-access-storage-sas.md)
* [Доступ к Azure Key Vault с помощью управляемого удостоверения службы виртуальной машины Linux](tutorial-windows-vm-access-nonaad.md)

См. дополнительные сведения об использовании управляемого удостоверения для виртуальной машины Linux:

* [Доступ к Azure Data Lake Store](tutorial-linux-vm-access-datalake.md)
* [Получение доступа к Azure Resource Manager с помощью управляемого удостоверения службы виртуальной машины Linux](tutorial-linux-vm-access-arm.md)
* [Доступ к службе хранилища Azure с помощью управляемого удостоверения виртуальной машины Linux](tutorial-linux-vm-access-storage.md)
* [Руководство по использованию управляемого удостоверения службы виртуальной машины Linux для доступа к службе хранилища Azure с учетными данными SAS](tutorial-linux-vm-access-storage-sas.md)
* [Доступ к Azure Key Vault с помощью управляемого удостоверения службы виртуальной машины Linux](tutorial-linux-vm-access-nonaad.md)

См. дополнительные сведения об использовании управляемого удостоверения для других служб Azure:

* [службе приложений Azure](/azure/app-service/app-service-managed-service-identity)
* [Функции Azure](/azure/app-service/app-service-managed-service-identity)
* [служебной шине Azure](../../service-bus-messaging/service-bus-managed-service-identity.md)
* [Центры событий Azure](../../event-hubs/event-hubs-managed-service-identity.md)
* [Управление API Azure](../../api-management/api-management-howto-use-managed-service-identity.md)

## Службы Azure, в которых поддерживается данная функция.<a name="which-azure-services-support-managed-identity"></a>

Управляемые удостоверения для ресурсов Azure можно использовать для аутентификации служб с поддержкой аутентификации Azure AD. См. дополнительные сведения о [службах, которые поддерживают управляемые удостоверения для ресурсов Azure](services-support-msi.md).

## <a name="next-steps"></a>Дополнительная информация

Чтобы использовать управляемые удостоверения для ресурсов Azure, ознакомьтесь со следующими краткими руководствами:

* [Использование назначаемого системой управляемого удостоверения на виртуальной машине Windows для доступа к Resource Manager](tutorial-windows-vm-access-arm.md)
* [Использование назначаемого системой управляемого удостоверения на виртуальной машине Linux для доступа к Resource Manager](tutorial-linux-vm-access-arm.md)
