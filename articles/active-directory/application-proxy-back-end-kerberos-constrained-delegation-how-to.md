---
title: Устранение неполадок конфигураций ограниченного делегирования Kerberos для прокси-сервера приложения | Документация Майкрософт
description: Устранение неполадок конфигураций ограниченного делегирования Kerberos для прокси-сервера приложения
services: active-directory
documentationcenter: ''
author: barbkess
manager: mtillman
ms.assetid: ''
ms.service: active-directory
ms.component: app-mgmt
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/24/2018
ms.author: barbkess
ms.reviewer: asteen
ms.openlocfilehash: f318c53de073c8f1fa6c3ae11cb335a4a91e137d
ms.sourcegitcommit: 95d9a6acf29405a533db943b1688612980374272
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/23/2018
ms.locfileid: "36334967"
---
# <a name="troubleshoot-kerberos-constrained-delegation-configurations-for-application-proxy"></a>Устранение неполадок конфигураций ограниченного делегирования Kerberos для прокси-сервера приложения

Доступные методы обеспечения единого входа в опубликованные приложения могут немного различаться в зависимости от приложения. Один из вариантов, которые предлагает по умолчанию компонент Azure Active Directory Application Proxy (Azure AD), — ограниченное делегирование Kerberos (KCD). Вы можете настроить соединитель, который позволяет проверять подлинность серверных приложений на базе ограниченного делегирования Kerberos.

Процедура включения KCD относительно проста. Обычно для нее достаточно общих знаний о разных компонентах и потоке проверки подлинности, который поддерживает единый вход. Однако иногда единый вход с ограниченным делегированием Kerberos работает неправильно. В этом случае требуются хорошие источники информации по устранению связанных с этим неполадок.

Эта статья содержит сводные сведения, которые помогут самостоятельно диагностировать и устранить некоторые из наиболее распространенных проблем. Кроме того, в ней приводятся дополнительные рекомендации по диагностике более сложных проблем реализации.

Для работы с этой статьей предполагается следующее:

-   Развертывание компонента Azure AD Application Proxy выполнено согласно [этой статье](manage-apps/application-proxy-enable.md), а общий доступ к приложениям без ограниченного делегирования Kerberos работает как ожидалось.

-   Опубликованное целевое приложение основано на службах Internet Information Services (IIS) и реализации Kerberos от корпорации Майкрософт.

-   Узлы сервера и приложения находятся в одном домене Azure Active Directory. Подробные сведения для нескольких доменов и лесов см. в [техническом документе об ограниченном делегировании Kerberos](https://aka.ms/KCDPaper).

-   Целевое приложение опубликовано в клиенте Azure с включенной предварительной проверкой подлинности. Пользователи должны входить в Azure с помощью проверки подлинности на основе форм. Расширенные сценарии проверки подлинности клиента не рассматриваются в этой статье, но будут добавлены в будущем.

## <a name="prerequisites"></a>предварительным требованиям

Компонент Azure AD Application Proxy можно развернуть в инфраструктуре или среде любого из множества типов. Конкретная архитектура зависит от потребностей организации. Наиболее распространенными причинами возникновения проблем, связанных с ограниченным делегированием Kerberos, являются не столько сами среды, сколько неправильная настройка или общий контроль.

До начала работы по устранению неполадок рекомендуем проверить, выполнены ли все предварительные требования, изложенные в статье [Ограниченное делегирование Kerberos для поддержки единого входа в приложения с помощью прокси приложения](manage-apps/application-proxy-configure-single-sign-on-with-kcd.md). Особое внимание нужно уделить разделу о настройке ограниченного делегирования Kerberos в 2012 R2. Там описан кардинально иной подход к настройке ограниченного делегирования Kerberos для предыдущих версий Windows. При этом не следует забывать о нескольких других аспектах:

-   Рядовой сервер домена довольно часто изменяет диалоговый сеанс, открытый по безопасному каналу с определенным контроллером домена (DC). Смена диалогового сеанса может произойти в любое время. Поэтому не следует ограничивать взаимодействие узлов соединителя лишь контроллерами домена определенного локального сайта.

-   Междоменные сценарии основываются на ссылках, ведущих к контроллерам домена, которые могут находиться за пределами периметра локальной сети. В этом случае не менее важно обеспечить прохождение трафика к контроллерам, представляющим другие соответствующие домены. Иначе произойдет сбой делегирования.

-   По возможности не следует располагать активные устройства IPS или IDS между узлами соединителя и контроллерами домена. Иногда это нарушает правильную работу и мешает прохождению основного трафика RPC.

В простых сценариях следует протестировать делегирование. Чем больше переменных вы вводите, тем с большими трудностями можете столкнуться. Чтобы сэкономить время, вы можете ограничить тестирование одним соединителем, а затем добавить другие соединители уже после устранения проблем.

Некоторые факторы среды также могут стать причиной проблемы. Чтобы избежать влияния факторов среды, во время тестирования следует свести архитектуру к абсолютному минимуму. Например, довольно часто встречаются неправильно настроенные внутренние списки управления доступом (ACL) брандмауэра. По возможности организуйте прохождение трафика напрямую от соединителя к контроллерам домена и серверному приложению.

Соединители лучше всего располагать как можно ближе к их целям. Использование встроенного брандмауэра при тестировании лишь чрезмерно усложняет процесс и может приводить к затягиванию работы.

Так в чем именно состоит проблема ограниченного делегирования Kerberos? Есть несколько распространенных признаков, указывающих на сбой единого входа с ограниченным делегированием Kerberos. Первые признаки проблемы обычно проявляются в браузере.

   ![Ошибка из-за неправильной конфигурации ограниченного делегирования Kerberos](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic1.png)

   ![Сбой авторизации из-за отсутствующих разрешений](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic2.png)

Оба этих изображения указывают на неработоспособность единого входа. В результате этого пользователь не может получить доступ к приложению.

## <a name="troubleshooting"></a>Устранение неполадок

Диагностика зависит от характера проблемы и наблюдаемых симптомов. Прежде чем продолжить, изучите материалы в приведенных ниже источниках. В них приведены полезные сведения.

-   [Устранение неполадок и сообщения об ошибках прокси приложения](manage-apps/application-proxy-troubleshoot.md)

-   [Ошибки и симптомы Kerberos](manage-apps/application-proxy-troubleshoot.md#kerberos-errors)

-   [Реализация единого входа в приложения с помощью прокси приложения](manage-apps/application-proxy-configure-single-sign-on-with-kcd.md#working-with-different-on-premises-and-cloud-identities)

Если вы добрались до этого места, наверняка вы столкнулись с серьезной проблемой. Начните с разделения всей процедуры на три этапы, в рамках которых можно устранять неполадки.

### <a name="client-pre-authentication"></a>Предварительная проверка подлинности клиента 
Внешний пользователь проходит проверку подлинности в Azure через браузер. Возможность прохождения предварительной проверки подлинности в Azure — это обязательное условие для правильной работы единого входа с ограниченным делегированием Kerberos. Протестируйте эту возможность и исправьте проблемы, если они возникнут. Этап предварительной проверки подлинности не имеет отношения к ограниченному делегированию Kerberos или опубликованному приложению. Любые неполадки легко исправить, просто убедившись, что учетная запись существует в Azure, а также что она не отключена и не заблокирована. Сообщение об ошибке в браузере обычно достаточно информативно, чтобы понять причину. Если вы не уверены, ознакомьтесь с другой документацией Майкрософт по устранению неполадок.

### <a name="delegation-service"></a>Служба делегирования 
Это соединитель прокси Azure, получающий для пользователя билет службы Kerberos из KDC (центр распространения Kerberos).

Внешнее взаимодействие между клиентом и интерфейсной частью Azure должно осуществляться без привлечения ограниченного делегирования Kerberos. Эта взаимодействие используется лишь при проверке работоспособности KCD. Таким образом, прокси-службе Azure можно предоставить допустимый идентификатор пользователя, используемый для получения билета Kerberos. Без этого идентификатора ограниченное делегирование Kerberos невозможно и приведет к сбою.

Как упоминалось ранее, сообщения об ошибках в браузере довольно точно описывают характер проблемы. Обязательно запишите идентификатор действия и метку времени из сообщения. Эти сведения помогут связать поведение системы с фактическими событиями в журнале событий прокси Azure.

   ![Ошибка из-за неправильной конфигурации ограниченного делегирования Kerberos](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic3.png)

Соответствующие записи в журнале событий имеют номер 13019 или 12027. Журналы событий соединителя доступны в разделе **Журналы приложений и служб** &gt; **Майкрософт** &gt; **AadApplicationProxy** &gt; **Соединитель** &gt; **Администрирование**.

   ![Событие 13019 из журнала событий прокси приложения](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic4.png)

   ![Событие 12027 из журнала событий прокси приложения](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic5.png)

1.   Используйте запись **A** во внутренней DNS для адреса приложения, а не запись **CName**.

2.   Перепроверьте, что узлу соединителя предоставлены права на делегирование для имени субъекта-службы назначенной учетной записи и выбран параметр **Использовать любой протокол проверки подлинности**. Дополнительные сведения см. в [Ограниченное делегирование Kerberos для поддержки единого входа в приложения с помощью прокси приложения](manage-apps/application-proxy-configure-single-sign-on-with-kcd.md).

3.   Убедитесь, что в Azure AD есть всего один экземпляр имени субъекта-службы. Выполните команду `setspn -x` из командной строки на любом узле члена домена.

4.   Проверьте, применяется ли политика домена для ограничения [максимального размера выдаваемых маркеров Kerberos](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/). Она помешает соединителю получить маркер, если он будет признан избыточным.

После этого для более глубокого понимания проблемы можно захватить данные, которыми обмениваются узел соединителя и домен ограниченного делегирования Kerberos, с помощью сетевой трассировки. Дополнительные сведения см. в [подробном документе по устранению неполадок](https://aka.ms/proxytshootpaper).

Если билеты обрабатываются правильно, в журналах должно присутствовать событие, указывающее на сбой проверки подлинности в связи с тем, что приложение возвращает ошибку 401. Это событие означает, что целевое приложение отклоняет ваш билет. В этом случае перейдите к следующему этапу.

### <a name="target-application"></a>Целевое приложение 
Потребитель билета Kerberos, предоставляемого соединителем. На этом этапе ожидается, что соединитель отправил билет службы Kerberos в серверную часть в виде заголовка внутри первого запроса приложения.

1.   Используя определенный на портале внутренний URL-адрес приложения, убедитесь, что приложение доступно прямо из браузера на узле соединителя. После этого можно выполнить вход. Соответствующие сведения см. на странице об **устранении неполадок соединителя**.

2.   Находясь на узле соединителя, убедитесь, что проверка подлинности между браузером и приложением выполняется с использованием Kerberos. Выполните одно из следующих действий:

3.  Запустите средства разработчика (**F12**) в Internet Explorer или используйте [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) на узле соединителя. Перейдите в приложение по внутреннему URL-адресу. Проверьте предложенные заголовки авторизации WWW, возвращенные в ответе приложения, чтобы убедиться в наличии согласования или Kerberos. 

    a. Большой двоичный объект Kerberos, который затем возвращается в ответе из браузера в приложение, обычно начинается с **YII**. Это указывает на использование Kerberos. С другой стороны, встроенная проверка подлинности Windows (NTLM) всегда начинается с **TlRMTVNTUAAB**, что после расшифровки из Base64 читается как NTLM Security Support Provider (NTLMSSP). Если в начале большого двоичного объекта стоит **TlRMTVNTUAAB**, значит протокол Kerberos недоступен. Если **TlRMTVNTUAAB** стоит, он, вероятнее всего, доступен.

       > [!NOTE]
       > При использовании Fiddler такой метод потребует временно отключить расширенную защиту в конфигурации приложения в службах IIS.

       ![Окно проверки сети в браузере](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic6.png)

    Б. На изображение выше в начале большого двоичного объекта стоит не **TIRMTVNTUAAB**. Значит протокол Kerberos доступен. Этот большой двоичный объект Kerberos начинается не с **YII**.

4.  Временно удалите NTLM из списка поставщиков на сайте IIS. Обратитесь к приложению непосредственно из Internet Explorer на узле соединителя. Так как NTLM теперь отсутствует в списке поставщиков, вы сможете обратиться к приложению с помощью одного только протокола Kerberos. Если сделать это не удается, вероятно, возникла проблема с конфигурацией приложения и проверка подлинности Kerberos не работает.

    a. Если протокол Kerberos недоступен, проверьте параметры проверки подлинности приложения в службах IIS. Убедитесь, что в самом начале списка указано значение **Negotiate**, а сразу после него — NTLM. Если выбрано значение **Not Negotiate**, **Kerberos or Negotiate** или **PKU2U**, продолжайте работу, только если Kerberos работает.

       ![Поставщики проверки подлинности Windows](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic7.png)
   
    Б. Наладив работу Kerberos и NTLM, временно отключите предварительную проверку подлинности для приложения на портале. Попробуйте обратиться к приложению из Интернета по внешнему URL-адресу. Вы должны получить запрос на проверку подлинности и быть в состоянии пройти ее с помощью той же учетной записи, которая использовалась на предыдущем этапе. Если эти условия не выполняются, значит проблема связана с серверным приложением, а не с ограниченным делегированием Kerberos.

    c. Снова включите предварительную проверку подлинности на портале. Пройдите проверку подлинности в Azure, попытавшись подключиться к приложению по внешнему URL-адресу. Если произошел сбой единого входа, должно появиться сообщение о запрете доступа в браузере, а также событие 13022 в журнале:

       *Соединителю прокси приложения Microsoft AAD не удается проверить подлинность пользователя, так как внутренний сервер отвечает на попытки проверки подлинности Kerberos ошибкой HTTP 401.*

       ![Ошибка запрета доступа 401 HTTTP](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic8.png)

    d. Проверьте приложения IIS. Убедитесь, что пул приложений и имя субъекта-службы настроены для использования той же учетной записи в AD Перейдите в IIS, как показано на следующем рисунке:

       ![Окно конфигурации приложения IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic9.png)

       Зная удостоверение, убедитесь, что эта учетная запись действительно настроена с использованием соответствующего имени субъекта-службы. Например, `setspn –q http/spn.wacketywack.com`. Введите приведенную ниже команду в окне командной строки.

       ![Командное окно SetSPN](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic10.png)

    д. Проверьте имя субъекта-службы, определенное в параметрах приложения на портале. Убедитесь, что оно совпадает с именем, настроенным для целевой учетной записи AD, которая используется в пуле приложений этого приложения.

       ![Настройка имени субъекта-службы на портале Azure](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic11.png)
   
    f. Перейдите в IIS и выберите для приложения параметр **Редактор конфигураций**. Перейдите в расположение **system.webServer/security/authentication/windowsAuthentication**. Убедитесь, что для параметра **UseAppPoolCredentials** задано значение **True**.

       ![Параметр учетных данные для пулов приложений в конфигурации IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic12.png)

       Если это не так, измените значение этого параметра на **True**. Удалите все кэшированные билеты Kerberos с внутреннего сервера, выполнив следующую команду:

       ```powershell
       Get-WmiObject Win32_LogonSession | Where-Object {$_.AuthenticationPackage -ne 'NTLM'} | ForEach-Object {klist.exe purge -li ([Convert]::ToString($_.LogonId, 16))}
       ``` 

Дополнительные сведения см. в разделе [Purge the Kerberos client ticket cache for all sessions (Powershell one-liner)](https://gallery.technet.microsoft.com/scriptcenter/Purge-the-Kerberos-client-b56987bf) (Очистка клиентского кэша с билетами Kerberos для всех сеансов (с помощью Powershell)).



При включенном режиме ядра повышается производительность операций Kerberos. Однако в этом случае расшифровка билета для запрашиваемой службы выполняется с помощью учетной записи компьютера. Эта учетная запись также называется локальной системой. Установка значения **True** может нарушать работу ограниченного делегирования Kerberos, когда приложение размещается сразу на нескольких серверах фермы.

-   В качестве дополнительной проверки также отключите **расширенную** защиту. В некоторых конфигурациях **расширенная** защита нарушала работу ограниченного делегирования Kerberos. В таких случаях приложение публиковалось в качестве вложенной папки веб-сайта по умолчанию. Это приложение настроено для анонимной проверки подлинности. Все целые диалоговые окна выделяются серым. Это означает, что дочерние объекты не наследуют никакие активные параметры. Рекомендуем выполнять тестирование,когда это возможно, но затем не забудьте **включить** эту функцию.

    После этих дополнительных проверок вы можете начинать работу с опубликованным приложением. Теперь можно добавить дополнительные соединители, также настроенные для делегирования. Дополнительные сведения см. в полном техническом руководстве по [устранению неполадок с Azure AD Application Proxy](https://aka.ms/proxytshootpaper).

Если и после этого остаются неполадки, обратитесь в службу поддержки Майкрософт. Создайте запрос в службу поддержки прямо на портале. Наш инженер свяжется с вами.

## <a name="other-scenarios"></a>Другие сценарии

- Прокси приложения Azure запрашивает билет Kerberos перед отправкой запроса к приложению. Некоторые приложения сторонних разработчиков, например Tableau Server, не полностью поддерживают этот метод проверки подлинности. Они ожидают более традиционные согласования. Первый запрос выполняется анонимно, позволяя приложению отправить ответ с поддерживаемыми типами проверки подлинности через 401.

- Проверка подлинности с несколькими прыжками — обычно используется в сценариях с многоуровневым приложением, где проверка подлинности требуется как для серверной, так и для интерфейсной части (например, SQL Server Reporting Services). Сведения о настройке сценария с несколькими прыжками см. в статье [Kerberos Constrained Delegation May Require Protocol Transition in Multi-hop Scenarios](https://support.microsoft.com/help/2005838/kerberos-constrained-delegation-may-require-protocol-transition-in-mul) (Ограниченное делегирование Kerberos: изменение протокола в сценариях с несколькими прыжками).

## <a name="next-steps"></a>Дополнительная информация
[Настройка ограниченного делегирования Kerberos в управляемом домене](../active-directory-domain-services/active-directory-ds-enable-kcd.md)
