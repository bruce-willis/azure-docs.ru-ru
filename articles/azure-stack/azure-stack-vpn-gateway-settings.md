---
title: Параметры VPN-шлюза для Azure Stack | Документация Майкрософт
description: Сведения о параметрах для VPN-шлюзов, используемых с Azure Stack.
services: azure-stack
documentationcenter: ''
author: brenduns
manager: femila
editor: ''
ms.assetid: fa8d3adc-8f5a-4b4f-8227-4381cf952c56
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 08/14/2018
ms.author: brenduns
ms.openlocfilehash: e9e474fe4a32bb99673fba2a88f28a3161f23362
ms.sourcegitcommit: 744747d828e1ab937b0d6df358127fcf6965f8c8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/16/2018
ms.locfileid: "43050417"
---
# <a name="vpn-gateway-configuration-settings-for-azure-stack"></a>Параметры конфигурации VPN-шлюза для Azure Stack

*Область применения: интегрированные системы Azure Stack и Пакет средств разработки Azure Stack*

VPN-шлюз — это разновидность шлюза виртуальной сети, который передает зашифрованный трафик между виртуальной сетью в Azure Stack и удаленным VPN-шлюзом. Удаленный VPN-шлюз может быть шлюзом Azure, устройством в центре обработки данных или устройством в другом расположении.  Если есть возможность сетевого подключения между двумя конечными точками, вы можете установить между двумя сетями VPN-подключение "сеть — сеть".

Подключение VPN-шлюза зависит от конфигурации нескольких ресурсов, каждый из которых содержит настраиваемые параметры. В разделах этой статьи рассматриваются ресурсы и параметры, относящиеся к VPN-шлюзу для виртуальной сети, созданной на основе модели развертывания с помощью Resource Manager. Описания и схемы топологий для каждого варианта подключения можно найти в статье [Сведения о VPN-шлюзе для Azure Stack](azure-stack-vpn-gateway-about-vpn-gateways.md).

## <a name="vpn-gateway-settings"></a>Параметры VPN-шлюза

### <a name="gateway-types"></a>Типы шлюзов

Каждая виртуальная сеть Azure Stack поддерживает один шлюз виртуальной сети, который должен относиться к типу **VPN**,  в отличие от Azure, где поддерживаются дополнительные типы.  

При создании шлюза виртуальной сети необходимо убедиться, что в конфигурации указан правильный тип шлюза. Для VPN-шлюза требуется `-GatewayType Vpn`, например:

```PowerShell
New-AzureRmVirtualNetworkGateway -Name vnetgw1 -ResourceGroupName testrg
-Location 'West US' -IpConfigurations $gwipconfig -GatewayType Vpn
-VpnType RouteBased
```

### <a name="gateway-skus"></a>Артикулы шлюзов

Во время создания шлюза виртуальной сети нужно указать SKU шлюза, который вы хотите использовать. Выберите номера SKU, которые соответствуют требованиям, в зависимости от типов рабочих нагрузок, пропускной способности, функций и соглашений об уровне обслуживания.

Azure Stack предлагает номера SKU VPN-шлюзов, показанные в следующей таблице.

|   | Пропускная способность VPN-шлюза |Максимальное количество туннелей IPsec для VPN-шлюза |
|-------|-------|-------|
|**SKU "Базовый"**  | 100 Мбит/с  | 10    |
|**SKU "Стандартный"**           | 100 Мбит/с  | 10    |
|**SKU "Высокопроизводительный"** | 200 Мбит/с    | 5 |

### <a name="resizing-gateway-skus"></a>Изменение размеров SKU шлюза

Azure Stack не поддерживает изменение размеров SKU между поддерживаемыми прежними версиями SKU.

Аналогичным образом Azure Stack не поддерживает изменение размера SKU с поддерживаемых устаревших уровней ("Базовый", "Стандартный" и HighPerformance) на новые уровни, которые поддерживаются в Azure (VpnGw1, VpnGw2 и VpnGw3).

### <a name="configure-the-gateway-sku"></a>Настройка номера SKU шлюза

#### <a name="azure-stack-portal"></a>Портал Azure Stack

Если для создания шлюза виртуальной сети Resource Manager используется портал Azure Stack, выбрать SKU шлюза можно в раскрывающемся списке. Представленные параметры соответствуют выбранным типу шлюза и типу VPN.

#### <a name="powershell"></a>PowerShell

В следующем примере PowerShell используется параметр **-GatewaySku** со значением VpnGw1.

```PowerShell
New-AzureRmVirtualNetworkGateway -Name vnetgw1 -ResourceGroupName testrg
-Location 'West US' -IpConfigurations $gwipconfig -GatewaySku VpnGw1
-GatewayType Vpn -VpnType RouteBased
```

### <a name="connection-types"></a>Типы подключений

В модели развертывания с помощью Resource Manager каждой конфигурации необходим определенный тип подключения шлюза виртуальной сети. Для параметра **-ConnectionType** в PowerShell можно указать такие значения (развертывание Resource Manager):

* IPsec

В следующем примере PowerShell создается подключение "сеть — сеть", для которого требуется тип IPsec.

```PowerShell
New-AzureRmVirtualNetworkGatewayConnection -Name localtovon -ResourceGroupName testrg
-Location 'West US' -VirtualNetworkGateway1 $gateway1 -LocalNetworkGateway2 $local
-ConnectionType IPsec -RoutingWeight 10 -SharedKey 'abc123'
```

### <a name="vpn-types"></a>Типы VPN

При создании шлюза виртуальной сети для конфигурации VPN-шлюза необходимо указать тип VPN. Выбор типа VPN зависит от топологии подключений, которую вы хотите создать.  Тип VPN может также зависеть от используемого оборудования. Для конфигураций "сеть — сеть" требуется VPN-устройство. Некоторые VPN-устройства поддерживают только определенный тип VPN.

> [!IMPORTANT]  
> Сейчас Azure Stack поддерживает только тип VPN на основе маршрута. Если устройство поддерживает только VPN на основе политики, подключения к этим устройствам из Azure Stack не поддерживаются.  
>
> Кроме того, сейчас Azure Stack не поддерживает использование селекторов трафика на основе политик для шлюзов на основе маршрутов, так как пользовательские конфигурации политики IPSec/IKE не поддерживаются.

* **PolicyBased**. Сети VPN на основе политик шифруют и направляют пакеты через туннели IPsec на основе политик IPsec, настроенных с помощью комбинаций префиксов адресов, между локальной сетью и виртуальной сетью Azure Stack. Политика (или селектор трафика) обычно определяется как список доступа в конфигурации VPN-устройства.

  >[!NOTE]
  >PolicyBased поддерживается в Azure, но не в Azure Stack.

* **RouteBased**. Сети VPN на основе маршрутов используют маршруты, которые настроены в таблице IP-пересылки (маршрутизации) для направления пакетов в соответствующие интерфейсы туннелей. Затем интерфейсы туннелей шифруют пакеты в туннели или расшифровывают их из туннелей. Политика (или селектор трафика) для VPN типа RouteBased настроена по схеме "любой к любому" (или используют подстановочные знаки). По умолчанию их нельзя изменить. Значение для типа VPN на основе маршрутов — RouteBased.

В следующем примере PowerShell используется параметр **-VpnType** со значением RouteBased. При создании шлюза необходимо убедиться, что в конфигурации указано правильное значение **-VpnType**.

```PowerShell
New-AzureRmVirtualNetworkGateway -Name vnetgw1 -ResourceGroupName testrg
-Location 'West US' -IpConfigurations $gwipconfig
-GatewayType Vpn -VpnType RouteBased
```

### <a name="gateway-requirements"></a>Требования к шлюзу

В таблице ниже перечислены требования к VPN-шлюзам.

| |Базовый VPN-шлюз с маршрутизацией на основе политик | Базовый VPN-шлюз с маршрутизацией на основе маршрутов | Стандартный VPN-шлюз с маршрутизацией на основе маршрутов | Высокопроизводительный VPN-шлюз с маршрутизацией на основе маршрутов|
|--|--|--|--|--|
| **Подключение "сеть — сеть" (S2S)** | Не поддерживается | Конфигурация VPN на основе маршрутов | Конфигурация VPN на основе маршрутов | Конфигурация VPN на основе маршрутов |
| **метод проверки подлинности**  | Не поддерживается | Общий ключ для подключения "сеть —сеть"  | Общий ключ для подключения "сеть —сеть"  | Общий ключ для подключения "сеть —сеть"  |   
| **максимальное число подключений «сеть —сеть»**  | Не поддерживается | 10 | 10| 5|
|**активная поддержка маршрутизации (BGP)** | Не поддерживается | Не поддерживается | Поддерживаются | Поддерживаются |

### <a name="gateway-subnet"></a>Подсеть шлюза

Прежде чем создать VPN-шлюз, необходимо создать подсеть для него. Подсеть шлюза имеет IP-адреса, которые используют виртуальные машины и службы шлюза виртуальной сети. При создании шлюза виртуальной сети его виртуальные машины развертываются в подсети шлюза и на них настраиваются необходимые параметры VPN-шлюза. **Не развертывайте** в подсети шлюза что-либо еще (например, дополнительные виртуальные машины).

>[!IMPORTANT]
>Чтобы подсети шлюзов работали правильно, каждую подсеть нужно назвать **GatewaySubnet** . Azure Stack использует это имя, чтобы определить, что это подсеть для развертывания виртуальных машин и служб шлюза виртуальной сети.

При создании подсети шлюза указывается количество IP-адресов, которое содержит подсеть. IP-адреса в подсети шлюза выделяются виртуальным машинам и службам шлюза. Некоторым конфигурациям требуется больше IP-адресов, чем прочим. Просмотрите инструкции к конфигурации, которую требуется создать, и убедитесь, что создаваемая подсеть шлюза соответствует указанным требованиям.

Кроме того, следует убедиться, что подсеть шлюза содержит достаточно IP-адресов для обработки дополнительных конфигураций в будущем. Хотя можно создать подсеть шлюза всего лишь с размером /29, мы советуем создавать подсети с размером /28 или больше (/28, /27, /26 и т. д.). Таким образом, если в будущем вы добавите какие-либо функции, вам не придется разделять шлюз и удалять, а затем повторно создавать подсеть шлюза, чтобы получить больше IP-адресов.

В примере PowerShell для Resource Manager ниже показана подсеть шлюза GatewaySubnet. Здесь приведена нотация CIDR, указывающая размер /27, при котором можно использовать достаточно IP-адресов для большинства существующих конфигураций.

```PowerShell
Add-AzureRmVirtualNetworkSubnetConfig -Name 'GatewaySubnet' -AddressPrefix 10.0.3.0/27
```

> [!IMPORTANT]
> При работе с подсетями шлюза не связывайте группу безопасности сети (NSG) с подсетью шлюза. Связывание группы безопасности сети (NSG) с этой подсетью приведет к тому, что VPN-шлюз перестанет правильно функционировать. Дополнительные сведения о группах безопасности сети см. в статье [Фильтрация сетевого трафика с помощью групп безопасности сети](/azure/virtual-network/virtual-networks-nsg).

### <a name="local-network-gateways"></a>Локальные сетевые шлюзы

При создании конфигурации VPN-шлюза в Azure шлюз локальной сети нередко представляет ваше локальное расположение. В Azure Stack шлюз представляет любое удаленное VPN-устройство, находящееся за пределами Azure Stack. Это может быть VPN-устройство в вашем или удаленном центре обработки данных либо VPN-шлюз в Azure.

Для локального сетевого шлюза следует задать имя и общедоступный IP-адрес VPN-устройства, а также указать префиксы адресов, которые относятся к локальному расположению. Azure проверяет наличие сетевого трафика по префиксам адресов назначения, учитывает конфигурацию, указанную для локального сетевого шлюза, и соответствующим образом направляет пакеты.

Следующий пример PowerShell создает шлюз локальной сети:

```PowerShell
New-AzureRmLocalNetworkGateway -Name LocalSite -ResourceGroupName testrg
-Location 'West US' -GatewayIpAddress '23.99.221.164' -AddressPrefix '10.5.51.0/24'
```

Иногда возникает необходимость изменить параметры локального сетевого шлюза. Например, при добавлении или изменении диапазона адресов, либо при изменении IP-адреса VPN-устройства. См. статью [Изменение параметров шлюза локальной сети с помощью PowerShell](/azure/vpn-gateway/vpn-gateway-modify-local-network-gateway).

## <a name="ipsecike-parameters"></a>Параметры IPsec/IKE

При настройке VPN-подключения в Azure Stack подключение нужно настроить на обеих сторонах.  Возможно, при настройке VPN-подключения между Azure Stack и устройством, например коммутатором или маршрутизатором, выполняющим функции VPN-шлюза, вам потребуется настроить дополнительные параметры для устройства.

В отличие от Azure, где поддерживается несколько предложений (как инициатора, так и отвечающего устройства), Azure Stack поддерживает только одно предложение.

### <a name="ike-phase-1-main-mode-parameters"></a>Параметры этапа 1 IKE (главный режим)

| Свойство              | Значение|
|-|-|
| Версия IKE           | IKEv2 |
|Группа Диффи — Хелмана   | Группа 2 (1024 бита) |
| Метод проверки подлинности | Общий ключ |
|Алгоритмы шифрования и хэширования | AES256, SHA256 |
|Срок действия SA (время)     | 28 800 сек|

### <a name="ike-phase-2-quick-mode-parameters"></a>Параметры этапа 2 IKE (быстрый режим)

| Свойство| Значение|
|-|-|
|Версия IKE |IKEv2 |
|Алгоритмы шифрования и хэширования (шифрование)     | GCMAES256|
|Алгоритмы шифрования и хэширования (аутентификация) | GCMAES256|
|Срок действия SA (время)  | 27 000 секунд<sup>см. примечание 1</sup> |
|Срок действия SA (байты) | 33 553 408<sup>см. примечание 2</sup>     |
|Полная безопасность пересылки (PFS) |Нет<sup>см. примечание 3</sup> |
|Обнаружение неиспользуемых одноранговых узлов | Поддерживаются|  

* *Примечание 1*. До версии 1803 Azure Stack использует значение 14 400 для срока действия SA (время).
* *Примечание 2*. До версии 1803 Azure Stack использует значение 819 200 для срока действия SA (байты).
* *Примечание 3*. До версии 1807 Azure Stack использует значение PFS2048 для полной безопасности пересылки (PFS).

## <a name="next-steps"></a>Дополнительная информация

[Подключение Azure Stack к Azure с помощью Azure ExpressRoute](azure-stack-connect-expressroute.md)
