---
title: Рекомендации по оптимизации производительности SQL Server на виртуальных машинах Azure Stack
description: В этой статье приведены рекомендации по оптимизации производительности SQL Server в виртуальной машине Microsoft Azure Stack.
services: azure-stack
documentationcenter: ''
author: mattbriggs
manager: femila
editor: ''
ms.assetid: ''
ms.service: azure-stack
ms.workload: na
pms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 09/28/2018
ms.author: mabrigg
ms.reviewer: anajod
ms.openlocfilehash: e784185cfc7f2c588db354bab1cfb36934b9c417
ms.sourcegitcommit: 5843352f71f756458ba84c31f4b66b6a082e53df
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/01/2018
ms.locfileid: "47585872"
---
# <a name="optimize-sql-server-performance"></a>Оптимизация производительности SQL Server

В этой статье приведены советы по оптимизации производительности SQL Server на виртуальных машинах Microsoft Azure Stack. При выполнении SQL Server в виртуальных машинах Azure Stack используйте те же средства настройки производительности базы данных, которые применяются для SQL Server в локальной серверной среде. Производительность реляционной базы данных в облаке Azure Stack зависит от многих факторов. Эти факторы включают в себя размер семейства виртуальных машин и конфигурацию дисков с данными.

При создании образов SQL Server [рекомендуется подготовить виртуальные машины на портале Azure Stack](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-server-provision). Скачайте расширение IaaS SQL из раздела Marketplace Management (Управление Marketplace) на портале администрирования Azure Stack и необходимые виртуальные жесткие диски (VHD) виртуальной машины SQL. К ним относятся SQL2014SP2, SQL2016SP1 и SQL2017.

> [!NOTE]  
> Хотя здесь описано, как подготовить виртуальную машину SQL Server, используя глобальный портал Azure, рекомендации также применяются к Azure Stack со следующими отличиями: твердотельный накопитель недоступен для диска ОС, управляемые диски недоступны и есть небольшие отличия в конфигурации хранилища.

В рамках этой статьи рассматривается обеспечение *самой высокой* производительности для SQL Server на виртуальных машинах Azure Stack. Если рабочая нагрузка не так велика, могут потребоваться не все рекомендуемые варианты оптимизации. При оценке этих рекомендаций учитывайте актуальные потребности в производительности и характер рабочих нагрузок.

> [!NOTE]  
> Рекомендации по производительности SQL Server на виртуальных машинах Azure см. в [этой статье](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-performance).

## <a name="before-you-begin"></a>Перед началом работы
Ниже приведен контрольный список по обеспечению оптимальной производительности SQL Server на виртуальных машинах Azure Stack.


|Область|Оптимизация|
|-----|-----|
|размер виртуальной машины; |[DS3](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes) или выше для выпуска SQL Server Enterprise.<br><br>[DS2](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes) или выше для выпусков SQL Server Standard и Web.|
|Хранилище |Используйте семейство виртуальных машин, поддерживающее [хранилище класса Premium](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-acs-differences).|
|диски; |Используйте по крайней мере два диска с данными (один для файлов журнала и один для файла данных и TempDB) и выберите размер диска в соответствии с потребностями в емкости. Задайте стандартные расположения файлов данных для этих дисков во время установки SQL Server.<br><br>Избегайте использования дисков операционной системы или временных дисков для хранения базы данных или журналов.<br>Обеспечьте чередование нескольких дисков данных Azure для увеличения пропускной способности ввода-вывода, используя дисковые пространства.<br><br>Выполняйте форматирование с использованием задокументированных размеров кластеров.|
|ВВОД-ВЫВОД|Включите быструю инициализацию для файлов данных.<br><br>Ограничьте автоматическое увеличение в базах данных с фиксированным небольшим шагом приращения (64–256 МБ).<br><br>Отключите автосжатие базы данных.<br><br>Настройте расположения по умолчанию для резервного копирования и файлов базы данных на дисках с данными, а не на диске операционной системы.<br><br>Включите заблокированные страницы.<br><br>Применяйте накопительные обновления и пакеты обновления SQL Server.|
|Характерные особенности|Выполняйте резервное копирование непосредственно в хранилище BLOB-объектов (если поддерживается используемой версией SQL Server).|
|||

Дополнительные сведения о том, *как* выполнить эти оптимизации и *для чего* они необходимы, см. в подробных сведениях и руководствах, предоставленных в следующих разделах.

## <a name="virtual-machine-size-guidance"></a>Рекомендации по установке размера виртуальной машины

Для приложений, чувствительных к уровню производительности, рекомендуется использовать следующие [размеры виртуальных машин](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes):

- **Выпуск SQL Server Enterprise**: DS3 или выше.

- **Выпуски SQL Server Standard и Web**: DS2 или выше.

В Azure Stack нет никаких различий в производительности между сериями семейства виртуальных машин DS и DS_v2.

## <a name="storage-guidance"></a>Рекомендации по выбору хранилища

Виртуальные машины серии DS (включительно с серией DSv2) в Azure Stack предоставляют максимальную пропускную способность (операции ввода-вывода в секунду) диска с данными и диска операционной системы. Виртуальная машина серии DS или DSv2 предоставляет до 1000 операций ввода-вывода в секунду для диска операционной системы и до 2300 операций ввода-вывода в секунду для диска с данными, независимо от типа или размера выбранного диска.

Пропускная способность диска с данными определяется уникальным образом на основе серии семейства виртуальных машин. Вы можете [ознакомиться с этой статьей](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes), чтобы определить пропускную способность диска с данными каждой серии семейства виртуальных машин.

> [!NOTE]  
> Для производственных рабочих нагрузок выберите виртуальную машину серии DSv2 или DS с целью обеспечения максимального количества операций ввода-вывода в секунду на диске операционной системы и дисках с данными.

Так как георепликация недоступна в Azure Stack, при создании учетной записи хранилища она не оказывает никакого влияния.

## <a name="disks-guidance"></a>Рекомендации по использованию дисков

Виртуальная машина Azure Stack поддерживает три основных типа дисков:

- **Диск операционной системы**. При создании виртуальной машины Azure Stack платформа подключает к ней по крайней мере один диск (обозначенный буквой **C**), используемый в качестве диска операционной системы. Этот диск представляет собой VHD-файл, сохраненный как страничный BLOB-объект в хранилище.

- **Временный диск.** Виртуальные машины Azure Stack содержат еще один диск (обозначенный буквой **D**), который называется временным диском. Это диск на узле, который может использоваться для области временных файлов.

- **Диски данных.** К виртуальной машине можно подключить дополнительные диски с данными, которые будут сохранены в хранилище как страничные BLOB-объекты.

В следующих разделах приводятся рекомендации по использованию этих дисков.

### <a name="operating-system-disk"></a>Диск операционной системы

Диск операционной системы — это виртуальный жесткий диск, который можно установить и использовать как диск с установленной операционной системой, данный диск имеет метку **C:** .

### <a name="temporary-disk"></a>Временный диск

Диск временного хранилища с меткой **D** не сохраняется. Не храните важные данные (например, файлы пользовательской базы данных или файлы журнала транзакций пользователя) на диске **D**, так как они могут быть утеряны.

TempDB рекомендуется хранить на диске с данными, так как каждый диск с данными обеспечивает более 2300 операций ввода-вывода в секунду.

### <a name="data-disks"></a>Диски данных

- **Храните файлы данных и журналов на дисках с данными.** Если вы не применяете чередование дисков, используйте два диска с данными из виртуальной машины, поддерживающей хранилище класса Premium, где один диск содержит файлы журнала, а другой — файлы данных и TempDB. Каждый диск с данными обеспечивает число операций ввода-вывода в секунду и пропускную способность (МБ/с) в зависимости от семейства виртуальных машин, как описано в статье [Поддерживаемые размеры виртуальных машин в Azure Stack](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes). При использовании чередования дисков, например в службе дисковых пространств, рекомендуется размещать файлы журналов и данных на одном диске (включая TempDB). Эта конфигурация предоставляет максимальное количество операций ввода-вывода в секунду, доступных для использования в SQL Server, независимо от файла, для которого это необходимо в определенный момент.

> [!NOTE]  
> При подготовке виртуальной машины SQL Server на портале у вас есть возможность изменить конфигурацию хранилища. В зависимости от конфигурации Azure Stack настраивает один или несколько дисков. Несколько дисков объединяются в единый пул хранилищ. Файлы данных и журналов совместно размещаются в этой конфигурации.

- **Чередование дисков.** Для повышения пропускной способности можно добавить дополнительные диски с данными и использовать чередование дисков. Чтобы определить количество дисков с данными, необходимо проанализировать количество операций ввода-вывода в секунду и пропускную способность, необходимые для файлов журналов, файлов данных и TempDB. Обратите внимание, что ограничения на операции ввода-вывода в секунду устанавливаются для каждого диска данных на основе серии виртуальных машин, а не в зависимости от их размера. Однако ограничения пропускной способности сети устанавливаются на основе размера виртуальной машины. Дополнительные сведения см. в таблицах в статье [Поддерживаемые размеры виртуальных машин в Azure Stack](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes). Придерживайтесь приведенных ниже рекомендаций.

    - Для Windows Server 2012 или более поздней версии используйте [дисковые пространства](https://technet.microsoft.com/library/hh831739.aspx), придерживаясь приведенных ниже рекомендаций.

        1.  Задайте чередование (размер блока чередования) в 64 КБ (65 536 байт) для рабочих нагрузок OLTP и 256 КБ (262 144 байт) для рабочих нагрузок хранилища данных, чтобы избежать снижения производительности из-за рассогласования разделов. Это следует сделать в PowerShell.

        2.  Задайте число столбцов равным количеству физических дисков. Используйте PowerShell (не пользовательский интерфейс диспетчера сервера) при настройке более восьми дисков.

            Например, следующая команда PowerShell создает пул хранилища с установленным размером чередования 64 КБ и числом столбцов, равным 2:

          ```PowerShell  
          $PoolCount = Get-PhysicalDisk -CanPool $True
          $PhysicalDisks = Get-PhysicalDisk | Where-Object {$_.FriendlyName -like "*2" -or $_.FriendlyName -like "*3"}

          New-StoragePool -FriendlyName "DataFiles" -StorageSubsystemFriendlyName "Storage Spaces*" -PhysicalDisks $PhysicalDisks | New-VirtualDisk -FriendlyName "DataFiles" -Interleave 65536 -NumberOfColumns 2 -ResiliencySettingName simple –UseMaximumSize |Initialize-Disk -PartitionStyle GPT -PassThru |New-Partition -AssignDriveLetter -UseMaximumSize |Format-Volume -FileSystem NTFS -NewFileSystemLabel "DataDisks" -AllocationUnitSize 65536 -Confirm:$false
          ```

- Определите число дисков, связанных с пулом хранилищ, на основании ожидаемой нагрузки. Помните, что в разных размерах виртуальной машины можно подключать различное количество дисков с данными. Дополнительные сведения см. в статье [Поддерживаемые размеры виртуальных машин в Azure Stack](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes).
- Чтобы обеспечить максимальное количество операций ввода-вывода в секунду для дисков с данными, рекомендуется добавить максимальное количество дисков с данными, поддерживаемое для данного [размера виртуальной машины](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes), и использовать чередование дисков.
- **Размер единицы размещения NTFS.** При форматировании диска с данными рекомендуется использовать размер единицы размещения 64 КБ для файлов данных и журналов, а также TempDB.
- **Рекомендации по управлению дисками.** При удалении диска с данными остановите службу SQL Server. Кроме того, не меняйте параметры кэша на дисках, так как это никак не влияет на улучшение производительности.

> [!WARNING]  
> Если не останавливать службы SQL на время таких операций, это может привести к повреждению базы данных.

## <a name="io-guidance"></a>Рекомендации по использованию операций ввода-вывода

- Рекомендуется включить быструю инициализацию файлов для сокращения времени, необходимого для начального выделения файлов. Чтобы воспользоваться преимуществами быстрой инициализации файлов, назначьте **SE_MANAGE_VOLUME_NAME** учетной записи службы SQL Server (MSSQLSERVER) и добавьте ее в политику безопасности **Выполнение задач по обслуживанию томов**. Если вы используете образ платформы SQL Server для Azure, то учетная запись службы по умолчанию (**NT Service\MSSQLSERVER**) не добавляется в политику безопасности **Выполнение задач по обслуживанию томов**. Другими словами, быстрая инициализация файлов в образе платформы SQL Server Azure не включена. После добавления учетной записи службы SQL Server в политику безопасности **Выполнение задач по обслуживанию томов** перезапустите службу SQL Server. Использование этой функции может быть показано из соображений безопасности. Дополнительные сведения см. в статье [Мгновенная инициализация файлов базы данных](https://msdn.microsoft.com/library/ms175935.aspx).
- **Автоматическое расширение** используется в случае непредвиденного роста. Не используйте авторасширение для повседневного управления ростом данных и журналов. При использовании автоматического расширения предварительно увеличьте размер файла с помощью параметра **Размер**.
- Убедитесь, что **автосжатие** отключено, чтобы избежать ненужных затрат ресурсов, что может отрицательно повлиять на производительность.
- Настройка расположений по умолчанию для файлов резервных копий и базы данных. Следуйте рекомендациям в этой статье и внесите изменения в окне свойств сервера. Инструкции см. в статье [Просмотр или изменение расположения по умолчанию для файлов данных и журнала (среда SQL Server Management Studio)](https://msdn.microsoft.com/library/dd206993.aspx). На следующем снимке экрана показано, где нужно внести необходимые изменения.

    > ![Просмотр или изменение расположений по умолчанию](./media/sql-server-vm-considerations/image1.png)

- Включение блокировки страниц для сокращения числа операций ввода-вывода, а также операций разбиения по страницам. Дополнительные сведения см. в статье [Включение параметра «Блокировка страниц в памяти» (Windows)](https://msdn.microsoft.com/library/ms190730.aspx).

- Рекомендуется сжимать файлы данных при их передаче в среду Azure Stack и из нее, включая файлы резервного копирования.

## <a name="feature-specific-guidance"></a>Обзор конкретных функций

Для некоторых развертываний получить дополнительные преимущества, используя более сложные методики настройки. В следующем списке перечислены некоторые функции SQL Server, которые могут помочь добиться лучшей производительности:

- **Создание резервной копии** **в хранилище Azure**. При выполнении резервного копирования данных SQL Server, запущенного на виртуальных машинах Azure Stack, можно использовать резервное копирование SQL Server на URL-адрес. Эта функция доступна, начиная с накопительного пакета обновления 2 для пакета обновления 1 SQL Server 2012, и рекомендуется к применению при архивации на подключенные диски данных.

    При выполнении резервного копирования или восстановления с использованием службы хранилища Azure следуйте рекомендациям из статьи [Резервное копирование SQL Server на URL-адрес — рекомендации и устранение неполадок](https://msdn.microsoft.com/library/jj919149.aspx) и [Восстановление из резервных копий в Microsoft Azure](https://docs.microsoft.com/sql/relational-databases/backup-restore/restoring-from-backups-stored-in-microsoft-azure?view=sql-server-2017). Кроме того, можно автоматизировать эти процессы архивации с помощью [автоматической архивации SQL Server на виртуальных машинах Azure](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-automated-backup).

-   **Резервное копирование в хранилище Azure Stack.** Вы можете выполнять резервное копирование в хранилище Azure Stack таким же образом, как и в службу хранилища Azure. При создании резервной копии в SQL Server Management Studio (SSMS) необходимо вручную ввести сведения о конфигурации. SSMS нельзя использовать для создания контейнера хранилища или подписанного URL-адреса. SSMS позволяет подключаться только к подпискам Azure, а не Azure Stack. Вместо этого необходимо создать учетную запись хранения, контейнер и подписанный URL-адрес на портале Azure Stack или с помощью PowerShell.

    При введении данных в диалоговое окно резервного копирования SQL Server:

    ![Резервное копирование SQL Server](./media/sql-server-vm-considerations/image3.png)

    > [!NOTE]  
    > Подписанный URL-адрес — это токен SAS на портале Azure Stack без начального знака "?" в строке. Если вы используете функцию копирования с портала, вам необходимо удалить начальный знак "?", чтобы токен работал в SQL Server.

    После указания и настройки назначения резервного копирования в SQL Server можно осуществлять резервное копирование в хранилище BLOB-объектов Azure Stack.

## <a name="next-steps"></a>Дополнительная информация

[Важные аспекты использования служб и создания приложений в Azure Stack](azure-stack-considerations.md)