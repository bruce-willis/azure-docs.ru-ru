---
title: Создание рабочих процессов для обработки электронных писем и вложений в Azure Logic Apps | Документация Майкрософт
description: В этом руководстве показано, как создавать автоматизированные рабочие процессы для обработки электронных писем и вложений в Azure Logic Apps, службе хранилища Azure и "Функции Azure"
services: logic-apps
ms.service: logic-apps
author: ecfan
ms.author: estfan
manager: jeconnoc
ms.topic: tutorial
ms.custom: mvc
ms.date: 07/20/2018
ms.reviewer: klam, LADocs
ms.openlocfilehash: 133cc9d8fa52bb655e9baaad53ee157fdc7524f7
ms.sourcegitcommit: 1d850f6cae47261eacdb7604a9f17edc6626ae4b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/02/2018
ms.locfileid: "39429426"
---
# <a name="process-emails-and-attachments-with-azure-logic-apps"></a>Обработка сообщений электронной почты и вложений с помощью Azure Logic Apps

Azure Logic Apps дает возможность автоматизировать рабочие процессы и интегрировать данные в различные службы Azure, Майкрософт, локальные системы и другие приложения SaaS (программное обеспечение как услуга). В этом руководстве показано, как создать [приложение логики](../logic-apps/logic-apps-overview.md), которое обрабатывает входящие электронные письма и вложения. Это логическое приложение обрабатывает это содержимое, сохраняет его в хранилище Azure и отправляет уведомления для просмотра этого содержимого. 

Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Настройка [хранилища Azure](../storage/common/storage-introduction.md) и Обозревателя службы хранилища для проверки сохраненных электронных писем и вложений.
> * Создание [функции Azure](../azure-functions/functions-overview.md), которая удаляет HTML из электронных писем. В этом руководстве содержится код, который можно использовать для этой функции.
> * Создание пустого приложения логики.
> * Добавление триггера, который отслеживает сообщения электронной почты для вложений.
> * Добавление условия, которое проверяет наличие вложений в сообщениях электронной почты.
> * Добавление действия, которое вызывает функцию Azure при наличии вложения в сообщении электронной почты.
> * Добавление действия, которое создает хранилище BLOB-объектов для сообщения электронной почты и вложений.
> * Добавление действия, которое отправляет электронные уведомления.

По завершении приложение логики будет выглядеть как этот высокоуровневый рабочий процесс:

![Высокоуровневое готовое приложение логики](./media/tutorial-process-email-attachments-workflow/overview.png)

Если у вас еще нет подписки Azure, <a href="https://azure.microsoft.com/free/" target="_blank">подпишитесь для получения бесплатной учетной записи</a> Azure, прежде чем начинать работу. 

## <a name="prerequisites"></a>Предварительные требования

* Учетная запись электронной почты поставщика услуг электронной почты, поддерживаемого Logic Apps, например Office 365 Outlook, Outlook.com или Gmail. Сведения о дополнительных поставщиках см. в [списке соединителей](https://docs.microsoft.com/connectors/).

  Это приложение логики использует учетную запись Office 365 Outlook. 
  Если используется другая учетная запись электронной почты, общие шаги остаются неизменными, однако интерфейс может выглядеть несколько иначе.

* Скачайте и установите <a href="https://storageexplorer.com/" target="_blank">бесплатный Обозреватель хранилищ Microsoft Azure</a>. Это средство помогает проверить, правильно ли настроен контейнер хранилища.

## <a name="sign-in-to-azure-portal"></a>Вход на портал Azure

Войдите на <a href="https://portal.azure.com" target="_blank">портал Azure</a> с помощью учетных данных учетной записи Azure.

## <a name="set-up-storage-to-save-attachments"></a>Настройка хранилища для сохранения вложений

Входящие сообщения электронной почты и вложения можно сохранить в виде больших двоичных объектов в [контейнере хранилища Azure](../storage/common/storage-introduction.md). 

1. Прежде чем создать контейнер хранилища, [создайте учетную запись хранения](../storage/common/storage-create-storage-account.md#create-a-storage-account) с такими параметрами:

   | Параметр | Значение | ОПИСАНИЕ | 
   |---------|-------|-------------| 
   | **Имя** | attachmentstorageacct | Имя вашей учетной записи | 
   | **Модель развертывания** | Диспетчер ресурсов | [Модель развертывания](../azure-resource-manager/resource-manager-deployment-model.md) для управления развертыванием ресурсов | 
   | **Account kind** (Тип учетной записи) | Универсальные | [Тип учетной записи хранения](../storage/common/storage-introduction.md#types-of-storage-accounts) | 
   | **Местоположение.** | Запад США | Регион для хранения сведений об учетной записи хранения. | 
   | **Репликация** | Локально избыточное хранилище (LRS) | Этот параметр указывает, как копируются, хранятся, управляются и синхронизируются данные. См. раздел [Репликация](../storage/common/storage-introduction.md#replication). | 
   | **Производительность** | Стандартная | Этот параметр определяет поддерживаемые типы данных и носители для хранения данных. См. раздел [Типы учетных записей хранения](../storage/common/storage-introduction.md#types-of-storage-accounts). | 
   | **Secure transfer required** (Требуется безопасное перемещение) | Отключено | Этот параметр указывает параметры безопасности, требуемые для запросов подключений. См. статью [Require secure transfer in Azure Storage](../storage/common/storage-require-secure-transfer.md) (Требование безопасной передачи в службе хранилища Azure). | 
   | **Подписка** | <*Имя вашей подписки Azure*> | Имя подписки Azure. | 
   | **Группа ресурсов** | LA-Tutorial-RG | Имя [группы ресурсов Azure](../azure-resource-manager/resource-group-overview.md), используемой для упорядочения связанных ресурсов и управления ими. <p>**Примечание.** Группа ресурсов существует в определенном регионе. Хотя элементы из этого руководства могут быть недоступны во всех регионах, попробуйте по возможности использовать тот же регион. | 
   | **Настройка виртуальных сетей** | Отключено | В рамках этого руководства используйте параметр **Отключено**. | 
   |||| 

   Учетную запись хранения также можно создать с помощью [Azure PowerShell](../storage/common/storage-quickstart-create-storage-account-powershell.md) или [Azure CLI](../storage/common/storage-quickstart-create-storage-account-cli.md).

2. После развертывания учетной записи хранения в Azure получите ключ доступа к ней:

   1. В меню учетной записи хранения в разделе **Параметры** выберите **Ключи доступа**. 

   2. Скопируйте имя учетной записи хранения и ключ **key1**, а затем сохраните эти значения в безопасном месте.

      ![Копирование имени и ключа учетной записи хранения](./media/tutorial-process-email-attachments-workflow/copy-save-storage-name-key.png)

   Получить ключ доступа к учетной записи хранения также можно с помощью [Azure PowerShell](https://docs.microsoft.com/powershell/module/azurerm.storage/get-azurermstorageaccountkey) или [Azure CLI](https://docs.microsoft.com/cli/azure/storage/account/keys?view=azure-cli-latest.md#az-storage-account-keys-list). 

3. Создайте контейнер хранилища BLOB-объектов для вложений электронной почты.
   
   1. В меню учетной записи хранения выберите **Обзор**. 
   В разделе **Службы** выберите **Большие двоичные объекты**.

      ![Добавление контейнера хранилища BLOB-объектов](./media/tutorial-process-email-attachments-workflow/create-storage-container.png)

   2. После того, как откроется страница **Контейнеры**, на панели инструментов выберите **Контейнер**. 

   3. В разделе **Создание контейнера** введите attachments в качестве имени контейнера. 
   В разделе **Общедоступный уровень доступа** выберите **Container (anonymous read access for containers and blobs)** (Контейнер (анонимный доступ на чтение к контейнерам и большим двоичным объектам)), а затем щелкните **ОК**.

      После завершения можно найти контейнер хранилища в учетной записи на портале Azure:

      ![Созданный контейнер хранилища Azure](./media/tutorial-process-email-attachments-workflow/created-storage-container.png)

   Контейнер хранилища также можно создать с помощью [Azure PowerShell](https://docs.microsoft.com/powershell/module/azure.storage/new-azurestoragecontainer) или [Azure CLI](https://docs.microsoft.com/cli/azure/storage/container?view=azure-cli-latest#az-storage-container-create). 

Подключите Обозреватель службы хранилища к учетной записи.

## <a name="set-up-storage-explorer"></a>Настройка Обозревателя службы хранилища

Теперь подключите Обозреватель службы хранилища к учетной записи хранения, чтобы убедиться, что ваше приложение логики правильно сохраняет вложения как большие двоичные объекты в контейнере хранилища.

1. Откройте Обозреватель службы хранилищ Microsoft Azure. 

   Обозреватель службы хранилища запросит подключение к вашей учетной записи хранения. 

2. В области **Connect to Azure Storage** (Подключение к службе хранилища Azure) выберите **Use a storage account name and key** (Использовать имя и ключ учетной записи хранения) и нажмите кнопку **Далее**. 

   ![Обозреватель службы хранилища Azure: подключение к учетной записи хранения](./media/tutorial-process-email-attachments-workflow/storage-explorer-choose-storage-account.png)

   > [!TIP]
   > Если запрос не отображается, выберите **Добавить учетную запись** на панели инструментов Обозревателя службы хранилища.

3. В разделе **Имя учетной записи** укажите имя своей учетной записи хранения. В разделе **Ключ учетной записи** укажите ключ доступа, сохраненный ранее. Щелкните **Далее**.

4. Подтвердите сведения о подключении, а затем выберите **Подключить**. 

   Обозреватель службы хранилища создает подключение. Ваша учетная запись хранения отображается в окне Обозревателя в разделе **(Local and Attached)** (Локальные и присоединенные) >**Учетные записи хранения**. 

5. Чтобы найти свой контейнер хранилища BLOB-объектов, в разделе **Учетные записи хранения** разверните свою учетную запись хранения **attachmentstorageacct**, а затем разверните **Blob Containers** (Контейнеры больших двоичных объектов), в которых находится контейнер **attachments**, например: 

   ![Обозреватель службы хранилища: поиск контейнера хранилища](./media/tutorial-process-email-attachments-workflow/storage-explorer-check-contianer.png)

Создайте [функцию Azure](../azure-functions/functions-overview.md), которая удаляет HTML из входящей электронной почты.

## <a name="create-function-to-clean-html"></a>Создание функции для очистки HTML

Теперь используйте фрагмент кода, предоставленный в руководстве, для создания функции Azure, которая удаляет HTML из каждого входящего сообщения электронной почты. Таким образом, содержимое электронной почты становится более простым в обработке. Затем можно вызвать эту функцию с помощью приложения логики.

1. Перед созданием функции [создайте приложение-функцию](../azure-functions/functions-create-function-app-portal.md) с такими параметрами:

   | Параметр | Значение | ОПИСАНИЕ | 
   | ------- | ----- | ----------- | 
   | **Имя приложения** | CleanTextFunctionApp | Глобально уникальное и описательное имя для вашего приложения функции | 
   | **Подписка** | <*Имя вашей подписки Azure*> | Та же подписка Azure, которая использовалась ранее | 
   | **Группа ресурсов** | LA-Tutorial-RG | Та же группа ресурсов Azure, которая использовалась ранее | 
   | **План размещения** | План потребления | Этот параметр определяет способ распределения и масштабирования ресурсов, например вычислительной мощности, для выполнения приложения-функции. См. статью [Масштабирование и размещение Функций Azure](../azure-functions/functions-scale.md). | 
   | **Местоположение.** | Запад США | Регион, использованный ранее | 
   | **Хранилище** | cleantextfunctionstorageacct | Создайте учетную запись хранения для приложения-функции. Вы можете использовать только строчные буквы и цифры. <p>**Примечание.** Эта учетная запись хранения содержит приложения-функции и отличается от ранее созданной учетной записи хранения для вложений электронной почты. | 
   | **Application Insights** | Отключить | Включает мониторинг приложения с помощью [Application Insights](../application-insights/app-insights-overview.md). В рамках этого руководства выберите параметр **Отключить**. | 
   |||| 

   Если приложение-функция не открывается автоматически после развертывания, найдите приложение на <a href="https://portal.azure.com" target="_blank">портале Azure</a>. В главном меню Azure выберите **Приложения-функции** и выберите приложение-функцию. 

   ![Выбор приложения-функции](./media/tutorial-process-email-attachments-workflow/select-function-app.png)

   Если раздел **Приложения-функции** не отображается в меню Azure, перейдите в раздел **Все службы**. В поле поиска найдите и выберите **Приложение-функция**. Дополнительные сведения см. в статье [Создание первой функции на портале Azure](../azure-functions/functions-create-first-azure-function.md).

   В противном случае Azure автоматически откроет приложение-функцию, как показано ниже:

   ![Созданное приложение-функция](./media/tutorial-process-email-attachments-workflow/function-app-created.png)

   Приложение-функцию можно также создать с помощью [Azure CLI](../azure-functions/functions-create-first-azure-function-azure-cli.md) или [шаблонов PowerShell и Resource Manager](../azure-resource-manager/resource-group-template-deploy.md).

2. В разделе **Приложения-функции** разверните **CleanTextFunctionApp** и выберите **Функции**. На панели инструментов функций выберите **Новая функция**.

   ![Создание функции](./media/tutorial-process-email-attachments-workflow/function-app-new-function.png)

3. В разделе **Choose a template below or go to the quickstart** (Выберите шаблон ниже или перейдите к краткому руководству) откройте список **Сценарий** и выберите **Ядро**. В шаблоне **Триггер HTTP** выберите **C#**.

   ![Выбор шаблона функции](./media/tutorial-process-email-attachments-workflow/function-select-httptrigger-csharp-function-template.png)

   > [!NOTE]
   > В этом образце приведен пример кода C#, поэтому вы можете следовать примеру без знания C#.

4. В области **Новая функция** в разделе **Имя** введите ```RemoveHTMLFunction```. В разделе **Уровень авторизации** оставьте значение **Функция** и выберите **Создать**.

   ![Имя функции](./media/tutorial-process-email-attachments-workflow/function-provide-name.png)

5. После того как редактор откроется, замените код шаблона на этот код, который удаляет HTML и возвращает результаты вызывающему объекту:

   ``` CSharp
   using System.Net;
   using System.Text.RegularExpressions;

   public static async Task<HttpResponseMessage> Run(HttpRequestMessage req, TraceWriter log)
   {
      log.Info($"HttpWebhook triggered");

      // Parse query parameter
      string emailBodyContent = await req.Content.ReadAsStringAsync();

      // Replace HTML with other characters
      string updatedBody = Regex.Replace(emailBodyContent, "<.*?>", string.Empty);
      updatedBody = updatedBody.Replace("\\r\\n", " ");
      updatedBody = updatedBody.Replace(@"&nbsp;", " ");

      // Return cleaned text
      return req.CreateResponse(HttpStatusCode.OK, new { updatedBody });
   }
   ```

6. Когда все будет готово, нажмите **Сохранить**. Чтобы проверить функцию, выберите **Тестирование** под значком стрелки (**<**) на правой границе редактора. 

   ![Открытая область "Тестирование"](./media/tutorial-process-email-attachments-workflow/function-choose-test.png)

7. В области **Тестирование** в разделе **Текст запроса** введите следующую строку и выберите **Запуск**.

   ```json
   {"name": "<p><p>Testing my function</br></p></p>"}
   ```

   ![Тестирование функции](./media/tutorial-process-email-attachments-workflow/function-run-test.png)

   В окне **Выходные данные** отображается результат, возвращаемый функцией:

   ```json
   {"updatedBody":"{\"name\": \"Testing my function\"}"}
   ```

После проверки работоспособности функции создайте приложение логики. Хотя в этом руководстве рассказывается, как создать функцию, которая удаляет HTML из сообщений электронной почты, в Logic Apps также имеется соединитель, преобразующий **HTML в текст**.

## <a name="create-your-logic-app"></a>Создание приложения логики

1. В главном меню на портале Azure последовательно выберите **Создать ресурс** > 
**Интеграция** > **Приложение логики**.

   ![Создание приложения логики](./media/tutorial-process-email-attachments-workflow/create-logic-app.png)

2. В разделе **Создание приложения логики** предоставьте сведения о приложении логики, как показано и описано. По завершении выберите **Закрепить на панели мониторинга** > **Создать**.

   ![Предоставление сведений о приложении логики](./media/tutorial-process-email-attachments-workflow/create-logic-app-settings.png)

   | Параметр | Значение | ОПИСАНИЕ | 
   | ------- | ----- | ----------- | 
   | **Имя** | LA-ProcessAttachment | Имя приложения логики. | 
   | **Подписка** | <*Имя вашей подписки Azure*> | Та же подписка Azure, которая использовалась ранее | 
   | **Группа ресурсов** | LA-Tutorial-RG | Та же группа ресурсов Azure, которая использовалась ранее |
   | **Местоположение.** | Запад США | Регион, использованный ранее | 
   | **Служба Log Analytics** | Отключить | В рамках этого руководства выберите параметр **Отключено**. | 
   |||| 

3. После развертывания приложения логики в Azure откроется конструктор Logic Apps и появится страница с вводным видео и шаблонами распространенных приложений логики. В разделе **Шаблоны** выберите **Пустое приложение логики**.

   ![Выбор шаблона пустого приложения логики](./media/tutorial-process-email-attachments-workflow/choose-logic-app-template.png)

Затем добавьте [триггер](../logic-apps/logic-apps-overview.md#logic-app-concepts), который ожидает передачи входящих сообщений электронной почты с вложениями. Каждое приложение логики должно запускаться по триггеру, который активируется, когда происходит определенное событие или если новые данные соответствуют заданным условиям. Дополнительные сведения см. в статье о [создании первого приложения логики](../logic-apps/quickstart-create-first-logic-app-workflow.md).

## <a name="monitor-incoming-email"></a>Мониторинг входящей электронной почты

1. В конструкторе в поле поиска в качестве фильтра введите: "Когда приходит электронное письмо". Выберите триггер для своего поставщика услуг электронной почты: **Когда приходит новое электронное письмо — <*ваш поставщик услуг электронной почты*>**.

   Например: 

   ![Выбор триггера для поставщика услуг электронной почты: "Когда приходит новое электронное письмо"](./media/tutorial-process-email-attachments-workflow/add-trigger-when-email-arrives.png)

   * Для рабочих или учебных учетных записей Azure выберите Office 365 Outlook. 
   * Для личных учетных записей Майкрософт выберите Outlook.com. 

2. При появлении запроса учетных данных войдите в свою учетную запись электронной почты для подключения к этой учетной записи в Logic Apps.

3. Теперь укажите критерии, используемые триггером для фильтрации новых сообщений электронной почты.

   1. Укажите папку, интервал и частоту проверки сообщений почты.

      ![Указание папки, интервала и частоты проверки сообщений почты](./media/tutorial-process-email-attachments-workflow/set-up-email-trigger.png)

      | Параметр | Значение | ОПИСАНИЕ | 
      | ------- | ----- | ----------- | 
      | **Папка** | Папка "Входящие" | Папка электронной почты для мониторинга | 
      | **Интервал** | 1 | Количество интервалов ожидания между проверками. | 
      | **Frequency** | Минута | Единица измерения времени для каждого интервала между проверками | 
      |  |  |  | 
  
   2. Выберите **Показать дополнительные параметры** и укажите следующие параметры:

      | Параметр | Значение | ОПИСАНИЕ | 
      | ------- | ----- | ----------- | 
      | **Has Attachment** (С вложением) | Yes | Получать только письма с вложениями. <p>**Примечание.** Триггер не удаляет любые электронные письма из вашей учетной записи, проверяя только новые сообщения и обрабатывая только те электронные письма, которые соответствуют фильтру темы. | 
      | **Включить вложения** | Yes | Получать вложения в качестве входных данных для рабочего процесса, а не просто проверять вложения. | 
      | **Фильтр темы** | ```Business Analyst 2 #423501``` | Текст для поиска в темах сообщений | 
      |  |  |  | 

4. Чтобы скрыть сведения о триггере, щелкните внутри заголовка окна триггера.

   ![Свертывание фигуры, чтобы скрыть сведения](./media/tutorial-process-email-attachments-workflow/collapse-trigger-shape.png)

5. Сохраните приложение логики. На панели инструментов конструктора нажмите кнопку **Сохранить**.

   Теперь приложение логики активно, но оно только проверяет электронную почту. 
   Затем добавьте условие, которое указывает критерии для продолжения рабочего процесса.

## <a name="check-for-attachments"></a>Проверка вложений

Теперь добавьте условие, которое выбирает только письма с вложениями.

1. В разделе триггера выберите **Новый шаг** > **Добавить условие**.

   !["Новый шаг", "Добавить условие"](./media/tutorial-process-email-attachments-workflow/add-condition-under-trigger.png)

2. Переименуйте условие, чтобы оно содержало более понятное описание.

   1. В строке заголовка условия нажмите кнопку **многоточия** (**...**) и выберите **Переименовать**.

      ![Переименование условия](./media/tutorial-process-email-attachments-workflow/condition-rename.png)

   2. Переименуйте условие, используя описание: ```If email has attachments and key subject phrase```.

3. Создайте условие, которое проверяет наличие сообщений электронной почты с вложениями. 

   1. В первой строке в разделе **И** щелкните поле слева. 
   В появившемся списке динамического содержимого выберите свойство **С вложением**.

      ![Добавление условия](./media/tutorial-process-email-attachments-workflow/build-condition.png)

   2. В среднем поле укажите для оператора значение **равно**.

   3. В поле справа введите **True** в качестве значения для сравнения со значением свойства **С вложением**, указанного для триггера.

      ![Добавление условия](./media/tutorial-process-email-attachments-workflow/finished-condition.png)

      Если оба значения равны, сообщение имеет по крайней мере одно вложение, передается условие и рабочий процесс продолжает работу.

   В базовом определении приложения логики, которое вы можете просмотреть в окне редактора кода, это условие выглядит следующим образом:

   ```json
   "Condition": {
      "actions": { <actions-to-run-when-condition-passes> },
      "expression": {
         "and": [ {
            "equals": [
               "@triggerBody()?['HasAttachment']",
                 "True"
            ]
         } ]
      },
      "runAfter": {},
      "type": "If"
   }
   ```

4. Сохраните приложение логики. На панели инструментов конструктора нажмите кнопку **Сохранить**.

### <a name="test-your-condition"></a>Проверка условия

Теперь проверьте правильность работы условия:

1. Если приложение логики еще не запущено, выберите **Запуск** на панели инструментов конструктора.

   На этом шаге приложение логики запускается вручную без необходимости ожидания указанного интервала времени. 
   Тем не менее ничего не произойдет, пока не поступит тестовое сообщение электронной почты в папку "Входящие". 

2. Отправьте электронное сообщение, которое соответствует этому критерию:

   * Тема электронного сообщения содержит текст, который указан в триггере **субъекта фильтра**: ```Business Analyst 2 #423501```

   * Сообщение электронной почты имеет одно вложение. 
   Теперь создайте один пустой текстовый файл и вложите его в электронное сообщение.

   Когда приходит сообщение электронной почты, приложение логики проверяет вложения и указанный текст темы.
   Если условие выполняется успешно, срабатывает триггер и обработчик Logic Apps создает экземпляр приложения логики и запускает рабочий процесс. 

3. Чтобы убедиться, что триггер сработал и приложение логики удачно запустилось, в меню приложения логики выберите **Обзор**.

   ![Проверка триггера и журнал запусков](./media/tutorial-process-email-attachments-workflow/checkpoint-run-history.png)

   Если приложение логики не запускается несмотря на срабатывание триггера, см. статью [Диагностика и устранение сбоев приложений логики](../logic-apps/logic-apps-diagnosing-failures.md).

Определите действия, выполняемые в ветви **Если истинно**. Чтобы сохранить сообщение электронной почты и вложения, удалите любой HTML из текста электронной почты, затем создайте большие двоичные объекты в контейнере для хранения электронной почты и вложений.

> [!NOTE]
> Приложение логики не должно выполнять никаких действий в ветви **Если ложно**, если сообщение электронной почты не имеет вложения. В качестве дополнительного упражнения после завершения работы с этим руководством вы можете добавить любое подходящее действие, которое вы хотите выполнить для ветви **Если ложно**.

## <a name="call-removehtmlfunction"></a>Вызов RemoveHTMLFunction

На этом шаге вы добавите ранее созданную функцию Azure в приложение логики и отправите содержимое электронного письма из триггера электронной почты в функцию.

1. В меню приложения логики выберите **Конструктор приложений логики**. Внутри ветви **Если истинно** выберите **Добавить действие**.

   ![Добавление действия внутри ветви "Если истинно"](./media/tutorial-process-email-attachments-workflow/if-true-add-action.png)

2. В поле поиска введите azure functions и выберите действие: **Выберите функцию Azure — Функции Azure**.

   ![Выбор действия "Выберите функцию Azure"](./media/tutorial-process-email-attachments-workflow/add-action-azure-function.png)

3. Выберите ранее созданное приложение-функцию **CleanTextFunctionApp**.

   ![Выбор приложения-функции Azure](./media/tutorial-process-email-attachments-workflow/add-action-select-azure-function-app.png)

4. Теперь выберите функцию **RemoveHTMLFunction**.

   ![Выбор функции Azure](./media/tutorial-process-email-attachments-workflow/add-action-select-azure-function.png)

5. Переименуйте фигуру функции с использованием этого описания: ```Call RemoveHTMLFunction to clean email body```.

6. Теперь укажите входные данные для обработки с помощью функции. 

   1. В разделе **Текст запроса** введите этот текст с пробелом в конце: 
   
      ```{ "emailBody": ``` 

      Пока вы будете работать с этими входными данными на следующих шагах, будет отображаться сообщение об ошибке о недопустимом формате JSON.
      При тестировании этой функции ранее входные данные, указанные для данной функции, использовали JavaScript Object Notation (JSON). 
      Таким образом, текст запроса должен использовать тот же формат.

      Кроме того, когда ваш курсор находится внутри поля **Текст запроса**, появляется список динамического содержимого, поэтому вы можете выбрать значения свойств, доступные из предыдущих действий. 
      
   2. Из списка динамического содержимого в разделе **Когда приходит новое электронное письмо** выберите свойство **Текст**. После этого свойства добавьте закрывающую фигурную скобку: ```}```

      ![Указание текста запроса для функции](./media/tutorial-process-email-attachments-workflow/add-email-body-for-function-processing.png)

   В итоге входные данные функции должны выглядеть приблизительно так, как показано в примере ниже:

   ![Окончательный текст запроса для передачи в функцию](./media/tutorial-process-email-attachments-workflow/add-email-body-for-function-processing-2.png)

7. Сохраните приложение логики.

Затем добавьте действие, создающее большой двоичный объект в контейнере хранилища для сохранения текста электронного сообщения.

## <a name="create-blob-for-email-body"></a>Создание большого двоичного объекта для текста электронного сообщения

1. В блоке **Если истинно** и в разделе функции Azure выберите **Добавить действие**. 

2. В поле поиска в качестве фильтра введите create blob и выберите действие: **Создать BLOB-объект — Хранилище BLOB-объектов**

   ![Добавление действия для создания большого двоичного объекта для текста электронного сообщения](./media/tutorial-process-email-attachments-workflow/create-blob-action-for-email-body.png)

3. Установите подключение к своей учетной записи хранения с этими параметрами, как показано ниже. Когда все будет готово, выберите **Создать**.

   ![Установка подключения к учетной записи хранения](./media/tutorial-process-email-attachments-workflow/create-storage-account-connection-first.png)

   | Параметр | Значение | ОПИСАНИЕ | 
   | ------- | ----- | ----------- | 
   | **Имя подключения** | AttachmentStorageConnection | Описательное имя для подключения | 
   | **Учетная запись хранения** | attachmentstorageacct | Имя учетной записи хранения, созданной ранее для сохранения вложений | 
   |||| 

4. Переименуйте действие **Создать BLOB-объект** с использованием этого описания: ```Create blob for email body```.

5. В действии **Создать BLOB-объект** укажите эти сведения и выберите поля, чтобы создать большой двоичный объект, как показано и описано:

   ![Указание сведений о больших двоичных объектах для текста электронного сообщения](./media/tutorial-process-email-attachments-workflow/create-blob-for-email-body.png)

   | Параметр | Значение | ОПИСАНИЕ | 
   | ------- | ----- | ----------- | 
   | **Путь к папке** | /attachments | Путь и имя контейнера, созданные ранее. В этом примере щелкните значок папки, а затем выберите контейнер /attachments. | 
   | **Имя BLOB-объекта** | Поле **От** | В этом примере в качестве имени большого двоичного объекта используйте имя отправителя. Щелкните это поле, чтобы открылся список динамического содержимого, а затем выберите поле **От** в разделе действия **Когда приходит новое электронное письмо**. | 
   | **Содержимое BLOB-объекта** | Поле **Содержимое** | В этом примере используйте текст электронного сообщения без HTML в качестве содержимого большого двоичного объекта. Щелкните это поле, чтобы появился список динамического содержимого, а затем выберите **Текст** в разделе действия **Call RemoveHTMLFunction to clean email body** (Вызов функции RemoveHTMLFunction для удаления текста электронного сообщения). |
   |||| 

   В итоге действие должно выглядеть приблизительно так, как показано в примере ниже:

   ![Выполненное действие "Создать BLOB-объект"](./media/tutorial-process-email-attachments-workflow/create-blob-for-email-body-done.png)

6. Сохраните приложение логики. 

### <a name="check-attachment-handling"></a>Проверка обработки вложений

Теперь проверьте, обрабатывает ли приложение логики электронные сообщения выбранным способом:

1. Если приложение логики еще не запущено, выберите **Запуск** на панели инструментов конструктора.

2. Отправьте электронное сообщение, которое соответствует этому критерию:

   * Тема электронного сообщения содержит текст, который указан в триггере **субъекта фильтра**: ```Business Analyst 2 #423501```

   * Ваше электронное сообщение содержит по крайней мере одно вложение. 
   Теперь создайте один пустой текстовый файл и вложите его в электронное сообщение.

   * Ваше электронное сообщение имеет тестовое содержимое в тексте, например: 

     ```
     Testing my logic app
     ```

   Если приложение логики не запускается несмотря на срабатывание триггера, см. статью [Диагностика и устранение сбоев приложений логики](../logic-apps/logic-apps-diagnosing-failures.md).

3. Убедитесь, что приложение логики сохранило электронное сообщение в правильный контейнер хранилища. 

   1. В Обозревателе службы хранилища разверните узел **(Local and Attached) (Локальные и присоединенные)**> 
   **Учетные записи хранения**>**attachmentstorageacct (External)**> 
   **Контейнеры BLOB-объектов**>**attachments**.

   2. Проверьте контейнер электронных сообщений **attachments**. 

      На данный момент в контейнере появляются только электронные сообщения, потому что приложение логики еще не обрабатывает вложения.

      ![Проверка Обозревателя службы хранилища на наличие сохраненных электронных сообщений](./media/tutorial-process-email-attachments-workflow/storage-explorer-saved-email.png)

   3. Затем удалите электронные сообщения в Обозревателе службы хранилища.

4. При желании для проверки ветви **Если ложно**, которая пока не активна, вы можете отправить электронное письмо, не соответствующее критериям.

Добавьте цикл для обработки всех вложений электронной почты.

## <a name="process-attachments"></a>Обработка вложений

Для обработки каждого вложения в электронном сообщении добавьте цикл **For each** в рабочий процесс приложения логики.

1. В области фигуры **Create blob for email body** (Создание большого двоичного объекта для текста электронного сообщения) выберите **More**(Еще) > **Добавить оператор " для каждого"**.

   ![Добавление цикла For each](./media/tutorial-process-email-attachments-workflow/add-for-each-loop.png)

2. Переименуйте цикл, используя описание: ```For each email attachment```.

3. Теперь укажите данные для обработки цикла. Щелкните в текстовом поле **Select an output from previous steps** (Выберите выходные данные из предыдущих шагов), чтобы открыть список динамического содержимого и выберите **Вложения**. 

   ![Выбор вложений](./media/tutorial-process-email-attachments-workflow/select-attachments.png)

   Поле **Вложения** передает массив, содержащий все вложения, включенные в электронные сообщения. 
   Цикл **For each** повторяет действия для каждого элемента, который передается в массив.

4. Сохраните приложение логики.

Добавьте действие, которое сохраняет каждое вложение в виде большого двоичного объекта в контейнере хранилища **attachments**.

## <a name="create-blob-for-each-attachment"></a>Создание большого двоичного объекта для каждого вложения

1. В цикле **For each email attachment** (Для каждого вложения электронной почты) выберите **Добавить действие**, чтобы назначить задачу для каждого найденного вложения.

   ![Добавление действия в цикл](./media/tutorial-process-email-attachments-workflow/for-each-add-action.png)

2. В поле поиска в качестве фильтра введите create blob, а затем выберите действие: **Создать BLOB-объект — Хранилище BLOB-объектов Azure**.

   ![Добавление действия для создания большого двоичного объекта](./media/tutorial-process-email-attachments-workflow/create-blob-action-for-attachments.png)

3. Переименуйте действие **Создать BLOB-объект 2** с использованием этого описания: ```Create blob for each email attachment```.

4. В действии **Create blob for each email attachment** (Создать большой двоичный объект для каждого вложения электронной почты) укажите эти сведения и выберите свойства для каждого большого двоичного объекта, который вы хотите создать, как показано и описано:

   ![Указание сведений о большом двоичном объекте](./media/tutorial-process-email-attachments-workflow/create-blob-per-attachment.png)

   | Параметр | Значение | ОПИСАНИЕ | 
   | ------- | ----- | ----------- | 
   | **Путь к папке** | /attachments | Путь и имя контейнера, созданные ранее. В этом примере щелкните значок папки, а затем выберите контейнер /attachments. | 
   | **Имя BLOB-объекта** | Поле **Имя** | В этом примере в качестве имени большого двоичного объекта используйте имя вложения. Щелкните это поле, чтобы открылся список динамического содержимого, а затем выберите поле **Имя** в разделе действия **Когда приходит новое электронное письмо**. | 
   | **Содержимое BLOB-объекта** | Поле **Содержимое** | В этом примере в качестве содержимого большого двоичного объекта используйте поле **Содержимое**. Щелкните это поле, чтобы открылся список динамического содержимого, а затем выберите поле **Содержимое** в разделе действия **Когда приходит новое электронное письмо**. |
   |||| 

   В итоге действие должно выглядеть приблизительно так, как показано в примере ниже:

   ![Выполненное действие "Создать BLOB-объект"](./media/tutorial-process-email-attachments-workflow/create-blob-per-attachment-done.png)

5. Сохраните приложение логики. 

### <a name="check-attachment-handling"></a>Проверка обработки вложений

Затем проверьте, обрабатывает ли приложение логики вложения так, как вы указали:

1. Если приложение логики еще не запущено, выберите **Запуск** на панели инструментов конструктора.

2. Отправьте электронное сообщение, которое соответствует этому критерию:

   * Тема электронного сообщения содержит текст, который указан в триггере **субъекта фильтра**: ```Business Analyst 2 #423501```

   * Ваше электронное сообщение содержит по крайней мере два вложения. 
   Теперь создайте два пустых текстовых файла и вложите их в электронное сообщение.

   Если приложение логики не запускается несмотря на срабатывание триггера, см. статью [Диагностика и устранение сбоев приложений логики](../logic-apps/logic-apps-diagnosing-failures.md).

3. Убедитесь, что приложение логики сохранило электронное сообщение и вложения в правильный контейнер хранилища. 

   1. В Обозревателе службы хранилища разверните узел **(Local and Attached) (Локальные и присоединенные)**> 
   **Учетные записи хранения**>**attachmentstorageacct (External)**> 
   **Контейнеры BLOB-объектов**>**attachments**.

   2. Проверьте электронное сообщение и вложения в контейнере **attachments**.

      ![Проверка сохраненных электронных сообщений и вложений](./media/tutorial-process-email-attachments-workflow/storage-explorer-saved-attachments.png)

   3. Затем удалите электронное сообщение и вложения в Обозревателе службы хранилища.

Добавьте действие, чтобы приложение логики отправляло электронное сообщение для просмотра вложений.

## <a name="send-email-notifications"></a>Отправка уведомлений по электронной почте

1. В ветви **Если истинно** в цикле **For each email attachment** (Для каждого вложения электронной почты) выберите **Добавить действие**. 

   ![Добавление действия в цикл "Для каждого вложения электронной почты"](./media/tutorial-process-email-attachments-workflow/add-action-send-email.png)

2. В поле поиска в качестве фильтра введите "отправить сообщение электронной почты", а затем выберите действие "отправить сообщение электронной почты" для поставщика электронной почты. 

   Чтобы отфильтровать список действий для определенной службы, можно сначала выбрать соединитель.

   ![Выбор действия "Отправить электронное письмо" для поставщика электронной почты](./media/tutorial-process-email-attachments-workflow/add-action-select-send-email.png)

   * Для рабочих или учебных учетных записей Azure выберите Office 365 Outlook. 
   * Для личных учетных записей Майкрософт выберите Outlook.com. 

3. При появлении запроса на ввод учетных данных войдите в свою учетную запись электронной почты для установки подключения к этой учетной записи в Logic Apps.

4. Переименуйте действие **Отправить сообщение электронной почты** с использованием этого описания: ```Send email for review```.

5. Укажите сведения для этого действия и выберите поля, которые следует добавить в электронное сообщение, как показано и описано. Чтобы добавить пустые строки в поле редактирования, нажмите Shift + ВВОД.  

   ![Отправка уведомления по электронной почте](./media/tutorial-process-email-attachments-workflow/send-email-notification.png)

   Если не удается найти требуемое поле в списке динамического содержимого, выберите **Еще** рядом с полем **Когда приходит новое электронное письмо**. 

   | Параметр | Значение | Примечания | 
   | ------- | ----- | ----- | 
   | **Текст** | ```Please review new applicant:``` <p>```Applicant name: ``` **От** <p>```Application file location: ``` **Путь** <p>```Application email content: ``` **Текст** | Содержимое текста электронного сообщения. Щелкните это поле, введите текст примера и из списка динамического содержимого выберите следующие поля: <p>— Поле **От** в разделе **Когда приходит новое электронное письмо**. </br>— Поле **Путь** в разделе **Create blob for email body** (Создание большого двоичного объекта в тексте электронного сообщения). </br>— **Текст** в разделе **Call RemoveHTMLFunction to clean email body** (Вызов функции RemoveHTMLFunction для удаления текста электронного сообщения). | 
   | **Тема**  | ```ASAP - Review applicant for position: ``` **Тема** | Тема электронного письма, которую необходимо указать. Щелкните это поле, введите текст примера и из списка динамического содержимого выберите в разделе **Когда приходит новое электронное письмо** поле **Тема**. | 
   | **To** | <*электронный адрес получателя*> | Для тестировании можете использовать свой собственный адрес. | 
   |||| 

   > [!NOTE] 
   > Если вы выбрали поле с массивом, в котором содержатся вложения, например **Содержимое**, конструктор автоматически добавляет цикл For each для действия, которое ссылается на это поле. Таким образом приложение логики будет выполнять это действие для каждого элемента массива. Чтобы удалить цикл, удалите поле массива, переместите ссылочное действие за пределы цикла, нажмите кнопку с многоточием (**...**) на панели заголовка цикла и щелкните **Удалить**.
     
6. Сохраните приложение логики. 

Теперь протестируйте приложение логики, которое выглядит, как показано в примере:

![Готовое приложение логики](./media/tutorial-process-email-attachments-workflow/complete.png)

## <a name="run-your-logic-app"></a>Запуск приложения логики

1. Отправьте электронное сообщение, которое соответствует этому критерию:

   * Тема электронного сообщения содержит текст, который указан в триггере **субъекта фильтра**: ```Business Analyst 2 #423501```

   * Ваше электронное сообщение содержит одно или несколько вложений. 
   Вы можете повторно использовать пустой текстовый файл из предыдущего теста. 
   Для более реалистичного сценария присоедините файл резюме.

   * Текстом электронного сообщения будет этот текст, который можно скопировать и вставить.

     ```
     Name: Jamal Hartnett   
     
     Street address: 12345 Anywhere Road   
     
     City: Any Town   
     
     State or Country: Any State   
     
     Postal code: 00000   
     
     Email address: jamhartnett@outlook.com   
     
     Phone number: 000-000-0000   
     
     Position: Business Analyst 2 #423501   

     Technical skills: Dynamics CRM, MySQL, Microsoft SQL Server, JavaScript, Perl, Power BI, Tableau, Microsoft Office: Excel, Visio, Word, PowerPoint, SharePoint, and Outlook   

     Professional skills: Data, process, workflow, statistics, risk analysis, modeling; technical writing, expert communicator and presenter, logical and analytical thinker, team builder, mediator, negotiator, self-starter, self-managing  
     
     Certifications: Six Sigma Green Belt, Lean Project Management   
     
     Language skills: English, Mandarin, Spanish   
     
     Education: Master of Business Administration   
     ```

2. Запустите приложение логики. В случае успешного запуска приложение логики отправляет электронное сообщение, которое выглядит как в следующем примере:

   ![Уведомление по электронной почте, отправленное приложением логики](./media/tutorial-process-email-attachments-workflow/email-notification.png)

   Если электронные сообщения не приходят, проверьте папку нежелательной почты. 
   Фильтр нежелательной почты может перенаправлять такие виды электронных сообщений. 
   В противном случае, если вы не уверены, что приложение логики работает правильно, см. статью [Диагностика сбоев приложений логики](../logic-apps/logic-apps-diagnosing-failures.md).

Поздравляем, вы создали и запустили приложение логики, которое автоматизирует задачи в различных службах Azure и вызывает пользовательский код.

## <a name="clean-up-resources"></a>Очистка ресурсов

Удалите ненужную группу ресурсов, содержащую приложение логики и связанные ресурсы. В главном меню Azure перейдите к **группам ресурсов**, а затем выберите группу ресурсов для приложения логики. Выберите **Удалить группу ресурсов**. Введите имя группы ресурсов для подтверждения и нажмите кнопку **Удалить**.

![Удаление группы ресурсов приложения логики](./media/tutorial-process-email-attachments-workflow/delete-resource-group.png)

## <a name="get-support"></a>Получение поддержки

* Если у вас возникли вопросы, то посетите [форум Azure Logic Apps](https://social.msdn.microsoft.com/Forums/en-US/home?forum=azurelogicapps).
* Отправить идею по поводу возможности или проголосовать за нее вы можете на [сайте отзывов пользователей Logic Apps](http://aka.ms/logicapps-wish).

## <a name="next-steps"></a>Дополнительная информация

В этом руководстве вы ознакомились с созданием приложения логики, с помощью которого можно обрабатывать и сохранять вложения электронной почты путем интеграции служб Azure, например службы хранилища Azure и функций Azure. Теперь узнайте о других соединителях, которые можно использовать для создания приложений логики.

> [!div class="nextstepaction"]
> [Connectors list](../connectors/apis-list.md) (Список соединителей)
