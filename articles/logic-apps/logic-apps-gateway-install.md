---
title: Установка локального шлюза данных в Azure Logic Apps | Документация Майкрософт
description: Загрузка и установка локального шлюза данных перед получением доступа к локальным данным из приложений логики
services: logic-apps
ms.service: logic-apps
author: ecfan
ms.author: estfan
manager: jeconnoc
ms.topic: article
ms.date: 07/20/2018
ms.reviewer: yshoukry, LADocs
ms.suite: integration
ms.openlocfilehash: 09e3879ed91a0e9c6d27940cae53f3e3f0397d7b
ms.sourcegitcommit: 727a0d5b3301fe20f20b7de698e5225633191b06
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/19/2018
ms.locfileid: "39145212"
---
# <a name="install-the-on-premises-data-gateway-for-azure-logic-apps"></a>Установка локального шлюза данных для Azure Logic Apps

Прежде чем подключить приложение логики к локальным источникам данных на локальном компьютере, необходимо загрузить и установить локальный шлюз данных. Этот шлюз работает как мост для шифрования и быстрой передачи данных между локальными источниками данных (не в облаке) и приложениями логики. В этой статье показано, как загрузить, установить и настроить локальный шлюз данных. 

Установка шлюза может успешно работать с такими службами, как Power BI, Microsoft Flow, PowerApps и Azure Analysis Services. Дополнительные сведения см. в разделе [Как работает шлюз](#gateway-cloud-service).

<a name="supported-connections"></a>

Шлюз поддерживает [локальные соединители](../connectors/apis-list.md#on-premises-connectors) для следующих источников данных в Azure Logic Apps.

*   BizTalk Server 2016
*   Файловая система
*   IBM DB2  
*   IBM Informix
*   IBM MQ
*   MySQL
*   База данных Oracle
*   PostgreSQL
*   сервер приложений SAP; 
*   сервер сообщений SAP;
*   SharePoint Server
*   SQL Server;
*   Teradata

Сведения о том, как использовать шлюз с другими службами, см. в следующих статьях:

* [Локальный шлюз данных](https://powerbi.microsoft.com/documentation/powerbi-gateway-onprem/)
* [Управление локальным шлюзом данных в PowerApps](https://powerapps.microsoft.com/tutorials/gateway-management/)
* [Управление локальным шлюзом данных в Microsoft Flow](https://flow.microsoft.com/documentation/gateway-manage/)
* [Локальный шлюз данных](../analysis-services/analysis-services-gateway.md)

<a name="requirements"></a>

## <a name="prerequisites"></a>Предварительные требования

* [Рабочая или учебная учетная запись](../active-directory/fundamentals/sign-up-organization.md), у которой есть [подписка Azure](https://docs.microsoft.com/azure/architecture/cloud-adoption-guide/adoption-intro/subscription-explainer). Во время установки шлюза необходимо войти в эту учетную запись. Это позволит связать установку шлюза с подпиской Azure. Позже эта учетная запись будет использоваться на портале Azure для создания ресурса Azure в процессе установки шлюза. Если у вас еще нет подписки Azure, <a href="https://azure.microsoft.com/free/" target="_blank">получите бесплатную учетную запись Azure</a>.

* Требования для локального компьютера приведены ниже.

  **Минимальные требования**
  * .NET Framework 4.5.2
  * 64-разрядная версия Windows 7 или Windows Server 2008 R2 (или более поздняя версия).

  **Рекомендуемые требования**
  * 8-ядерный ЦП;
  * 8 ГБ ОЗУ;
  * 64-разрядная версия Windows Server 2012 R2 (или более поздняя версия)

* **Важные сведения**

  * Локальный шлюз данных должен быть установлен только на локальном компьютере, который не является контроллером домена. Тем не менее не нужно устанавливать шлюз на компьютере, на котором размещен источник данных. Кроме того, для всех источников данных потребуется только один шлюз, поэтому нет необходимости устанавливать шлюз для каждого источника данных.

    > [!TIP]
    > Чтобы свести к минимуму задержки, шлюз можно установить как можно ближе к источнику данных или даже на том же компьютере, если только у вас есть соответствующие разрешения.

  * Шлюз необходимо устанавливать на компьютер, который *не* выключается, не переходит в спящий режим и не подключен к Интернету. В таких условиях шлюз работать не может. 
  Снижение производительности шлюза также может наблюдаться при использовании беспроводной сети.

  * Во время установки войти можно только с помощью [рабочей или учебной учетной записи](../active-directory/sign-up-organization.md), управляемой Azure Active Directory, а не с помощью учетной записи Майкрософт. 
  Кроме того, убедитесь, что эта учетная запись не является гостевой учетной записью Azure B2B. 
  Также ее необходимо использовать для входа на портал Azure при регистрации установки шлюза. Это достигается путем создания ресурса Azure для шлюза. 
  Затем при создании подключения от приложения логики к локальным источникам данных можно выбрать этот ресурс шлюза. 
  [Почему необходимо использовать рабочую или учебную учетную запись Azure AD?](#why-azure-work-school-account)

  > [!TIP]
  > Если вы зарегистрировались для использования предложения Office 365 и не предоставили действительного рабочего адреса электронной почты, то адрес для входа может выглядеть следующим образом: `username@domain.onmicrosoft.com` 
  >
  > Чтобы использовать учетную запись Майкрософт, которая содержит [стандартную подписку Visual Studio](https://visualstudio.microsoft.com/vs/pricing/), сначала [создайте каталог (клиент) в Azure Active Directory](../active-directory/develop/active-directory-howto-tenant.md) или используйте каталог по умолчанию с помощью учетной записи Майкрософт. 
  > Добавьте в каталог пользователя с паролем, а затем предоставьте этому пользователю доступ к своей подписке. 
  > Затем вы можете войти в систему во время установки шлюза, используя эти имя пользователя и пароль.

  * Регион, который был выбран для установки шлюза, определяет расположение, в котором будет выполнена регистрация шлюза в Azure, путем создания ресурса Azure. 
  При создании ресурса шлюза в Azure необходимо выбрать *такое же* расположение, как и для установки шлюза. Регион по умолчанию находится в том же расположении, что и клиент Azure AD, который управляет учетной записью Azure. Во время установки шлюза расположение можно изменить.

  * При наличии шлюза, который был настроен с помощью установщика более старой версии, чем версия 14.16.6317.4, невозможно изменить расположение шлюза, запустив установщик более последней версии. Тем не менее можно использовать последнюю версию установщика, чтобы настроить новый шлюз с требуемым расположением.
  
    Если имеется установщик шлюза версии ниже 14.16.6317.4, но еще не установлен шлюз, вместо него можно скачать и использовать последнюю версию установщика.

<a name="install-gateway"></a>

## <a name="install-data-gateway"></a>Установка шлюза данных

1. [Скачайте, сохраните и запустите установщик шлюза на локальном компьютере](http://go.microsoft.com/fwlink/?LinkID=820931&clcid=0x409).

2. Примите путь установки по умолчанию или укажите расположение на компьютере, куда необходимо установить шлюз.

3. Просмотрите и примите условия использования и заявление о конфиденциальности, а затем выберите **Установить**.

   ![Принятие условия использования и заявления о конфиденциальности](./media/logic-apps-gateway-install/accept-terms.png)

4. После успешной установки шлюза укажите адрес электронной почты рабочей или учебной учетной записи и выберите **Вход**.

   ![Выполнение входа в рабочую или учебную учетную запись](./media/logic-apps-gateway-install/sign-in-gateway-install.png)

5. Последовательно выберите **Register a new gateway on this computer** (Регистрация нового шлюза на этом компьютере) > **Далее**, что позволит зарегистрировать установленный шлюз в [облачной службе шлюза](#gateway-cloud-service). 

   ![Зарегистрировать шлюз](./media/logic-apps-gateway-install/register-new-gateway.png)

6. Для установки шлюза необходимо указать следующие сведения.

   * Имя, требуемое для установки. 

   * Ключ восстановления, который необходимо создать, длина которого должна быть не менее восьми символов.

     > [!IMPORTANT]
     > Сохраните и держите ключ восстановления в безопасном месте. Этот ключ понадобится при изменении расположения шлюза или при миграции, восстановлении или перехвате имеющегося шлюза.

   * Подтверждение ключа восстановления 

     ![Настойка шлюза](./media/logic-apps-gateway-install/set-up-gateway.png)

7. Проверьте регион, который был выбран для облачной службы шлюза и служебной шины Azure, используемый для установки шлюза. 

   ![Проверка региона](./media/logic-apps-gateway-install/check-region.png)

   > [!IMPORTANT]
   > Чтобы изменить регион после завершения установки шлюза, требуется ключ восстановления этой установки шлюза. Кроме того, шлюз требуется удалить, а затем установить заново. Дополнительные сведения см. в разделе [Change location, migrate, restore, or take over existing gateway](#update-gateway-installation) (Изменение расположения, миграции, восстановления или перехват имеющегося шлюза).

   *Причины изменения региона установки шлюза.* 

   Например, чтобы уменьшить задержку, можно изменить регион своего шлюза на тот регион, что и в приложении логики. 
   Или можно выбрать регион, который находится ближе всего к локальному источнику данных. 
   *Ресурс шлюза в Azure* и приложение логики могут размещаться в разных расположениях.

8. Чтобы принять регион по умолчанию, выберите **Настроить**. А для изменения региона по умолчанию необходимо выполнить следующие действия.

   1. Рядом с текущим регионом выберите **Изменить регион**. 

      ![Изменение региона](./media/logic-apps-gateway-install/change-region.png)

   2. На следующей странице откройте список **Выбрать регион**, выберите требуемый регион и нажмите кнопку **Готово**.

      ![Выберите другой регион](./media/logic-apps-gateway-install/select-region-gateway-install.png)

9. После появления страницы подтверждения выберите **Закрыть**. 

   Затем установщиком будет подтверждено, что теперь шлюз подключен к сети и готов к использованию.

   ![Завершение подключения шлюза](./media/logic-apps-gateway-install/finished-gateway-default-location.png)

10. Теперь зарегистрируйте шлюз в Azure с помощью [создания ресурса Azure для установки шлюза](../logic-apps/logic-apps-gateway-connection.md). 

## <a name="enable-high-availability"></a>Включение высокой доступности

После установки более одного шлюза и настройки их для использования в качестве кластеров локальный шлюз данных будет поддерживать высокий уровень доступности. Если вы собрались создать новый шлюз, а у вас уже имеется существующий шлюз, то можно создать кластеры с высоким уровнем доступности. Они упорядочивают шлюзы в группы, которые могут помочь избежать единой точки отказа. Чтобы использовать эту возможность, обратите внимание на следующие требования и рекомендации.

* Только некоторые соединители поддерживают высокую доступность, например соединитель файловой системы и другие подобные. 
     
* Для этой установки требуется наличие хотя бы одного установленного шлюза в той же подписке Azure, в которой находятся основной шлюз и ключ восстановления. 

* На основном шлюзе должны быть установлены обновления от ноября 2017 г. или более ранние.

После соблюдения этих требований при создании следующего шлюза выберите **Add to an existing gateway cluster** (Добавить в существующий кластер шлюза), основной шлюз для кластера, а затем предоставьте ключ восстановления основного шлюза.
Дополнительные сведения см. в разделе [Кластеры с высоким уровнем доступности для локальных шлюзов данных](https://docs.microsoft.com/power-bi/service-gateway-high-availability-clusters).

<a name="update-gateway-installation"></a>

## <a name="change-location-migrate-restore-or-take-over-existing-gateway"></a>Изменение расположения, миграции, восстановления или перехват имеющегося шлюза

Если необходимо изменить расположение шлюза, переместить установку шлюза на новый компьютер, восстановить поврежденный шлюз или использовать владельца существующего шлюза, вам потребуется ключ восстановления, предоставленный во время установки шлюза. С помощью этого действия старый шлюз будет отключен.

1. Отройте **Панель управления** компьютера и перейдите к разделу **Программы и компоненты**. Выберите в списке программ **Локальный шлюз данных** и затем нажмите кнопку **Удалить**.

2. [Повторно установите локальный шлюз данных](http://go.microsoft.com/fwlink/?LinkID=820931&clcid=0x409).

3. После открытия установщика войдите с помощью той же рабочей или учебной учетной записи, которая использовалась при установке шлюза.

4. Выберите **Перенос, восстановление или перехват имеющегося шлюза** и нажмите кнопку **Далее**.

   ![Выберите "Перенос, восстановление или перехват имеющегося шлюза"](./media/logic-apps-gateway-install/migrate-recover-take-over-gateway.png)

5. В разделе **Доступные шлюзы** или **Available gateway clusters** (Доступные кластеры шлюза) выберите установку шлюза, которую необходимо изменить. Для установки шлюза необходимо ввести ключ восстановления. 

   ![Выбор основного шлюза](./media/logic-apps-gateway-install/select-existing-gateway.png)

6. Чтобы изменить регион, выберите **Изменить регион**, а затем выберите новый регион.

7. Когда все будет готово, щелкните **Настроить**.

## <a name="configure-proxy-or-firewall"></a>Настройка прокси-сервера или брандмауэра

Локальный шлюз данных создает исходящее подключение к [Служебной шине Azure](https://azure.microsoft.com/services/service-bus/). Если для рабочей среды требуется, чтобы при доступе в Интернет трафик проходил через прокси-сервер, то это ограничение может помешать подключению шлюза данных к облачной службе шлюза. Чтобы определить, используется ли в сети прокси-сервер, просмотрите следующую статью на сайте superuser.com. 

[How do I know what proxy server I'm using? (SuperUser.com)](https://superuser.com/questions/346372/how-do-i-know-what-proxy-server-im-using) (Способы определения используемого прокси-сервера [SuperUser.com]) 

Сведения о том, как предоставить данные прокси-сервера для шлюза, см. в статье [Настройка параметров прокси-сервера для локального шлюза данных](https://docs.microsoft.com/power-bi/service-gateway-proxy). Чтобы проверить, не блокирует ли прокси-сервер или брандмауэр подключения, проверьте, действительно ли компьютер может подключиться к Интернету и [служебной шине Azure](https://azure.microsoft.com/services/service-bus/). В командной строке PowerShell выполните следующую команду.

`Test-NetConnection -ComputerName watchdog.servicebus.windows.net -Port 9350`

> [!NOTE]
> Эта команда только проверяет возможность подключения к сети и служебной шине Azure. Данная команда ничего не делает со шлюзом или облачной службой шлюза, которая шифрует и хранит учетные данные и сведения о шлюзах. 
>
> Кроме того, эта команда используется только в Windows Server 2012 R2 или более поздней версии и Windows 8.1 или более поздней версии. В более ранних версиях ОС для проверки возможности подключения можно использовать Telnet. Узнайте больше о [служебной шине Azure и гибридных решениях](../service-bus-messaging/service-bus-fundamentals-hybrid-solutions.md).

Полученные результаты должны напоминать результаты из примера, где значению параметра **TcpTestSucceeded** соответствует значение **True**.

```text
ComputerName           : watchdog.servicebus.windows.net
RemoteAddress          : 70.37.104.240
RemotePort             : 5672
InterfaceAlias         : vEthernet (Broadcom NetXtreme Gigabit Ethernet - Virtual Switch)
SourceAddress          : 10.120.60.105
PingSucceeded          : False
PingReplyDetails (RTT) : 0 ms
TcpTestSucceeded       : True
```

Если значение **TcpTestSucceeded** не равно **True**, возможно, шлюз блокируется брандмауэром. Чтобы обеспечить исчерпывающие сведения, замените значения параметров **ComputerName** и **Port** значениями, приведенными ниже в подразделе [Настройка портов](#configure-ports) этой статьи.

Брандмауэр может также блокировать подключения, устанавливаемые служебной шиной Azure с центрами обработки данных Azure. В этом случае разрешите (разблокируйте) все IP-адреса этих центров обработки данных в своем регионе. Чтобы узнать эти IP-адреса, [получите список IP-адресов Azure здесь](https://www.microsoft.com/download/details.aspx?id=41653).

## <a name="configure-ports"></a>Настройка портов

Шлюз создает исходящее подключение к [служебной шине Azure](https://azure.microsoft.com/services/service-bus/) и осуществляет связь через исходящие порты: TCP-порты 443 (по умолчанию), 5671, 5672 и 9350–9354. Шлюзу не требуются входящие порты. Узнайте больше о [служебной шине Azure и гибридных решениях](../service-bus-messaging/service-bus-fundamentals-hybrid-solutions.md).

Шлюзом используются следующие полные доменные имена.

| Имена доменов | Исходящие порты | ОПИСАНИЕ | 
| ------------ | -------------- | ----------- | 
| *.analysis.windows.net | 443 | HTTPS | 
| *.core.windows.net | 443 | HTTPS | 
| *.frontend.clouddatahub.net | 443 | HTTPS | 
| *.login.windows.net | 443 | HTTPS | 
| *.microsoftonline-p.com | 443 | Используется для проверки подлинности в зависимости от конфигурации. | 
| *.msftncsi.com | 443 | Используется для проверки подключения к Интернету, если шлюз недоступен для службы Power BI. | 
| *.servicebus.windows.net | 443, 9350–9354 | Прослушиватели ретрансляции служебной шины по протоколу TCP (порт 443 требуется для получения маркера контроля доступа). | 
| *.servicebus.windows.net | 5671–5672 | Протокол AMQP | 
| login.microsoftonline.com | 443 | HTTPS | 
||||

В некоторых случаях подключения к служебной шине Azure будут устанавливаться по IP-адресам, а не полным доменным именам. Поэтому может потребоваться добавить IP-адреса для области данных в список разрешений брандмауэра. Чтобы добавить в список разрешений IP-адреса, а не домены, можно скачать и использовать [список диапазонов IP-адресов центров обработки данных Microsoft Azure](https://www.microsoft.com/download/details.aspx?id=41653). IP-адреса из этого списка перечислены в нотации [Бесклассовая адресация](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing).

### <a name="force-https-communication-with-azure-service-bus"></a>Принудительное взаимодействие протокола HTTPS со служебной шиной Azure

Некоторые прокси-серверы пропускают трафик только через порты под номером 80 и 443. По умолчанию обмен данными со служебной шиной Azure происходит через порты, отличные от 443.
Можно настроить шлюз для принудительного использования служебной шины Azure через протокол HTTPS вместо прямого подключения TCP. Но это может значительно снизить производительность. Для этого выполните следующие действия.

1. Перейдите в расположение клиентского каталога локального шлюза данных. Обычно его можно найти по адресу ```C:\Program Files\On-premises data gateway\Microsoft.PowerBI.EnterpriseGateway.exe```

   В противном случае для поиска расположения клиента откройте консоль служб на том же компьютере, найдите **On-premises data gateway service** (служба "Локальный шлюз данных") и просмотрите свойство **Path to executable** (Путь к исполняемому файлу).

2. Откройте файл *конфигурации*: **Microsoft.PowerBI.DataMovement.Pipeline.GatewayCore.dll.config**.

3. Измените значение **ServiceBusSystemConnectivityModeString** из **AutoDetect** на **https**.

   ```html
   <setting name="ServiceBusSystemConnectivityModeString" serializeAs="String">
      <value>Https</value>
   </setting>
   ```

<a name="windows-service-account"></a>

## <a name="windows-service-account"></a>Учетная запись службы Windows

Локальный шлюз данных работает как служба Windows с именем On-premises data gateway service (служба "Локальный шлюз данных") и при этом использует "NT SERVICE\PBIEgwService" для учетных данных учетной записи Log On As (Вход в систему как). По умолчанию локальный шлюз данных имеет разрешения "Вход в качестве службы" для компьютера, на котором устанавливается шлюз. Для создания и обслуживания шлюза на портале Azure учетная запись службы Windows должна иметь по крайней мере разрешения **участника**. 

> [!NOTE]
> Учетная запись службы Windows отличается от учетной записи, которая использовалась для подключения к локальным источникам данных, и от рабочей или учебной учетной записи, которая использовалась для входа в облачные службы.

<a name="restart-gateway"></a>

## <a name="restart-gateway"></a>Перезапуск шлюза

Шлюз данных работает как служба Windows и, как и любая другая служба Windows, может быть запущен и остановлен различными способами. Например, можно открыть командную строку с дополнительными разрешениями на компьютере, на котором выполняется шлюз, и выполнить одну из команд, приведенных ниже.

* Чтобы остановить службу, выполните указанную ниже команду.
  
  `net stop PBIEgwService`

* Чтобы запустить службу, выполните указанную ниже команду.
  
  `net start PBIEgwService`

## <a name="tenant-level-administration"></a>Администрирование на уровне клиента 

Сейчас нет единого места, где администраторы клиентов могут управлять всеми шлюзами, которые установили и настроили другие пользователи. Если вы являетесь администратором клиента, то может потребоваться попросить пользователей в организации добавить вас в качестве администратора для каждого устанавливаемого шлюза. Таким образом, управление всеми шлюзами организации можно осуществлять на странице настроек шлюза или через [команды PowerShell](https://docs.microsoft.com/power-bi/service-gateway-high-availability-clusters#powershell-support-for-gateway-clusters). 

<a name="gateway-cloud-service"></a>

## <a name="how-does-the-gateway-work"></a>Как работает шлюз данных?

Шлюз данных обеспечивает быстрый и безопасный обмен данными между приложением логики, облачной службой шлюза и локальным источником данных. Облачная служба шлюза шифрует и хранит учетные данные источников данных и сведения о шлюзах. Эта служба также передает запросы и их результаты между приложением логики, локальным шлюзом данных и локальными источниками данных. 

Шлюз работает с брандмауэрами и использует только исходящие соединения. Весь трафик поступает как безопасный исходящий трафик от агента шлюза. Шлюз ретранслирует данные из локальных источников по шифрованным каналам через служебную шину Azure. Служебная шина создает канал между шлюзом и службой вызовов, при этом она не хранит никаких данных. Шифруются все данные, которые передаются через шлюз.

![diagram-for-on-premises-data-gateway-flow](./media/logic-apps-gateway-install/how-on-premises-data-gateway-works-flow-diagram.png)

Шаги ниже описывают, что случится, когда пользователь в облаке взаимодействует с элементом, подключенным к локальному источнику данных.

1. Облачная служба шлюза создает запрос, а также зашифрованные учетные данные для источника данных, и отправляет запрос в очередь для обработки шлюзом.

2. Облачная служба шлюза анализирует запрос и отправляет его в служебную шину Azure.

3. Локальный шлюз данных опрашивает служебную шину Azure, чтобы проверить наличие ожидающих запросов.

4. Шлюз получает запрос, расшифровывает учетные данные и подключается к источникам данных, используя эти учетные данные.

5. Затем шлюз отправляет запрос к источнику данных для выполнения.

6. Результаты отправляются из источника данных обратно в шлюз, а затем — в облачную службу шлюза. Затем облачная служба шлюза использует эти результаты.

<a name="faq"></a>

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

### <a name="general"></a>Общие сведения

**Вопрос**. Нужно ли устанавливать шлюз для источников данных в облаке, например для базы данных SQL Azure? <br/>
**Ответ**. Нет, шлюз подключается только к локальным источникам данных.

**Вопрос**. Нужно ли устанавливать шлюз на том же компьютере, на котором находится источник данных? <br/>
**Ответ**. Нет, шлюз подключается к источнику данных, используя предоставленные сведения о подключении. В этом смысле шлюз можно рассматривать как клиентское приложение. Ему просто необходима возможность подключения к серверу, имя которого было предоставлено.

<a name="why-azure-work-school-account"></a>

**Вопрос**. Почему для входа необходимо использовать рабочую или учебную учетную запись? <br/>
**Ответ**. При установке локального шлюза данных можно использовать только рабочую или учебную учетную запись. Учетная запись для входа хранится в клиенте, которым управляет Azure Active Directory (Azure AD). Как правило, имя участника-пользователя учетной записи Azure AD совпадает с адресом электронной почты.

**Вопрос**. Где хранятся мои учетные данные? <br/>
**Ответ**. Учетные данные, введенные для источника данных, хранятся в облачной службе шлюза в зашифрованном виде. Расшифровываются они в локальном шлюзе данных.

**Вопрос**. Есть ли какие-либо требования к пропускной способности сети? <br/>
**Ответ**. Проверьте пропускную способность сети, так как она должна быть высокой. Все среды разные, и объем отправляемых данных может повлиять на результаты. Чтобы гарантировать определенный уровень пропускной способности между локальным источником данных и центрами данных Azure, воспользуйтесь [ExpressRoute](https://azure.microsoft.com/services/expressroute/). Чтобы измерить пропускную способность, воспользуйтесь внешним инструментом, например Azure Speed Test.

**Вопрос**. Что такое задержка при выполнении запросов к источнику данных из шлюза? Какая архитектура подойдет лучше всего? <br/>
**Ответ**. Чтобы уменьшить задержки в сети, необходимо установить шлюз как можно ближе к источнику данных. Вы можете установить шлюз на фактический источник данных, что сведет к минимуму соответствующие задержки. Кроме того, рассмотрите взаимодействие с центрами данных Azure. Например, если служба использует центр обработки данных в западной части США, а SQL Server размещен на виртуальной машине Azure, тогда, возможно, эту виртуальную машину Azure лучше также разместить в регионе "Западная часть США". Это позволит свести к минимуму задержки и избежать затрат на исходящий трафик виртуальной машины Azure.

**Вопрос**. Как результаты отправляются обратно в облако? <br/>
**Ответ**. Результаты отправляются с помощью служебной шины Azure.

**Вопрос**. Устанавливаются ли какие-либо входящие подключения к шлюзу из облака? <br/>
**Ответ**. Нет, шлюз использует исходящие подключения к служебной шине Azure.

**Вопрос**. Что делать, если мной заблокированы исходящие подключения? Что нужно открыть? <br/>
**Ответ**. Проверьте порты и узлы, которые использует шлюз.

**Вопрос**. Как на самом деле называется служба Windows? <br/>
**Ответ**. На вкладке "Службы" в диспетчере задач имя службы — "PBIEgwService" или "Power BI Enterprise Gateway Service". В консоли служб имя службы — "On-premises data gateway service" (служба "Локальный шлюз данных"). В качестве идентификатора безопасности службы служба Windows использует NT SERVICE\PBIEgwService.

**Вопрос**. Может ли служба Windows шлюза работать с учетной записью Azure Active Directory? <br/>
**Ответ**. Нет, службе Windows требуется действительная учетная запись Windows.

### <a name="disaster-recovery"></a>Аварийное восстановление

**Вопрос**. Какие варианты доступны для аварийного восстановления? <br/>
**Ответ**. Чтобы восстановить или перенести шлюз, вы можете использовать ключ восстановления. Ключ восстановления указывается при установке шлюза.

**Вопрос**. В чем заключается преимущество ключа восстановления? <br/>
**Ответ**. Он позволяет перенести шлюз или восстановить параметры шлюза после аварии.

## <a name="troubleshooting"></a>Устранение неполадок

В этом разделе рассматриваются некоторые распространенные проблемы, которые могут возникнуть при настройке и использовании локального шлюза данных.

**Вопрос**. Установка шлюза завершилась ошибкой. Почему? <br/>
**Ответ**. Данная ошибка может возникнуть, если антивирусное программное обеспечение на конечном компьютере устарело. Можно обновить антивирусное программное обеспечение или отключить антивирусное программное обеспечение на время установки шлюза, а затем снова его включить.

**Вопрос**. Почему при создании ресурса шлюза в Azure процесс его установки не отображается? <br/>
**Ответ**. Такая ошибка может произойти по нескольким причинам.

* Установка шлюза уже зарегистрирована и заявлена другим ресурсом шлюза в Azure. Установки шлюзов не отображаются в списке экземпляров после создания ресурсов для шлюзов.
Чтобы проверить регистрации шлюзов на портале Azure, необходимо просмотреть все ресурсы Azure с типом **Локальные шлюзы данных** для *всех* подписок Azure. 

* Идентификаторы пользователя, который установил шлюз в Azure AD, и пользователя, который вошел на портал Azure, отличаются. Убедитесь, что для входа в систему и установки шлюза использовался один и тот же идентификатор.

[!INCLUDE [existing-gateway-location-changed](../../includes/logic-apps-existing-gateway-location-changed.md)]

**Вопрос**. Где находятся журналы шлюза? <br/>
**Ответ**.См. раздел [**Журналы**, ](#logs)приведенный далее в этой статье.

**Вопрос**. Как узнать, какие запросы отправляются к локальному источнику данных? <br/>
**Ответ**. Вы можете включить трассировку запросов, в том числе и отправляемых. Не забудьте вернуть исходное значение трассировки запросов после устранения неполадок. При включенной трассировке запросов создаются журналы большего размера.

Кроме того, можно рассмотреть инструменты трассировки запросов, доступные для вашего источника данных. Например, можно использовать расширенные события или SQL Profiler для SQL Server и служб Analysis Services.

### <a name="outdated-gateway-version"></a>Устаревшая версия шлюза

При использовании устаревшей версии шлюза может возникать ряд проблем. Рекомендуем убедиться, что используется последняя версия. Если шлюз не обновлялся месяц или дольше, то можно установить его последнюю версию и проверить, получится ли воспроизвести проблему.

### <a name="error-failed-to-add-user-to-group--2147463168-pbiegwservice-performance-log-users"></a>Error: Failed to add user to group. (Ошибка: не удалось добавить пользователя в группу.) (-2147463168 PBIEgwService Performance Log Users ) (-2147463168 пользователей журналов производительности PBIEgwService)

Эта ошибка появляется, если вы пытаетесь установить шлюз на контроллер домена, который не поддерживается. Убедитесь, что развертывание шлюза происходит на компьютере, который не является контроллером домена.

<a name="logs"></a>

### <a name="logs"></a>Журналы

Чтобы облегчить устранение неполадок, всегда запускайте сбор и просмотр журналов шлюза. Существует несколько способов сбора журнала. Простейшим вариантом является использование пользовательского интерфейса установщика шлюза после установки шлюза. 

1. Откройте установщик локального шлюза данных на компьютере.
2. В меню слева выберите **Диагностика**.
3. В разделе **Журналы шлюза** выберите **Экспорт журналов**.

   ![Экспорт журналов из установщика шлюза](./media/logic-apps-gateway-install/export-logs.png)

Различные журналы можно найти в других расположениях, приведенных ниже.

| Тип журнала | Расположение | 
|----------|----------| 
| **Журналы установщика** | %localappdata%\Temp\On-premises_data_gateway_<*ггггммдд*>.<*номер*>.log | 
| **Журналы конфигурации** | C:\Users\<*имя пользователя*>\AppData\Local\Microsoft\On-premises data gateway\GatewayConfigurator<*ггггммдд*>.<*номер*>.log | 
| **Журналы службы корпоративного шлюза** | C:\Users\PBIEgwService\AppData\Local\Microsoft\On-premises data gateway\Gateway<*ггггммдд*>.<*номер*>.log | 
||| 

**Журналы событий**

Чтобы найти журнал событий шлюза, выполните следующие действия.

1. На компьютере, где установлен шлюз, откройте средство **Просмотр событий**. 
2. Разверните **Просмотр событий (локально)** > **Applications and Services Logs** (Журналы приложений и служб). 
3. Установите флажок **On-premises data gateway service** (служба "Локальный шлюз данных").

   ![Просмотр журналов событий шлюза](./media/logic-apps-gateway-install/event-viewer.png)

### <a name="telemetry"></a>Телеметрия

Можно активировать дополнительные функции наблюдения и устранения неполадок и собирать данные телеметрии. 

1. Перейдите в расположение клиентского каталога локального шлюза данных. Обычно его можно найти по адресу ```C:\Program Files\On-premises data gateway```

   В противном случае для поиска расположения клиента откройте консоль служб на том же компьютере, найдите **On-premises data gateway service** (служба "Локальный шлюз данных") и просмотрите свойство **Path to executable** (Путь к исполняемому файлу).

2. Откройте файл *конфигурации*: **Microsoft.PowerBI.DataMovement.Pipeline.GatewayCore.dll.config**.

3. Измените значение **SendTelemetry** на **true**.

   ```html
   <setting name="SendTelemetry" serializeAs="String">
      <value>true</value>
   </setting>
   ```

4. Сохраните изменения и перезапустите службу Windows.

### <a name="review-slow-query-performance"></a>Обзор производительности медленных запросов

Если будет обнаружено, что запросы медленно работают через шлюз, можно включить дополнительное ведение журнала, которое выводит запросы и их длительность. Эти журналы могут указать, какие из запросов медленные или долго выполняются. Чтобы настроить производительность запросов, может потребоваться изменить источник данных, например настроить индексы запросов SQL Server.

Чтобы определить длительность запроса, выполните следующие действия.

1. Перейдите в то же расположение, где находится клиент шлюза. Обычно его можно найти по адресу ```C:\Program Files\On-premises data gateway```

   В противном случае для поиска расположения клиента откройте консоль служб на том же компьютере, найдите **On-premises data gateway service** (служба "Локальный шлюз данных") и просмотрите свойство **Path to executable** (Путь к исполняемому файлу).

2. Откройте и измените файл конфигурации, как описано ниже.

   * **Microsoft.PowerBI.DataMovement.Pipeline.GatewayCore.dll.config**

     В этом файле необходимо изменить значение **EmitQueryTraces** с **false** на **true**, что позволит шлюзу регистрировать запросы, отправленные из шлюза источника данных.

     ```html
     <setting name="EmitQueryTraces" serializeAs="String">
        <value>true</value>
     </setting>
     ```

     > [!IMPORTANT]
     > Включение параметра EmitQueryTraces может сильно увеличить размер журнала, который зависит от использования шлюза. Завершив просмотр журналов, убедитесь, что вы снова выполнили сброс параметра EmitQueryTraces на **false**, вместо того чтобы оставить этот параметр активным на длительный срок.

   * **Microsoft.PowerBI.DataMovement.Pipeline.Diagnostics.dll.config**

     Чтобы подробные записи журнала шлюза, включая записи, отображающие продолжительность, изменили значение **TracingVerbosity** с **4** на **5**, необходимо выполнить следующие действия. 

     * В этом файле конфигурации измените значение **TracingVerbosity** с **4** на **5** 

       ```html
       <setting name="TracingVerbosity" serializeAs="String">
          <value>5</value>
       </setting>
       ```

     * Откройте установщик шлюза, выберите **Диагностики**, включите **Дополнительное ведение журнала**, а затем нажмите кнопку **Применить**.

       ![Включение дополнительного ведения журнала](./media/logic-apps-gateway-install/turn-on-additional-logging.png)

     > [!IMPORTANT]
     > Включение параметра TracingVerbosity может сильно увеличить размер журнала, который зависит от использования шлюза. Завершив просмотр журналов, убедитесь, что **Дополнительное ведение журнала** отключено в установщике шлюза или значение параметра TracingVerbosity в файле конфигурации снова сброшено на **4**, вместо того чтобы оставлять этот параметр активным на длительный срок.

3. Чтобы определить длительность запроса, выполните следующие действия.

   1. [Экспортируйте](#logs) и откройте журнал шлюза.

   2. Чтобы найти запрос, выполните поиск типа активности. Пример. 

      | тип действия; | ОПИСАНИЕ | 
      |---------------|-------------| 
      | MGEQ | Запросы, выполняемые через ADO.NET. | 
      | MGEO | Запросы, выполняемые через OLEDB. | 
      | MGEM | Запросы, выполняемые из комбинированных модулей. | 
      ||| 

   3. Обратите внимание на второй GUID, который является идентификатором запроса.

   4. Продолжайте поиск типа действия, пока не найдете запись с именем "FireActivityCompletedSuccessfullyEvent", продолжительность которой исчисляется в миллисекундах. 
   Подтвердите, что запись имеет тот же идентификатор запроса. Пример.

      ```text 
      DM.EnterpriseGateway Verbose: 0 : 2016-09-26T23:08:56.7940067Z DM.EnterpriseGateway    baf40f21-2eb4-4af1-9c59-0950ef11ec4a    5f99f566-106d-c8ac-c864-c0808c41a606    MGEQ    21f96cc4-7496-bfdd-748c-b4915cb4b70c    B8DFCF12 [DM.Pipeline.Common.TracingTelemetryService] Event: FireActivityCompletedSuccessfullyEvent (duration=5004)
      ```

      > [!NOTE] 
      > Запись "FireActivityCompletedSuccessfullyEvent" является подробной записью и не регистрируется, если параметр "TracingVerbosity" находится на уровне 5.

### <a name="trace-traffic-with-fiddler"></a>Трассировка трафика с помощью Fiddler

[Fiddler](http://www.telerik.com/fiddler) — это бесплатный инструмент от компании Telerik, который отслеживает трафик HTTP. Вы можете просмотреть трафик с помощью службы Power BI с клиентского компьютера. Эта служба позволит выявить ошибки и другие сопутствующие сведения.

## <a name="next-steps"></a>Дополнительная информация
    
* [Подключение к локальным данным из приложений логики](../logic-apps/logic-apps-gateway-connection.md)
* [Возможности интеграции Enterprise](../logic-apps/logic-apps-enterprise-integration-overview.md)
* [Список соединителей](../connectors/apis-list.md)
