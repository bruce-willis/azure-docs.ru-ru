---
title: Повторное размещение приложения компании Contoso путем миграции на виртуальные машины Azure с помощью Azure Site Recovery | Microsoft Docs
description: В этой статье описано, как повторно разместить локальное приложение, выполнив миграцию lift-and-shift локальных машин в Azure с помощью службы Azure Site Recovery.
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 09/05/2018
ms.author: raynew
ms.openlocfilehash: b8adaebfe3195e85850bca868ed8fce41d6635f8
ms.sourcegitcommit: 3d0295a939c07bf9f0b38ebd37ac8461af8d461f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/06/2018
ms.locfileid: "43842657"
---
# <a name="contoso-migration-rehost-an-on-premises-app-to-azure-vms"></a>Миграция приложения компании Contoso: повторное размещение локального приложения на виртуальных машинах Azure


В этой статье показано, как компания Contoso повторно размещает свое локальное приложение SmartHotel360 в Azure путем миграции виртуальных машин приложения в Виртуальные машины Azure.


Это документ из цикла статей о том, как вымышленная компания Contoso переносит локальные ресурсы в облако Microsoft Azure. В статьях этого цикла содержатся общие сведения и сценарии развертывания, в которых проиллюстрирована настройка инфраструктуры миграции, оценка пригодности локальных ресурсов для миграции и выполнение различных типов миграции. Сценарии становятся все более сложными. Со временем мы добавим другие статьи.

**Статья** | **Дополнительные сведения** | **Состояние**
--- | --- | ---
[Статья 1. Общие сведения](contoso-migration-overview.md) | Обзор серии статей, стратегии миграции компании Contoso и используемых в этой серии примеров приложений. | Доступна
[Статья 2. Развертывание инфраструктуры миграции в Contoso](contoso-migration-infrastructure.md) | Компания Contoso готовит локальную инфраструктуру и инфраструктуру Azure для миграции. Для всех статей миграции в серии используется одна и та же инфраструктура. | Доступна
[Статья 3. Оценка готовности локальных ресурсов к переносу в Azure](contoso-migration-assessment.md)  | Компания Contoso выполняет оценку локального приложения SmartHotel360 в VMware. Для оценки виртуальных машин приложения Contoso использует службу "Миграция Azure". Для оценки базы данных SQL Server приложения используется Помощник по миграции данных. | Доступна
[Статья 4. Повторное размещение приложения на виртуальной машине Azure и в Управляемом экземпляре Базы данных SQL](contoso-migration-rehost-vm-sql-managed-instance.md) | Специалисты компании Contoso переносят локальное приложение SmartHotel360 в Azure по методу lift-and-shift. Специалисты компании Contoso переносят виртуальную машину внешнего интерфейса приложения с помощью [Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-overview). Они переносят базу данных приложения в Управляемый экземпляр Базы данных SQL Azure с помощью [Azure Database Migration Service](https://docs.microsoft.com/azure/dms/dms-overview). | Доступна   
Статья 5. Перемещение приложения в виртуальные машины Azure | Специалисты компании Contoso переносят виртуальные машины приложения SmartHotel360 на виртуальные машины Azure с помощью службы Site Recovery. | Эта статья
[Статья 6. Повторное размещение приложения на виртуальных машинах Azure и в группе доступности SQL Server AlwaysOn](contoso-migration-rehost-vm-sql-ag.md) | Компания Contoso переносит приложение SmartHotel360. Для переноса виртуальных машин приложения компания Contoso использует Site Recovery. Она использует службу Azure Database Migration Service для миграции базы данных приложения в кластер SQL Server, который защищен группой доступности AlwaysOn. | Доступна 
[Статья 7. Повторное размещение приложения Linux на виртуальных машинах Azure](contoso-migration-rehost-linux-vm.md) | Специалисты компании Contoso выполняют миграцию приложения osTicket для Linux по методу lift-and-shift на виртуальные машины Azure с помощью Azure Site Recovery. | Доступна
[Статья 8. Повторное размещение приложения Linux на виртуальных машинах Azure и в Azure MySQL](contoso-migration-rehost-linux-vm-mysql.md) | Специалисты компании Contoso переносят приложение osTicket для Linux на виртуальные машины Azure с помощью Azure Site Recovery, а также переносят базу данных приложения в экземпляр Azure MySQL Server, используя MySQL Workbench. | Доступна
[Статья 9. Рефакторинг приложения в веб-приложениях Azure и базе данных SQL Azure](contoso-migration-refactor-web-app-sql.md) | Специалисты компании Contoso переносят приложение SmartHotel360 в веб-приложение Azure, а базу данных приложения — в экземпляр SQL Server Azure с помощью Помощника по миграции баз данных. | Доступна
[Статья 10. Рефакторинг приложения Linux в веб-приложениях Azure и Azure MySQL](contoso-migration-refactor-linux-app-service-mysql.md) | Специалисты компании Contoso переносят свое приложение osTicket для Linux в веб-приложение Azure в нескольких регионах Azure с помощью диспетчера трафика Azure, интегрированного с GitHub для непрерывной поставки. Компания Contoso переносит базу данных приложения в экземпляр Базы данных Azure для MySQL. | Доступна 
[Статья 11. Рефакторинг TFS в VSTS](contoso-migration-tfs-vsts.md) | Специалисты компании Contoso переносят локальное развертывание Team Foundation Server в Visual Studio Team Services в Azure. | Доступна
[Статья 12. Перепроектирование приложения для использования контейнеров Azure и Базы данных SQL Azure](contoso-migration-rearchitect-container-sql.md) | Специалисты компании Contoso переносят приложение SmartHotel360 в Azure. Затем уровень веб-приложений преобразуется в контейнер Windows, работающий в Azure Service Fabric, и базу данных в службе "База данных SQL Azure". | Доступна
[Статья 13. Повторное создание приложения в Azure](contoso-migration-rebuild.md) | Специалисты компании Contoso выполняют повторную сборку приложения SmartHotel360, используя ряд возможностей и служб Azure, включая Службу приложений Azure, Службу Azure Kubernetes (AKS), Функции Azure, Cognitive Services и Azure Cosmos DB. | Доступна


В этой статье рассказывается, как компания Contoso выполняет миграцию двухуровневого приложения Windows. Приложение .NET SmartHotel360 работает на виртуальных машинах VMware в Azure. Это приложение с открытым кодом, и если вы хотите использовать его, вы можете скачать его с веб-сайта [github](https://github.com/Microsoft/SmartHotel360).



## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство и деловые партнеры определили указанные ниже цели этой миграции.

- **Адаптация к расширению бизнеса**. По мере развития компании Contoso растет нагрузка на локальные системы и инфраструктуры.
- **Минимизация рисков**. Приложение SmartHotel360 критически важно для бизнеса компании Contoso. Ей нужно без рисков перенести приложение в Azure.
- **Расширение**. Contoso не хочет изменять приложение, но хочет обеспечить его стабильность.


## <a name="migration-goals"></a>Цели миграции

Группа, работающая над облачной инфраструктурой компании Contoso, определила цели этой миграции. Эти цели используются для определения оптимального метода миграции.

- После миграции в Azure приложение должно работать так же эффективно, как оно работает в VMWare.  В облаке приложение будет играть такую же критически важную роль, как и в локальной среде. 
- Contoso не считает нужным вкладывать средства в это приложение.  Оно важно для бизнеса, но компании Contoso просто нужно безопасно переместить его в облако в его текущей форме.
- В компании Contoso не намерены изменять модель взаимодействия с этим приложением. Contoso хочет взаимодействовать с ним в облаке так же, как и сейчас.
- В компании Contoso не хотят изменять функции приложения. Нужно изменить только его расположение.


## <a name="solution-design"></a>Архитектура решения

Определив свои цели и требования, Contoso начинает разработку и анализ решения для развертывания и планирует процесс миграции, включая службы Azure, которые будут использоваться в ходе этой миграции.

### <a name="current-app"></a>Текущее приложение

- Приложение разбито на уровни на двух виртуальных машинах (**WEBVM** и **SQLVM**).
- Виртуальные машины расположены на узле VMware ESXi **contosohost1.contoso.com** (версии 6.5).
- Средой VMware управляет сервер vCenter Server 6.5 (**vcenter.contoso.com**), который запущен на виртуальной машине.
- Contoso использует локальный центр обработки данных (contoso-datacenter) с локальным контроллером домена (**contosodc1**).

### <a name="proposed-architecture"></a>Предлагаемая архитектура

- Так как приложение является рабочей нагрузкой в рабочей среде, виртуальные машины приложений в Azure будут располагаться в рабочей группе ресурсов ContosoRG.
- Виртуальные машины приложений будут перенесены в основной регион Azure (восточная часть США 2) и помещены в рабочую сеть (VNET-PROD-EUS2).
- Интерфейсная виртуальная машина сети будет находиться в интерфейсной подсети (PROD-FE-EUS2) в рабочей сети.
- Виртуальная машина базы данных будет находиться в подсети базы данных (PROD-DB-EUS2) в рабочей сети.
- После завершения миграции локальные виртуальные машины в центре обработки данных Contoso будут выведены из эксплуатации.

![Архитектура сценария](./media/contoso-migration-rehost-vm/architecture.png) 

### <a name="database-considerations"></a>Рекомендации по базе данных

В ходе проектирования решения специалисты Contoso сравнили функции Базы данных Azure SQL и SQL Server. На принятие решения об использовании экземпляра SQL Server, действующего на виртуальной машине Azure по модели IaaS, повлияли следующие соображения. 

- Использование виртуальной машины Azure под управлением SQL Server выглядит оптимальным решением, если нужно настроить операционную систему или сервер базы данных либо использовать сторонние приложения на той же виртуальной машине.
- Software Assurance позволит Contoso приобрести Управляемый экземпляр Базы данных SQL по сниженной цене, воспользовавшись Преимуществом гибридного использования Azure для SQL Server. Это позволит сэкономить до 30 % на Управляемом экземпляре.



### <a name="solution-review"></a>Проверка решения

Специалисты Contoso оценивают предлагаемый дизайн, составляя список плюсов и минусов.

**Рассмотрение** | **Дополнительные сведения**
--- | ---
**Преимущества** | Обе виртуальные машины будут перемещены в Azure без изменений, упрощая миграцию.<br/><br/> Так как компания Contoso использует метод lift-and-shift для обеих виртуальных машин приложения, база данных приложения не требует использования специальных средств для конфигурации и миграции.<br/><br/> Contoso может использовать свои инвестиции в программу Software Assurance, используя Преимущество гибридного использования Azure.<br/><br/> Компания Contoso сохранит полный контроль над виртуальными машинами приложений в Azure. 
**Недостатки** | Виртуальные машины WEBVM и SQLVM работают под управлением Windows Server 2008 R2. Операционная система поддерживается средой Azure для определенных ролей (июль 2018 г.). [Узнайте больше](https://support.microsoft.com/help/2721672/microsoft-server-software-support-for-microsoft-azure-virtual-machines).<br/><br/> Веб-уровень и уровень данных приложения останутся в одной точке отработки отказа.</br><br/> Виртуальная машина SQLVM работает под управлением SQL Server 2008 R2, который не находится в основной фазе поддержки. Однако он поддерживается для виртуальных машин Azure (июль 2018 г.). [Узнайте больше](https://support.microsoft.com/en-us/help/956893).<br/><br/> Contoso потребуется и дальше поддерживать виртуальные машины приложения, а не переходить на управляемую службу, такую как Служба приложений Azure и База данных SQL Azure.



### <a name="migration-process"></a>Процесс миграции

Contoso перенесет интерфейсные виртуальные машины и виртуальные машины базы данных на виртуальные машины Azure с помощью Site Recovery.

- В качестве первого шага Contoso подготовит и настроит компоненты Azure для Site Recovery, а также подготовит локальную инфраструктуру VMware.
- У компании уже есть [инфраструктура Azure](contoso-migration-infrastructure.md), поэтому специалистам Contoso необходимо добавить всего пару компонентов Azure специально для Site Recovery.
- Когда все будет подготовлено, Contoso сможет начать репликацию виртуальных машин.
- После того как репликация будет включена и начнет работать, Contoso перенесет виртуальную машину путем отработки отказа в Azure.

![Процесс миграции](./media/contoso-migration-rehost-vm/migraton-process.png) 



### <a name="azure-services"></a>Службы Azure

**Служба** | **Описание** | **Стоимость**
--- | --- | ---
[Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/) | Служба организует и контролирует миграцию и аварийное восстановление виртуальных машин Azure, а также локальных виртуальных машин и физических серверов.  | Во время репликации в Azure взимается плата за службу хранилища Azure.  При отработке отказа создаются виртуальные машины Azure, за которые взимается плата. Дополнительные сведения о ценах см. на [этой странице](https://azure.microsoft.com/pricing/details/site-recovery/).


## <a name="prerequisites"></a>Предварительные требования

Ниже показано, что необходимо сделать специалистам компании Contoso, чтобы реализовать этот сценарий.

**Требования** | **Дополнительные сведения**
--- | ---
**Подписка Azure.** | Специалисты Contoso создали подписки ранее в этой серии статей. Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial/).<br/><br/> Если вы создаете бесплатную учетную запись, вы являетесь администратором своей подписки и можете выполнять любые действия.<br/><br/> Если вы используете существующую подписку, в которой не являетесь администратором, администратор должен назначить вам права владельца или участника.<br/><br/> Если вам требуются более детализированные разрешения, ознакомьтесь с [этой статьей](../site-recovery/site-recovery-role-based-linked-access-control.md). 
**Инфраструктура Azure** | [Узнайте, как](contoso-migration-infrastructure.md) компания Contoso настраивает инфраструктуру Azure.<br/><br/> Просмотрите дополнительные сведения о конкретных требованиях к [сети](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#network) и [хранилищу](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#storage) для Site Recovery.
**Локальные серверы** | Необходимы локальные серверы vCenter версии 5.5, 6.0 или 6.5.<br/><br/> Необходимы узлы ESXi версии 5.5, 6.0 или 6.5.<br/><br/> Одна или несколько виртуальных машин VMware должны работать на узле ESXi.
**Локальные виртуальные машины** | Виртуальные машины должны соответствовать [требованиям Azure](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#azure-vm-requirements).


## <a name="scenario-steps"></a>Шаги выполнения сценария

Ниже рассказывается, как администраторы компании Contoso выполняют миграцию.

> [!div class="checklist"]
> * **Шаг 1. Подготовка Azure для Site Recovery**. Специалисты компании Contoso создают учетную запись хранения Azure для хранения реплицируемых данных, а также хранилище служб восстановления.
> * **Шаг 2. Подготовка локальных ресурсов VMware для Site Recovery**. Специалисты компании Contoso подготавливают учетные записи для обнаружения виртуальных машин и установки агента, а также ведут подготовку к подключению к виртуальным машинам Azure после отработки отказа.
> * **Шаг 3. Репликация виртуальных машин**. Специалисты компании Contoso настраивают репликацию и запускают репликацию виртуальных машин в хранилище Azure.
> * **Шаг 4. Миграция виртуальных машин с использованием Site Recovery**. Специалисты компании Contoso выполняют тестовую отработку отказа для проверки надлежащей работы всех компонентов, а затем выполняют полную отработку отказа для миграции виртуальных машин в Azure.




## <a name="step-1-prepare-azure-for-the-site-recovery-service"></a>Шаг 1. Подготовка Azure для службы Site Recovery

Ниже перечислены компоненты Azure, которые необходимы для миграции виртуальных машин компании Contoso в Azure.

- Виртуальная сеть, в которой будут размещены виртуальные машины Azure, созданные в результате отработки отказа.
- Учетная запись хранения Azure для размещения реплицируемых данных. 
- хранилище служб восстановления в Azure.

Специалисты компании Contoso настроили их указанным ниже образом.

1. Настройка сети. В процессе [развертывания инфраструктуры Azure](contoso-migration-infrastructure.md) специалисты компании Contoso уже настроили сеть, которую они могут использовать для Site Recovery

    - SmartHotel360 — это рабочее приложение, и виртуальные машины будут перенесены в рабочую сеть Azure (VNET-PROD-EUS2) в основном регионе "Восточная часть США 2".
    - Обе виртуальные машины будут размещены в группе ресурсов ContosoRG, которая используется для рабочих ресурсов.
    - Интерфейсная виртуальная машина приложения (WEBVM) будет перенесена в интерфейсную подсеть (PROD-FE-EUS2) в рабочей сети.
    - Виртуальная машина базы данных приложения (SQLVM) будет перенесена в подсеть базы данных (PROD-DB-EUS2) в рабочей сети.

2. Настройка учетной записи хранения. Компания Contoso создает учетную запись хранения Azure (contosovmsacc20180528) в основном регионе.
    - Учетная запись хранения должна быть создана в том же регионе, что и хранилище служб восстановления.
    - Специалисты компании используют учетную запись общего назначения со стандартным хранилищем и репликацию LRS. 

    ![Хранилище Site Recovery](./media/contoso-migration-rehost-vm/asr-storage.png)

3. Создание хранилища. Специалисты компании Contoso настроили сеть и учетную запись хранения. Теперь они создают хранилище служб восстановления (ContosoMigrationVault) и размещают его в группе ресурсов ContosoFailoverRG в основном регионе East US 2 (восточная часть США 2).

    ![Хранилище служб восстановления](./media/contoso-migration-rehost-vm/asr-vault.png)

**Нужна дополнительная помощь?**

Ознакомьтесь с [дополнительными сведениями](https://docs.microsoft.com/azure/site-recovery/tutorial-prepare-azure) о настройке Azure для Site Recovery.


## <a name="step-2-prepare-on-premises-vmware-for-site-recovery"></a>Шаг 2. Подготовка локальных ресурсов VMware для Site Recovery

Ниже перечислены элементы, которые компании Contoso необходимо подготовить в локальной среде.

- Учетная запись на сервере vCenter или узле vSphere ESXi для автоматизации обнаружения виртуальных машин.
- Учетная запись, благодаря которой можно автоматически установить службу Mobility Service на виртуальных машинах VMware. 
- Параметры локальных виртуальных машин, чтобы компания Contoso могла подключаться к реплицированным виртуальным машинам Azure после отработки отказа.


### <a name="prepare-an-account-for-automatic-discovery"></a>Подготовка учетной записи для автоматического обнаружения

Site Recovery требуется доступ к серверам VMware, чтобы:

- Автоматически обнаруживать виртуальные машины. 
- Управлять репликацией, отработкой отказа и восстановлением размещения виртуальных машин.
- Требуется по крайней мере учетная запись только для чтения. Учетная запись должна позволять выполнять ряд операций, например создавать и удалять диски, а также включать виртуальные машины.

Администраторы компании Contoso настраивают учетную запись следующим образом:

1. Специалисты компании создают роль на уровне vCenter.
2. Затем они назначают этой роли необходимые разрешения.



### <a name="prepare-an-account-for-mobility-service-installation"></a>Подготовка учетной записи к установке службы Mobility Service

Необходимо установить Mobility Service на каждой виртуальной машине.

- Если включена репликация виртуальных машин, Site Recovery может автоматически принудительно установить службу Mobility Service.
- Чтобы служба Site Recovery могла получать доступ к виртуальным машинам для принудительной установки, необходима соответствующая учетная запись. Вам потребуется указать эту учетную запись при настройке репликации.
- Учетная запись может относиться к домену или быть локальной; у нее должны быть разрешения на установку программного обеспечения на виртуальных машинах.


### <a name="prepare-to-connect-to-azure-vms-after-failover"></a>Подготовка к подключению виртуальных машин Azure после отработки отказа

После отработки отказа специалисты компании Contoso хотят подключиться к виртуальным машинам Azure. Для этого перед миграцией администраторы компании Contoso выполняют указанные ниже действия.

1. Для доступа через Интернет они делают указанное ниже.

 - Перед отработкой отказа включают RDP на локальной виртуальной машине.
 - Проверяют, добавлены ли правила TCP и UDP для профиля **Общедоступный**.
 - Проверяют, разрешен ли RDP в разделе **Брандмауэр Windows** > **Разрешенные приложения** для всех профилей.
 
2. Для доступа через межсайтовый VPN они делают указанное ниже.

 - Включают RDP на локальной машине.
 - Разрешают RDP в разделе **Брандмауэр Windows** -> **Разрешенные приложения и компоненты** для **доменных и частных** сетей.
 - Задают для политики SAN операционной системы на локальной виртуальной машине значение **OnlineAll**.

Кроме того, при запуске отработки отказа им необходимо проверить указанные ниже аспекты.

- При запуске отработки отказа на виртуальной машине не должно быть обновлений Windows, ожидающих установки. Если есть такие обновления, не удастся войти в систему на виртуальной машине до их завершения.
- После отработки отказа специалисты компании могут просмотреть снимок экрана виртуальной машины в разделе **Диагностика загрузки**. Если не удается сделать это, необходимо проверить, работает ли виртуальная машина, и изучить [советы по устранению неполадок](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).


**Нужна дополнительная помощь?**

- Ознакомьтесь с [дополнительными сведениями](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-automatic-discovery) о создании и назначении роли для автоматического обнаружения.
- [Узнайте, как](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-mobility-service-installation) создать учетную запись для принудительной установки службы Mobility Service.


## <a name="step-3-replicate-the-on-premises-vms"></a>Шаг 3. Репликация локальных виртуальных машин

Чтобы можно было запустить миграцию в Azure, администраторам компании Contoso потребуется настроить и включить репликацию.

### <a name="set-a-replication-goal"></a>Выбор цели репликации

1. В хранилище в разделе с именем хранилища (ContosoVMVault) специалисты компании выбирают цель репликации (**Начало работы** > **Site Recovery** > **Подготовка инфраструктуры**.
2. Они указывают, что их машины расположены в локальной среде, работают в VMware, и их необходимо реплицировать в Azure.

    ![Цель репликации](./media/contoso-migration-rehost-vm/replication-goal.png)

### <a name="confirm-deployment-planning"></a>Подтверждение планирования развертывания

Для продолжения они должны подтвердить, что они завершили планирование развертывания. Для этого им необходимо щелкнуть пункт **Да, выполнено**. В этом сценарии компания Contoso переносит только две виртуальные машины, поэтому ей не нужно планировать развертывание.


### <a name="set-up-the-source-environment"></a>Настройка исходной среды

Теперь администраторы Contoso должны настроить исходную среду. Для этого специалисты скачивают шаблон OVF и с его помощью развертывают сервер конфигурации Site Recovery в качестве локальной виртуальной машины VMware с высокой доступностью. После настройки и запуска сервера конфигурации сотрудники компании должны зарегистрировать его в хранилище.

На сервере конфигурации выполняется ряд компонентов.

- Компонент сервера конфигурации, который используется для координации обмена данными между локальным источником и Azure, а также для управления репликацией данных.
- Сервер обработки, который действует как шлюз репликации. Он получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования, а затем отправляет эти данные в службу хранилища Azure.
- Сервер обработки также устанавливает службу Mobility Service на виртуальных машинах, которые требуется реплицировать, и выполняет автоматическое обнаружение локальных виртуальных машин VMware.



Администраторы Contoso делают это следующим образом:

1. В хранилище они скачивают шаблон OVF в разделе **Подготовка инфраструктуры** > **Источник** > **Сервер конфигурации**.
    
    ![Скачивание OVF](./media/contoso-migration-rehost-vm/add-cs.png)

2. Они импортируют шаблон в VMware, чтобы создать и развернуть виртуальную машину.

    ![Шаблон OVF](./media/contoso-migration-rehost-vm/vcenter-wizard.png)

3.  При первом включении виртуальная машина загружается в среду установки Windows Server 2016. Специалисты компании принимают условия лицензионного соглашения и вводят пароль администратора.
4. После установки они входят в виртуальную машину от имени администратора. При первом входе в систему по умолчанию запускается средство настройки Azure Site Recovery.
5. В этом средстве они указывают имя для регистрации сервера конфигурации в хранилище.
6. Средство проверяет, может ли виртуальная машина подключиться к Azure. После создания подключения они входят систему в подписке Azure. Учетные данные должны иметь доступ к хранилищу, в котором необходимо зарегистрировать сервер конфигурации.

    ![Регистрация сервера конфигурации](./media/contoso-migration-rehost-vm/config-server-register2.png)

7. Средство выполняет некоторые задачи конфигурации, а затем перезагружается.
8. После этого специалисты выполняют повторный вход на компьютер, и мастер управления сервером конфигурации запускается автоматически.
9. В мастере необходимо выбрать сетевой адаптер для приема трафика репликации. После настройки этого параметра его не удастся изменить.
10. Они выбирают подписку, группу ресурсов и хранилище, в котором необходимо зарегистрировать сервер конфигурации.
        ![Хранилище](./media/contoso-migration-rehost-vm/cswiz1.png) 

10. Специалисты компании скачивают и устанавливают MySQL Server и VMWare PowerCLI. 
11. После проверки они указывают FQDN или IP-адрес сервера vCenter либо узла vSphere. Они оставляют порт, используемый по умолчанию, и указывают понятное имя для сервера в Azure.
12. Они указывают учетную запись, которую они создали для автоматического обнаружения, и учетные данные, которые они использовали для автоматической установки Mobility Service. Чтобы можно было работать с компьютерами с ОС Windows, у учетной записи должны быть права локального администратора на виртуальных машинах.

    ![vCenter](./media/contoso-migration-rehost-vm/cswiz2.png)

7. По окончании регистрации на портале Azure сотрудники компании тщательно проверяют, указаны ли серверы конфигурации и VMware на странице **Источник** в хранилище. Обнаружение может занять 15 минут или более. 
8. Затем Site Recovery подключается к серверам VMware, используя указанные параметры, и обнаруживает виртуальные машины.

### <a name="set-up-the-target"></a>Настройка цели

Теперь администраторы компании Contoso вводят параметры репликации для целевой среды.

1. Они выбирают **Подготовка инфраструктуры** > **Цель** и задают параметры целевой среды.
2. Site Recovery проверяет наличие учетной записи хранения Azure и сети в указанном целевом расположении.

### <a name="create-a-replication-policy"></a>Создание политики репликации

Теперь администраторы Contoso могут создать политику репликации.

1. В разделе **Подготовка инфраструктуры** > **Параметры репликации** > **Политика репликации** >  **Create and Associate** (Создать и связать) специалисты компании создают политику **ContosoMigrationPolicy**.
2. При этом они используют параметр по умолчанию.
    - **Пороговое значение RPO**. По умолчанию используется значение 60 минут. Это значение определяет, как часто создаются точки восстановления. Если непрерывная репликация превышает это значение, выдаются оповещения.
    - **Хранение точки восстановления**. По умолчанию используется значение 24 часа. Этим значением определяется продолжительность периода хранения для каждой точки восстановления. Реплицированные виртуальные машины можно восстановить до любой точки в рамках этого периода.
    - **Периодичность создания моментальных снимков с согласованием приложений**. Значение по умолчанию — час. Это значение указывает частоту, с которой система создает моментальные снимки приложений.

        ![Создание политики репликации](./media/contoso-migration-rehost-vm/replication-policy.png)

5. Политика автоматически сопоставляется с сервером конфигурации. 

    ![Связывание политики репликации](./media/contoso-migration-rehost-vm/replication-policy2.png)

### <a name="enable-replication-for-webvm"></a>Включение репликации для WEBVM

Настроив все компоненты, администраторы компании Contoso могут включить репликацию виртуальных машин. Они начинают работу с WebVM.

1. В разделе **Репликация приложений** > **Источник** > **+Выполнить репликацию** они настраивают параметры источника.
2. Они указывают, что они хотят включить виртуальные машины, выбрать сервер vCenter и сервер конфигурации.

    ![Включение репликации](./media/contoso-migration-rehost-vm/enable-replication1.png)

3. Они выбирают параметры цели, в том числе группу ресурсов и сеть Azure, а также учетную запись хранилища.

     ![Включение репликации](./media/contoso-migration-rehost-vm/enable-replication2.png)

4. Они выбирают виртуальную машину **WebVM** для репликации, проверяют политику репликации и включают репликацию.

    - На этом этапе они выбирают только виртуальную машину WEBVM, так как необходимо выбрать виртуальную сеть и подсеть, виртуальные машины приложения размещаются в разных подсетях.
    - Если репликация включена, Site Recovery автоматически устанавливает службу Mobility Service на виртуальной машине.

    ![Включение репликации](./media/contoso-migration-rehost-vm/enable-replication3.png)

5. Они отслеживают ход репликации в разделе **Задания**. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.
6. В разделе **Основные компоненты** на портале Azure они могут просматривать структуру виртуальных машин, реплицируемых в Azure.


### <a name="enable-replication-for-sqlvm"></a>Включение репликации для виртуальной машины SQLVM

Теперь администраторы компании Contoso могут начать репликацию виртуальной машины SQLVM, используя описанный выше процесс.

1. Они выбирают параметры источника.

    ![Включение репликации](./media/contoso-migration-rehost-vm/enable-replication1.png)

2. Затем они указывают параметры цели.

     ![Включение репликации](./media/contoso-migration-rehost-vm/enable-replication2-sqlvm.png)

3. Они выбирают машину SQLVM, которую необходимо реплицировать. 

    ![Включение репликации](./media/contoso-migration-rehost-vm/enable-replication3-sqlvm.png)

4. Они применяют политику репликации, которая была использована для виртуальной машины WEBVM, и включают репликацию.

    ![Представление инфраструктуры](./media/contoso-migration-rehost-vm/essentials.png)

**Нужна дополнительная помощь?**

- Полное пошаговое руководство для этих трех шагов см. в статье [Настройка аварийного восстановления в Azure для локальных виртуальных машин VMware](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial).
- С помощью подробных инструкций вы можете [настроить исходную среду](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-source), [развернуть сервер конфигурации](https://docs.microsoft.com/azure/site-recovery/vmware-azure-deploy-configuration-server) и [настроить параметры репликации](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-replication).
- Вы можете получить дополнительные сведения о том, как [включить репликацию](https://docs.microsoft.com/azure/site-recovery/vmware-azure-enable-replication).


## <a name="step-4-migrate-the-vms"></a>Шаг 4. Миграция виртуальных машин 

Администраторы компании Contoso выполняют быструю тестовую отработку отказа, а затем полную отработку отказа для миграции виртуальных машин.

### <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа

Тестовая отработка отказа позволяет проверить, все ли работает как надо. 

1. Специалисты компании Contoso запускают тестовую отработку отказа для последнего доступного момента времени: **Latest processed** (Последняя обработанная).
2. Они выбирают **Shut down machine before beginning failover** (Завершить работу машины перед началом отработки отказа), поэтому перед запуском отработки отказа Site Recovery пытается завершить работу исходной виртуальной машины. Отработка отказа продолжится, даже если их не удастся отключить. 
3. При тестировании отработки отказа происходит следующее: 

    - выполняется проверка на соблюдение всех необходимых условий для миграции;
    - операция отработки отказа обрабатывает данные для создания виртуальной машины Azure; если выбрана последняя точка восстановления, на основе данных создается точка восстановления;
    - создается виртуальная машина Azure с использованием данных, обработанных на предыдущем шаге.
    
3. По завершении отработки отказа на портале Azure появится реплика виртуальной машины Azure. Они проверяют, работает ли виртуальная машина, имеет ли она соответствующий размер и подключена ли к соответствующей сети. 
4. После проверки тестовой отработки отказа они удаляют результаты отработки отказа, записывают и сохраняют все наблюдения. 

### <a name="create-and-customize-a-recovery-plan"></a>Создание и настройка плана восстановления

 Убедившись, что тестовая отработка отказа выполнена правильно, администраторы компании Contoso создают план восстановления для миграции. 

- План восстановления определяет порядок отработки отказа и указывает, каким образом необходимо сделать виртуальные машины Azure доступными в Azure.
- Так как для приложения используется два уровня, специалисты компании настраивают план восстановления таким образом, чтобы виртуальная машина с данными (SQLVM) запускалась, прежде чем запустится интерфейсная виртуальная машина (WEBVM).

1. В разделе **Recovery Plans (Site Recovery) (Планы восстановления (Site Recovery))** > **+План восстановления** они создают план и добавляют в него виртуальные машины.

    ![План восстановления](./media/contoso-migration-rehost-vm/recovery-plan.png)

2. После создания плана специалисты компании настраивают его (**Планы восстановления** > **SmartHotelMigrationPlan** > **Настройка**).
2.  Они удаляют виртуальную машину WEBVM из раздела **Группа 1: запуск**.  Благодаря этому при первом действии запуска будет затронута только виртуальная машина SQLVM.
3.  В разделе **+Группа** > **Добавить защищенные элементы** они добавляют виртуальную машину WEBVM в раздел "Группа 2: запуск".  Виртуальные машины должны находиться в двух различных группах.


### <a name="migrate-the-vms"></a>Миграция виртуальных машин


Теперь администраторы компании Contoso могут выполнить полную отработку отказа, чтобы завершить миграцию.

1. Они выбирают план восстановления, затем щелкают **Отработка отказа**.
2. Они выполняют отработку отказа до последней точки восстановления, и, прежде чем запустить отработку отказа, Site Recovery пытается завершить работу виртуальных машин. Они могут отслеживать ход отработки отказа на странице **Задания**.

    ![Отработка отказа](./media/contoso-migration-rehost-vm/failover1.png)


3. После отработки отказа специалисты компании проверяют, отображается ли виртуальная машина Azure должным образом на портале Azure.

    ![Отработка отказа](./media/contoso-migration-rehost-vm/failover2.png)  

3. После проверки специалисты компании завершают миграцию для каждой виртуальной машины. В результате будет остановлена репликация виртуальных машин, и Site Recovery перестанет начислять плату за эту операцию.

    ![Отработка отказа](./media/contoso-migration-rehost-vm/failover3.png)

**Нужна дополнительная помощь?**

- [Узнайте, как](https://docs.microsoft.com/azure/site-recovery/tutorial-dr-drill-azure) выполнить тестовую отработку отказа. 
- [Узнайте](https://docs.microsoft.com/azure/site-recovery/site-recovery-create-recovery-plans), как создать план восстановления.
- [Узнайте, как](https://docs.microsoft.com/azure/site-recovery/site-recovery-failover) выполнить отработку отказа в Azure.

## <a name="clean-up-after-migration"></a>Очистка после миграции

По завершении миграции уровни приложения SmartHotel360 работают на виртуальных машинах Azure.

Теперь специалистам компании Contoso необходимо выполнить указанные ниже действия по очистке.  

- Удалить машину WEBVM из перечня в vCenter.
- Удалить машину SQLVM из перечня в vCenter.
- Удалить машины WEBVM и SQLVM из локальных заданий резервного копирования.
- Обновить внутренние документы и отразить в них новое расположение и IP-адреса виртуальных машин.
- Проверить все ресурсы, взаимодействующие с виртуальными машинами, и обновить все соответствующие параметры или документы согласно новой конфигурации.

## <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда приложение работает, компании Contoso необходимо полностью ввести его в эксплуатацию и защитить его в Azure.

### <a name="security"></a>Безопасность

Специалисты по безопасности компании Contoso проверяют виртуальные машины Azure, чтобы выявить любые проблемы безопасности.

- Чтобы можно было управлять доступом, команда проверяет группы безопасности сети (NSG) для виртуальных машин. NSG используются, чтобы в приложение поступал только разрешенный для него трафик.
- Команда также рассматривает возможность защиты данных на диске с использованием шифрования дисков Azure и KeyVault.

[Узнайте больше](https://docs.microsoft.com/azure/security/azure-security-best-practices-vms#vm-authentication-and-access-control) о рекомендациях по обеспечению безопасности виртуальных машин.

## <a name="bcdr"></a>Непрерывность бизнес-процессов и аварийное восстановление

Чтобы обеспечить непрерывность бизнес-процессов и аварийное восстановление (BCDR), Contoso выполняет следующие действия:

- Безопасное хранение данных. Специалисты Contoso выполняют резервное копирование данных, содержащихся в виртуальных машинах, с помощью службы Azure Backup. [Узнайте больше](https://docs.microsoft.com/azure/backup/backup-introduction-to-azure-backup?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).
- Поддержание работы приложений. Специалисты компании Contoso реплицируют виртуальные машины приложения в дополнительный регион Azure с помощью Site Recovery. [Узнайте больше](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-quickstart).



### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

1. У компании Contoso имеются лицензии на виртуальные машины, и она воспользуется Преимуществом гибридного использования Azure.  Contoso выполнит преобразование имеющихся виртуальных машин Azure, чтобы использовать льготные расценки.
2. Компания будет использовать Управление затратами Azure по лицензии Cloudyn (дочернее подразделение корпорации Майкрософт). Это решение по управлению затратами для нескольких облаков, с помощью которого можно использовать Azure и другие облачные ресурсы, а также управлять ими. Дополнительные сведения об управлении расходами см. [на этой странице](https://docs.microsoft.com/azure/cost-management/overview). 

## <a name="conclusion"></a>Заключение

В этой статье рассказано, как компания Contoso повторно разместила приложение SmartHotel360 в Azure путем миграции виртуальных машин приложения в виртуальные машины Azure с помощью службы Site Recovery. 


## <a name="next-steps"></a>Дополнительная информация

В [следующей статье](contoso-migration-rehost-vm-sql-ag.md) этой серии мы расскажем, как компания Contoso повторно размещает интерфейсные виртуальные машины приложения SmartHotel360 в виртуальной машине Azure и выполняет миграцию базы данных в группу доступности AlwaysOn SQL Server в Azure.

