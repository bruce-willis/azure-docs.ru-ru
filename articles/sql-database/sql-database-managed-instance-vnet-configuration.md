---
title: Конфигурация виртуальной сети для Управляемого экземпляра Базы данных SQL Azure | Документация Майкрософт
description: В этой статье описываются параметры конфигурации виртуальной сети (VNet) для Управляемого экземпляра Базы данных SQL Azure.
services: sql-database
ms.service: sql-database
ms.subservice: managed-instance
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: srdan-bozovic-msft
ms.author: srbozovi
ms.reviewer: bonova, carlrab
manager: craigg
ms.date: 09/20/2018
ms.openlocfilehash: 9d3f867dad40017e8e97ec4f5e370533b018263c
ms.sourcegitcommit: 5b8d9dc7c50a26d8f085a10c7281683ea2da9c10
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/26/2018
ms.locfileid: "47181181"
---
# <a name="configure-a-vnet-for-azure-sql-database-managed-instance"></a>Настройка виртуальной сети для Управляемого экземпляра Базы данных SQL Azure

Управляемый экземпляр Базы данных SQL Azure необходимо развернуть в [виртуальной сети](../virtual-network/virtual-networks-overview.md) Azure. Это развертывание поддерживает следующие сценарии: 
- Подключение к управляемому экземпляру непосредственно из локальной сети 
- Подключение управляемого экземпляра к связанному серверу или другому локальному хранилищу данных 
- Подключение управляемого экземпляра к ресурсам Azure  

## <a name="plan"></a>План

Составьте план по развертыванию управляемого экземпляра в виртуальной сети в соответствии с ответами на следующие вопросы: 
- Сколько управляемых экземпляров вы планируете развертывать: один или несколько? 

  От числа управляемых экземпляров зависит минимальный размер подсети для их размещения. Дополнительные сведения см. в разделе [Определение размера подсети для управляемого экземпляра](#determine-the-size-of-subnet-for-managed-instances). 
- Будет ли управляемый экземпляр развернут в имеющейся виртуальной сети или же вы создадите для него новую? 

   Если вы планируете использовать имеющуюся виртуальную сеть, необходимо изменить ее конфигурацию, чтобы она соответствовала управляемому экземпляру. Дополнительные сведения см. в разделе [Изменение существующей виртуальной сети для управляемого экземпляра](#modify-an-existing-virtual-network-for-managed-instances). 

   Если вы планируете создать виртуальную сеть, см. раздел [Создание виртуальной сети для управляемого экземпляра](#create-a-new-virtual-network-for-a-managed-instance).

## <a name="requirements"></a>Требования

Чтобы создать Управляемый экземпляр, создайте выделенную подсеть (подсеть Управляемого экземпляра) в виртуальной сети, которая соответствует следующим требованиям:
- **Выделенная подсеть.** С подсетью Управляемого экземпляра не должны быть связаны другие облачные службы, и она не должна быть подсетью шлюза. Вы не сможете создать Управляемый экземпляр в подсети, если в ней содержатся другие ресурсы, кроме Управляемого экземпляра, а также не сможете позже добавить в такую подсеть другие ресурсы.
- **Совместимые группы безопасности сети (NSG).** Группы безопасности сети, связанные с подсетью Управляемого экземпляра, должны содержать также правила, приведенные в таблицах ниже ("Обязательные правила безопасности для входящего трафика" и "Обязательные правила безопасности для исходящего трафика"). Вы можете использовать группу безопасности сети для полного контроля доступа к конечной точке данных Управляемого экземпляра путем фильтрации трафика через порт 1433. 
- **Таблица совместимых определяемых пользователем маршрутов (UDR).** В подсети Управляемого экземпляра должна быть пользовательская таблица маршрутов с **интернет-маршрутом следующего прыжка 0.0.0.0/0** , установленным в качестве обязательного определяемого пользователем маршрута. Кроме того, можно добавить определяемый пользователем маршрут, который передает трафик с локальных частных IP-адресов в качестве назначения через шлюз виртуальной сети или виртуальное сетевое устройство (NVA). 
- **Наличие необязательной пользовательской DNS**. Если в виртуальной сети определен пользовательский DNS-сервер, то в список должен быть добавлен IP-адрес рекурсивных сопоставителей Azure (например, 168.63.129.16). Дополнительные сведения см. в статье [Configuring a Custom DNS for Azure SQL Database Managed Instance](sql-database-managed-instance-custom-dns.md) (Настройка пользовательской DNS для Управляемого экземпляра Базы данных SQL Azure). Пользовательский DNS-сервер должен иметь возможность разрешать имена узлов в следующих доменах и их дочерних доменах: *microsoft.com*, *windows.net*, *windows.com*, *msocsp.com*, *digicert.com*, *live.com*, *microsoftonline.com* и *microsoftonline-p.com*. 
- **Отсутствие конечной точки службы.** С подсетью Управляемого экземпляра не должна быть связана конечная точка службы. При создании виртуальной сети отключите параметр "Конечные точки службы".
- **Достаточно IP-адресов.** В подсети Управляемого экземпляра должно быть как минимум 16 IP-адресов (рекомендуемый минимум — 32 IP-адреса). Дополнительные сведения см. в разделе [Определение размера подсети для управляемого экземпляра](#determine-the-size-of-subnet-for-managed-instances).

> [!IMPORTANT]
> Если целевая подсеть не соответствует перечисленным выше требованиям, в ней невозможно развернуть Управляемый экземпляр. *Политика намерений сети*, которая применяется в подсети, позволяет предотвратить несоответствующие изменения в конфигурации сети во время создания Управляемого экземпляра. *Эта политика* удаляется после удаления последнего экземпляра из подсети.

### <a name="mandatory-inbound-security-rules"></a>Обязательные правила безопасности для входящего трафика 

| ИМЯ       |ПОРТ                        |ПРОТОКОЛ|ИСТОЧНИК           |НАЗНАЧЕНИЕ|ДЕЙСТВИЕ|
|------------|----------------------------|--------|-----------------|-----------|------|
|управление  |9000, 9003, 1438, 1440, 1452|TCP     |Любой              |Любой        |РАЗРЕШИТЬ |
|mi_subnet   |Любой                         |Любой     |MI SUBNET        |Любой        |РАЗРЕШИТЬ |
|health_probe|Любой                         |Любой     |AzureLoadBalancer|Любой        |РАЗРЕШИТЬ |

### <a name="mandatory-outbound-security-rules"></a>Обязательные правила безопасности для исходящего трафика 

| ИМЯ       |ПОРТ          |ПРОТОКОЛ|ИСТОЧНИК           |НАЗНАЧЕНИЕ|ДЕЙСТВИЕ|
|------------|--------------|--------|-----------------|-----------|------|
|управление  |80, 443, 12000|TCP     |Любой              |Любой        |РАЗРЕШИТЬ |
|mi_subnet   |Любой           |Любой     |Любой              |MI SUBNET  |РАЗРЕШИТЬ |

##  <a name="determine-the-size-of-subnet-for-managed-instances"></a>Определение размера подсети для управляемого экземпляра

При создании Управляемого экземпляра Azure размещает несколько виртуальных машин, число которых зависит от уровня, выбранного во время подготовки. Поскольку виртуальные машины связанны с подсетью, им необходимы IP-адреса. Azure может выделить дополнительные виртуальные машины для обеспечения высокой доступности во время выполнения обычных операций и технического обслуживания. В результате число необходимых IP-адресов будет больше, чем число управляемых экземпляров в подсети. 

Для управляемого экземпляра необходимо не менее 16 и не более 256 IP-адресов в подсети. Поэтому при определении IP-адресов подсети для маски подсети можно использовать значения от /28 до /24. 

> [!IMPORTANT]
> Подсеть с 16-ю IP-адресами является абсолютным минимумом и обладает ограниченным потенциалом для дальнейшего развертывания Управляемого экземпляра. Настоятельно рекомендуется выбирать подсети с префиксом /27 или ниже. 

Если планируется развертывать несколько управляемых экземпляров внутри подсети и при этом необходимо оптимизировать размер подсети, для расчета нужно использовать такие параметры: 

- Azure использует пять IP-адресов в подсети для своих потребностей 
- Каждому экземпляру общего назначения требуются два адреса 
- Каждому критически важному для бизнеса экземпляру требуются четыре адреса.

**Пример**. Вы планируете использовать три экземпляра общего назначения и два критически важных для бизнеса экземпляра. Это означает, что требуется 5 + 3 * 2 + 2 * 4 = 19 IP-адресов. Поскольку диапазоны IP-адресов определяются как значения в степени 2, вам потребуется диапазон из 32 (2 ^ 5) IP-адресов. Таким образом, необходимо зарезервировать подсеть с маской подсети /27. 

> [!IMPORTANT]
> Вычисления, показанные выше, устареют с выпуском дополнительных усовершенствований. 

## <a name="create-a-new-virtual-network-for-a-managed-instance"></a>Создание виртуальной сети для Управляемого экземпляра

Самый простой способ создания и настройки виртуальной сети — использовать шаблон развертывания Azure Resource Manager.

1. Войдите на портал Azure.

2. Используйте кнопку **Развертывание в Azure**, чтобы развернуть виртуальную сеть в облаке Azure.

  <a target="_blank" href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fazure-quickstart-templates%2Fmaster%2F101-sql-managed-instance-azure-environment%2Fazuredeploy.json" rel="noopener" data-linktype="external"> <img src="http://azuredeploy.net/deploybutton.png" data-linktype="external"> </a>

  Эта кнопка откроет форму, которую можно использовать для настройки сетевой среды, в которой можно развернуть управляемый экземпляр.

  > [!Note]
  > Этот шаблон Azure Resource Manager развертывает виртуальную сеть с двумя подсетями. Одна подсеть, называемая **ManagedInstances**, зарезервирована для управляемых экземпляров и имеет предварительно настроенную таблицу маршрутов, а другая подсеть, называемая **Defaul**, используется для других ресурсов, которые должны получить доступ к управляемому экземпляру (например, виртуальные машины Azure). Вы можете удалить подсеть **Default**, если она не нужна.

3. Настройка сетевой среды. В приведенной ниже форме можно настроить параметры сетевой среды.

![Настройка сети Azure](./media/sql-database-managed-instance-vnet-configuration/create-mi-network-arm.png)

Вы можете изменить имена виртуальной сети и подсетей и настроить диапазоны IP-адресов, связанные с сетевыми ресурсами. Как только вы нажмете кнопку "Купить", эта форма создаст и настроит вашу среду. Если вам не нужны две подсети, можно удалить подсеть, заданную по умолчанию. 

## <a name="modify-an-existing-virtual-network-for-managed-instances"></a>Изменение существующей виртуальной сети для управляемого экземпляра 

Просмотрев вопросы и ответы в этом разделе, вы узнаете, как добавить управляемый экземпляр в существующую виртуальную сеть. 

**Какая модель используется для развертывания существующей виртуальной сети: классическая или развертывание с помощью Resource Manager?** 

Управляемый экземпляр можно создать только в виртуальных сетях Resource Manager. 

**Вы хотите создать подсеть для управляемого экземпляра SQL или использовать имеющуюся?**.

Перед созданием подсети сделайте следующее: 

- Вычислите размер подсети, следуя инструкциям из раздела [Определение размера подсети для управляемого экземпляра](#determine-the-size-of-subnet-for-managed-instances).
- Следуйте инструкциям из статьи [Создание, изменение или удаление виртуальной сети](../virtual-network/virtual-network-manage-subnet.md). 
- Создайте таблицу маршрутов, которая содержит одну запись **0.0.0.0/0** в качестве интернет-маршрута следующего прыжка и свяжите ее с подсетью управляемого экземпляра.  

Если вы хотите создать Управляемый экземпляр внутри существующей подсети, мы рекомендуем использовать следующий сценарий PowerShell для подготовки подсети.
```powershell
$scriptUrlBase = 'https://raw.githubusercontent.com/Microsoft/sql-server-samples/master/samples/manage/azure-sql-db-managed-instance/prepare-subnet'

$parameters = @{
    subscriptionId = '<subscriptionId>'
    resourceGroupName = '<resourceGroupName>'
    virtualNetworkName = '<virtualNetworkName>'
    subnetName = '<subnetName>'
    }

Invoke-Command -ScriptBlock ([Scriptblock]::Create((iwr ($scriptUrlBase+'/prepareSubnet.ps1?t='+ [DateTime]::Now.Ticks)).Content)) -ArgumentList $parameters
```
Подготовка подсети выполняется в три простых шага:

- Проверка. Выбранная виртуальная сеть и подсеть проверяются на соответствие сетевым требованиям Управляемого экземпляра.
- Подтверждение. Пользователю предоставляется набор изменений, которые необходимо выполнить, чтобы подготовить подсеть для развертывания Управляемого экземпляра, и он получает запрос на согласие.
- Подготовка. Виртуальная сеть и подсеть настраиваются надлежащим образом.

**Настроен ли у вас пользовательский сервер DNS?** 

Если ответ утвердительный, см. статью [Configuring a Custom DNS for Azure SQL Database Managed Instance](sql-database-managed-instance-custom-dns.md) (Настройка пользовательской DNS для Управляемого экземпляра Базы данных SQL Azure). 

## <a name="next-steps"></a>Дополнительная информация

- Дополнительные сведения см. в статье [Общие сведения об Управляемом экземпляре Базы данных SQL Azure (предварительная версия)](sql-database-managed-instance.md).
- Чтобы узнать как создать виртуальную сеть и управляемый экземпляр, а также восстановить базу данных из резервной копии базы данных см. статью [Создание Управляемого экземпляра Базы данных SQL Azure на портале Azure](sql-database-managed-instance-get-started.md).
- Во избежание проблем при настройке DNS см. статью [Configuring a Custom DNS for Azure SQL Database Managed Instance](sql-database-managed-instance-custom-dns.md) (Настройка пользовательской DNS для Управляемого экземпляра Базы данных SQL Azure)
