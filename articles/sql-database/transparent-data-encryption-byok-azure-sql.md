---
title: Прозрачное шифрование данных — создание собственных ключей (BYOK) — База данных Azure SQL | Документация Майкрософт
description: Поддержка создания собственных ключей для прозрачного шифрования данных в Azure Key Vault для Базы данных SQL и хранилища данных SQL. Обзор TDE с поддержкой BYOK, преимущества, принцип работы, замечания и рекомендации.
keywords: ''
services: sql-database
documentationcenter: ''
author: aliceku
manager: craigg
ms.prod: ''
ms.reviewer: vanto
ms.suite: sql
ms.prod_service: sql-database, sql-data-warehouse
ms.service: sql-database
ms.custom: ''
ms.tgt_pltfrm: ''
ms.topic: conceptual
ms.date: 08/30/2018
ms.author: aliceku
monikerRange: = azuresqldb-current || = azure-sqldw-latest || = sqlallproducts-allversions
ms.openlocfilehash: d87747e60c375f844681ed6cfd40dba84f46a9b2
ms.sourcegitcommit: 32d218f5bd74f1cd106f4248115985df631d0a8c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2018
ms.locfileid: "46963617"
---
# <a name="transparent-data-encryption-with-bring-your-own-key-support-for-azure-sql-database-and-data-warehouse"></a>Прозрачное шифрование данных с поддержкой использования собственных ключей для Базы данных SQL Azure и Хранилища данных SQL Azure.

Поддержка создания собственных ключей (BYOK) для [прозрачного шифрования данных (TDE)](https://docs.microsoft.com/sql/relational-databases/security/encryption/transparent-data-encryption) позволяет зашифровать ключ шифрования базы данных (DEK) с помощью асимметричного ключа, который называется предохранителем TDE.  Предохранитель TDE находится под вашим управлением и сохраняется в [Azure Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-secure-your-key-vault) — облачной системе Azure для управления внешними ключами. Azure Key Vault — это первая служба управления ключами, для которой в TDE интегрирована поддержка BYOK. Ключ шифрования TDE, который хранится на загрузочной странице базы данных, шифруется и расшифровывается с помощью предохранителя TDE. Предохранитель TDE хранится в Azure Key Vault и никогда не покидает пределы этого хранилища ключей. Если будет отменен доступ сервера к хранилищу ключей, он потеряет возможность расшифровывать и считывать в память базу данных.  Предохранитель TDE настраивается на уровне логического сервера и наследуется всеми базами данных, связанными с этим сервером. 

Теперь благодаря поддержке BYOK пользователи могут самостоятельно управлять ключами и выполнять через Azure Key Vault такие операции, как смена ключей, настройка разрешений для хранилища ключей, удаление ключей и (или) включение аудита и отчетности по всем предохранителям TDE. Key Vault поддерживает централизованное управление ключами, использует тщательно отслеживаемые аппаратные модули безопасности (HSM) и позволяет разделять обязанности по управлению ключами и данными, что позволяет обеспечить соответствие законодательным нормам.  


TDE с поддержкой BYOK обеспечивает следующие преимущества:
- более высокая прозрачность и точность контроля с возможностью самостоятельно управлять предохранителем TDE;   
- централизованное управление предохранителями TDE (а равно и другими ключами и секретами для всех остальных служб Azure) благодаря их размещению в Key Vault;
- разделение обязанностей по управлению ключами и данными в организации;
- повышение доверия со стороны клиентов, так как принцип работы Key Vault не позволяет сотрудникам Майкрософт видеть или извлекать ключи шифрования; 
- поддержка смены ключей.

> [!IMPORTANT]
> Для тех, кто использует TDE под управлением службы и намерен перейти на работу с Key Vault, все функции TDE сохраняются в процессе перехода на предохранитель TDE в Key Vault. Не потребуется никаких остановок в работе или повторного шифрования файлов базы данных. Для перехода с управляемого службой ключа на ключ Key Vault достаточно лишь заново зашифровать ключ шифрования базы данных (DEK). Эта операция выполняется в через Интернет и не занимает много времени. 
>

## <a name="how-does-tde-with-byok-support-work"></a>Как работает TDE с поддержкой BYOK?
 
![Аутентификация сервера в Key Vault](./media/transparent-data-encryption-byok-azure-sql/tde-byok-server-authentication-flow.PNG)

Когда вы впервые настраиваете для TDE использование предохранителя из Key Vault, сервер отправляет в Key Vault ключи шифрования от всех баз данных, поддерживающих TDE, чтобы создать запрос на упаковку ключа. Key Vault возвращает ключ шифрования для зашифрованной базы данных, и этот ключ сохраняется в базе данных пользователя.  

>[!IMPORTANT]
>Здесь важно отметить, что **сохраненный в Azure Key Vault предохранитель TDE никогда не покидает пределы Azure Key Vault**. Логический сервер может только отправлять запросы на операции с ключом, которые выполняются с материалом ключа для предохранителя TDE в пределах Key Vault, но **никогда не получает доступ к самому предохранителю TDE и не кэширует его**. Администратор Key Vault имеет право в любой момент отменить разрешения Key Vault для сервера, и в этом случае все подключения к этому серверу разрываются. 
>


## <a name="guidelines-for-configuring-tde-with-byok"></a>Рекомендации по настройке TDE с поддержкой BYOK

### <a name="general-guidelines"></a>Общие рекомендации
- Убедитесь, что Azure Key Vault и База данных SQL Azure размещаются в одном клиенте.  Взаимодействие между хранилищем ключей и сервером, размещенными в разных клиентах, **не поддерживается**.
- Заранее определите, какие подписки вы будете использовать для необходимых ресурсов. Для перемещения сервера в другую подписку потребуется заново настроить TDE с поддержкой BYOK. Дополнительные сведения [о перемещении ресурсов](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-move-resources).
- При настройке TDE с поддержкой BYOK важно учитывать нагрузку на хранилище ключей, которая будет создаваться в результате повторяющихся операций упаковки и распаковки. Например, все базы данных, связанные с одним логическим сервером, используют один предохранитель TDE, а значит при отработке отказа для этого сервера будет активировано столько операций с ключами в хранилище, сколько баз данных хранится на этом сервере. Исходя из нашего опыта и задокументированных [ограничений для службы хранилища ключей](https://docs.microsoft.com/azure/key-vault/key-vault-service-limits) рекомендуем связывать с Azure Key Vault в одной подписке не более 500 баз данных категории "Стандартный" или "Общего назначения" или не более 200 баз данных категории "Премиум" или "Критически важный для бизнеса". Это позволит поддерживать стабильно высокий уровень доступности при обращении к предохранителю TDE в хранилище ключей. 
- Рекомендация. Сохраняйте локальную копию предохранителя TDE.  Для этого потребуется устройство HSM, на котором вы создадите локальную версию предохранителя TDE, и система депонирования ключей для хранения этой локальной копии предохранителя TDE.  Узнайте, [как передать ключ из локального модуля HSM в Azure Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-hsm-protected-keys).


### <a name="guidelines-for-configuring-azure-key-vault"></a>Рекомендации по настройке Azure Key Vault

- Создайте хранилище ключей с поддержкой [обратимого удаления](https://docs.microsoft.com/azure/key-vault/key-vault-ovw-soft-delete), чтобы избежать полной потери данных при случайном удалении ключа или хранилища ключей.  Для [включения свойства обратимого удаления необходимо использовать PowerShell](https://docs.microsoft.com/azure/key-vault/key-vault-soft-delete-powershell), так как оно пока не поддерживается на портале AKV, но является обязательным для SQL:  
  - При обратимом удалении ресурсы сохраняются в течение определенного периода времени (90 дней), если не будут восстановлены или очищены раньше.
  - Для действий **восстановления** и **очистки** в политике доступа хранилища ключей заданы собственные разрешения. 
- Установите блокировку ресурсов для хранилища ключей, чтобы управлять правами на удаление этого критически важного ресурса и предотвратить случайное или несанкционированное удаление.  [Дополнительная информация о блокировке ресурсов](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-lock-resources)

- Предоставьте логическому серверу доступ к хранилищу ключей с помощью удостоверения Azure Active Directory (Azure AD).  При использовании пользовательского интерфейса портала удостоверение Azure AD, которое предоставляет серверу права доступа к хранилищу ключей, создается автоматически.  Если вы настраиваете TDE с поддержкой BYOK через PowerShell, удостоверение Azure AD нужно создать отдельно и проверить успешность его создания. Подробные пошаговые инструкции по настройке TDE с поддержкой BYOK с помощью PowerShell см. в [этой статье](transparent-data-encryption-byok-azure-sql-configure.md).

  >[!NOTE]
  >Если политика доступа хранилища ключей приведет к **случайному удалению удостоверения Azure AD или отмене разрешений сервера**, этот сервер потеряет доступ к хранилищу ключей, а базы данных, зашифрованные с помощью TDE, будут удалены в течение 24 часов.
  >

- Не используйте виртуальные сети и (или) брандмауэры при настройке Azure Key Vault.  Если SQL потеряет доступ к хранилищу ключей, все базы данных, зашифрованные с помощью TDE, будут удалены в течение 24 часов.
- Включите аудит и отчеты для всех ключей шифрования. Key Vault предоставляет журналы, которые легко можно передать в любые средства управления информационной безопасностью и событиями безопасности (SIEM). Например, они уже интегрированы в службу [Log Analytics](https://docs.microsoft.com/azure/log-analytics/log-analytics-azure-key-vault) из Operations Management Suite (OMS).
- Чтобы обеспечить высокий уровень доступности для зашифрованных баз данных, настройте для каждого логического сервера два экземпляра Azure Key Vault в разных регионах.


### <a name="guidelines-for-configuring-the-tde-protector-asymmetric-key-stored-in-azure-key-vault"></a>Рекомендации по настройке предохранителя TDE (асимметричного ключа), который хранится в Azure Key Vault

- Создайте ключ шифрования на локальном устройстве HSM. Это должен быть асимметричный ключ RSA 2048, который можно хранить в Azure Key Vault.
- Передайте ключ в систему депонирования ключей.  
- Импортируйте файл ключа шифрования (в формате PFX, BYOK или BACKUP) в Azure Key Vault. 
    

>[!NOTE] 
    >Для целей тестирования можно создать ключ прямо в Azure Key Vault, но такой ключ нельзя сохранить в локальной системе депонирования, так как закрытый ключ никогда не покидает хранилище ключей.  Всегда создавайте резервные копии ключей, используемых для шифрования рабочих данных, и помещайте их в систему депонирования, так как потеря такого ключа (при случайном удалении из хранилища ключей, истечении срока действия и т. п.) приведет к безвозвратной потере данных.
    >
    
- Используйте ключ без определенного срока действия и никогда не изменяйте срок действия для уже используемого ключа. **При истечении срока действия ключа все зашифрованные базы данных теряют доступ к предохранителю TDE и удаляются в течение 24 часов**.
- Убедитесь, что ключ включен и имеет разрешения на операции *получения*, *упаковки* и *распаковки ключа*.
- Создайте резервную копию ключа, сохраненного в Azure Key Vault, перед первым его использованием. См. дополнительные сведения о команде [Backup-AzureKeyVaultKey](https://docs.microsoft.com/powershell/module/azurerm.keyvault/backup-azurekeyvaultkey?view=azurermps-5.1.1).
- Создавайте резервную копию ключа при каждом изменении в его параметрах (при добавлении списков управления доступом, тегов, атрибутов и т. п.).
- **Сохраняйте предыдущие версии** ключа в хранилище ключей при смене ключа, чтобы сохранить возможность восстановления из старых резервных копий базы данных. Когда для базы данных изменяется предохранитель TDE, старые резервные копии базы данных **не обновляются** до последней версии предохранителя TDE.  Для восстановления любой резервной копии нужно использовать тот предохранитель TDE, с которым она создавалась. Чтобы правильно сменить ключ, используйте инструкции из [этой статьи](transparent-data-encryption-byok-azure-sql-key-rotation.md).
- Сохраните все использовавшиеся ранее ключи в Azure Key Vault, если снова перейдете к управляемым службой ключами.  Это обеспечит возможность восстановить резервные копии баз данных, созданных с предохранителями TDE из Azure Key Vault.  Предохранители TDE, созданные в Azure Key Vault, следует сохранять до тех пор, пока сохраняются созданные с ними резервные копии.  
- Создайте восстанавливаемые резервные копии этих ключей с помощью [Backup-AzureKeyVaultKey](https://docs.microsoft.com/powershell/module/azurerm.keyvault/backup-azurekeyvaultkey?view=azurermps-5.1.1).
- Чтобы без риска потери данных удалить ключ, который мог быть скомпрометирован в результате инцидента безопасности, следуйте инструкциям из [этой статьи](transparent-data-encryption-byok-azure-sql-remove-tde-protector.md).


## <a name="high-availability-geo-replication-and-backup--restore"></a>Высокая доступность, георепликация, резервное копирование и восстановление

### <a name="high-availability-and-disaster-recovery"></a>Высокий уровень доступности и аварийное восстановление

Настройка высокого уровня доступности в Azure Key Vault может выполняться по-разному в зависимости от конфигурации базы данных и логического сервера. Ниже приведены рекомендуемые конфигурации для двух разных случаев.  Первый вариант — для автономной базы данных или логического сервера без геоизбыточности.  Второй вариант подразумевает, что для базы данных или логического сервера настроены группы отработки отказа или геоизбыточность, при этом для каждой геоизбыточной копии требуется локальное хранилище Azure Key Vault в пределах группы отработки отказа для правильной отработки географически распределенных отказов. В первом случае высокий уровень доступности для базы данных и логического сервера без геоизбыточности можно настроить, создав для сервера в двух разных регионах два разных хранилища ключей, в которых будет храниться одинаковый материал ключей.  Для этого создайте предохранитель TDE в первичном хранилище ключей, которое находится в одном регионе с логическим сервером, и клонируйте этот ключ в хранилище ключей в другом регионе Azure. Теперь сервер сможет использовать вторичное хранилище ключей, если с первичным возникнут проблемы в процессе работы базы данных. Используйте командлет Backup-AzureKeyVaultKey, чтобы извлечь из первичного хранилища ключ в зашифрованном формате, а затем выполните командлет Restore-AzureKeyVaultKey, указав хранилище ключей во втором регионе.


![Высокий уровень доступности с одним сервером и без географического аварийного восстановления](./media/transparent-data-encryption-byok-azure-sql/SingleServer_HA_Config.PNG)

## <a name="how-to-configure-geo-dr-with-azure-key-vault"></a>Настройка географического аварийного восстановления для Azure Key Vault

Чтобы сохранить высокий уровень доступности для предохранителей TDE, используемых для зашифрованных баз данных, следует настроить избыточные хранилища Azure Key Vault в существующих или создаваемых группах отработки отказа Базы данных SQL или экземпляры активной георепликации.  Каждый геореплицированный сервер должен иметь отдельное хранилище ключей, размещенное в том же регионе Azure, что и сервер. Если база данных-источник станет недоступной из-за сбоя в одном регионе, то после отработки отказа база данных-получатель сможет взять работу на себя, используя вторичное хранилище ключей. 
 
Для геореплицированных баз данных SQL Azure необходима следующая конфигурация Azure Key Vault:
- Одна база данных-источник с хранилищем ключей в том же регионе и одна база данных-получатель хранилищем ключей в том же регионе. 
- Должно существовать не менее одной и не более четырех баз данных-получателей. 
- Вторичные реплики баз данных-получателей (создание цепочек) не поддерживаются.

В следующем разделе будут более подробно рассмотрены процессы установки и настройки. 

### <a name="azure-key-vault-configuration-steps"></a>Действия по настройке Azure Key Vault

- Установите [PowerShell](https://docs.microsoft.com/powershell/azure/install-azurerm-ps?view=azurermps-5.6.0). 
- Создайте два хранилища Azure Key Vault в двух разных регионах, [включив для них функцию обратимого удаления с помощью PowerShell](https://docs.microsoft.com/azure/key-vault/key-vault-soft-delete-powershell) (эта возможность пока не поддерживается на портале AKV, но является обязательной для SQL).
- Регионы, в которых создаются два хранилища Azure Key Vault, должны быть расположены в одном географическом регионе Azure, чтобы выполнялись процессы резервного копирования и восстановления ключей.  Если вы хотите, чтобы эти хранилища ключей размещались в разных географических регионах, например для соответствия требованиям к географическому аварийному восстановлению, выполните [процедуру BYOK](https://docs.microsoft.com/azure/key-vault/key-vault-hsm-protected-keys), которая позволяет импортировать ключи из локального аппаратного модуля безопасности.
- Создайте в первом хранилище ключей новый ключ:  
  - ключ RSA/RSA-HSA 2048; 
  - без даты окончания срока действия; 
  - ключ включен и имеет разрешения на операции получения, упаковки и распаковки ключа. 
- Создайте резервную копию первичного ключа и восстановите его во вторичном хранилище ключей.  См. документацию по командлетам [Backup-AzureKeyVaultKey](https://docs.microsoft.com/powershell/module/azurerm.keyvault/backup-azurekeyvaultkey?view=azurermps-5.1.1) и [Restore-AzureKeyVaultKey](https://docs.microsoft.com/powershell/module/azurerm.keyvault/restore-azurekeyvaultkey?view=azurermps-5.5.0). 

### <a name="azure-sql-database-configuration-steps"></a>Действия по настройке Базы данных SQL Azure

Описанные ниже этапы настройки будут различаться в зависимости от того, создаете вы новое развертывание SQL или используете уже существующее развертывание SQL с географическим аварийным восстановлением.  Здесь мы сначала опишем действия для нового развертывания, а затем покажем, как назначить хранящийся в Azure Key Vault предохранитель TDE существующему развертыванию, для которого уже создана связь географического аварийного восстановления. 

Для нового развертывания сделайте следующее.
- Создайте два логических сервера SQL в тех же двух регионах, где вы ранее создали хранилища ключей. 
- Выберите область TDE для логического сервера, а затем для каждого логического сервера SQL выполните следующие действия:  
   - Выберите AKV в том же регионе. 
   - Выберите ключ, который вы намерены использовать в качестве предохранителя TDE. Каждый сервер будет использовать локальную копию предохранителя TDE. 
   - Выполнив эту операцию на портале, вы получите удостоверение [AppID](https://docs.microsoft.com/azure/active-directory/managed-service-identity/overview) для логического сервера SQL, которое позволяет назначать логическому серверу SQL разрешения на доступ к хранилищу ключей. Не удаляйте это удостоверение. Чтобы отменить доступ, удалите в Azure Key Vault разрешения для логического сервера SQL, которые предоставляют этому серверу доступ к хранилищу ключей.
- Создайте базу данных-источник. 
- И наконец, выполните [рекомендации по активной георепликации](https://docs.microsoft.com/azure/sql-database/sql-database-geo-replication-overview). В результате будет создана база данных-получатель.

![Группы отработки отказа и географическое аварийное восстановление](./media/transparent-data-encryption-byok-azure-sql/Geo_DR_Config.PNG)

>[!NOTE]
>Важно убедиться, что в обоих хранилищах ключей хранится один и тот же предохранитель TDE. Если все выполнено правильно, можно переходить к созданию географической связи между базами данных.
>

Ниже описан процесс для существующей базы данных SQL, развернутой с поддержкой географического аварийного восстановления.

Так как логические серверы SQL уже существуют, а первичная и вторичная базы данных уже назначены, остается лишь выполнить действия по настройке Azure Key Vault в следующем порядке. 
- Прежде всего на логическом сервере SQL, где размещена база данных-получатель, сделайте следующее: 
   - назначьте хранилище ключей, расположенное в том же регионе; 
   - назначьте предохранитель TDE. 
- Теперь переходите к логическому серверу SQL, где размещена база данных-источник: 
   - выберите тот же предохранитель TDE, который используется для базы данных-получателя.
   
![Группы отработки отказа и географическое аварийное восстановление](./media/transparent-data-encryption-byok-azure-sql/geo_DR_ex_config.PNG)

>[!NOTE]
>При назначении серверу хранилища ключей важно начинать процесс с сервера-получателя.  На втором шаге назначьте хранилище ключей серверу-источнику и обновите предохранитель TDE. При этом связь географического аварийного восстановления продолжит работать, так как предохранитель TDE для реплицированной базы данных уже доступен на обоих серверах.
>

В сценарии для Базы данных SQL с географическим аварийным восстановлением, прежде чем включить TDE с ключами, сохраненными в Azure Key Vault и управляемыми клиентом, необходимо создать и поддерживать два хранилища Azure Key Vault с идентичным содержимым в тех же регионах, которые будут использоваться для георепликации базы данных SQL.  "Идентичное содержимое" здесь означает, что оба хранилища ключей должны содержать копии одного предохранителя TDE, чтобы оба сервера имели доступ к предохранителям TDE, используемым для всех баз данных.  В дальнейшем нужно соблюдать следующие требования: поддерживать синхронизацию обоих хранилищ ключей, то есть размещать в них одинаковые копии предохранителя TDE после смены ключей; сохранять старые версии ключей, которые использовались для файлов журналов или резервных копий; сохранять одинаковые свойства ключей для всех последующих предохранителей TDE; сохранять одинаковые разрешения на доступ серверов SQL в хранилищах ключей.  
 
Выполните действия, описанные в [обзоре активной георепликации](https://docs.microsoft.com/azure/sql-database/sql-database-geo-replication-overview), чтобы запустить тестовую отработку отказа. Этот процесс нужно выполнять регулярно для проверки разрешений сервера SQL на доступ к обоим хранилищам ключей. 


### <a name="backup-and-restore"></a>Архивация и восстановление

После того, как вы зашифруете базу данных с помощью TDE с ключом, сохраненным в Key Vault, все создаваемые резервные копии также будут шифроваться с помощью того же предохранителя TDE.

Чтобы восстановить резервную копию, зашифрованную с помощью предохранителя TDE из Key Vault, необходимо убедиться, что материал ключа по-прежнему находится в исходном хранилище с тем же именем. Когда для базы данных изменяется предохранитель TDE, старые резервные копии базы данных **не обновляются** до последней версии предохранителя TDE. Поэтому мы рекомендуем сохранять все старые версии предохранителя TDE в Key Vault, чтобы иметь возможность восстановить резервные копии базы данных. 

Если ключ, который может потребоваться для восстановления резервной копии, отсутствует в исходном хранилище ключей, возвращается следующее сообщение об ошибке: "Target server <Servername> does not have access to all AKV Uris created between <Timestamp #1> and <Timestamp #2>. Please retry operation after restoring all AKV Uris." (Целевой сервер не имеет доступа ко всем URI AKV, созданным с <метка времени №1> по <метка времени №2>. Повторите операцию после восстановления всех URI AKV).

Чтобы устранить эту проблему, выполните командлет [Get-AzureRmSqlServerKeyVaultKey](/powershell/module/azurerm.sql/get-azurermsqlserverkeyvaultkey) для восстановления из Key Vault списка ключей, которые были добавлены на сервер (если пользователь еще не удалил их). Чтобы убедиться, что все резервные копии можно восстановить, сохраняйте доступ целевого сервера резервного копирования ко всем используемым ключам.

   ```powershell
   Get-AzureRmSqlServerKeyVaultKey `
   -ServerName <LogicalServerName> `
   -ResourceGroup <SQLDatabaseResourceGroupName>
   ```
Дополнительные сведения о восстановлении резервной копии для Базы данных SQL см. в [этой статье](https://docs.microsoft.com/azure/sql-database/sql-database-recovery-using-backups). Дополнительные сведения о восстановлении резервной копии для хранилища данных SQL см. в [этой статье](https://docs.microsoft.com/azure/sql-data-warehouse/sql-data-warehouse-restore-database-overview).


Дополнительное замечание относительно резервных копий файлов журналов: сохраненные резервные копии журналов остаются зашифрованными с помощью исходного шифратора TDE, даже если произошла смена предохранителя TDE и база данных уже использует новый предохранитель TDE.  Для восстановления базы данных потребуется оба ключа.  Если файл журнала использует предохранитель TDE, хранящийся в Azure Key Vault, этот ключ потребуется во время восстановления, даже если база данных переведена на работу с управляемым службой предохранителем TDE.


