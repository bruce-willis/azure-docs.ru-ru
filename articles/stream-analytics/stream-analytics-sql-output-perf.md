---
title: Вывод данных Azure Stream Analytics в Базу данных SQL Azure
description: Сведения о выводе данных в SQL Azure из Azure Stream Analytics, а также об увеличении пропускной способности операций записи.
services: stream-analytics
author: chetang
ms.author: chetang
manager: katicad
ms.reviewer: mamccrea
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 09/21/2018
ms.openlocfilehash: 623d03c96866392ef245fb924cbf6600e7850ffe
ms.sourcegitcommit: 715813af8cde40407bd3332dd922a918de46a91a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2018
ms.locfileid: "47057816"
---
# <a name="azure-stream-analytics-output-to-azure-sql-database"></a>Вывод данных Azure Stream Analytics в Базу данных SQL Azure

В этой статье рассматриваются советы по улучшению пропускной способности операций записи при загрузке данных в Базу данных SQL Azure с использованием Azure Stream Analytics.

При выводе данных в SQL из Azure Stream Analytics поддерживается запись в параллельном режиме. Эта возможность реализует топологии заданий с [полной параллельной обработкой](https://docs.microsoft.com/azure/stream-analytics/stream-analytics-parallelization#embarrassingly-parallel-jobs), когда несколько секций выходных данных могут записывать в целевую таблицу в параллельном режиме. Тем не менее активации этой возможности в Azure Stream Analytics может быть недостаточно для увеличения пропускной способности, так как пропускная способность очень зависит от конфигурации Базы данных SQL Azure и схемы таблицы. Выбранные индексы, ключ кластеризации, коэффициент заполнения индекса и сжатие влияют на время загрузки таблиц. Дополнительные сведения о том, как оптимизировать Базу данных SQL Azure для улучшения производительности запросов и загрузки на основе внутренних тестов производительности, см. в статье [Настройка производительности в Базе данных SQL Azure](https://docs.microsoft.com/azure/sql-database/sql-database-performance-guidance).

Ниже приведены некоторые конфигурации каждой службы, которые позволяют повысить общую пропускную способность решения.

## <a name="azure-stream-analytics"></a>Azure Stream Analytics

- **Секционирование по наследованию**. Этот вариант конфигурации выходных данных SQL позволяет наследовать схему секционирования, используемую на предыдущем шаге запроса или с предыдущими входными данными. Если этот параметр включен, выполняется запись в таблицу на диске и присутствует задание с топологией [полной параллельной обработки](https://docs.microsoft.com/azure/stream-analytics/stream-analytics-parallelization#embarrassingly-parallel-jobs), будет прослеживаться лучшая пропускная способность. Такое секционирование автоматически выполняется для многих других [выходных данных](https://docs.microsoft.com/azure/stream-analytics/stream-analytics-parallelization#partitions-in-sources-and-sinks). Блокировка таблицы (TABLOCK) также отключается для массовой вставки, выполняемой при использовании этого параметра.

> [!NOTE] 
> При наличии более чем 8 секций входных данных может быть нецелесообразно использовать наследование схемы секционирования входных данных. Это максимальное ограничение было обнаружено в таблице с одним столбцом идентификаторов и кластеризованным индексом. В зависимости от этой схемы и выбранных индексов, результаты отличаются.

- **Размер пакета.** Конфигурация выходных данных SQL позволяет указать максимальный размер пакета выходных данных Azure Stream Analytics в зависимости от характера целевой таблицы или рабочей нагрузки. Размер пакета равен максимальному числу записей, отправляемых с каждой транзакцией массовой вставки. В кластеризованных индексах columnstore для пакетов с числом строк около [100 000](https://docs.microsoft.com/sql/relational-databases/indexes/columnstore-indexes-data-loading-guidance) можно использовать дополнительную параллелизацию, выполнять минимальное ведение журнала и блокировки. Оптимальным выбором могут быть таблицы на диске с 10 000 строк (по умолчанию) или меньше, так как большие размеры пакетов могут привести к укрупнению блокировки во время операции массовой вставки.

- **Настройка входных сообщений.** Если вы выполнили оптимизацию с использованием секционирования по наследованию и размера пакета, путем увеличения количества входных событий в сообщении на секцию можно дополнительно повысить пропускную способность записи. Путем настройки входных сообщений размеры пакетов в Azure Stream Analytics можно увеличивать вплоть до указанного размера, тем самым повышая пропускную способность. Это можно сделать, применив [сжатие](https://docs.microsoft.com/azure/stream-analytics/stream-analytics-define-inputs) или большие размеры сообщений, доступные в номере SKU концентратора событий (цен. категория "Премиум").

## <a name="sql-azure"></a>SQL Azure

- **Секционированная таблица и индексы.** Если использовать [секционированные](https://docs.microsoft.com/sql/relational-databases/partitions/partitioned-tables-and-indexes?view=sql-server-2017) таблицу SQL и индексы для таблицы с тем же столбцом в качестве ключа секции (например, PartitionId), можно значительно уменьшить состязания между секциями во время операций записи. Для секционированной таблицы потребуется создать [функцию](https://docs.microsoft.com/sql/t-sql/statements/create-partition-function-transact-sql?view=sql-server-2017) и [схему](https://docs.microsoft.com/sql/t-sql/statements/create-partition-scheme-transact-sql?view=sql-server-2017) секционирования в первичной файловой группе. Это приведет к повышению уровня доступности имеющихся данных при загрузке новых данных. Может быть достигнуто ограничение операций ввода-вывода журнала в зависимости от количества секций, которые можно увеличить, обновив номер SKU.

- **Предупреждение нарушений уникальных ключей.** Если в журнале действий Azure Stream Analytics появилось [несколько предупреждающих сообщений о нарушении ключа](https://docs.microsoft.com/azure/stream-analytics/stream-analytics-common-troubleshooting-issues#handle-duplicate-records-in-azure-sql-database-output), убедитесь, что на ваше задание не повлияли нарушения ограничений, которые могут произойти во время восстановления. Этого можно избежать, установив для индексов параметр [IGNORE\_DUP\_KEY](https://docs.microsoft.com/azure/stream-analytics/stream-analytics-common-troubleshooting-issues#handle-duplicate-records-in-azure-sql-database-output).

## <a name="azure-data-factory-and-in-memory-tables"></a>Служба "Фабрика данных Azure" и таблицы в памяти

- **Таблица в памяти как временная таблица.** [Таблицы в памяти](https://docs.microsoft.com/sql/relational-databases/in-memory-oltp/in-memory-oltp-in-memory-optimization) предоставляют очень высокую скорость загрузки данных, но размер данных не должен превышать доступный объем памяти. Тесты производительности демонстрируют, что массовая загрузка из таблицы в памяти в таблицу на диске примерно в 10 раз быстрее, чем во время непосредственной массовой вставки с помощью одного средства записи в дисковой таблице со столбцом идентификаторов и кластеризованным индексом. Чтобы использовать производительность массовой вставки, настройте [задание копирования с использованием службы "Фабрика данных Azure"](https://docs.microsoft.com/azure/data-factory/connector-azure-sql-database), позволяющее копировать данные из таблицы в памяти в таблицу на диске.

## <a name="summary"></a>Сводка

Таким образом, если использовать функцию секционирования выходных данных в Azure Stream Analytics для выходных данных SQL, согласованная параллелизация задания с секционированной таблицей в SQL Azure может обеспечить значительные усовершенствования пропускной способности. Использование службы "Фабрика данных Azure" для оркестрации перемещения данных из таблицы в памяти в таблицы на диске позволяет достичь значительного увеличения пропускной способности. Если это целесообразно, повышение плотности сообщений также может быть важным фактором для улучшения общей пропускной способности.
