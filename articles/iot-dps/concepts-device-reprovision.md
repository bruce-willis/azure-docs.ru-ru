---
title: Основные понятия повторной подготовки устройств для службы подготовки устройств к добавлению в центр Интернета вещей Azure | Документы Майкрософт
description: Описание основных понятий повторной подготовки устройств для службы подготовки устройств к добавлению в центр Интернета вещей Azure
author: wesmc7777
ms.author: wesmc
ms.date: 08/15/2018
ms.topic: conceptual
ms.service: iot-dps
services: iot-dps
manager: timlt
ms.openlocfilehash: 391131df7726131865ab9d875e8fcde185b3d0a5
ms.sourcegitcommit: 32d218f5bd74f1cd106f4248115985df631d0a8c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2018
ms.locfileid: "46965580"
---
# <a name="iot-hub-device-reprovisioning-concepts"></a>Основные понятия повторной подготовки устройств к добавлению в центр Интернета вещей


Во время жизненного цикла решения Интернета вещей часто приходится перемещать устройства между центрами Интернета вещей. Причинами этого перемещения могут быть следующие сценарии.

* **Географическое расположение и географическая задержка**: при перемещении устройства между расположениями сетевая задержка снижается за счет переноса устройства в ближайший центр Интернета вещей.

* **Мультитенантность**: устройство можно использовать в одном решении Интернета вещей и переназначить новому клиенту или расположению клиента. Обслуживание этого нового клиента может выполняться с помощью другого центра Интернета вещей.

* **Смена решения**: устройство может быть перемещено в новое или обновленное решение Интернета вещей. Для этого переопределения устройству может потребоваться взаимодействовать с новым центром Интернета вещей, подключенным к другим компонентам серверной части. 

* **Карантин**: аналогичен смене решения. Неисправное, скомпрометированное или устаревшее устройство может быть переназначено центру Интернета вещей, где оно может пройти обновление и вернуться в состояние соответствующего требованиям. Когда устройство будет работать надлежащим образом, оно переносится в свой основной центр.

Все эти вопросы решает поддержка повторной подготовки в службе подготовки устройств. Устройства можно автоматически переназначить новому центру Интернета вещей на основе политики повторной подготовки, которая настроена в записи регистрации устройства. 

## <a name="device-state-data"></a>Данные о состоянии устройства

Данные о состоянии устройства формируются из возможностей устройства и [двойника устройства](../iot-hub/iot-hub-devguide-device-twins.md). Эти данные хранятся в экземпляре службы подготовки устройств и в центре Интернета вещей, которому назначено устройство. 

![Подготовка с помощью службы подготовки устройств](./media/concepts-device-reprovisioning/dps-provisioning.png)

При начальной подготовке устройства с помощью экземпляра службы подготовки устройств выполняются следующие действия.

1. Устройство отправляет запрос на подготовку в экземпляр службы подготовки устройств. Экземпляр службы проверяет подлинность удостоверения устройства на основе записи регистрации и создает начальную конфигурации данных о состоянии устройства. Экземпляр службы назначает устройство центру Интернета вещей на основе конфигурации регистрации и возвращает это назначение центра Интернета вещей устройству.

2. Экземпляр службы подготовки предоставляет копию данных о начальном состоянии устройства в назначенный центр Интернета вещей. Устройство подключается к назначенному центру Интернета вещей и начинает работать.


Со временем данные о состоянии устройства в центре Интернета могут обновляться с помощью [операций на устройстве](../iot-hub/iot-hub-devguide-device-twins.md#device-operations) и [операций в серверной части](../iot-hub/iot-hub-devguide-device-twins.md#back-end-operations). Сведения о начальном состоянии устройства, хранящиеся в экземпляре службы подготовки устройств, не затрагиваются. Эти данные представляют начальную конфигурацию.

![Подготовка с помощью службы подготовки устройств](./media/concepts-device-reprovisioning/dps-provisioning-2.png)

В зависимости от сценария при перемещении устройства между центрами Интернета вещей может также потребоваться перенести состояние устройства, обновленное в предыдущем центре Интернета вещей, в новый центр Интернета вещей. Эта возможность поддерживается политиками повторной подготовки в службе подготовки устройств. 


## <a name="reprovisioning-policies"></a>Политики повторной подготовки

В зависимости от сценария устройство обычно отправляет запрос на подготовку в экземпляр службы подготовки при перезагрузке и поддерживает метод запуска подготовки вручную по требованию. Политика повторной подготовки в записи регистрации определяет способ обработки этих запросов экземпляром службы подготовки устройств и выясняет необходимость переноса данных о состоянии устройства во время повторной подготовки. К отдельным регистрациям и группам регистраций применяются одни и те же политики.

* **Повторная подготовка и перенос данных**. Эта политика используется по умолчанию для новых записей регистрации. Эта политика начинает действовать, когда устройства, связанные с записью регистрации, отправляют новый запрос на подготовку (1). В зависимости от конфигурации записи регистрации устройство может быть переназначено другому центру Интернета вещей. При смене центров Интернета вещей происходит удаление регистрации устройства в начальном центре Интернета вещей. Обновленные сведения о состоянии устройства из этого начального центра Интернета вещей будут перенесены в новый центр Интернета вещей (2). Во время переноса устройство находится в состоянии **Идет назначение**.

    ![Подготовка с помощью службы подготовки устройств](./media/concepts-device-reprovisioning/dps-reprovisioning-migrate.png)


* **Повторная подготовка и сброс до начальной конфигурации**. Эта политика начинает действовать, когда устройства, связанные с записью регистрации, отправляют новый запрос на подготовку (1). В зависимости от конфигурации записи регистрации устройство может быть переназначено другому центру Интернета вещей. При смене центров Интернета вещей происходит удаление регистрации устройства в начальном центре Интернета вещей. Данные начальной конфигурации, полученные экземпляром службы подготовки во время подготовки устройства, предоставляются в новый центр Интернета вещей (2). Во время переноса устройство находится в состоянии **Идет назначение**.

    Эта политика часто используется для сброса параметров до заводских настроек без смены центров Интернета вещей. 

    ![Подготовка с помощью службы подготовки устройств](./media/concepts-device-reprovisioning/dps-reprovisioning-reset.png)


* **Никогда не выполнять повторную подготовку**. Устройство никогда не переназначается другому центру. Эта политика предоставляется для управления обратной совместимостью.

#### <a name="managing-backwards-compatibility"></a>Управление обратной совместимостью

До сентября 2018 г. назначения устройств центрам Интернета вещей были фиксированными. Когда устройство проходило процедуру повторной подготовки, оно могло быть назначено только тому же центру Интернета вещей. 

Решениям, которые стали зависимыми от этого поведения, служба подготовки предлагает обратную совместимость. Сейчас такое поведение сохраняется для устройств в соответствии со следующими критериями.

1. Устройства подключаются с помощью версии API до появления собственной поддержки повторной подготовки в службе подготовки устройств. См. в таблицу API ниже.

2. В записи регистрации для устройств не задана политика их повторной подготовки. 

Такая совместимость гарантирует, что к уже развернутым устройствам применяется то же поведение, которое было во время начального тестирования. Чтобы сохранить прежнее поведение, не сохраняйте политику повторной подготовки в эти регистрации. Если политика повторной подготовки задана, она имеет приоритет над поведением. За счет приоритизации политики повторной подготовки клиенты могут обновлять поведение устройства без повторного создания образа устройства.

На следующей блок-схеме приводятся данные, определяющие поведение.

![блок-схема обратной совместимости](./media/concepts-device-reprovisioning/reprovisioning-compatibility-flow.png)

В следующей таблице приводятся версии API до появления собственной поддержки повторной подготовки в службе подготовки устройств.


| REST API | Пакет C SDK | Пакет SDK для Python |  Пакет SDK для Node | Пакет SDK для Java | ПАКЕТ SDK .NET |
| -------- | ----- | ---------- | --------- | -------- | -------- |
| [2018-04-01 и более ранние версии](https://docs.microsoft.com/rest/api/iot-dps/deviceenrollment/createorupdate#uri-parameters) | [1.2.8 и более ранние версии](https://github.com/Azure/azure-iot-sdk-c/blob/master/version.txt) | [1.4.2 и более ранние версии](https://github.com/Azure/azure-iot-sdk-python/blob/0a549f21f7f4fc24bc036c1d2d5614e9544a9667/device/iothub_client_python/src/iothub_client_python.cpp#L53) | [1.7.3 или более ранние версии](https://github.com/Azure/azure-iot-sdk-node/blob/074c1ac135aebb520d401b942acfad2d58fdc07f/common/core/package.json#L3) | [1.13.0 или более ранние версии](https://github.com/Azure/azure-iot-sdk-java/blob/794c128000358b8ed1c4cecfbf21734dd6824de9/device/iot-device-client/pom.xml#L7) | [1.1.0 или более ранние версии](https://github.com/Azure/azure-iot-sdk-csharp/blob/9f7269f4f61cff3536708cf3dc412a7316ed6236/provisioning/device/src/Microsoft.Azure.Devices.Provisioning.Client.csproj#L20)

> [!NOTE]
> Эти значения и ссылки могут меняться. Это лишь попытка выяснить, когда версии могут быть определены клиентом и какими будут ожидаемые версии.




## <a name="next-steps"></a>Дополнительная информация

- [Повторная подготовка устройств](how-to-reprovision.md)







