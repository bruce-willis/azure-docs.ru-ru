---
title: Настройка устройства для службы "Подготовка устройств к добавлению в Центр Интернета вещей"
description: Настройка устройства для подготовки через службу подготовки устройств для Центра Интернета вещей во время производства устройства.
author: wesmc7777
ms.author: wesmc
ms.date: 04/02/2018
ms.topic: tutorial
ms.service: iot-dps
services: iot-dps
manager: timlt
ms.custom: mvc
ms.openlocfilehash: 998bc7cb7e3289a85a9ffc315f7c1f5e568a75cb
ms.sourcegitcommit: f057c10ae4f26a768e97f2cb3f3faca9ed23ff1b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/17/2018
ms.locfileid: "41918273"
---
# <a name="set-up-a-device-to-provision-using-the-azure-iot-hub-device-provisioning-service"></a>Настройка устройства для подготовки с помощью службы подготовки устройств для Центра Интернета вещей

В предыдущем руководстве вы узнали, как настроить службу подготовки устройств для Центра Интернета вещей, чтобы автоматически подготавливать устройства в Центре Интернета вещей. В этом руководстве объясняется, как настроить устройство во время производства для автоматической подготовки в Центре Интернета вещей. Устройство подготавливается на основе [механизма аттестации](concepts-device.md#attestation-mechanism) после первой загрузки и подключения к службе подготовки. В рамках этого руководства рассматриваются следующие задачи:

> [!div class="checklist"]
> * создание клиентского пакета SDK служб подготовки устройств для определенной платформы;
> * извлечение артефактов безопасности;
> * создать программный пакет регистрации устройств.

В этом руководстве предполагается, что экземпляр службы подготовки устройств и Центр Интернета вещей уже созданы с помощью инструкций, приведенных в предыдущем руководстве [Настройка облачных ресурсов для подготовки устройств с помощью службы подготовки устройств для Центра Интернета вещей](tutorial-set-up-cloud.md).

В этом руководстве используется [репозиторий пакетов SDK для Azure IoT и библиотек для C](https://github.com/Azure/azure-iot-sdk-c), который содержит клиентский пакет SDK службы подготовки устройств для C. Пакет SDK сейчас обеспечивает поддержку доверенного платформенного модуля (TPM) и сертификата X.509 для устройств под управлением Windows или Ubuntu. Для этого руководства используется клиент разработки Windows. Также предполагается, что у вас есть навыки работы с Visual Studio 2017. 

Если вы не знакомы с процессом автоматической подготовки, обязательно ознакомьтесь со статьей [Принципы автоматической подготовки устройств](concepts-auto-provisioning.md), прежде чем продолжать работу. 


[!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]

## <a name="prerequisites"></a>Предварительные требования

* Visual Studio 2015 или [Visual Studio 2017](https://www.visualstudio.com/vs/) со включенной рабочей нагрузкой [Разработка классических приложений на C++](https://www.visualstudio.com/vs/support/selecting-workloads-visual-studio-2017/).
* Установите последнюю версию [Git](https://git-scm.com/download/).



## <a name="build-a-platform-specific-version-of-the-sdk"></a>Создание версии пакета SDK для определенной платформы

Клиентский пакет SDK для службы подготовки устройств позволяет реализовать программный пакет регистрации устройств. Но до этого нужно создать версию пакета SDK для определенной клиентской платформы разработки и механизма аттестации. С помощью этого руководства вы создадите пакет SDK, который использует Visual Studio 2017 на платформе разработки Windows для поддерживаемого типа аттестации:

1. Загрузите последнюю версию выпуска [системы сборки CMake](https://cmake.org/download/). На этом же сайте найдите криптографический хэш для выбранной вами версии бинарного дистрибутива. Проверьте загруженный бинарный дистрибутив, используя соответствующее значение криптографического хэша. В следующем примере для проверки криптографического хэша для дистрибутива MSI x64 версии 3.11.4 использовалась среда Windows PowerShell:

    ```PowerShell
    PS C:\Users\wesmc\Downloads> $hash = get-filehash .\cmake-3.11.4-win64-x64.msi
    PS C:\Users\wesmc\Downloads> $hash.Hash -eq "56e3605b8e49cd446f3487da88fcc38cb9c3e9e99a20f5d4bd63e54b7a35f869"
    True
    ```

    **Перед** установкой `CMake` очень важно установить на компьютер необходимые компоненты Visual Studio (Visual Studio с рабочей нагрузкой "Разработка классических приложений на C++"). После установки компонентов и проверки загрузки установите систему сборки CMake.

1. Откройте командную строку или оболочку Git Bash. Выполните следующую команду для клонирования репозитория GitHub [пакета SDK для устройства C Интернета вещей Azure](https://github.com/Azure/azure-iot-sdk-c):
    
    ```cmd/sh
    git clone https://github.com/Azure/azure-iot-sdk-c.git --recursive
    ```
    Размер этого репозитория в настоящее время составляет примерно 220 МБ. Выполнение этой операции может занять несколько минут.


1. Создайте подкаталог `cmake` в корневом каталоге репозитория Git и перейдите в эту папку. 

    ```cmd/sh
    cd azure-iot-sdk-c
    mkdir cmake
    cd cmake
    ```

1. Создайте пакет SDK для платформы разработки на основании механизмов аттестации, которые будут использоваться. Используйте одну из следующих команд (также обратите внимание на две точки в конце строки каждой команды). По завершении CMake создает подкаталог `/cmake` с содержимым для вашего устройства.
 
    - Для устройств, использующих симулятор TPM для аттестации, выполните следующую команду:

        ```cmd/sh
        cmake -Duse_prov_client:BOOL=ON -Duse_tpm_simulator:BOOL=ON ..
        ```

    - Для любых других устройств (физический TPM/HSM/X.509 или имитированный сертификат X.509).

        ```cmd/sh
        cmake -Duse_prov_client:BOOL=ON ..
        ```


Теперь вы можете использовать пакет SDK для создания кода регистрации устройства. 
 
<a id="extractsecurity"></a> 

## <a name="extract-the-security-artifacts"></a>извлечение артефактов безопасности; 

Следующий шаг заключается в извлечении артефактов безопасности для механизма аттестации, который используется устройством. 

### <a name="physical-devices"></a>Физические устройства 

В зависимости от того, создается пакет SDK для использования аттестации физического доверенного платформенного модуля (TPM) или HSM или для использования сертификатов X.509, сбор артефактов безопасности выглядит следующим образом.

- Для устройства с доверенным платформенным модулем необходимо определить связанный **ключ подтверждения** у производителя микросхемы доверенного платформенного модуля. Можно получить уникальный **ИД регистрации** для устройства TPM с помощью хэширования ключа подтверждения.  

- Для устройства X.509 необходимо получить сертификаты, выпущенные для устройств. Служба подготовки поддерживает записи регистрации двух типов, которые позволяют управлять доступом для устройств, использующих механизм аттестации X.509. Необходимые сертификаты зависят от типов регистрации, которые будут использоваться.

    1. Индивидуальные регистрации. Регистрация для одного конкретного устройства. Для этого типа записи регистрации требуются [сертификаты конечного объекта](concepts-security.md#end-entity-leaf-certificate).
    1. Группы регистрации. Для этого типа записи регистрации требуются промежуточные или корневые сертификаты. Дополнительные сведения см. в разделе [Управление доступом устройств к службе подготовки с использованием сертификатов X.509](concepts-security.md#controlling-device-access-to-the-provisioning-service-with-x509-certificates).

### <a name="simulated-devices"></a>Виртуальные устройства

В зависимости от того, создается пакет SDK для использования аттестации для имитированного устройства с помощью сертификатов доверенного платформенного модуля (TPM) или X.509, сбор артефактов безопасности выглядит следующим образом.

- Для имитированного устройства с TPM

   1. Откройте командную строку Windows, перейдите к подкаталогу `azure-iot-sdk-c` и запустите симулятор TPM. Он ожидает передачи данных через сокет на портах 2321 и 2322. Не закрывайте это командное окно. Симулятор должен работать, пока вы не выполните все инструкции из этого руководства. 

      В подкаталоге `azure-iot-sdk-c` выполните следующую команду, чтобы запустить симулятор:

      ```cmd/sh
      .\provisioning_client\deps\utpm\tools\tpm_simulator\Simulator.exe
      ```

      > [!NOTE]
      > Если для выполнения этого шага вы используете командную строку Git Bash, необходимо изменить знаки обратной косой черты на знаки прямой косой черты, например: `./provisioning_client/deps/utpm/tools/tpm_simulator/Simulator.exe`.

   1. С помощью Visual Studio откройте решение `azure_iot_sdks.sln`, созданное в папке *cmake*, и скомпилируйте его с помощью команды "Собрать решение" в меню "Сборка".

   1. На панели *обозревателя решений* в Visual Studio перейдите в папку **Provision\_Tools**. Щелкните проект **tpm_device_provision** правой кнопкой мыши и выберите параметр **Назначить запускаемым проектом**. 

   1. Запустите решение с помощью одной из команд запуска в меню "Отладка". В окне выходных данных отображается **_идентификатор регистрации_** и **_ключ подтверждения_** симулятора TPM, необходимые для регистрации устройства. Скопируйте эти значения для дальнейшего использования. Можете закрыть окно с идентификатором регистрации и ключом подтверждения, но не закрывайте окно симулятора TPM, который был запущен на шаге 1.

- Для имитированного устройства с сертификатом X.509

  1. С помощью Visual Studio откройте решение `azure_iot_sdks.sln`, созданное в папке *cmake*, и скомпилируйте его с помощью команды "Собрать решение" в меню "Сборка".

  1. На панели *обозревателя решений* в Visual Studio перейдите в папку **Provision\_Tools**. Щелкните проект **dice\_device\_enrollment** правой кнопкой мыши и выберите параметр **Назначить запускаемым проектом**. 
  
  1. Запустите решение с помощью одной из команд запуска в меню "Отладка". При появлении запроса введите **i** в окне вывода для индивидуальной регистрации. В окне вывода отобразится локально созданный сертификат X.509 для имитированного устройства. Скопируйте в буфер обмена выходные данные, начиная со строки *-----BEGIN CERTIFICATE-----* и заканчивая строкой *-----END CERTIFICATE-----*. Не забудьте скопировать и эти две строки. Необходим только первый сертификат из окна выходных данных.
 
  1. Создайте файл **_X509testcert.pem_**, откройте его в любом текстовом редакторе и скопируйте в файл содержимое из буфера обмена. Сохраните файл, так как он понадобится позже для регистрации устройства. При запуске программного обеспечения для регистрации используется тот же сертификат, что и для автоматической подготовки.    

Такие артефакты безопасности необходимы при регистрации устройств в службе подготовки устройств. Служба подготовки ожидает загрузки этих устройств и подключается к ним в любой момент времени в будущем. При первой загрузке устройства клиентский пакет SDK взаимодействует с микросхемой (или симулятором), извлекая артефакты безопасности с устройства, и проверяет регистрацию в службе подготовки устройств. 

## <a name="create-the-device-registration-software"></a>Создание программного пакета регистрации устройств

Последний шаг заключается в написании приложения, использующего клиентский пакет SDK службы подготовки устройств для регистрации устройства в службе Центра Интернета вещей. 

> [!NOTE]
> Для этого шага предполагается использование имитированного устройства с запущенным примером приложения для регистрации, которое использует SDK, на рабочей станции. Этот же подход используется и при создании приложения для регистрации для развертывания на физическом устройстве. 

1. На портале Azure выберите колонку **Обзор** службы подготовки устройств и скопируйте значение **_области идентификатора_**. *Область идентификаторов* создается службой и гарантирует уникальность. Она неизменяемая и используется для уникальной идентификации идентификаторов регистрации.

    ![Извлеките сведения о конечной точке службы подготовки устройств из колонки на портале](./media/tutorial-set-up-device/extract-dps-endpoints.png) 

1. В *обозревателе решений* Visual Studio перейдите в папку **Provision\_Samples**. Выберите пример проекта с именем **prov\_dev\_client\_sample** и откройте исходный файл **prov\_dev\_client\_sample.c**.

1. Присвойте значение _идентификатора области_, полученное на шаге 1, переменной `id_scope` (удалите квадратные скобки справа /`[` и слева /`]`). 

    ```c
    static const char* global_prov_uri = "global.azure-devices-provisioning.net";
    static const char* id_scope = "[ID Scope]";
    ```

    Также приведена переменная `global_prov_uri`, которая позволяет API регистрации клиента в Центре Интернета вещей `IoTHubClient_LL_CreateFromDeviceAuth` подключаться к указанному экземпляру службы подготовки устройств.

1. В функции **main()** этого же файла закомментируйте или раскомментируйте переменную `hsm_type`. Она определяет механизм аттестации, используемый программным пакетом регистрации устройства (TPM или X.509): 

    ```c
    hsm_type = SECURE_DEVICE_TYPE_TPM;
    //hsm_type = SECURE_DEVICE_TYPE_X509;
    ```

1. Сохраните изменения и повторно создайте пример проекта **prov\_dev\_client\_sample**, выбрав "Собрать решение" в меню "Сборка". 

1. В папке **Provision\_Samples** щелкните правой кнопкой мыши проект **prov\_dev\_client\_sample** и выберите пункт **Назначить запускаемым проектом**. Не запускайте пример приложения.

> [!IMPORTANT]
> И не запускайте устройство. Сначала необходимо завершить процесс, зарегистрировав устройство в службе подготовки устройств. Ссылка на следующую статью приводится в разделе с дополнительными сведениями ниже.

### <a name="sdk-apis-used-during-registration-for-reference-only"></a>API пакета SDK, используемые при регистрации (только для справки)

Ниже для справки приводятся предоставляемые в пакете SDK интерфейсы API для приложения, которые используются при регистрации. Эти API помогают устройству подключиться и зарегистрироваться в службе подготовки устройств во время загрузки. В свою очередь устройство получает сведения, необходимые для подключения к экземпляру Центра Интернета вещей.

```C
// Creates a Provisioning Client for communications with the Device Provisioning Client Service.  
PROV_DEVICE_LL_HANDLE Prov_Device_LL_Create(const char* uri, const char* scope_id, PROV_DEVICE_TRANSPORT_PROVIDER_FUNCTION protocol)

// Disposes of resources allocated by the provisioning Client.
void Prov_Device_LL_Destroy(PROV_DEVICE_LL_HANDLE handle)

// Asynchronous call initiates the registration of a device.
PROV_DEVICE_RESULT Prov_Device_LL_Register_Device(PROV_DEVICE_LL_HANDLE handle, PROV_DEVICE_CLIENT_REGISTER_DEVICE_CALLBACK register_callback, void* user_context, PROV_DEVICE_CLIENT_REGISTER_STATUS_CALLBACK reg_status_cb, void* status_user_ctext)

// Api to be called by user when work (registering device) can be done
void Prov_Device_LL_DoWork(PROV_DEVICE_LL_HANDLE handle)

// API sets a runtime option identified by parameter optionName to a value pointed to by value
PROV_DEVICE_RESULT Prov_Device_LL_SetOption(PROV_DEVICE_LL_HANDLE handle, const char* optionName, const void* value)
```

Возможно, вам потребуется более точно определить клиентское приложение для регистрации службы подготовки устройств сначала с помощью имитированного устройства, а затем — в ходе настройки службы тестирования. Когда приложение будет работать в тестовой среде, его можно создать для конкретного устройства и скопировать исполняемый файл в образ устройства. 

## <a name="clean-up-resources"></a>Очистка ресурсов

Возможно, на этом этапе вам понадобится запустить службу подготовки устройств и Центр Интернета вещей на портале. Если вы хотите прервать настройку подготовки устройств и (или) приостановить прохождение этой серии руководств, рекомендуется завершить работу служб, чтобы избежать лишних затрат.

1. В меню слева на портале Azure щелкните **Все ресурсы** и откройте службу подготовки устройств. В верхней части колонки **Все ресурсы** щелкните **Удалить**.  
1. В меню слева на портале Azure нажмите кнопку **Все ресурсы** и выберите свой Центр Интернета вещей. В верхней части колонки **Все ресурсы** щелкните **Удалить**.  

## <a name="next-steps"></a>Дополнительная информация
Из этого руководства вы узнали, как выполнить следующие задачи:

> [!div class="checklist"]
> * создать клиентский пакет SDK службы подготовки устройств для определенной платформы;
> * извлечение артефактов безопасности;
> * создать программный пакет регистрации устройств.

Перейдите к следующему руководству, чтобы узнать, как подготовить свое устройство в Центре Интернета вещей, зарегистрировав его в службе подготовки устройств для Центра Интернета вещей Azure, позволяющей выполнить автоматическую подготовку.

> [!div class="nextstepaction"]
> [Provision the device to an IoT hub using the Azure IoT Hub Device Provisioning Service](tutorial-provision-device-to-hub.md) (Подготовка устройства в Центре Интернета вещей с помощью службы подготовки устройств для Центра Интернета вещей).

