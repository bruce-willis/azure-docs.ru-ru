---
title: Хранилище запросов в базе данных Azure для PostgreSQL
description: В этой статье описан компонент "Хранилище запросов" в службе "База данных Azure для PostgreSQL".
services: postgresql
author: rachel-msft
ms.author: raagyema
ms.service: postgresql
ms.topic: conceptual
ms.date: 09/24/2018
ms.openlocfilehash: 149840157c5e9bb47be70f669b2078585fe4b56c
ms.sourcegitcommit: 32d218f5bd74f1cd106f4248115985df631d0a8c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2018
ms.locfileid: "46953034"
---
# <a name="monitor-performance-with-the-query-store"></a>Мониторинг производительности с помощью хранилища запросов

**Применимо к**: база данных Azure для PostgreSQL 9.6 и 10

> [!IMPORTANT]
> Компонент "Хранилище запросов" доступен в рамках общедоступной предварительной версии.


Компонент "Хранилище запросов" в базе данных Azure для PostgreSQL позволяет отслеживать производительность запросов с течением времени. Хранилище запросов упрощает устранение неполадок, позволяя быстро выявлять самые медленные и ресурсоемкие запросы. Хранилище запросов автоматически ведет журнал запросов и статистики выполнения и сохраняет их для просмотра. Этот компонент разделяет данные по периодам, давая представление о закономерностях использования баз данных. Данные для всех пользователей, баз данных и запросов хранятся в базе данных с именем **azure_sys** в экземпляре базы данных Azure для PostgreSQL.

> [!IMPORTANT]
> Не изменяйте базу данных **azure_sys** или ее схемы. Это приведет к нарушению работы хранилища запросов и связанных функций оценки производительности.

## <a name="enabling-query-store"></a>Включение хранилища запросов
Хранилище запросов является дополнительной функцией, поэтому оно не активно на сервере по умолчанию. Хранилище включается или отключается глобально для всех (но не для отдельных) баз данных на данном сервере.

### <a name="enable-query-store-using-the-azure-portal"></a>Включение хранилища запросов с помощью портала Azure
1. Войдите на портал Azure и выберите сервер службы "База данных Azure для PostgreSQL".
2. В разделе меню **Параметры** выберите **Параметры сервера**.
3. Найдите параметр **pg_qs.query_capture_mode**.
4. Замените значение NONE на TOP и сохраните.

Этот параметр также можно задать с помощью Azure CLI.
```azurecli-interactive
az postgres server configuration set --name pg_qs.query_capture_mode --resource-group myresourcegroup --server mydemoserver --value TOP
```

Подождите около 20 минут, пока первый набор данных сохранится в базе данных azure_sys.

## <a name="information-in-query-store"></a>Данные в хранилище запросов
Хранилище запросов включает два хранилища:
- хранилище статистики времени выполнения для хранения статистических сведений о выполнении запросов;
- хранилище статистики ожидания для хранения статистических сведений об ожидании.

Распространенные сценарии использования хранилища запросов включают следующие:
- определение числа выполнений запроса за данный период времени;
- сравнение среднего времени выполнения запроса за периоды времени для выявления больших расхождений;
- определение самых медленно выполняющихся запросов за прошедшие X часов;
- определение основных N запросов, ожидающих ресурсы;
- понимание характера ожидания для конкретного запроса.

С целью экономии места к статистическим данным о выполнении запросов в хранилище статистики времени выполнения применяется агрегирование за фиксированный настраиваемый период. Сведения в этих хранилищах отображаются путем запроса представлений хранилища запросов.

Следующий запрос возвращает сведения о запросах в хранилище запросов:
```sql
SELECT * FROM query_store.qs_view; 
``` 

Это запрос статистики ожидания:
```sql
SELECT * FROM query_store.pgms_wait_sampling_view;
```

## <a name="finding-wait-queries"></a>Поиск запросов ожидания
Типы событий ожидания объединяют разные события ожидания в группы по принципу сходства. Хранилище запросов предоставляет тип события ожидания, имя определенного события ожидания и запрашиваемый запрос. Возможность сопоставлять эти сведения об ожидании со статистикой времени выполнения запроса позволяет получить более глубокое понимание аспектов, влияющих на характеристики производительности запросов.

Ниже приведены некоторые примеры получения более подробных сведений о рабочей нагрузке с помощью статистики ожидания в хранилище запросов.

| **Наблюдение** | **Действие** |
|---|---|
|Ожидания с высоким уровнем блокировки | Проверьте текст затронутых запросов и определите целевые сущности. Найдите в хранилище запросов другие запросы, изменяющие ту же сущность, которые часто выполняются и (или) имеют большую длительность. Определив эти запросы, рекомендуется изменить логику приложения, чтобы улучшить параллелизм, или использовать менее строгий уровень изоляции.|
| Ожидания с большим числом операций ввода-вывода буфера | Найдите в хранилище запросов запросы с большим числом физических операций чтения. Если они соответствуют запросам с высокими значениями ожидания ввода-вывода, попробуйте ввести индекс для базовой сущности, чтобы задать поиск вместо сканирования. Это позволит свести к минимуму затраты на операции ввода-вывода запросов. Ознакомьтесь с **рекомендациями по повышению производительности** серверов на портале: возможно, для этого сервера есть рекомендации по индексам, которые позволят оптимизировать запросы.|
| Ожидания с высокой загрузкой памяти | Найдите в хранилище запросов запросы, использующие больше всего памяти. Эти запросы, скорее всего, дополнительно задерживают выполнение соответствующих запросов. Ознакомьтесь с **рекомендациями по повышению производительности** для сервера на портале: возможно, есть рекомендации по индексам, которые позволят оптимизировать запросы.|

## <a name="configuration-options"></a>Варианты настройки
При включении хранилища запросов оно сохраняет данные с 15-минутным периодом агрегирования: не более 500 уникальных запросов на период. 

Ниже приведены настраиваемые параметры для хранилища запросов.
| **Параметр** | **Описание** | **По умолчанию** | **Range**|
|---|---|---|---|
| pg_qs.query_capture_mode | Задает, какие инструкции отслеживаются. | top | none, top, all |
| pg_qs.max_query_text_length | Задает максимальную длину запроса, которую можно сохранить. Более длинные запросы будут усечены. | 6000 | 100–10 000 |
| pg_qs.retention_period_in_days | Задает период хранения. | 7 | 1–30 |
| pg_qs.track_utility | Задает, будут ли отслеживаться команды служебных программ. | on | on, off |

Следующие параметры применяются исключительно к статистике ожидания.
| **Параметр** | **Описание** | **По умолчанию** | **Range**|
|---|---|---|---|
| pgms_wait_sampling.query_capture_mode | Задает, какие инструкции отслеживаются для статистики ожидания. | Нет | none, all|
| Pgms_wait_sampling.history_period | Задайте частоту (в миллисекундах) выборки событий ожидания. | 100 | 1–600 000 |

> [!NOTE] 
> **pg_qs.query_capture_mode** заменяет **pgms_wait_sampling.query_capture_mode**. Если параметр pg_qs.query_capture_mode имеет значение NONE, pgms_wait_sampling.query_capture_mode не оказывает влияния.


Используйте [портал Azure](howto-configure-server-parameters-using-portal.md) или [Azure CLI](howto-configure-server-parameters-using-cli.md), чтобы получить значение для параметра или задать другое значение.

## <a name="views-and-functions"></a>Представления и функции
Просмотр и управление хранилищем запросов осуществляеются с помощью следующих представлений и функций. Любой пользователь с общедоступной ролью PostgreSQL может использовать эти представления для просмотра данных в хранилище запросов. Эти представления доступны только в базе данных **azure_sys**.

Запросы нормализованы: обратите внимание на их структуру после удаления литералов и констант. Если два запроса идентичны, за исключением литеральных значений, они будут иметь один хэш.

### <a name="querystoreqsview"></a>query_store.qs_view
Это представление возвращает все данные в хранилище запросов. Для каждого отдельного идентификатора базы данных, идентификатора пользователя и идентификатора запроса используется отдельная строка. 

|**Имя**   |**Тип** | **Справочные материалы**  | **Описание**|
|---|---|---|---|
|runtime_stats_entry_id |bigint | | Идентификатор из таблицы runtime_stats_entries|
|user_id    |oid    |pg_authid.oid  |Идентификатор объекта пользователя, который выполнил инструкцию|
|db_id  |oid    |pg_database.oid    |Идентификатор объекта базы данных, в которой была выполнена инструкция|
|query_id   |bigint  || Внутренний хэш-код, вычисляемый на основе дерева синтаксического анализа инструкции|
|query_sql_text |Varchar(10000)  || Текст репрезентативной инструкции. Разные запросы с одной структурой объединяются в кластеры: этот текст — текст для первого запроса в кластере.|
|plan_id    |bigint |   |Идентификатор плана, соответствующего этому запросу (пока недоступно)|
|start_time |timestamp  ||  Запросы проходят агрегирование по временным группам — интервал группы составляет 15 минут по умолчанию (значение можно настроить). Это время начала, соответствующее временной группе для этой записи.|
|end_time   |timestamp  ||  Время окончания, соответствующее временной группе для этой записи.|
|calls  |bigint  || Число выполнений запроса|
|total_time |double precision   ||  Общее время выполнения запроса (в миллисекундах)|
|min_time   |double precision   ||  Минимальное время выполнения запроса (в миллисекундах)|
|min_time   |double precision   ||  Максимальное время выполнения запроса (в миллисекундах)|
|mean_time  |double precision   ||  Среднее время выполнения запроса (в миллисекундах)|
|stddev_time|   double precision    ||  Стандартное отклонение времени выполнения запроса (в миллисекундах) |
|rows   |bigint ||  Общее число строк, полученных или затронутых инструкцией|
|shared_blks_hit|   bigint  ||  Общее число обращений инструкции к кэшу общего блока|
|shared_blks_read|  bigint  ||  Общее число операций чтения общего блока, выполненных инструкцией|
|shared_blks_dirtied|   bigint   || Общее число общих блоков, измененных инструкцией |
|shared_blks_written|   bigint  ||  Общее число общих блоков, записанных инструкцией|
|local_blks_hit|    bigint ||   Общее число обращений инструкции к кэшу локального блока|
|local_blks_read|   bigint   || Общее число операций чтения локального блока, выполненных инструкцией|
|local_blks_dirtied|    bigint  ||  Общее число локальных блоков, измененных инструкцией|
|local_blks_written|    bigint  ||  Общее число локальных блоков, записанных инструкцией|
|temp_blks_read |bigint  || Общее число временных блоков, считанных инструкцией|
|temp_blks_written| bigint   || Общее число временных блоков, записанных инструкцией|
|blk_read_time  |double precision    || Общее время (в миллисекундах), затраченное инструкцией на чтение блоков (если track_io_timing включен, в противном случае нуль)|
|blk_write_time |double precision    || Общее время (в миллисекундах), затраченное инструкцией на запись блоков (если track_io_timing включен, в противном случае нуль)|
    
### <a name="querystorequerytextsview"></a>query_store.query_texts_view
Это представление возвращает текстовые данные запроса в хранилище запросов. Для каждого отдельного query_text используется отдельная строка.

|**Имя**|  **Тип**|   **Описание**|
|---|---|---|
|query_text_id  |bigint     |Идентификатор для таблицы query_texts|
|query_sql_text |Varchar(10000)     |Текст репрезентативной инструкции. Разные запросы с одной структурой объединяются в кластеры: этот текст — текст для первого запроса в кластере.|

### <a name="querystorepgmswaitsamplingview"></a>query_store.pgms_wait_sampling_view
Это представление возвращает данные событий ожидания в хранилище запросов. Для каждого отдельного идентификатора базы данных, идентификатора пользователя, идентификатора запроса и события используется отдельная строка.

|**Имя**|  **Тип**|   **Справочные материалы**| **Описание**|
|---|---|---|---|
|user_id    |oid    |pg_authid.oid  |Идентификатор объекта пользователя, который выполнил инструкцию|
|db_id  |oid    |pg_database.oid    |Идентификатор объекта базы данных, в которой была выполнена инструкция|
|query_id   |bigint     ||Внутренний хэш-код, вычисляемый на основе дерева синтаксического анализа инструкции|
|event_type |текст       ||Тип события, которого ожидает серверный компонент|
|event  |текст       ||Имя события ожидания, если серверный компонент сейчас находится в состоянии ожидания|
|calls  |Целое число         ||Число одинаковых записанных событий|


### <a name="functions"></a>Функции Azure
Query_store.qs_reset() returns void

`qs_reset` удаляет все статистические данные, собранные хранилищем запросов на данный момент. Эту функцию может выполнить только роль администратора сервера.

Query_store.staging_data_reset() returns void

`staging_data_reset` удаляет все статистические данные, собранные хранилищем запросов в памяти (то есть данные в памяти, которые еще не были очищены в базе данных). Эту функцию может выполнить только роль администратора сервера.


## <a name="next-steps"></a>Дополнительная информация
- Дополнительные сведения о [ситуациях, в которых хранилище запросов может быть особенно полезным](concepts-query-store-scenarios.md).
- Дополнительные сведения о [рекомендациях по работе с хранилищем запросов](concepts-query-store-best-practices.md).