---
title: Обзор конечных точек служб виртуальной сети Базы данных Azure для сервера PostgreSQL | Документация Майкрософт
description: Описание работы конечных точек служб виртуальной сети сервера Базы данных Azure для PostgreSQL.
services: postgresql
author: mbolz
ms.author: mbolz
manager: jhubbard
editor: jasonwhowell
ms.service: postgresql
ms.topic: conceptual
ms.date: 08/20/2018
ms.openlocfilehash: 4f488128b3f7a9aa06be9358439536d78615430e
ms.sourcegitcommit: 974c478174f14f8e4361a1af6656e9362a30f515
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2018
ms.locfileid: "42144439"
---
# <a name="use-virtual-network-service-endpoints-and-rules-for-azure-database-for-postgresql"></a>Использование конечных точек службы и правил виртуальной сети для Базы данных Azure для PostgreSQL

*Правила виртуальной сети* — это одна из функций безопасности брандмауэра, обеспечивающая управление приемом сервером Базы данных Azure для PostgreSQL подключений из определенных подсетей в виртуальных сетях. В этой статье объясняется, почему правила виртуальной сети иногда являются лучшим вариантом для защиты подключений к серверу Базы данных Azure для PostgreSQL.

Чтобы создать правило виртуальной сети, требуется [виртуальная сеть][vm-virtual-network-overview] и [конечная точка службы виртуальной сети][vm-virtual-network-service-endpoints-overview-649d], используемая для ссылки. На следующем рисунке показано, как конечная точка службы виртуальной сети работает с Базой данных Azure для PostgreSQL.

![Пример того, как работает конечная точка службы виртуальной сети](media/concepts-data-access-and-security-vnet/vnet-concept.png)

> [!NOTE]
> Эта функция доступна во всех облаках общедоступного облака Azure, где База данных Azure для PostgreSQL развернута для серверов общего назначения и оптимизирована для операций в памяти.

<a name="anch-terminology-and-description-82f" />

## <a name="terminology-and-description"></a>Терминология и описание

**Виртуальная сеть**. С подпиской Azure могут быть связаны виртуальные сети.

**Подсеть**. Виртуальная сеть содержит **подсети**. Все ваши виртуальные машины Azure назначены в подсети. Одна подсеть может содержать несколько виртуальных машин или других вычислительных узлов. Вычислительные узлы, которые находятся вне вашей виртуальной сети, не имеют доступа к ней, если только не настроить систему безопасности таким образом, чтобы предоставить им доступ.

**Конечная точка службы виртуальной сети**. [Конечная точка службы виртуальной сети][vm-virtual-network-service-endpoints-overview-649d] — это подсеть, значения свойств которой включают в себя одно или несколько формальных имен типов службы Azure. В этой статье мы рассмотрим тип **Microsoft.Sql**, который относится к службе Azure, которая называется Базой данных SQL. Этот тег службы также применяется к службам "База данных Azure для PostgreSQL" и "База данных Azure для MySQL". Важно отметить, что при применении тега службы **Microsoft.Sql** к конечной точке службы виртуальной сети она настроит трафик конечной точки службы для всех серверов базы данных SQL Azure, Базы данных Azure для PostgreSQL и базы данных Azure для PostgreSQL в подсети. 

**Правило виртуальной сети**. Правило виртуальной сети для сервера базы данных Azure для PostgreSQL — это подсеть, которая указана в списке управления доступом (ACL) сервера Базы данных Azure для PostgreSQL. Для включения в ACL для сервера базы данных Azure для PostgreSQL подсеть должна содержать имя типа **Microsoft.Sql**.

Правило виртуальной сети предписывает серверу Базы данных Azure для PostgreSQL принимать подключения от всех узлов, находящихся в подсети.







<a name="anch-benefits-of-a-vnet-rule-68b" />

## <a name="benefits-of-a-virtual-network-rule"></a>Преимущества правила виртуальной сети

Пока вы не выполните соответствующие действия, виртуальные машины в подсети не могут взаимодействовать с сервером Базы данных Azure для PostgreSQL. Создание правила виртуальной сети — это единственное действие, которое устанавливает подключение. Чтобы обосновать выбор подхода на основе правил виртуальной сети, требуется сравнить преимущества и недостатки этого подхода с конкурирующими функциями безопасности, предоставляемыми брандмауэром.

### <a name="a-allow-access-to-azure-services"></a>О. Разрешение доступа к службам Azure

На панели безопасности подключения есть кнопка **Вкл./Выкл.** с надписью **Разрешить доступ к службам Azure**. Значение **ON** (Вкл.) разрешает подключение со всех IP-адресов Azure и из всех подсетей Azure. Эти Azure IP-адреса и подсети могут принадлежать не вам. Возможно, значение **Вкл.** делает вашу систему более открытой, чем требуется для Базы данных Azure для PostgreSQL. Правила виртуальной сети обеспечивают более детализированный контроль.

### <a name="b-ip-rules"></a>B. Правила фильтрации IP-адресов

Брандмауэр Базы данных Azure для PostgreSQL позволяет указать диапазоны IP-адресов, подключения с которых принимаются Базой данных Azure для PostgreSQL. Эта методика хорошо подходит для постоянных IP-адресов, которые находятся за пределами частной сети Azure. Однако за пределами частной сети Azure используется множество *динамических* IP-адресов. Динамические IP-адреса могут изменяться, например при перезапуске виртуальной машины. Было бы неразумно указывать динамический IP-адрес в правиле брандмауэра в рабочей среде.

Можно сохранить выбранный IP-адрес, присвоив виртуальной машине *статический* IP-адрес. Дополнительные сведения см. в разделе [Настройка частных IP-адресов для виртуальной машины с помощью портала Azure][vm-configure-private-ip-addresses-for-a-virtual-machine-using-the-azure-portal-321w].

Однако применение статических IP-адресов может усложнить управление и создать дополнительные расходы при увеличении масштаба среды. Правила виртуальной сети проще устанавливать и контролировать.

### <a name="c-cannot-yet-have-azure-database-for-postgresql-on-a-subnet-without-defining-a-service-endpoint"></a>C. Базу данных Azure для PostgreSQL невозможно создать в подсети без определения конечной точки службы

Если сервер **Microsoft.Sql** был узлом в подсети виртуальной сети, то все узлы в этой виртуальной сети могли взаимодействовать с сервером Базы данных Azure для PostgreSQL. В этом случае виртуальные машины могли взаимодействовать с Базой данных Azure для PostgreSQL без необходимости в каких-либо правилах виртуальной сети или правилах фильтрации IP-адресов.

Однако к августу 2018 года служба Базы данных Azure для PostgreSQL еще не вошла в список служб, которые могут быть назначены напрямую в подсеть.

<a name="anch-details-about-vnet-rules-38q" />

## <a name="details-about-virtual-network-rules"></a>Сведения о правилах виртуальной сети

В этом разделе приводятся некоторые сведения о правилах виртуальной сети.

### <a name="only-one-geographic-region"></a>Только один географический регион

Каждая конечная точка службы виртуальной сети может использоваться только в одном регионе Azure. Конечная точка не поддерживает прием подключений из подсети в других регионах.

Любое правило виртуальной сети ограничена регионом, в котором используется базовая конечная точка.

### <a name="server-level-not-database-level"></a>На уровне сервера, а не базы данных

Каждое правило виртуальной сети применяется ко всему серверу Базы данных Azure для PostgreSQL, не только к одной конкретной базе данных на сервере. Другими словами, правило виртуальной сети применяется на уровне сервера,а не на уровне базы данных.

#### <a name="security-administration-roles"></a>Роли администратора безопасности

Роли безопасности для администрирования конечных точек службы виртуальной сети разделены. Требуется действие каждой из следующих ролей:

- **администратор сети:**&nbsp; включение конечной точки;
- **администратор базы данных:**&nbsp; обновление списка управления доступом (ACL) для добавления данной подсети на сервер Базы данных Azure для PostgreSQL.

*Альтернатива RBAC*

Роли администратора сети и администратора базы данных имеют больше возможностей, чем требуется для управления правилами виртуальной сети. На самом деле для этого требуется только часть их возможностей.

У вас есть возможность использовать [управление доступом на основе ролей (RBAC)][rbac-what-is-813s] в Azure, чтобы создать отдельную настраиваемую роль с необходимыми правами. Эту настраиваемую роль можно использовать вместо роли администратора сети или администратора базы данных. Контактная зона потенциального нарушения безопасности будет меньше при добавлении пользователя в настраиваемую роль, чем при его добавлении в одну из двух основных ролей администратора.

> [!NOTE]
> Иногда База данных Azure для PostgreSQL и подсеть виртуальной сети относятся к разным подпискам. В этих случаях необходимо обеспечить следующую конфигурацию:
> - Обе подписки должны быть в одном клиенте Azure Active Directory.
> - Пользователь должен иметь необходимые разрешения для запуска операций, например для включения конечных точек службы или добавления подсети виртуальной сети к заданному серверу.

## <a name="limitations"></a>Ограничения

Для Базы данных Azure для PostgreSQL правила виртуальной сети имеют следующие ограничения:

- В брандмауэре для Базы данных Azure для PostgreSQL каждое правило виртуальной сети ссылается на подсеть. Все такие упомянутые подсети должны размещаться в том же географическом регионе, где размещена База данных Azure для PostgreSQL.

- Каждый сервер Базы данных Azure для PostgreSQL может использовать до 128 записей ACL для любой заданной виртуальной сети.

- Правила виртуальной сети применяются только к виртуальным сетям Azure Resource Manager, но не к сетям на основе [классической модели развертывания][arm-deployment-model-568f].

- Включение конечных точек службы виртуальной сети для Базы данных Azure для PostgreSQL с помощью тега службы **Microsoft.Sql** также включает конечные точки для всех служб Базы данных Azure: Базы данных Azure для MySQL, Базы данных Azure для PostgreSQL, базы данных SQL Azure и хранилища данных SQL Azure.

- Поддержка конечных точек службы виртуальной сети предназначена только для серверов общего назначения и серверов, оптимизированных для операций в памяти.

- К приведенным ниже элементам сети применяются диапазоны IP-адресов в брандмауэре, а правила виртуальной сети — нет:
    - [виртуальная частная сеть (VPN) типа "сеть — сеть"][vpn-gateway-indexmd-608y].
    - локальная среда с подключением [ExpressRoute][expressroute-indexmd-744v].

## <a name="expressroute"></a>ExpressRoute

Если сеть подключена к сети Azure с использованием [ExpressRoute][expressroute-indexmd-744v], то для каждого канала настроены два общедоступных IP-адреса в Microsoft Edge. Эти два IP-адреса используются для подключения к службам Майкрософт, таким как служба хранилища Azure, с помощью общедоступного пиринга Azure.

Чтобы разрешить взаимодействие канала с Базой данных Azure для PostgreSQL, необходимо создать правила IP-сети для общедоступных IP-адресов каналов. Чтобы найти общедоступные IP-адреса канала ExpressRoute, отправьте запрос по ExpressRoute в службу поддержки через портал Azure.

## <a name="adding-a-vnet-firewall-rule-to-your-server-without-turning-on-vnet-service-endpoints"></a>Добавление правила брандмауэра виртуальной сети к серверу без включения конечных точек службы виртуальной сети

Если задано лишь правило брандмауэра, обеспечить безопасность сервера в виртуальной сети невозможно. Для безопасности нужно **включить** конечные точки службы виртуальной сети. При **включении** конечных точек службы подсеть виртуальной сети будет простаивать, пока не будет выполнен переход из состояния **Выкл.** в состояние **Вкл.** Это особенно верно в случае с большими виртуальными сетями. С помощью параметра **IgnoreMissingServiceEndpoint** можно уменьшить или исключить время простоя во время перехода.

Задать параметр **IgnoreMissingServiceEndpoint** можно с помощью Azure CLI или портала.

## <a name="related-articles"></a>Связанные статьи
- [Виртуальные сети Azure][vm-virtual-network-overview]
- [Конечные точки служб виртуальной сети][vm-virtual-network-service-endpoints-overview-649d]

## <a name="next-steps"></a>Дополнительная информация
Статьи о создании правил виртуальной сети см. по следующим ссылкам:
- [Create and manage Azure Database for PostgreSQL VNet service endpoints and VNet rules by using the Azure portal](howto-manage-vnet-using-portal.md) (Создание конечных точек службы виртуальной сети Базы данных Azure для PostgreSQL и правил виртуальной сети с использованием портала Azure)
- [Create and manage Azure Database for PostgreSQL VNet service endpoints using Azure CLI](howto-manage-vnet-using-cli.md) (Создание конечных точек службы виртуальной сети Базы данных Azure для PostgreSQL и правил виртуальной сети с использованием интерфейса командной строки Azure)


<!-- Link references, to text, Within this same Github repo. -->
[arm-deployment-model-568f]: ../azure-resource-manager/resource-manager-deployment-model.md

[vm-virtual-network-overview]: ../virtual-network/virtual-networks-overview.md

[vm-virtual-network-service-endpoints-overview-649d]: ../virtual-network/virtual-network-service-endpoints-overview.md

[vm-configure-private-ip-addresses-for-a-virtual-machine-using-the-azure-portal-321w]: ../virtual-network/virtual-networks-static-private-ip-arm-pportal.md

[rbac-what-is-813s]: ../active-directory/role-based-access-control-what-is.md

[vpn-gateway-indexmd-608y]: ../vpn-gateway/index.yml

[expressroute-indexmd-744v]: ../expressroute/index.yml