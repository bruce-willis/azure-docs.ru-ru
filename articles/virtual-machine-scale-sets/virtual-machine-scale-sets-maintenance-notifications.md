---
title: Уведомления об обслуживании для масштабируемых наборов виртуальных машин в Azure | Документация Майкрософт
description: Сведения о просмотре уведомлений об обслуживании и запуске самообслуживания для масштабируемых наборов виртуальных машин в Azure.
services: virtual-machine-scale-sets
documentationcenter: ''
author: shants123
editor: ''
tags: azure-service-management,azure-resource-manager
ms.assetid: ''
ms.service: virtual-machine-scale-sets
ms.workload: infrastructure-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/09/2018
ms.author: shants
ms.openlocfilehash: 82a3ce9f899e94a1cc737f2ca2dc1dc79688a224
ms.sourcegitcommit: 7b845d3b9a5a4487d5df89906cc5d5bbdb0507c8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/14/2018
ms.locfileid: "42146946"
---
# <a name="planned-maintenance-notifications-for-virtual-machine-scale-sets"></a>Уведомления о плановом обслуживании для масштабируемых наборов виртуальных машин

Azure периодически внедряет обновления, чтобы повысить надежность, производительность и безопасность инфраструктуры узлов для виртуальных машин. Эти обновления могут включать исправления среды размещения, модернизацию оборудования и (или) вывод оборудования из эксплуатации. В большинстве случаев обновления никак не влияют на размещенные виртуальные машины. Но в некоторых ситуациях такое влияние может проявляться.

- Если обслуживание не требует перезагрузки, Azure применяет миграцию на месте для временной остановки виртуальной машины на период обновления узла. Операции обслуживания, для которых не требуется перезагрузка, выполняются поочередно для каждого домена сбоя. Этот процесс останавливается, если возникают любые предупреждения о состоянии работоспособности.

- Если для обслуживания требуется перезагрузка, вы получите уведомление о запланированном обслуживании с указанием времени. В этих случаях вам предоставляется некоторый период (окно), в течение которого вы можете самостоятельно запустить обслуживание в удобное время.


Плановое обслуживание, требующее перезагрузки, разделяется на несколько этапов. На каждом этапе затрагиваются разные области (регионы).

- Волна начинается с уведомления клиентов. По умолчанию уведомление отправляется владельцу и совладельцам подписки. С помощью [оповещений журнала действий](../monitoring-and-diagnostics/monitoring-overview-activity-logs.md) Azure вы можете добавить получателей и другие методы доставки уведомлений (электронная почта, текстовые сообщения или веб-перехватчики).  
- Такое уведомление обозначает начало *периода самообслуживания*. В течение указанного периода вы можете выяснить, какие виртуальные машины будут обслуживаться на текущем этапе. Также у вас есть возможность запустить обслуживание в удобное для вас время.
- После периода самообслуживания, начинается *период запланированного обслуживания*. В определенный момент этого периода Azure назначает и применяет для вашей виртуальной машины необходимые операции обслуживания. 

Такое разделение на два периода дает вам достаточно времени для запуска обслуживания и перезагрузки виртуальной машины до того, как Azure начнет обслуживание автоматически.


Чтобы получить информацию о периодах обслуживания и (или) запустить самообслуживание виртуальных машин, включенных в масштабируемые наборы виртуальных машин, можно использовать портал Azure, PowerShell, REST API или CLI.

  
## <a name="should-you-start-maintenance-during-the-self-service-window"></a>Нужно ли начинать обслуживание в период самообслуживания?  

Приведенные ниже рекомендации помогут вам решить, нужно ли самостоятельно выбирать время для запуска обслуживания.

> [!NOTE] 
> Самостоятельное обслуживание может оказаться недоступным для некоторых виртуальных машин. Чтобы определить, доступно ли упреждающее обслуживание для ваших виртуальных машин, проверьте наличие ссылки **Начать** в информации о состоянии обслуживания. Самообслуживание сейчас недоступно для облачных служб Azure (веб-ролей и рабочих ролей) и Azure Service Fabric.


Самостоятельное обслуживание не рекомендуется для развертываний, основанных на *группах доступности*. Группы доступности образуют систему с высоким уровнем доступности, в которой любые изменения применяются в любой момент только к одному домену обновления. Для групп доступности нужно учесть следующие факторы и рекомендации:

- Позвольте Azure управлять запуском обслуживания. Если обслуживание требует перезагрузки, оно выполняется отдельно для каждого домена обновления. Домены обновления не обязательно обновляются последовательно. Между обслуживанием доменов обновления соблюдаются паузы не менее 30 минут.
- Если для вас недопустима временная потеря мощности или пропускной способности (в объеме, обратно пропорциональном количеству доменов обновления), эту проблему можно легко устранить: добавьте на весь период обслуживания необходимое количество дополнительных экземпляров.
- Если обслуживание не требует перезагрузки, обновления применяются на уровне доменов сбоя. 
    
**Не применяйте** режим самообслуживания в следующих ситуациях. 

- Если вы часто завершаете работу виртуальных машин вручную из DevTest Labs, автоматически или по расписанию. Самостоятельное обслуживание в таких сценариях может привести к отмене изменений в состоянии обслуживания и, соответственно, к дополнительным простоям.
- Если вы используете виртуальные машины в течение короткого периода, то есть они наверняка будут удалены до завершения периода обслуживания. 
- Если вы используете рабочие нагрузки с большим объемом информации о состоянии, которая хранится на локальном (временном) диске и должна сохраняться после обновления. 
- Если вы часто изменяете размеры виртуальной машины. Этот может привести к отмене изменений в состоянии обслуживания. 
- Если вы настроили запланированные события, которые активируют для рабочей нагрузки упреждающую отработку отказа или корректное завершение работы за 15 минут до выключения на обслуживание.

Обязательно **используйте** самообслуживание, если вам важна непрерывная работа виртуальной машины в течение всего периода запланированного обслуживания и ваша система не соответствует ни одному из указанных выше "блокирующих" условий. 

Режим самообслуживания лучше всего подходит для следующих ситуаций:

- Если вам нужно сообщить руководству и (или) клиенту точное время обслуживания. 
- Если вам важно завершить обслуживание не позднее определенной даты. 
- Если вам важно соблюдать определенную последовательность обслуживания, например, для безопасного восстановления многоуровневого приложения.
- Если вам нужна пауза более 30 минут для восстановления виртуальных машин между обслуживанием двух доменов обновления. Чтобы управлять длительностью пауз между обслуживанием доменов обновления, запускайте обслуживание виртуальных машин только для одного домена обновления в каждый момент времени.

 
## <a name="view-virtual-machine-scale-sets-that-are-affected-by-maintenance-in-the-portal"></a>Просмотр масштабируемых наборов виртуальных машин, для которых будет выполняться обслуживание, на портале

Когда будет запланирован очередной этап обслуживания, вы сможете просмотреть на портале Azure список масштабируемых наборов виртуальных машин, которые будут затронуты на этом этапе. 

1. Войдите на [портале Azure](https://portal.azure.com).
2. В меню слева последовательно выберите **Все службы** и **Масштабируемые наборы виртуальных машин**.
3. В разделе **Масштабируемые наборы виртуальных машин** выберите **Изменить столбцы**, чтобы открыть список доступных столбцов.
4. В разделе **Доступные столбцы** выберите элемент **Самообслуживание** и переместите его в список **Выбранные столбцы**. Нажмите кнопку **Применить**.  

    Чтобы элемент **Самообслуживание** было проще найти, в разделе **Доступные столбцы** вместо значения **Все** выберите значение **Свойства**.

Теперь столбец **Самообслуживание** появится в списке масштабируемых наборов виртуальных машин. Для каждого масштабируемого набора виртуальных машин в столбце "Самообслуживание" может быть одно из следующих значений.

| Значение | ОПИСАНИЕ |
|-------|-------------|
| Yes | По меньшей мере для одной из виртуальных машин в этом наборе действует период самообслуживания. В период самообслуживания обслуживание можно запустить в любое время. | 
| Нет  | В этом наборе нет ни одной виртуальной машины, для которой действует период самообслуживания. | 
| - | Ни один из масштабируемых наборов виртуальных машин не будет затронут на предстоящем этапе планового обслуживания.| 

## <a name="notification-and-alerts-in-the-portal"></a>Уведомление и оповещения на портале

Azure извещает расписание планового обслуживания, отправив сообщение владельцу подписки или группе совладельцев. Вы можете добавить получателей и (или) каналы для получения этой информации, создавая оповещения журнала действий Azure. Дополнительные сведения см. в статье [Мониторинг действий подписки с помощью журнала действий Azure](../monitoring-and-diagnostics/monitoring-overview-activity-logs.md).

1. Войдите на [портале Azure](https://portal.azure.com).
2. В меню слева выберите **Монитор**. 
3. На панели **Монитор — Оповещения (классические)** выберите **+Добавить оповещение журнала действий**.
4. На странице **Добавить оповещение журнала действий** выберите или введите требуемую информацию. В разделе **Критерии** установите следующие значения:
   - **Категория событий** — выберите **Работоспособность служб**.
   - **Службы** — выберите **Virtual Machine Scale Sets and Virtual Machines** (Масштабируемые наборы виртуальных машин и виртуальные машины).
   - **Тип** — выберите **Плановое техническое обслуживание**. 
    
Дополнительные сведения о том, как настроить оповещения журнала действий вы найдете [здесь](../monitoring-and-diagnostics/monitoring-activity-log-alerts.md).
    
    
## <a name="start-maintenance-on-your-virtual-machine-scale-set-from-the-portal"></a>Запуск обслуживания масштабируемого набора виртуальных машин на портале

Дополнительные сведения об обслуживании можно найти в обзоре масштабируемых наборах виртуальных машин. Если хотя бы одна виртуальная машина в масштабируемом наборе виртуальных машин будет затронута на очередном этапе планового обслуживания, в верхней части страницы появится лента уведомления. Щелкните эту ленту, чтобы перейти к странице **Обслуживание**. 

На странице **Обслуживание** отображаются сведения о том, какой экземпляр виртуальной машины будет затронут плановым обслуживанием. Чтобы начать обслуживание, установите флажок для соответствующей виртуальной машины. Затем щелкните **Начать обслуживание**.

Как только вы запустите обслуживание, выбранные виртуальные машины из масштабируемого набора станут временно недоступны. Если вы пропустите период самообслуживания, для вас будет доступна только информация о периоде автоматического обслуживания Azure для этого масштабируемого набора виртуальных машин.
 
## <a name="check-maintenance-status-by-using-powershell"></a>Проверка состояния обслуживания с помощью PowerShell

Чтобы узнать, когда для виртуальных машин в ваших масштабируемых наборах виртуальных машин запланировано обслуживание, вы можете использовать Azure PowerShell. Информацию о плановом обслуживании можно получить, выполнив командлет [Get-AzureRmVmss](https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmss) с параметром `-InstanceView`.
 
Сведения об обслуживании возвращаются, только если обслуживание запланировано. Если запланированное обслуживание не затрагивает указанный экземпляр виртуальной машины, командлет не возвращает информацию об обслуживании. 

```powershell
Get-AzureRmVmss -ResourceGroupName rgName -VMScaleSetName vmssName -InstanceId id -InstanceView
```

В разделе **MaintenanceRedeployStatus** возвращаются следующие свойства: 
| Значение | ОПИСАНИЕ   |
|-------|---------------|
| IsCustomerInitiatedMaintenanceAllowed | Указывает, можно ли сейчас запустить обслуживание на этой виртуальной машине. ||
| PreMaintenanceWindowStartTime         | Начало периода самообслуживания, в течение которого можно инициировать обслуживание на виртуальной машине. ||
| PreMaintenanceWindowEndTime           | Конец периода самообслуживания, в течение которого можно инициировать обслуживание на виртуальной машине. ||
| MaintenanceWindowStartTime            | Начало периода запланированного обслуживания, в течение которого Azure запустит обслуживание для виртуальной машины. ||
| MaintenanceWindowEndTime              | Конец периода запланированного обслуживания, в течение которого Azure запустит обслуживание для виртуальной машины. ||
| LastOperationResultCode               | Результат последней попытки запуска обслуживания на этой виртуальной машине. ||



### <a name="start-maintenance-on-your-vm-instance-by-using-powershell"></a>Запуск обслуживания на экземпляре виртуальной машины с помощью PowerShell

Вы можете запустить обслуживание для виртуальной машины, если параметр **IsCustomerInitiatedMaintenanceAllowed** для нее имеет значение **True**. Используйте командлет [Set-AzureRmVmss](/powershell/module/azurerm.compute/set-azurermvmss) с параметром `-PerformMaintenance`.

```powershell
Set-AzureRmVmss -ResourceGroupName rgName -VMScaleSetName vmssName -InstanceId id -PerformMaintenance 
```

## <a name="check-maintenance-status-by-using-the-cli"></a>Проверка состояния обслуживания с помощью CLI

Сведения о плановом обслуживании можно просмотреть с помощью команды [az vmss list-instances](/cli/azure/vmss?view=azure-cli-latest#az-vmss-list-instances).
 
Сведения об обслуживании возвращаются, только если обслуживание запланировано. Если запланированное обслуживание не затрагивает указанный экземпляр виртуальной машины, команда не возвращает информацию об обслуживании. 

```azure-cli
az vmss list-instances -g rgName -n vmssName --expand instanceView
```

Для каждого экземпляра виртуальной машины в разделе **MaintenanceRedeployStatus** возвращаются следующие свойства: 
| Значение | ОПИСАНИЕ   |
|-------|---------------|
| IsCustomerInitiatedMaintenanceAllowed | Указывает, можно ли сейчас запустить обслуживание на этой виртуальной машине. ||
| PreMaintenanceWindowStartTime         | Начало периода самообслуживания, в течение которого можно инициировать обслуживание на виртуальной машине. ||
| PreMaintenanceWindowEndTime           | Конец периода самообслуживания, в течение которого можно инициировать обслуживание на виртуальной машине. ||
| MaintenanceWindowStartTime            | Начало периода запланированного обслуживания, в течение которого Azure запустит обслуживание для виртуальной машины. ||
| MaintenanceWindowEndTime              | Конец периода запланированного обслуживания, в течение которого Azure запустит обслуживание для виртуальной машины. ||
| LastOperationResultCode               | Результат последней попытки запуска обслуживания на этой виртуальной машине. ||


### <a name="start-maintenance-on-your-vm-instance-by-using-the-cli"></a>Запуск обслуживания на экземпляре виртуальной машины с помощью CLI

Если для параметра `IsCustomerInitiatedMaintenanceAllowed` задано значение **True**, при вызове следующей функции запускается обслуживание для экземпляра виртуальной машины:

```azure-cli
az vmss perform-maintenance -g rgName -n vmssName --instance-ids id
```

## <a name="faq"></a>Часто задаваемые вопросы

**Вопрос. Зачем вам нужно перезагружать мою виртуальную машину?**

**Ответ.** Большинство обновлений платформы Azure не влияет на доступность виртуальных машин, но в некоторых случаях мы не можем избежать перезагрузки виртуальных машин, размещенных в Azure. Накопилось уже несколько изменений, для которых нам нужно перезапустить наши серверы, а значит, и вашу виртуальную машину.

**Вопрос. Могу ли я гарантировать безопасность, если выполню все рекомендации по настройке группы доступности для обеспечения высокого уровня доступности?**

**Ответ.** Для виртуальных машин, развернутых в группе доступности или в масштабируемом наборе виртуальных машин, применяется концепция доменов обновления. Во время обслуживания Azure учитывает ограничения доменов обновления и не выполняет перезагрузку виртуальных машин из разных доменов обновления, входящих в одну группу доступности. Также Azure ожидает не менее 30 минут, прежде чем переходить к обновлению следующей группы виртуальных машин. 

Дополнительные сведения о высоком уровне доступности есть в статье о [регионах и доступности виртуальных машин в Azure](../virtual-machines/windows/regions-and-availability.md).

**Вопрос. Как я получу информацию о плановом обслуживании?**

**Ответ.** Процедура планового обслуживания начинается с настройки расписания для одного или нескольких регионов Azure. Вскоре после этого владельцам подписки отправляется уведомление по электронной почте (одно сообщение для каждой подписки). Дополнительные каналы и получателей уведомлений можно настроить с помощью оповещений журнала действий. Если вы развертываете виртуальную машину в регионе, для которого уже назначено плановое обслуживание, уведомление не создается. Чтобы узнать о плановом обслуживании, проверьте состояние обслуживания для виртуальной машины.

**Вопрос. Я не вижу никакой информации о плановом обслуживании на портале, в PowerShell или интерфейсе командной строки. Что я делаю не так?**

**Ответ.** Сведения о плановом обслуживании доступны только во время этапа планового обслуживания, и только для тех виртуальных машин, которые затронуты на этом этапе. Если вы не видите никаких данных, значит, процедура обслуживания уже завершена, еще не запущена или виртуальная машина размещается на уже обновленном сервере.

**Вопрос. Можно ли точно узнать время обслуживания моей виртуальной машины?**

**Ответ.** При создании расписания мы определяем период длительностью в несколько дней. Точная последовательность серверов (и связанных виртуальных машин) в рамках этого периода неизвестна. Если вам важно знать точное время обновления виртуальных машин, используйте [запланированные события](../virtual-machines/windows/scheduled-events.md). Вы можете создать на виртуальной машине запрос, позволяющий получить уведомление за 15 минут до перезагрузки этой виртуальной машины.

**Вопрос. Как долго будет перезагружаться виртуальная машина?**

**Ответ.** Перезагрузка в течение периода самообслуживания может занять несколько минут. Длительность зависит от размера виртуальной машины. Перезагрузка, инициированная Azure в период запланированного обслуживания, обычно занимает около 25 минут. Если вы используете облачные службы (рабочие роли и веб-роли), масштабируемые наборы виртуальных машин или группы доступности, то вы получите дополнительную паузу в 30 минут между обновлением разных групп (доменов обновления) виртуальных машин в период запланированного обслуживания. 

**Вопрос. Информация об обслуживании не отображается в виртуальных машинах. В чем может быть проблема?**

**Ответ.** Есть несколько причин, по которым вы можете не видеть информацию об обслуживании на виртуальных машинах.
   - Вы используете подписку *Для внутреннего использования в Майкрософт*.
   - Для виртуальных машин не запланировано обслуживание. Процедура обслуживания была завершена, отменена или изменена таким образом, что перестала влиять на эти виртуальные машины.
   - В представлении списка виртуальных машин отсутствует столбец **Обслуживание**. Мы добавили этот столбец в представление по умолчанию, но если вы ранее настраивали нестандартное представление, теперь столбец **Обслуживание** следует вручную добавить в представление списка виртуальных машин.

**Вопрос. Для моей виртуальной машины запланировано обслуживание во второй раз. Почему?**

**Ответ.** Есть несколько ситуаций, в которых для виртуальной машины после обслуживания и развертывания будет запланировано новое обслуживание.
   - Мы отменили процедуру обслуживания и перезапустили ее с другими полезными данными. Мы обнаружили полезные данные, при обработке которых происходит сбой, и теперь нам нужно выполнить дополнительное развертывание.
   - Виртуальная машина *восстановлена* на другой узел из-за сбоя оборудования.
   - Вы решили остановить (отменить распределение) и перезапустить виртуальную машину.
   - Вы настроили **автоматическое завершение работы** для виртуальной машины.

## <a name="next-steps"></a>Дополнительная информация

Узнайте, как получать события обслуживания с виртуальной машины с помощью службы [Запланированные события](../virtual-machines/windows/scheduled-events.md).
