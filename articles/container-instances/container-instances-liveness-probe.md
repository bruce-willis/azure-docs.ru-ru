---
title: Настройка проб активности в службе "Экземпляры контейнеров Azure"
description: Подробные сведения о настройке проб активности для перезагрузки неработоспособных контейнеров в службе "Экземпляры контейнеров Azure"
services: container-instances
author: jluk
manager: jeconnoc
ms.service: container-instances
ms.topic: article
ms.date: 06/08/2018
ms.author: juluk
ms.openlocfilehash: 1582f0d7ec688bc72cc9d1aa6ae0ddb0a6ad3a17
ms.sourcegitcommit: 248c2a76b0ab8c3b883326422e33c61bd2735c6c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2018
ms.locfileid: "39213077"
---
# <a name="configure-liveness-probes"></a>Настройка проб активности

Контейнерные приложения могут выполняться на протяжении длительного периода времени, что может стать причиной неисправных состояний, для исправления которых может быть необходимо перезагрузить контейнер. Служба "Экземпляры контейнеров Azure" поддерживает связь проб активности с конфигурациями. Это позволяет перезапустить контейнер в случае сбоев в работе важных функциональных возможностей.

В этой статье описывается развертывание группы контейнеров, содержащей пробу активности. В рамках этого примера демонстрируется автоматический перезапуск имитированного неработоспособного контейнера.

## <a name="yaml-deployment"></a>Развертывание файла YAML

Создайте файл `liveness-probe.yaml` со следующим фрагментом кода. Этот файл определяет группу контейнера, содержащую контейнер NGNIX, который в конечном итоге становится неработоспособным.

```yaml
apiVersion: 2018-06-01
location: eastus
name: livenesstest
properties:
  containers:
  - name: mycontainer
    properties:
      image: nginx
      command:
        - "/bin/sh"
        - "-c"
        - "touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600"
      ports: []
      resources:
        requests:
          cpu: 1.0
          memoryInGB: 1.5
      livenessProbe:
        exec:
            command:
                - "cat"
                - "/tmp/healthy"
        periodSeconds: 5
  osType: Linux
  restartPolicy: Always
tags: null
type: Microsoft.ContainerInstance/containerGroups
```

Выполните следующую команду, чтобы развернуть эту группу контейнеров с представленной выше конфигурацией YAML:

```azurecli-interactive
az container create --resource-group myResourceGroup --name livenesstest -f liveness-probe.yaml
```

### <a name="start-command"></a>Команда "Запуск"

Развертывание определяет команду запуска для выполнения при первом запуске контейнера, определенную свойством `command`, которое принимает массив строк. В этом примере передается следующая команда, которая запускает сеанс Bash и создает файл с именем `healthy` в каталоге `/tmp`:

```bash
/bin/sh -c "touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600"
```

 Перед удалением файла система будет переведена в спящий режим на 30 секунд, а затем — на 10 минут.

### <a name="liveness-command"></a>Команда активности

Это развертывание определяет `livenessProbe`, поддерживающую команду активности `exec`, которая выступает в качестве проверки активности. Если в результате выполнения этой команды возвращается ненулевое значение, работа контейнера будет завершена и перезапущена, после чего отобразится сообщение о том, что не удалось найти файл `healthy`. Если эта команда завершается успешно с кодом выхода 0, никакие действия выполняться не будут.

Свойство `periodSeconds` определяет команду активности, которая должна выполняться каждые 5 секунд.

## <a name="verify-liveness-output"></a>Проверка выходных данных активности

В течение первых 30 секунд завершается работа файла `healthy`, созданного с помощью команды запуска. Если команда активности проверяет наличие файла `healthy`, код состояния возвращает нулевое значение, что свидетельствует об успешном выполнении. Таким образом, перезагрузка не нужна.

Через 30 секунд работа `cat /tmp/healthy` завершится сбоем, что приведет к неработоспособному состоянию и завершению возникающих событий.

Эти события можно просмотреть на портале Azure или в Azure CLI.

![Неработоспособные события на портале][portal-unhealthy]

Просматривая события на портале Azure, вы увидите, что события типа `Unhealthy` будут запускаться после сбоя работы команды активности. Далее будет выполняться событие типа `Killing`, сообщающее об удалении контейнера и необходимости перезагрузки системы. Количество перезагрузок контейнера будет увеличиваться после каждого такого события.

Перезагрузка выполняется "на месте", а ресурсы (например, общедоступные IP-адреса и содержимое конкретного узла) будут сохранены.

![Счетчик перезагрузки на портале][portal-restart]

Если проба активности постоянно завершается сбоем и активирует слишком много перезагрузок, контейнер вводит экспоненциальную задержку.

## <a name="liveness-probes-and-restart-policies"></a>Пробы активности и политики перезагрузки

Политики перезагрузки заменяют поведение перезагрузки, активируемое пробами активности. Например, если задать `restartPolicy = Never` *и* пробу активности, группа контейнеров не будет перезагружаться в случае сбоя проверки активности. Вместо этого группа контейнеров будет соответствовать политике перезагрузки группы контейнеров `Never`.

## <a name="next-steps"></a>Дополнительная информация

Для выполнения сценариев на основе задачи может понадобиться, чтобы пробы активности включали функцию автоматической перезагрузки в случае, если необходимая функция не работает должным образом. Дополнительные сведения о запуске контейнеров на основе задач см. статье [Выполнение задачи-контейнера в службе "Экземпляры контейнеров Azure"](container-instances-restart-policy.md).

<!-- IMAGES -->
[portal-unhealthy]: ./media/container-instances-liveness-probe/unhealthy-killing.png
[portal-restart]: ./media/container-instances-liveness-probe/portal-restart.png
