---
title: 'Azure Front Door Service: методы маршрутизации трафика | Документация Майкрософт'
description: Эта статья поможет вам разобраться в различных методах маршрутизации трафика, используемых Front Door.
services: front-door
documentationcenter: ''
author: sharad4u
ms.service: frontdoor
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/10/2018
ms.author: sharadag
ms.openlocfilehash: 26b4e2b1bf2dc9e59bc41e1d9f0628a1f476d402
ms.sourcegitcommit: 4ecc62198f299fc215c49e38bca81f7eb62cdef3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2018
ms.locfileid: "47031492"
---
# <a name="front-door-routing-methods"></a>Методы маршрутизации Front Door

Azure Front Door Service поддерживает различные методы маршрутизации трафика, которые определяют режим маршрутизации трафика HTTP или HTTPS в разные конечные точки службы. К каждому запросу клиента, поступившему во Front Door, применяется настроенный метод маршрутизации. Это гарантирует, что запросы пересылаются на оптимальный экземпляр внутреннего сервера. 

В службе Front Door используются четыре основных принципа маршрутизации трафика.

* **[Задержка](#latency)**. Маршрутизация на основе задержки гарантирует, что запросы отправляются на внутренние серверы с минимальной допустимой задержкой в диапазоне чувствительности. По сути запросы пользователей направляются в "ближайший" набор внутренних серверов с точки зрения сетевой задержки.
* **[Приоритет](#priority)**. Если вы хотите использовать основной внутренний сервер службы для всего трафика, а также предоставлять резервные внутренние серверы на случай, если основной или резервный внутренний сервер станут недоступны, можно назначить различным внутренним серверам разные приоритеты.
* **[Вес](#weighted)**. Если вы хотите распределять трафик по всему набору внутренних серверов (равномерно или с учетом весовых коэффициентов), можно назначить различным внутренним серверам разный вес.
* **[Сходство сеансов](#sessionaffinity)**. Вы можете настроить сходство сеансов для интерфейсных узлов или доменов, если вы хотите, чтобы последующие запросы пользователя отправлялись на тот же внутренний сервер до тех пор, пока сеанс пользователя остается активным и экземпляр внутреннего сервера сообщает о своей работоспособности на основании проб работоспособности. 

Все конфигурации Front Door включают в себя мониторинг работоспособности внутренних серверов и немедленную глобальную автоматическую отработку отказа. Дополнительные сведения см. в разделе [Пробы работоспособности](front-door-health-probes.md). Front Door можно настроить для применения одного метода маршрутизации. В зависимости от потребностей приложения можно сочетать несколько или все доступные методы маршрутизации, чтобы создать оптимальную топологию маршрутизации.

## <a name = "latency"></a>Маршрутизация трафика на основе минимальной задержки

Скорость реагирования многих приложений можно повысить, развернув внутренние серверы в двух или больше расположениях в разных регионах и направляя трафик в ближайшее к пользователю расположение. Метод маршрутизации трафика по умолчанию для конфигурации Front Door пересылает запросы пользователей на внутренний сервер, ближайший к среде Front Door, получившей запрос. В сочетании с архитектурой произвольной передачи Azure Front Door Service такой подход гарантирует, что каждый из пользователей получает максимальную производительность с учетом своего расположения.

Под ближайшим внутренним сервером не обязательно подразумевается тот, который расположен ближе всего географически. Вместо этого Front Door определяет ближайший внутренний сервер, измеряя сетевую задержку. Узнайте больше об [архитектуре маршрутизации Front Door](front-door-routing-architecture.md). 

Ниже приведен общий процесс принятия решений.

| Доступные внутренние серверы | Приоритет | Задержка (с учетом пробы работоспособности) | Weights |
|-------------| ----------- | ----------- | ----------- |
| Сначала выберите все внутренние серверы, которые включены и возвращают работоспособное состояние (200 ОК) для пробы работоспособности. Предположим, имеются шесть внутренних серверов, A, B, C, D, E и F, и сервер C находится в неработоспособном состоянии, а сервер E отключен. Поэтому список доступных внутренних серверов будет содержать A, B, D и F.  | Затем выбираются наиболее приоритетные внутренние серверы из доступных. Скажем, внутренние серверы A, B и D имеют приоритет 1, а внутренний сервер F имеет приоритет 2. Поэтому будут выбраны внутренние серверы A, B и D.| Выберите внутренние серверы с диапазоном задержки (минимальная задержка и чувствительность к задержке в миллисекундах). Например, если задержка сервера A составляет 15 мс, задержка сервера B — 30 мс и задержка сервера D — 60 мс для среды Front Door и чувствительность к задержке составляет 30 мс, то пул с минимальной задержкой будет состоять из внутренних серверов A и B, так как задержка сервера D на 30 мс выше, чем задержка ближайшего сервера, A. | Наконец, Front Door будет циклически перебирать трафик в окончательном выбранном пуле внутренних серверов с учетом указанных весовых коэффициентов. Например, если внутренний сервер A имеет вес 5, а внутренний сервер B имеет вес 8, то трафик между внутренним серверами A и B будет распределяться в соотношении 5:8. |

>[!NOTE]
> По умолчанию задано значение свойства чувствительности к задержке, равное 0 мс, то есть запрос всегда пересылается на самый быстрый внутренний сервер.


## <a name = "priority"></a>Маршрутизация трафика по приоритету

Как правило, организация стремится обеспечить надежность своих служб, развертывая одну или несколько резервных служб на случай, если основная служба выйдет из строя. В отрасли эта топология также называется топологией развертывания "активный — резервный" или "активный — пассивный". Метод маршрутизации трафика "По приоритету" позволяет клиентам Azure легко реализовать эту схему отработки отказа.

По умолчанию Front Door содержит список внутренних серверов с одинаковым приоритетом. По умолчанию Front Door отправляет трафик только на внутренние серверы с максимальным приоритетом (наименьшим значением приоритета), то есть в основной набор внутренних серверов. Если основные внутренние серверы недоступны, Front Door направляет трафик в дополнительный набор внутренних серверов (с вторым наименьшим значением приоритета). Если и основные, и дополнительные внутренние серверы становятся недоступны, трафик направляется в третий набор внутренних серверов в порядке приоритетности и т. д. Доступность внутреннего сервера основывается на настроенном состоянии (включен или отключен) и текущем состоянии работоспособности внутреннего сервера, которое определяют пробы работоспособности.

### <a name="configuring-priority-for-backends"></a>Настройка приоритета внутренних серверов

Каждый из внутренних серверов во внутреннем пуле в конфигурации Front Door имеет свойство Priority, которое может иметь значение от 1 до 5. С помощью Azure Front Door Service можно настроить приоритет каждого внутреннего сервера явным образом, задав это свойство. Это свойство может принимать значения от 1 до 5. Чем меньше значение, тем выше приоритет. У внутренних серверов могут быть одинаковые значения приоритета.

## <a name = "weighted"></a>Метод маршрутизации трафика со взвешиванием
Маршрутизация трафика по методу взвешивания позволяет распределять трафик равномерно или в соответствии с предустановленными весовыми коэффициентами.

При использовании метода маршрутизации трафика со взвешиванием каждому внутреннему серверу в конфигурации Front Door присваивается определенный вес. Это целое число в диапазоне от 1 до 1000. По умолчанию этот параметр задает вес, равный 50.

Трафик распределяется среди доступных внутренних серверов с указанной допустимой чувствительностью к задержке методом циклического перебора с учетом указанных весовых коэффициентов. Если чувствительность к задержке имеет значение 0 миллисекунд, то это свойство не учитывается, если только в пуле не доступны два внутренних сервера с одинаковой сетевой задержкой. 

Метод взвешивания позволяет реализовать некоторые полезные сценарии.

* **Постепенное обновление приложения**. Направляйте часть трафика на новый внутренний сервер и постепенно доведите объем трафика до 100 %, чтобы соблюсти паритет с остальными внутренними серверами.
* **Перенос приложений в Azure**. Создайте внутренний пул, который включает в себя внутренние серверы, расположенные в среде Azure и за ее пределами. Настройте веса внутренних серверов так, чтобы приоритет отдавался новым внутренним серверам. Это можно делать постепенно, начиная с отключенных новых внутренних серверов, а затем назначая им наименьшие веса, медленно увеличивая их до уровня, при котором они будут принимать большую часть трафика. Затем можно будет отключить менее предпочтительные внутренние серверы и удалить их из пула.  
* **Переход в облако для получения дополнительной емкости**. Быстро расширьте локальное развертывание в облако, воспользовавшись службой Front Door. Если вам требуется дополнительная емкость в облаке, можно добавить или включить дополнительные внутренние серверы и указать, какая часть трафика направляется на каждый из них.

## <a name = "affinity"></a>Сходство сеансов
По умолчанию без использования сходства сеансов Front Door пересылает запросы одного клиента на разные внутренние серверы согласно конфигурации балансировки нагрузки, особенно в том случае, если задержки различных внутренних серверов изменяются или разные запросы одного пользователя поступают в разные среды Front Door. Тем не менее для некоторых приложений с отслеживанием состояния и сценариев предпочтительно, чтобы последующие запросы от одного пользователя поступали на внутренний сервер, который обработал предыдущий запрос. Функция сходства сеансов на основе файлов cookie удобна, если нужно, чтобы сеанс пользователя выполнялся на одном и том же внутреннем сервере. С помощью управляемых Front Door файлов cookie служба Azure Front Door Service может направлять последующий трафик из сеанса пользователя на тот же внутренний сервер для обработки, пока этот сервер находится в работоспособном состоянии и не истек срок действия сеанса пользователя. 

Сходство сеансов можно включить на уровне интерфейсного узла для всех настроенных доменов (или поддоменов). После включения служба Front Door добавляет файл cookie в сеанс пользователя. Используя сходство сеансов на основе файлов cookie, служба Front Door может идентифицировать различных пользователей, даже если они используют один и тот же IP-адрес. В свою очередь, это обеспечивает более равномерное распределение трафика между различными внутренними серверами.

Время существования файла cookie и сеанса пользователя одинаковы, так как сейчас Front Door поддерживает только файл cookie сеанса. 

> [!NOTE]
> Общедоступные прокси-серверы могут мешать использовать сходство сеансов. Это обусловлено тем, что для установления сеанса службе Front Door требуется добавить файл cookie сходства сеансов в ответ. Это невозможно сделать в том случае, если ответ может быть сохранен в кэше, так как это помешает использовать файлы cookie из других клиентов, запрашивающих тот же ресурс. Чтобы избежать этого, сходство сеансов **не** устанавливается, если внутренний сервер отправляет кэшируемый ответ при попытке установить сеанс. Если сеанс уже установлен, то не важно, кэшируется ли ответ от внутреннего сервера.
> В следующих обстоятельствах будет установлено сходство сеансов, **если только** ответ не содержит код состояния HTTP 304:
> - Ответ содержит определенные значения в заголовке ```Cache-Control```, которые предотвращают кэширование, например private или no-store.
> - Ответ содержит заголовок ```Authorization```, срок действия которого не истек.
> - Ответ содержит код состояния HTTP 302.

## <a name="next-steps"></a>Дополнительная информация

- Дополнительные сведения о [создании Front Door](quickstart-create-front-door.md).
- Дополнительные сведения о том, [как работает Front Door](front-door-routing-architecture.md).
