---
title: Аварийное восстановление с помощью Azure DNS и диспетчера трафика | Документация Майкрософт
description: Обзор решений для аварийного восстановления с использованием Azure DNS и диспетчера трафика.
services: dns
documentationcenter: na
author: KumudD
manager: jeconnoc
editor: ''
tags: azure-resource-manager
ms.assetid: ''
ms.service: dns
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 06/08/2018
ms.author: kumud
ms.openlocfilehash: d608378f9b3ff3179f9e37ef13f88c65a645d018
ms.sourcegitcommit: 5a7f13ac706264a45538f6baeb8cf8f30c662f8f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/29/2018
ms.locfileid: "37112992"
---
# <a name="disaster-recovery-using-azure-dns-and-traffic-manager"></a>Аварийное восстановление с помощью Azure DNS и диспетчера трафика

При аварийном восстановлении основное внимание уделяется восстановлению после серьезной потери функциональности приложения. Чтобы выбрать решение для аварийного восстановления, владельцы бизнеса и технологий должны сначала определить уровень функциональности, который требуется приложению во время аварии, например: недоступное, частично доступное с ограниченной функциональностью, с отложенной доступностью или полностью доступное.
Большинство корпоративных клиентов выбирают мультирегиональную архитектуру отработки отказа на уровне приложений или инфраструктуры. Клиенты могут выбрать несколько подходов для обеспечения отработки отказа и высокого уровня доступности через архитектуру резервирования. Ниже приведены некоторые из распространенных подходов.

- **Шаблон "активный — пассивный" с "холодным" резервом**. В этом решении отработки отказа виртуальные машины и другие устройства, работающие в резервном регионе, неактивны до тех пор, пока не возникнет необходимость в отработке отказа. Тем не менее производственная среда реплицируется в виде резервных копий, образов виртуальных машин или шаблонов Resource Manager в другой регион. Этот механизм отработки отказа является экономически эффективным, но занимает больше времени для выполнения полного перехода на другой ресурс.
 
    ![Шаблон "активный — пассивный" с "холодным" резервом](./media/disaster-recovery-dns-traffic-manager/active-passive-with-cold-standby.png)
    
    *Рис. Шаблон "активный — пассивный" с конфигурацией "холодного" резерва аварийного восстановления*

- **Шаблон "активный — пассивный" с контрольным светом**. В этом решении отработки отказа резервная среда настроена с минимальной конфигурацией. Настройка имеет только необходимые службы, работающие для поддержки только минимального и критического набора приложений. По своей сути этот сценарий может выполнять только минимальные функциональные возможности, но его можно масштабировать и создавать дополнительные службы, чтобы взять большую часть производственной нагрузки, если произойдет переход на другой ресурс.
    
    ![Шаблон "активный — пассивный" с контрольным светом](./media/disaster-recovery-dns-traffic-manager/active-passive-with-pilot-light.png)
    
    *Рис. Шаблон "активный — пассивный" с конфигурацией "контрольного света" аварийного восстановления*

- **Шаблон "активный — пассивный" с "теплым" резервом**. В этом решении отработки отказа резервный регион предварительно включен и готов взять на себя базовую нагрузку, включено автоматическое масштабирование, все экземпляры доступны и запущены. Это решение не масштабируется для полной рабочей нагрузки, а является функциональным, где все службы запущены и работают. Это решение является дополненной версией подхода с контрольным светом.
    
    ![Шаблон "активный — пассивный" с "теплым" резервом](./media/disaster-recovery-dns-traffic-manager/active-passive-with-warm-standby.png)
    
    *Рис. Шаблон "активный — пассивный" с конфигурацией "теплого" резерва аварийного восстановления*
    
Дополнительные сведения об отработке отказа и высоком уровне доступности см. в разделе [Аварийное восстановление для приложений Azure](https://docs.microsoft.com/azure/architecture/resiliency/disaster-recovery-azure-applications).


## <a name="planning-your-disaster-recovery-architecture"></a>Планирование архитектуры аварийного восстановления

Существует два технических аспекта относительно настройки архитектуры аварийного восстановления.
-  Использование механизма развертывания для репликации экземпляров, данных и конфигураций между основной и резервной средами. Этот тип аварийного восстановления может быть выполнен с помощью Azure Site-Recovery посредством устройств или служб партнеров Microsoft Azure, таких как Veritas или NetApp. 
- Разработка решения для перенаправления сетевого или Интернет-трафика с основного сайта на резервный. Этот тип аварийного восстановления может осуществляться посредством Azure DNS, диспетчера трафика Azure или глобальной подсистемы балансировки нагрузки сторонних разработчиков.

Эта статья ограничена подходами перенаправления трафика посредством сети и Интернета. Инструкции для настройки Azure Site Recovery см. в разделе [Документация по Site Recovery](https://docs.microsoft.com/azure/site-recovery/).
Служба доменных имен (DNS) является одним из наиболее эффективных механизмов для перенаправления сетевого трафика, поскольку служба DNS часто является глобальной и внешней по отношению к центру обработки данных и изолирована от любых сбоев на уровнях регионов или зон доступности (AZ). Можно использовать механизм отработки отказа на основе DNS и служб Azure (две службы DNS могут выполнить в некотором роде то же самое): Azure DNS (авторитетный DNS) и диспетчера трафика Azure (маршрутизация смарт-трафика на основе DNS). 

Важно понимать несколько концепций в DNS, которые широко используются для обсуждения решений, представленных в этой статье.
- **Запись DNS**. Записи — это указатели, указывающие на IPv4-адрес домена. 
- **CNAME или каноническое имя**. Этот тип записи используется для указания другой записи DNS. CNAME в ответ возвращает не IP-адрес, а указатель на запись, содержащую IP-адрес. 
- **Маршрутизация по весовым коэффициентам**. К конечным точкам службы можно привязать весовые коэффициенты, а затем распределить трафик на основе назначенных весовых коэффициентов. Этот метод маршрутизации является одним из четырех механизмов маршрутизации трафика, доступных в диспетчере трафика. Для получения дополнительных сведений см. раздел [Метод маршрутизации по весовым коэффициентам](../traffic-manager/traffic-manager-routing-methods.md#weighted).
- **Маршрутизация по приоритетам**. Маршрутизация по приоритетам основана на проверке работоспособности конечных точек. По умолчанию диспетчер трафика Azure отправляет весь трафик на конечную точку с наивысшим приоритетом, а при возникновении ошибки или при сбое диспетчер трафика перенаправляет трафик в дополнительную конечную точку. Дополнительные сведения см. в разделе [Метод маршрутизации по приоритетам](../traffic-manager/traffic-manager-routing-methods.md#priority).

## <a name="manual-failover-using-azure-dns"></a>Отработка отказа вручную с использованием Azure DNS
Решение отработки отказа вручную Azure DNS для аварийного восстановления использует стандартный механизм DNS для перехода на другой ресурс с резервной копией сайта. Ручной режим посредством Azure DNS лучше всего работает при использовании сочетания режимов с "холодным" резервом или с контрольным светом. 

![Отработка отказа вручную с использованием Azure DNS](./media/disaster-recovery-dns-traffic-manager/manual-failover-using-dns.png)

*Рис. Отработка отказа вручную с использованием Azure DNS*

Для этого решения сделаны следующие допущения.
-   Основные и дополнительные конечные точки имеют статические IP-адреса, которые нечасто меняются. Допустим, что IP-адрес для первичного сайта — 100.168.124.44, а для вторичного сайта — 100.168.124.43.
-   Для основного и вторичного сайта существуют зоны Azure DNS. Допустим, что для основного сайта конечной точкой является prod.contoso.com, а для резервной копии сайта — dr.contoso.com. Также существует запись DNS для основного приложения, известного как www.contoso.com.   
-   Срок жизни находится на уровне или ниже значения RTO соглашения об уровне обслуживания, установленного в организации. Например, если предприятие задает значение RTO ответа приложения после сбоя 60 мин, то значение срока жизни должно быть меньше 60 мин, считается чем ниже, тем лучше. Настройку Azure DNS для отработки отказа вручную можно выполнить следующим образом.
1. Создание зоны DNS
2. Создание записей зоны DNS
3. Обновление записи CNAME

### <a name="step-1-create-a-dns"></a>Шаг 1. Создание зоны DNS
Создайте зону DNS (например, www.contoso.com), как показано ниже.

![Создание зоны DNS в Azure](./media/disaster-recovery-dns-traffic-manager/create-dns-zone.png)

*Рис. Создание зоны DNS в Azure*

### <a name="step-2-create-dns-zone-records"></a>Шаг 2. Создание записей зоны DNS

В данной зоне создайте три записи (пример: www.contoso.com, prod.contoso.com и dr.consoto.com), как показано на рисунке ниже.

![Создание записей зоны DNS](./media/disaster-recovery-dns-traffic-manager/create-dns-zone-records.png)

*Рис. Создание записей зоны DNS в Azure*

В этом сценарии веб-сайту www.contoso.com задано срок жизни 30 мин, что значительно меньше установленного RTO, и указывает на рабочий веб-сайт prod.contoso.com. Эта конфигурация выполняется во время обычных бизнес-операций. Срок жизни для веб-сайтов prod.contoso.com и dr.contoso.com был установлен 300 секунд или 5 минут. Вы можете использовать службу мониторинга Azure, такую как Azure Monitor или Azure App Insights, или любые партнерские решения для мониторинга, такие как Dynatrace. Можно использовать даже домашние решения, которые могут отслеживать или обнаруживать сбои приложений или виртуальной инфраструктуры.

### <a name="step-3-update-the-cname-record"></a>Шаг 3. Обновление записи CNAME

После обнаружения сбоя измените значение записи, чтобы указать на dr.contoso.com, как показано ниже.
       
![Обновление записи CNAME](./media/disaster-recovery-dns-traffic-manager/update-cname-record.png)

*Рис. Обновление записи CNAME в Azure*

В течение 30 минут большинство резольверов обновит файл кэшированной зоны, и любой запрос к веб-сайту www.contoso.com будет перенаправлен на веб-сайт dr.contoso.com.
Чтобы изменить значение CNAME, также можно выполнить следующую команду Azure CLI.
 ```azurecli
   az network dns record-set cname set-record \
   --resource-group 123 \
   --zone-name contoso.com \
   --record-set-name www \
   --cname dr.contoso.com
```
Этот шаг можно выполнить вручную или с помощью автоматизации. Это можно выполнить вручную через консоль или с помощью Azure CLI. Пакет SDK Azure и API можно использовать для автоматического обновления CNAME без ручного вмешательства. Автоматизация может быть построена посредством службы "Функции Azure" или в стороннем приложении мониторинга, или даже локально.

### <a name="how-manual-failover-works-using-azure-dns"></a>Ручная отработка отказа с использованием Azure DNS
Так как DNS-сервер находится за пределами зоны отработки отказа или аварии, он изолирован от простоев. Это позволяет пользователю создать простой сценарий отработки отказа, который является экономически эффективным и будет работать все время, предполагая, что оператор во время аварии имеет подключение к сети и может сделать переключение. Если решение является сценарием, необходимо убедиться, что сервер или служба, запускающие сценарий, изолированы от проблемы, затрагивающей рабочую среду. Кроме того, имейте в виду низкий срок жизни, который был установлен для зоны, так что ни один резольвер во всем мире не кэширует конечную точку в течение долгого времени, а клиенты могут получать доступ к сайту в пределах RTO. Так как могут потребоваться некоторые предварительные и другие административные действия, необходимо иметь достаточно времени, прежде чем делать переключение при использовании режимов с "холодным" резервом и контрольным светом.

## <a name="automatic-failover-using-azure-traffic-manager"></a>Автоматический переход на другой ресурс с использованием диспетчера трафика Azure
При наличии сложных архитектур и нескольких наборов ресурсов, способных выполнять одну и ту же функцию, можно настроить диспетчер трафика Azure (на основании DNS) для проверки работоспособности ресурсов и направлять трафик от неработоспособного ресурса к работоспособному. В следующем примере основной и дополнительный регионы содержат полное развертывание. Это развертывание включает в себя облачные службы и синхронизированную базу данных. 

![Автоматический переход на другой ресурс с использованием диспетчера трафика Azure](./media/disaster-recovery-dns-traffic-manager/automatic-failover-using-traffic-manager.png)

*Рис. Автоматический переход на другой ресурс, используя диспетчер трафика Azure*

Однако только основной регион активно обрабатывает сетевые запросы от пользователей. Дополнительный регион становится активным, только если в основном регионе происходит нарушение работы службы. В этом случае все новые сетевые запросы перенаправляются в дополнительный регион. Поскольку резервное копирование базы данных происходит почти мгновенно, оба балансировщика нагрузки имеют IP-адреса, которые могут быть проверены на работоспособность, и экземпляры всегда запущены и работают. Эта топология предоставляет возможность перехода на низкий уровень RTO и переход на другой ресурс без какого-либо ручного вмешательства. Дополнительный регион для отработки отказа должен быть готов к работе сразу после сбоя основного региона.
Этот сценарий идеально подходит для использования диспетчера трафика Azure со встроенными пробами для различных типов проверок работоспособности, включая http/https и TCP. Диспетчер трафика Azure также имеет модуль правил, который может быть настроен на переход на другой ресурс при сбое, как описано ниже. Рассмотрим следующие решения с использованием диспетчера трафика.
- Клиент имеет конечную точку Регион № 1, известную как prod.contoso.com, со статическим IP-адресом 100.168.124.44 и конечную точку Регион № 2, известную как dr.contoso.com, со статическим IP-адресом 100.168.124.43. 
-   Каждая из этих сред имеет внешнее устройство связи, подобное подсистеме балансировки нагрузки. Балансировщик нагрузки может быть настроен на наличие конечной точки на основе DNS или полного доменного имени (FQDN), как показано выше.
-   Все экземпляры в Регионе № 2 реплицируются в режиме почти реального времени с Регионом № 1. Кроме того, обновляются образы компьютеров, а все данные конфигурации и программного обеспечения исправлены и точно соответствуют Региону № 1.  
-   Автомасштабирование было предварительно сконфигурировано. 

Ниже приведены шаги, необходимые для настройки отработки отказа с помощью диспетчера трафика Azure.
1. Создание профиля диспетчера трафика Azure
2. Создание конечных точек в профиле диспетчера трафика
3. Настройка конфигурации проверки работоспособности и перехода на другой ресурс

### <a name="step-1-create-a-new-azure-traffic-manager-profile"></a>Шаг 1. Создание профиля диспетчера трафика Azure
Создайте новый профиль диспетчера трафика Azure с именем contoso123 и выберите метод маршрутизации по приоритетам. При наличии существующей группы ресурсов, которую требуется связать, можно выбрать ее. В противном случае создайте новую группу ресурсов.

![Создание профиля диспетчера трафика](./media/disaster-recovery-dns-traffic-manager/create-traffic-manager-profile.png)
*Рис. Создание профиля диспетчера трафика*

### <a name="step-2-create-endpoints-within-the-traffic-manager-profile"></a>Шаг 2. Создание конечных точек в профиле диспетчера трафика

На этом этапе создаются конечные точки, указывающие на рабочие веб-сайты и веб-сайты аварийного восстановления. Здесь в качестве внешней конечной точки выберите **Тип**, но если ресурс размещен в Azure, можно выбрать **конечную точку Azure**. При выборе **конечной точки Azure** затем выберите **Целевой ресурс**, который является либо **службой приложения**, либо **общедоступным IP-адресом**, выделенным Azure. Приоритет установлен как **1**, так как это основная служба для Региона № 1.
Аналогичным образом создайте конечную точку аварийного восстановления в диспетчере трафика.

![Создание конечных точек аварийного восстановления](./media/disaster-recovery-dns-traffic-manager/create-disaster-recovery-endpoint.png)

*Рис. Создание конечных точек аварийного восстановления*

### <a name="step-3-set-up-health-check-and-failover-configuration"></a>Шаг 3. Настройка конфигурации проверки работоспособности и перехода на другой ресурс

На этом шаге срок жизни DNS устанавливается на 10 секунд, что соблюдается большинством рекурсивных резольверов с выходом в Интернет. Эта конфигурация означает, что ни один резольвер DNS не будет кэшировать информацию более 10 секунд. При настройке мониторинга конечной точки параметр "путь" указывает на root или путь к root, но можно настроить параметры конечной точки для вычисления пути, например prod.contoso.com/index. В приведенном ниже примере показан **https** как протокол проверки. Тем не менее можно выбрать **http** или **tcp**. Выбор протокола зависит от конечного приложения. Интервал проверки установлен на 10 секунд, что обеспечивает быструю проверку, а повторение попыток установлено на 3. В результате диспетчер трафика переключится на вторую конечную точку, если три последовательных интервалах зарегистрируют сбой. Следующая формула определяет общее время автоматического перехода на другой ресурс: Время перехода на другой ресурс = Срок жизни + Повторение попыток * Проверка интервала. В этом случае значение равно 10 + 3 * 10 = 40 секунд (Макс).
Если "Повторение попыток" имеет значение 1, а "Срок жизни" установлен на 10 секунд, то время для перехода на другой ресурс равно 10 + 1 * 10 = 20 секунд. Установите значение "Повторение попыток" большее **1**, чтобы исключить переход на другой ресурс из-за ложных срабатываний или любых незначительных сетевых сбоев. 


![Настройка проверки работоспособности](./media/disaster-recovery-dns-traffic-manager/set-up-health-check.png)

*Рис. Настройка конфигурации проверки работоспособности и перехода на другой ресурс*

### <a name="how-automatic-failover-works-using-traffic-manager"></a>Автоматический переход на другой ресурс с использованием диспетчера трафика

Во время аварии основная конечная точка получает пробы и ее состояние изменяется на **пониженное**, а веб-сайт аварийного восстановления становится **подключенным**. По умолчанию диспетчер трафика направляет весь трафик в первичную конечную точку (с наивысшим приоритетом). Если основная конечная точка оказывается с пониженной работоспособностью, диспетчер трафика направляет трафик к дополнительной конечной точке при условии, что она остается в работоспособном состоянии. В диспетчере трафика можно настроить больше конечных точек, которые будут служить дополнительными конечными точками восстановления при отказе или балансирами нагрузки, распределяя нагрузку между конечными точками.

## <a name="next-steps"></a>Дополнительная информация
- См. дополнительные сведения о [диспетчере трафика Azure](../traffic-manager/traffic-manager-overview.md).
- Дополнительные сведения по [Azure DNS](../dns/dns-overview.md).









