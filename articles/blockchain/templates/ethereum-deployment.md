---
title: Шаблон решения консорциума Proof-of-Work для Ethereum
description: Использование шаблона решения консорциума Proof-of-Work для Etherereum для развертывания и настройки сети Ethereum в консорциуме с несколькими участниками
services: azure-blockchain
keywords: ''
author: PatAltimore
ms.author: patricka
ms.date: 5/21/2018
ms.topic: article
ms.service: azure-blockchain
ms.reviewer: zeyadr
manager: femila
ms.openlocfilehash: 823bea9bac8ff270d5b5c02e3b76a2f7236c9c99
ms.sourcegitcommit: 1981c65544e642958917a5ffa2b09d6b7345475d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/03/2018
ms.locfileid: "48241691"
---
# <a name="ethereum-proof-of-work-consortium-solution-template"></a>Шаблон решения консорциума Proof-of-Work для Ethereum

Шаблон решения консорциума Proof-of-Work для Ethereum должен помочь проще и быстрее развертывать и настраивать сеть Ethereum для консорциума с несколькими участниками при минимальных знаниях об Azure и Ethereum.

Небольшой объем входных пользовательских данных и развертывание одним щелчком на портале Azure позволяют для каждого участника подготовить сетевое расположение — с помощью Microsoft Azure Compute, сетевых служб и служб хранилища по всему миру. Сетевое расположение каждого участника состоит из набора узлов с балансировкой нагрузки транзакций, с помощью которого приложение или пользователь могут взаимодействовать для отправки транзакций, набора узлов майнинга для записи транзакций и VPN-шлюза. На следующем этапе добавляется подключение шлюзов для создания полностью настроенной блокчейн-сети из нескольких участников.

## <a name="about-blockchain"></a>О технологии блокчейн

Для тех, кто не знаком с блокчейн-сообществом, выпуск этого решения — отличная возможность познакомиться с этой технологией в простой и настраиваемой среде Azure. Тем не менее, прежде чем создавать сети консорциумов с несколькими участниками, рекомендуется попробовать развернуть автономную сеть Ethereum с простой топологией с помощью представленного здесь пошагового руководства.

### <a name="mining-node-details"></a>Сведения об узлах майнинга

Узлы, которые реализуют майнинговые транзакции, отделены от узлов, которые принимают транзакции, чтобы исключить конкуренцию за ресурсы между двумя разными действиями.

Участник консорциума может подготовить до пяти регионов, содержащих один или несколько узлов майнинга, расположенных на управляемом диске. Один или несколько узлов в регионе настраиваются в качестве загрузочного узла для поддержки динамического обнаружения узлов в сети. Узлы майнинга взаимодействуют с другими узлами майнинга, чтобы координировать состояние базового распределенного реестра. Для приложения нет необходимости взаимодействовать с этими узлами или учитывать их состояние. Используя частные сети, узлы майнинга изолированы от входящего трафика, чтобы обеспечить дополнительный уровень защиты. Исходящий трафик разрешен, но не к порту обнаружения Ethereum.

На всех узлах установлена стабильная версия клиента Go Ethereum (Geth), и все они настроены в качестве узлов майнинга. Если первичный блок не предоставлен, все узлы используют один и тот же адрес Ethereum и пару ключей, защищенную паролем учетной записи Ethereum. Указанная парольная фраза Ethereum используется для создания учетной записи по умолчанию (coinbase) для каждого узла майнинга. Узлы майнинга собирают вознаграждения, которые добавляются в эту учетную запись.

Количество узлов майнинга на каждого участника консорциума зависит от общего размера сети и объема мощностей хэширования, выделенных для каждого участника. Для сетей большего размера необходимо скомпрометировать больше узлов, чтобы получить недобросовестное преимущество. Шаблон поддерживает до 15 узлов майнинга в одном регионе, подготовленных с помощью масштабируемых наборов виртуальных машин.

### <a name="transaction-node-details"></a>Сведения об узле транзакций

Участник консорциума также содержит набор узлов транзакций с балансировкой нагрузки. К этим узлам предусмотрен доступ из внешней виртуальной сети, чтобы приложения могли использовать эти узлы для отправки транзакций или выполнения смарт-контрактов в сети блокчейн. На всех узлах установлена стабильная версия клиента Go Ethereum (Geth), и они настроены для организации полной копии распределенного реестра. Если пользовательский первичный блок не указан, эти узлы используют учетную запись Ethereum, защищенную паролем учетной записи Ethereum.

На узлах транзакций выполняется балансировка нагрузки в группе доступности для обеспечения высокой доступности. Шаблон поддерживает до пяти узлов транзакций, подготовленных с помощью масштабируемого набора виртуальных машин.

### <a name="log-analytics-details"></a>Данные Log Analytics

В каждой среде создается новый экземпляр службы Log Analytics или же можно подключить существующий экземпляр этой службы. Это позволяет отслеживать различные метрики производительности для каждой виртуальной машины, содержащейся в развернутой сети.

## <a name="deployment-architecture"></a>Архитектура развертывания

### <a name="description"></a>ОПИСАНИЕ

Этот шаблон решения можно развернуть для сети консорциума Ethereum с несколькими участниками для одного или нескольких регионов. Виртуальная сеть каждого региона подключена к другим регионам в топологии цепочки с помощью шлюзов виртуальной сети и ресурсов подключения. Он также предоставляет регистратора, который содержит необходимые сведения для всех средства майнинга и узлов транзакций в каждом регионе развертывания.

### <a name="standalone-and-consortium-leader-overview"></a>Общие сведения об изоляции и лидерах консорциума

![Общие сведения об изоляции и лидерах консорциума](./media/ethereum-deployment/leader-overview.png)

### <a name="joining-consortium-member-overview"></a>Общие сведения о присоединении участников к консорциуму

![Общие сведения о присоединении участников к консорциуму](./media/ethereum-deployment/member-overview.png)

## <a name="getting-started"></a>Приступая к работе

Для этого процесса нужна подписка Azure, которая может поддерживать развертывание нескольких масштабируемых наборов виртуальных машин и управление дисками. При необходимости для начала создайте бесплатную учетную запись Azure.

После защиты подписки перейдите на портал Azure. Выберите **+ Создать ресурс**, "Marketplace (просмотреть все)" и выполните поиск **Ethereum Proof-of-Work Consortium** (Консорциум Proof-of-Work для Ethereum).

Развертывание шаблона поможет выполнить настройки для расположения первого участника в сети. Процесс развертывания состоит из пяти шагов: основы, Operations Management Suite, регион развертывания, размер и производительность сети, параметры Ethereum.

### <a name="basics"></a>Основы

В разделе **Основы** укажите значения для стандартных параметров любого развертывания, такие как подписка, группа ресурсов и основные свойства виртуальной машины.

![Основы](./media/ethereum-deployment/sample-deployment.png)

Имя параметра|ОПИСАНИЕ| Допустимые значения|Значения по умолчанию
---|---|---|---
Создать новую сеть или присоединиться к существующей сети?|Создание новой сети или подключение к сети существующего консорциума|Создание новой и присоединение к существующей|Создать
Развернуть сеть, которая будет частью консорциума?|Сеть консорциума позволяет присоединять к этой сети будущие развертывания (отображаются, если выбран вариант *Создать новую* выше)|Изолированный консорциум|Автономный
Префикс ресурса |Строка используется как основа для именования ресурсов (2–4 буквенно-цифровых символа). Для некоторых ресурсов к строке добавляется уникальный хэш при добавлении информации об этих ресурсах.|2–4 буквенно-цифровых символа|Нет данных
Имя пользователя виртуальной машины| Имя пользователя администратора каждой развернутой виртуальной машины (только буквенно-цифровые символы)|1–64 символа |gethadmin
Authentication type (Тип проверки подлинности)|Метод аутентификации на виртуальной машине. |Пароль или открытый ключ SSH|Пароль
Пароль (тип проверки подлинности = пароль)|Пароль учетной записи администратора для каждой развернутой виртуальной машины. Пароль должен содержать символы по меньшей мере трех видов из следующих: 1 строчная буква, 1 прописная буква, 1 цифра и 1 специальный символ. <br />Хотя все виртуальные машины изначально имеют одинаковый пароль, вы можете изменить пароль после инициализации.|12–72 знаков|Нет данных
Ключ SSH (тип аутентификации = открытый ключ)|Ключ защищенной оболочки, используемый для удаленного входа.|| Нет данных
Подписка| Подписка, для которой необходимо развернуть сеть консорциума||Нет данных
Группа ресурсов| Группа ресурсов, куда будет развертываться сеть консорциума.||Нет данных
Расположение| Регион Azure для группы ресурсов. ||Нет данных



### <a name="operations-management-suite"></a>Operations Management Suite

В колонке Operations Management Suite (OMS) можно настроить ресурс OMS для своей сети. OMS будет собирать и оценивать полезные метрики и журналы из сети, предоставляя возможность быстро проверять работоспособность сети и заниматься устранением неполадок. Период использования бесплатной версии OMS завершится после достижения предельного размера сети.

![Создание нового OMS](./media/ethereum-deployment/new-oms.png)

Имя параметра|ОПИСАНИЕ| Допустимые значения|Значения по умолчанию
---|---|---|---
Подключение к существующей OMS|Создание нового экземпляра Log Analytics или присоединение существующего экземпляра|Создание новой и присоединение к существующей|Создание нового расположения Log Analytics|Регион, в котором будет развернута новая служба Log Analytics (отображается, если выбран вариант *Создать новую*)
Идентификатор существующей рабочей области OMS|Идентификатор рабочей области для существующего экземпляра (отображается, если выбран вариант *Join Existing* (Присоединить существующий)) уровня службы OMS|Выберите ценовую категорию для нового экземпляра. Дополнительные сведения см. в https://azure.microsoft.com/pricing/details/log-analytics/ (отображается, если выбран вариант *Join Existing* (Присоединить существующий))|Бесплатный изолированный для каждого узла|Free
Существующий первичный ключ OMS|Первичный ключ используется для подключения к существующему экземпляру OMS (отображается, если выбран вариант *Join Existing* (Присоединить существующий))

### <a name="deployment-regions"></a>Регионы развертывания

Затем в разделе **Регионы развертывания** укажите входные данные для **Number of region(s)** (Количество регионов) для развертывания сети консорциума и выберите регионы Azure, основываясь на указанном количестве регионов. Пользователь может развернуть сеть не более чем в пяти регионах.

![Регионы развертывания](./media/ethereum-deployment/deployment-regions.png)

Имя параметра| ОПИСАНИЕ| Допустимые значения |Значения по умолчанию
---|---|---|---
Количество регионов| Количество регионов для развертывания сети консорциума|1, 2, 3, 4, 5| 2
Первый регион| Первый регион для развертывания сети консорциума|Все разрешенные регионы Azure| Запад США
Второй регион |Второй регион развертывания сети консорциума (отображается только в том случае, если для количества регионов указано значение 2)|Все разрешенные регионы Azure| Восточная часть США
Третий регион| Третий регион развертывания сети консорциума (отображается только в том случае, если для количества регионов указано значение 3)|Все разрешенные регионы Azure| Центральный регион США
Четвертый регион| Четвертый регион развертывания сети консорциума (отображается только в том случае, если для количества регионов указано значение 4)|Все разрешенные регионы Azure| Восток США 2
Пятый регион| Пятый регион развертывания сети консорциума (отображается только в том случае, если для количества регионов указано значение 5)|Все разрешенные регионы Azure| Западный регион США 2

### <a name="network-size-and-performance"></a>Размер и производительность сети

Затем в разделе **Размер и производительность сети** укажите входные данные для размера сети консорциума, такие как количество и размер узлов майнинга и узлов транзакций.

![Размер и производительность сети](./media/ethereum-deployment/network-size-performance.png)

Имя параметра |ОПИСАНИЕ |Допустимые значения| Значения по умолчанию
---|---|---|---
Количество узлов майнинга|Количество узлов майнинга, которые развернуты в одном регионе|2–15| 2
Производительность хранилища узлов майнинга|Тип управляемых дисков, на которых развернуты узлы майнинга.|Standard или Premium|Стандартная
Размер виртуальной машины узла майнинга|Размер виртуальной машины, используемой для узлов майнинга.|"Стандартный" A, <br />"Стандартный" D, <br />"Стандартный" D-v2, <br />"Стандартный" F, <br />"Стандартный" DS, <br />"Стандартный" FS|Стандартный D1v2
Количество узлов транзакций с балансировкой нагрузки|Количество узлов транзакций, подготовленных в качестве части сети.|1–5| 2
Производительность хранилища узлов транзакций|Тип управляемых дисков, на которых развернуты узлы транзакций.|Standard или Premium|Стандартная
Размер виртуальной машины узла транзакций|Размер виртуальной машины, используемой для узлов транзакций.|"Стандартный" A, <br />"Стандартный" D, <br />"Стандартный" D-v2, <br />"Стандартный" F, <br />"Стандартный" DS, <br />"Стандартный" FS|Стандартный D1v2

### <a name="ethereum-settings"></a>Параметры Ethereum

Затем в разделе **Параметры Ethereum** укажите параметры конфигурации Ethereum, такие как сетевой идентификатор и пароль учетной записи Ethereum или первичный блок.

![Параметры Ethereum](./media/ethereum-deployment/standalone-leader-deployment.png)

Имя параметра |ОПИСАНИЕ |Допустимые значения|Значения по умолчанию
---|---|---|---
Идентификатор ConsortiumMember|Идентификатор, связанный с каждым участником сети консорциума, который используется для настройки пространства IP-адресов, чтобы избежать конфликтов. <br /><br />Идентификатор участника должен быть уникальным среди разных организаций в одной сети. Уникальный идентификатор участника необходим даже в том случае, когда та же организация развертывает участников в нескольких регионах.<br /><br />Запишите значение этого параметра, так как его потребуется использовать совместно с другими присоединяемыми участниками.|0–255
Идентификатор сети Ethereum|Идентификатор сети для сети Ethereum развертываемого консорциума. Каждая сеть Ethereum имеет свой собственный идентификатор сети, причем 1 соответствует идентификатору общедоступной сети. Хотя к сети доступ есть только у узлов майнинга, по-прежнему рекомендуется использовать большие значения во избежание конфликтов.|5–999 999 999| 10101010
Пользовательский первичный блок|Параметр, который определяет автоматическое создание первичного блока или предоставление пользовательского первичного блока.|Да/нет| Нет 
Пароль учетной записи Ethereum (Пользовательский первичный блок = нет)|Пароль администратора, используемый для защиты учетной записи Ethereum, импортируется на каждый узел. Пароль должен содержать следующее: 1 прописную букву, 1 строчную букву и 1 цифру.|12 или более знаков|Нет данных
Парольная фраза закрытого ключа Ethereum (Первичный блок = нет)|Парольная фраза, используемая для создания закрытого ключа ECC, связана с создаваемой учетной записью Ethereum по умолчанию. Предварительно созданный закрытый ключ не требуется передавать явным образом куда-либо.<br /><br />Рекомендуем выбирать в достаточной степени случайную парольную фразу, чтобы обеспечить защиту закрытого ключа и избежать перекрытия с другими участниками консорциума. Парольная фраза должна содержать по меньшей мере 1 прописную букву, 1 строчную букву и 1 цифру.<br /><br />Обратите внимание, что если два участника будут использовать одну и ту же парольную фразу, созданные учетные записи будут совпадать. Одна и та же парольная фраза полезна в том случае, если одна и та же организация пытается выполнить развертывание по всем регионам и ей нужно совместно использовать одну учетную запись на всех узлах.|12 или более знаков|Нет данных
Первичный блок (Пользовательский первичный блок = да)|Строка формата JSON, представляющая пользовательский первичный блок. Дополнительные сведения о формате первичного блока можно найти в разделе "Настройка сети".<br /><br />При предоставлении пользовательского первичного блока все равно создается учетная запись Ethereum. Попробуйте указать существующую учетную запись Ethereum в первичном блоке, чтобы не ожидать начала майнинга.|Допустимый JSON |Нет данных
Общий ключ для подключения|Общий ключ для подключения между шлюзами виртуальной сети.| 12 или более знаков|Нет данных
URL-адрес данных консорциума|URL-адрес, указывающий на данные конфигурации соответствующего консорциума, предоставляемые развертыванием другого участника. <br /><br />Эти сведения предоставляет уже подключенный участник, имеющий развертывание. При развертывании остальной сети URL-адрес формируется в процессе развертывания шаблона с именем CONSORTIUM-DATA.||Нет данных
Шлюз виртуальной сети для подключения|Путь к ресурсу шлюза виртуальной сети, к которому выполняется подключение.<br />Эти сведения предоставляет уже подключенный участник, имеющий развертывание. При развертывании остальной части сети URL-адрес находится в выходных данных развертывания шаблона с именем CONSORTIUM_MEMBER_GATEWAY_ID. Примечание. Должен использоваться тот же URL-адрес данных и ресурс шлюза виртуальной сети участника консорциума данных.||Нет данных
Конечная точка регистратора сведений кэширующего узла|Конечная точка сведений кэширующего узла, предоставляемая развертыванием другого участника|Действительная конечная точка первого участника в консорциуме|Нет данных
Ключ регистратора сведений кэширующего узла|Первичный ключ сведений кэширующего узла, предоставляемый развертыванием другого участника|Допустимый первичный ключ первого участника консорциума|Нет данных

### <a name="summary"></a>Сводка

Просмотрите итоговую колонку, чтобы изучить предоставленные входные данные и выполнить элементарную проверку перед развертыванием.

![Сводка](./media/ethereum-deployment/summary.png)

Просмотрите юридические и конфиденциальные условия и нажмите кнопку **Приобрести**, чтобы выполнить развертывание. Если развертывание содержит несколько регионов или выполняется для сети консорциума, этот шаблон предварительно развертывает VPN-шлюзы, необходимые для поддержки подключения к сети с другими участниками. Развертывание шлюза может занять от 45 до 50 минут.

## <a name="post-deployment-sanity-checks"></a>Проверки работоспособности после развертывания

### <a name="administrator-page"></a>Страница администратора

После успешного завершения развертывания и подготовки всех ресурсов можно перейти на страницу администратора, чтобы ознакомиться с сетью блокчейна и проверить ее работоспособность после развертывания. URL-адрес страницы администратора — это DNS-имя подсистемы балансировки нагрузки; он указан в разделе выходных данных развертывания шаблона с именем ADMIN_SITE.

Чтобы найти его, выберите группу ресурсов, которая была развернута. Затем выберите **Обзор** и щелкните ссылку непосредственно под параметром **Развертывания**, указывающим количество успешно выполненных развертываний.

![Общие сведения о группе ресурсов](./media/ethereum-deployment/resource-overview.png)

Новый экран содержит хронологию развертывания. Выберите первый ресурс развертывания (например, microsoft-azure-blockchain.azure-blockchain-servi...) и найдите раздел **Outputs** (Выходные данные) в нижней части страницы. Вы увидите URL-адрес страницы администратора в выходном параметре развертывания шаблона с именем ADMIN_SITE.

![Развертывания ресурсов](./media/ethereum-deployment/resource-deployments.png)

![Выходные данные развертывания](./media/ethereum-deployment/deployment-output.png)

Чтобы перейти на страницу администратора, скопируйте значение выходного параметра **ADMIN-SITE** и откройте его в другой вкладке.

На странице администратора можно просмотреть общие сведения о топологии развертывания в разделе "Состояние узла Ethereum". Эти сведения включают в себя все имена узлов, количество кэширующих узлов и последний виденный блок. Количество кэширующих узлов для каждого узла находится в диапазоне от минимального значения — на один меньше, чем *Общее число узлов* — до максимального количества узлов. Обратите внимание, что количество кэширующих узлов не ограничивает число узлов, которые могут быть развернуты в сети.
В некоторых случаях вы увидите, что количество кэширующих узлов резко меняется и может быть меньше, чем (общее число узлов – 1). Разница в количестве не всегда означает, что узлы находятся в неработоспособном состоянии, поскольку ветвления в реестре могут вызвать незначительные изменения в количестве кэширующих узлов. Наконец, можно изучить последний виденный блок на каждом узле в сети, чтобы определить ветвления или задержки в системе.

![Состояние узла](./media/ethereum-deployment/node-status.png)

Состояние узла обновляется каждые 10 секунд. Перезагрузите страницу через браузер или нажмите кнопку **Обновить**, чтобы обновить представление.

### <a name="oms-portal"></a>Портал OMS

Портал OMS можно найти по следующей ссылке в выходных данных развертывания (OMSPORTALURL) или выбрав ресурс OMS в группе развернутых ресурсов.

![URL-АДРЕС OMS](./media/ethereum-deployment/oms-url.png)

![Ресурс OMS](./media/ethereum-deployment/oms-resource.png)

На портале в первую очередь отображается общая статистика по сети.

![Общие сведения об OMS](./media/ethereum-deployment/oms-overview.png)

Щелкнув обзор, можно перейти к просмотру статистики по отдельным узлам на портале.

![Статистика по отдельным узлам](./media/ethereum-deployment/per-node-stats.png)

### <a name="accessing-nodes"></a>Доступ к узлам

Вы можете удаленно подключиться к виртуальным машинам для узлов транзакций по протоколу SSH с предоставленным вами именем администратора и паролем или ключом SSH. Поскольку виртуальные машины узлов транзакций не имеют собственных публичных IP-адресов, вам нужно будет перейти к балансировщику нагрузки и указать номер порта. Команда SSH для доступа к первому узлу транзакций отображается в выходном параметре развертывания шаблона, **SSH_TO_FIRST_TX_NODE** (для этого развертывания: ssh -p 4000 gethadmin@leader4vb.eastus.cloudapp.azure.com). Чтобы получить дополнительные узлы транзакций, увеличьте номер порта на единицу (например, первый узел транзакций находится на порту 4000).

Поскольку виртуальные машины, в которых запущены узлы майнинга, недоступны извне, необходимо пройти через один из узлов транзакций. После создания сеанса SSH к узлу транзакций установите свой закрытый ключ на узле транзакций или используйте пароль, чтобы запустить сеанс SSH с любым из узлов майнинга.

**Примечание.**

Имена узлов можно получить на сайте администрирования или на портале Azure. На портале Azure имена узлов, которые входят в состав ресурса масштабируемого набора виртуальных машин, находятся в списке **Instances** (Экземпляры), который отличается от фактических имен узлов. Например, имя узла на портале Azure может выглядеть как **mn-asdfmv-reg1_0**, но фактическое имя узла будет иметь следующий вид: **mn-asdfmv-reg**.

Например: 

Имя узла портала Azure| Фактическое имя узла
---|---
mn-ethwvu-reg1_0| mn-ethwvu-reg1000000
mn-ethwvu-reg1_1 |mn-ethwvu-reg1000001
mn-ethwvu-reg1_2 |mn-ethwvu-reg1000002

## <a name="adding-a-new-consortium-member"></a>Добавление нового участника консорциума

### <a name="sharing-data"></a>Общий доступ к данным

Первый (или подключенный) участник консорциума должен указать другим участникам несколько фрагментов данных, чтобы они могли присоединиться и установить свое подключение. В частности:

1. **Shared Consortium Configuration Data** (Общие сведения о конфигурации консорциума). Набор данных, используемый для управления подключениями Ethereum между двумя участниками. Необходимые сведения, включая первичный блок, идентификатор сети консорциума и загрузочные узлы, записываются в файл на узлах транзакций лидера или другого развернутого участника. Расположение этого файла отображается в выходном параметре развертывания шаблона с именем **CONSORTIUM-DATA**.
2. **Peer Info endpoint** (Конечная точка сведений кэширующего узла). Конечная точка регистратора сведений кэширующего узла для получения сведений обо всех узлах, уже подключенных к сети Ethereum — от лидеров или развертываний других участников. База данных сохраняет набор сведений о каждом подключенном к сети узле, например имя узла сервера, частные IP-адреса и т. д. Это выходной параметр развертывания шаблона с именем **PEER_INFO_ENDPOINT**.
3. **Peer Info Primary Key** (Первичный ключ сведений кэширующего узла). Первичный ключ регистратора сведений кэширующего узла используется для получения доступа к лидеру или первичному ключу сведений кэширующего узла другого участника. Это выходной параметр развертывания шаблона с именем **PEER_INFO_PRIMARY_KEY**.


4. **VNET Gateway** (Шлюз виртуальной сети). Каждый участник устанавливает подключение ко всей сети блокчейна через существующего участника. Для подключения виртуальной сети необходимо знать путь к ресурсу шлюза виртуальной сети участника, к которому вы подключаетесь. Это выходной параметр развертывания шаблона с именем **CONSORTIUM_MEMBER_GATEWAY_ID**.
5. **Shared Key** (Открытый ключ). Предварительно заданный секретный ключ между двумя подключающимися участниками сети консорциума. Это буквенно-цифровая строка длиной от 1 до 128 символов, которая согласовывается вне контекста развертывания. (Например, **МоЙОткрытЫйКлючАБВ123**)

### <a name="acceptance-of-new-member"></a>Принятие нового участника

Этот шаг следует выполнять после того, как присоединяемый участник успешно развернет свою сеть. Прежде чем участника можно будет присоединить к сети и он сможет видеть трафик транзакций, существующий участник должен выполнить окончательную настройку на своем VPN-шлюзе, чтобы он смог принимать входящие подключения. Это означает, что узлы Ethereum присоединяемого участника не будут работать до установки подключения. Эту конфигурацию можно выполнить с помощью PowerShell или xPlat CLI. Модуль PowerShell и сценарий xPlat CLI также сохраняются на узле транзакций вместе с данными консорциума. Расположение сценария указано в выходных параметрах развертывания с именами **PAIR-GATEWAY-PS-MODULE** и **PAIR-GATEWAY-AZURE-CLISCRIPT** соответственно.

**Настройка PowerShell/интерфейса командной строки**

Узнать больше о том, как приступить к работе с командлетами Azure PowerShell и командной строкой Azure xPlat, можно в документации по Azure.

Вам потребуется последняя версия командлетов Azure, установленная локально, и открытый сеанс. Убедитесь, что входите в сеанс с учетными данными подписки Azure.

**PowerShell: подключение**

Загрузите модуль PowerShell и сохраните его локально. Расположение модуля PowerShell указано в выходном параметре **PAIR-GATEWAY-PS-MODULE** развертывания шаблона.

Если он еще не включен, используйте командлет **Set-ExecutionPolicy** для локального сеанса, чтобы разрешить запуск неподписанного модуля.

**Set-ExecutionPolicy Unrestricted CurrentUser**

Далее войдите в свою подписку Azure, в которой выполнено развертывание лидера, с использованием командлета

**Login-AzureRmAccount**

Затем импортируйте модуль:

**Import-Module <filepath to downloaded file>**

И наконец, выполните функцию, передав ей соответствующие входные данные:

- **MyGatewayResourceId** — путь к ресурсу шлюза. Это выходной параметр развертывания шаблона с именем **CONSORTIUM_MEMBER_GATEWAY_ID**.
- **OtherGatewayResourceId** — путь к ресурсу шлюза подключаемого участника. Он предоставляется присоединяемым участником и содержится в выходном параметре развертывания шаблона с именем **CONSORTIUM_MEMBER_GATEWAY_ID**.
- **ConnectionName** — имя для идентификации подключения к этому шлюзу.
- **Shared Key** — предварительно заданный секретный ключ между двумя подключающимися участниками сети консорциума.

**CreateConnection** - MyGatewayResourceId <resource path of your Gateway> -OtherGatewayResourceId <путь к ресурсу шлюза присоединяемого участника> -ConnectionName Имя_подключения -SharedKey "МоЙОткрытЫйКлючАБВ123"

**xPlat CLI: подключение**

Загрузите сценарий Azure CLI и сохраните его локально. Расположение сценария Azure CLI указывается в параметре развертывания шаблона с именем **PAIR-GATEWAY-AZURE-CLI-SCRIPT**.

Запустите сценарий с соответствующими входными данными:

- **MyGatewayResourceId** — путь к ресурсу шлюза. Это выходной параметр развертывания шаблона с именем **CONSORTIUM_MEMBER_GATEWAY_ID**.
- **OtherGatewayResourceId** — путь к ресурсу шлюза подключаемого участника. Он предоставляется присоединяемым участником и содержится в параметре развертывания шаблона с именем **CONSORTIUM_MEMBER_GATEWAY_ID**.
- **ConnectionName** — имя для идентификации подключения к этому шлюзу.
- **Shared Key** — предварительно заданный секретный ключ между двумя подключающимися участниками сети консорциума.
- **Location** — регион Azure, где развернут ресурс шлюза.

``` powershell
az network vpn-connection create --name $ConnectionName --resource-group
$MyResourceGroup --vnet-gateway1 $MyGatewayResourceId --shared-key $SharedKey --vnet-
gateway2 $OtherGatewayResourceId --enable-bgp
```

После успешной настройки подключения между развертываниями **лидера** и **участника** архитектура будет выглядеть следующим образом.

![Архитектура лидеров и участников](./media/ethereum-deployment/leader-member.png)

## <a name="fund-new-member-account"></a>Создание новой учетной записи участника

### <a name="generated-genesis-block"></a>Создание первичного блока

Учетная запись Ethereum первого участника создается с 1 триллионом эфира, если развертывание создает первичный блок (Пользовательский первичный блок = нет). Другие участники получат учетную запись, которая предварительно не содержит средств, и они должны ожидать накопления эфира, когда их узлы майнинга начнут майнинг блоков. Чтобы избежать необходимости ожидания новыми участниками накопления эфира, можно ускорить учетные записи Ethereum присоединяемых участников явным образом, начислив им необходимые средства.

Чтобы сделать это, присоединяемые участники должны предоставить вам учетные записи Ethereum, показанные на их администраторских веб-сайтах. Затем с помощью своего администраторского веб-сайта вы можете начислить эфир из своей учетной записи на их учетные записи, указав предоставленные ими данные.

### <a name="custom-genesis-block"></a>Пользовательский первичный блок

Если с указанной учетной записью Ethereum предоставляется пользовательский первичный блок, можно использовать MetaMask или другой инструмент для переноса эфира из такой указанной учетной записи в предварительно созданную учетную запись Ethereum, отображаемую на администраторском веб-сайте. Инструкции по использованию MetaMask см. в разделе [Создание учетной записи Ethereum](#create-ethereum-account).

Если пользовательский первичный блок предоставляется без учетной записи или у вас есть доступ к предварительно выделенным учетным записям, необходимо подождать, пока узлы майнинга начнут майнинг и в вашей учетной записи будет генерироваться эфир. Скорость генерации средств зависит от уровня сложности, заданного в пользовательском первичном блоке.

## <a name="create-ethereum-account"></a>Создание учетной записи Ethereum

Чтобы создать дополнительную учетную запись, можно использовать несколько разных решений. Одно такое решение — расширение для Chrome MetaMask, которое предоставляет хранилище удостоверений и подключение к сети Ethereum — открытой, тестовой или пользовательской. MetaMask формирует транзакцию для регистрации учетной записи в сети.

Эта транзакция, как и любая другая транзакция, будет передана на один из узлов транзакций и в конечном итоге будет передана в один блок, как показано ниже.

![Узел транзакции](./media/ethereum-deployment/transaction-node.png)

Чтобы установить это расширение в браузере Chrome, откройте меню "Настройки и управление Google Chrome" > Дополнительные инструменты > Расширения > Добавить расширение и выполните поиск расширения MetaMask.

![Расширение MetaMask](./media/ethereum-deployment/metamask-extension.png)

После установки откройте MetaMask и создайте новое хранилище. По умолчанию хранилище будет подключено к сети Morden Test Network. Необходимо будет изменить этот параметр, чтобы подключиться к развернутой закрытой сети консорциума, в частности к подсистеме балансировки нагрузки перед узлами транзакций. В выходных данных шаблона найдите опубликованную конечную точку Ethereum RPC на порту 8545 с именем `ETHEREUM-RPC-ENDPOINT` и введите ее имя в поле Custom RPC, как показано ниже.

![Параметры MetaMask](./media/ethereum-deployment/metamask-settings.png)

При создании хранилища создается кошелек, содержащий учетную запись. Чтобы создать дополнительные учетные записи, выберите команду **Switch Accounts** (Выбрать другую учетную запись) и затем нажмите кнопку **+**.

![MetaMask создает учетную запись](./media/ethereum-deployment/metamask-create-account.png)

### <a name="initiate-initial-ether-allocation"></a>Активация начального распределения эфира

На странице администратора можно сформировать транзакцию для передачи эфира из предварительно выделенной учетной записи в другую учетную запись Ethereum. Эта передача эфира происходит в виде транзакции, которая будет отправлена из узла транзакций и будет передана в блок, как показано ниже.

![Узел транзакции](./media/ethereum-deployment/transaction-node-mined.png)

Через значок буфера обмена в кошельке MetaMask скопируйте адрес учетной записи Ethereum, в которую нужно передать эфир, и вернитесь на страницу администратора. Вставьте скопированную учетную запись в поле ввода для передачи 1000 эфира из предварительно выделенной учетной записи Ethereum в вашу новую учетную запись. Нажмите кнопку **Submit** (Отправить) и ожидайте завершения транзакции в блоке.

![Состояние узла](./media/ethereum-deployment/node-status2.png)

После передачи транзакции в вычисляемый блок баланс счета в MetaMask для вашей учетной записи будет отражать передачу 1000 эфира.

![Передача эфира в MetaMask](./media/ethereum-deployment/metamask-transfer.png)

### <a name="transfer-of-ether-between-accounts"></a>Передача эфира между учетными записями

На этом этапе можно выполнять транзакции внутри частной сети консорциума. Простейшая транзакция — передача эфира из одной учетной записи в другую. Для формирования такой транзакции можно использовать MetaMask еще раз, передав средства из первой учетной записи, использованной выше, в другую учетную запись.

В кошельке **Wallet 1** в MetaMask нажмите кнопку Send (Отправить). Скопируйте адрес второго кошелька, созданного в поле ввода **Recipient Address** (Адрес получателя), и количество эфира для передачи в поле ввода **Amount** (Сумма). Нажмите кнопку **Send** (Отправить) и согласитесь с отправкой транзакции.

![Операция отправки эфира в MetaMask](./media/ethereum-deployment/metamask-send.png)

Когда транзакция будет получена и зафиксирована в блоке, балансы счетов соответствующим образом обновятся. Следует отметить, что из кошелька **Wallet 1** вычитается более 15 эфира, поскольку потребовалось уплатить вознаграждение майнинга для обработки транзакции.

![Кошелек 1](./media/ethereum-deployment/wallet1.png)

![Кошелек 2](./media/ethereum-deployment/wallet2.png)

## <a name="next-steps"></a>Дополнительная информация

Теперь вы готовы приступить к разработке приложений и смарт-контрактов на основе сети блокчейна частного консорциума.
